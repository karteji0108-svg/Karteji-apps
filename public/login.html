<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0B1120" />
  <title>Masuk | KARTEJI</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24..48,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      darkMode: ['class', '[data-theme="dark"]'],
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'system-ui', 'Segoe UI', 'Roboto', 'sans-serif'] },
          colors: {
            brand: { primary: '#0F172A' },
            accent: { DEFAULT: '#F97316', glow: '#FDBA74' }
          },
          animation: {
            'slide-up': 'slideUp .55s cubic-bezier(.16, 1, .3, 1) both',
            'blob': 'blob 11s ease-in-out infinite',
            'sheen': 'sheen 1.2s ease-out both',
          },
          keyframes: {
            slideUp: { '0%': { transform: 'translateY(18px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.08)' },
              '66%': { transform: 'translate(-20px, 20px) scale(.92)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            sheen: { '0%': { transform: 'translateX(-120%)' }, '100%': { transform: 'translateX(120%)' } }
          }
        }
      }
    }
  </script>

  <style>
    :root{
      color-scheme: light;
      --bg0:#f8fafc; --bg1:#ffffff;
      --fg0:#0f172a; --fg1:rgba(15,23,42,.68);
      --glass: rgba(255,255,255,.78);
      --glassBorder: rgba(255,255,255,.55);
      --glassShadow: 0 18px 60px rgba(2,6,23,.16);
      --ring: rgba(249,115,22,.35);
    }
    html[data-theme="dark"]{
      color-scheme: dark;
      --bg0:#050814; --bg1:#0b1223;
      --fg0:#e5e7eb; --fg1:rgba(229,231,235,.72);
      --glass: rgba(15,23,42,.55);
      --glassBorder: rgba(148,163,184,.18);
      --glassShadow: 0 18px 70px rgba(0,0,0,.45);
      --ring: rgba(253,186,116,.30);
    }

    body { font-family:"Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; -webkit-font-smoothing: antialiased; }
    body::-webkit-scrollbar { display:none; }
    *{ -webkit-tap-highlight-color: transparent; }

    .glass-card{
      background: var(--glass);
      backdrop-filter: blur(18px) saturate(130%);
      -webkit-backdrop-filter: blur(18px) saturate(130%);
      border: 1px solid var(--glassBorder);
      box-shadow: var(--glassShadow);
    }
    .glass-inset{
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,0));
      border: 1px solid rgba(255,255,255,.10);
    }

    .tap{ transition: transform .16s ease, box-shadow .16s ease, filter .16s ease; will-change: transform; }
    .tap:active{ transform: scale(.992); }

    .focus-ring:focus{ outline:none; }
    .focus-ring:focus-visible{ box-shadow: 0 0 0 6px var(--ring); }

    .ad-2000{ animation-delay:2000ms; }

    @media (prefers-reduced-motion: reduce){
      * { animation:none !important; transition:none !important; scroll-behavior:auto !important; }
    }
  </style>

  <script>
    // Theme bootstrap (before paint)
    (function(){
      const saved = localStorage.getItem('kte_theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
</head>

<body class="h-screen w-screen overflow-hidden relative">

  <!-- Liquid background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0"
      style="
        background:
          radial-gradient(1200px 600px at 18% 8%, rgba(59,130,246,.16), transparent 55%),
          radial-gradient(900px 520px at 92% 18%, rgba(249,115,22,.14), transparent 55%),
          radial-gradient(900px 520px at 42% 96%, rgba(99,102,241,.14), transparent 55%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
      ">
    </div>

    <div class="absolute inset-0 overflow-hidden pointer-events-none">
      <div class="absolute top-[-12%] left-[-12%] w-96 h-96 rounded-full filter blur-3xl opacity-30 animate-blob"
           style="background: rgba(59,130,246,.55)"></div>
      <div class="absolute bottom-[-12%] right-[-12%] w-96 h-96 rounded-full filter blur-3xl opacity-25 animate-blob ad-2000"
           style="background: rgba(249,115,22,.55)"></div>
    </div>

    <!-- subtle grain -->
    <div class="absolute inset-0 opacity-[.06] pointer-events-none"
      style="background-image: url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22%3E%3Cfilter id=%22n%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.9%22 numOctaves=%222%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22120%22 height=%22120%22 filter=%22url(%23n)%22 opacity=%220.35%22/%3E%3C/svg%3E');">
    </div>
  </div>

  <!-- Top actions -->
  <div class="absolute top-0 left-0 right-0 z-40 pt-6 px-6">
    <div class="flex items-center justify-between gap-3">
      <a href="index.html"
         class="tap focus-ring inline-flex items-center gap-2 font-extrabold text-sm py-2 px-3 rounded-full glass-inset"
         style="color: var(--fg1)">
        <span class="material-symbols-rounded text-lg">arrow_back</span>
        Kembali
      </a>

      <button id="btn-theme"
        class="tap focus-ring inline-flex items-center gap-2 font-extrabold text-sm py-2 px-3 rounded-full glass-inset"
        style="color: var(--fg1)"
        aria-label="Ganti tema">
        <span id="themeIcon" class="material-symbols-rounded text-lg" aria-hidden="true">dark_mode</span>
      </button>
    </div>
  </div>

  <!-- Content -->
  <section class="absolute inset-0 z-30 flex flex-col justify-center items-center px-6">

    <div class="glass-card w-full max-w-[390px] rounded-[2rem] p-8 animate-slide-up relative z-10">
      <!-- header -->
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-14 h-14 rounded-2xl mb-4 text-white shadow-lg"
             style="background: linear-gradient(135deg, #0F172A, #111c33); box-shadow: 0 18px 60px rgba(2,6,23,.18);">
          <span class="material-symbols-rounded text-3xl">login</span>
        </div>

        <h1 class="text-2xl font-extrabold tracking-tight" style="color: var(--fg0)">Selamat Datang</h1>
        <p class="text-sm mt-1 font-semibold" style="color: var(--fg1)">Masuk ke Dashboard Warga</p>
      </div>

      <!-- form -->
      <div class="space-y-5">
        <!-- email -->
        <div class="relative group">
          <div class="absolute left-4 top-1/2 -translate-y-1/2 transition-colors"
               style="color: rgba(148,163,184,.9)">
            <span class="material-symbols-rounded text-xl">mail</span>
          </div>
          <input id="email" type="email" placeholder="Alamat Email" autocomplete="email"
            class="focus-ring w-full pl-12 pr-4 py-4 rounded-2xl text-sm font-extrabold outline-none transition-all"
            style="
              background: rgba(148,163,184,.12);
              border: 1px solid rgba(148,163,184,.18);
              color: var(--fg0);
            "
          />
        </div>

        <!-- password -->
        <div class="relative group">
          <div class="absolute left-4 top-1/2 -translate-y-1/2 transition-colors"
               style="color: rgba(148,163,184,.9)">
            <span class="material-symbols-rounded text-xl">lock</span>
          </div>

          <input id="password" type="password" placeholder="Password" autocomplete="current-password"
            class="focus-ring w-full pl-12 pr-12 py-4 rounded-2xl text-sm font-extrabold outline-none transition-all"
            style="
              background: rgba(148,163,184,.12);
              border: 1px solid rgba(148,163,184,.18);
              color: var(--fg0);
            "
          />

          <button id="togglePass" type="button"
            class="tap focus-ring absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-xl"
            style="color: rgba(148,163,184,.95)"
            aria-label="Tampilkan/Sembunyikan password">
            <span id="eyeIcon" class="material-symbols-rounded text-xl">visibility</span>
          </button>
        </div>

        <div class="flex items-center justify-end">
          <a href="#" class="text-xs font-extrabold hover:opacity-80 transition"
             style="color: rgba(148,163,184,.95)">Lupa Password?</a>
        </div>

        <!-- message -->
        <div class="text-center min-h-[22px]">
          <span id="msg"
            class="hidden text-xs font-extrabold px-3 py-1 rounded-full"
            style="color:#ef4444; background: rgba(239,68,68,.10); border: 1px solid rgba(239,68,68,.20);">
          </span>
        </div>

        <!-- button -->
        <button id="loginBtn"
          class="tap focus-ring w-full text-white font-extrabold py-4 rounded-2xl transition-all flex items-center justify-center gap-3 relative overflow-hidden group"
          style="background: linear-gradient(135deg, #0F172A, #111c33); box-shadow: 0 18px 60px rgba(2,6,23,.18);">
          <span class="relative z-10">Masuk Akun</span>
          <span class="material-symbols-rounded relative z-10 text-lg group-hover:translate-x-1 transition-transform">login</span>

          <!-- sheen -->
          <span class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity">
            <span class="absolute -left-1/2 top-0 h-full w-1/2 bg-white/15 skew-x-[-18deg] animate-sheen"></span>
          </span>
        </button>
      </div>

      <!-- footer -->
      <div class="mt-8 text-center pt-6"
           style="border-top: 1px solid rgba(148,163,184,.18);">
        <p class="text-sm font-semibold" style="color: var(--fg1)">
          Belum punya akun?
          <a href="register.html" class="font-extrabold hover:opacity-80 transition ml-1" style="color: #F97316">
            Daftar Sekarang
          </a>
        </p>
      </div>
    </div>

    <p class="absolute bottom-8 text-[10px] font-extrabold tracking-widest opacity-60"
       style="color: rgba(148,163,184,.95)">
      &copy; 2025 KARTEJI
    </p>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // Konfigurasi Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
      authDomain: "katar-9cac3.firebaseapp.com",
      projectId: "katar-9cac3",
      storageBucket: "katar-9cac3.firebasestorage.app",
      messagingSenderId: "1017734829960",
      appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d",
      measurementId: "G-M4F9J10TTE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const msgEl = document.getElementById("msg");
    const btn = document.getElementById("loginBtn");
    const togglePass = document.getElementById("togglePass");
    const eyeIcon = document.getElementById("eyeIcon");

    // Theme toggle
    const btnTheme = document.getElementById("btn-theme");
    const themeIcon = document.getElementById("themeIcon");
    function getTheme(){ return document.documentElement.getAttribute('data-theme') || 'light'; }
    function setTheme(next){
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('kte_theme', next);
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta) meta.setAttribute('content', next === 'dark' ? '#0B1120' : '#F8FAFC');
      themeIcon.textContent = (next === 'dark') ? 'light_mode' : 'dark_mode';
    }
    function toggleTheme(){ setTheme(getTheme() === 'dark' ? 'light' : 'dark'); }
    setTheme(getTheme());
    btnTheme?.addEventListener('click', toggleTheme);

    function setMsg(text){
      if(text){
        msgEl.textContent = text;
        msgEl.classList.remove('hidden');
      } else {
        msgEl.classList.add('hidden');
      }
    }

    togglePass.addEventListener("click", () => {
      const isPass = passEl.type === "password";
      passEl.type = isPass ? "text" : "password";
      eyeIcon.textContent = isPass ? "visibility_off" : "visibility";
    });

    async function doLogin() {
      const email = emailEl.value.trim();
      const password = passEl.value;

      if (!email || !password) return setMsg("Email dan Password wajib diisi");

      btn.disabled = true;
      btn.classList.add("opacity-75", "cursor-not-allowed");
      const originalHTML = btn.innerHTML;

      btn.innerHTML = `
        <span class="material-symbols-rounded animate-spin text-xl">progress_activity</span>
        <span class="ml-2 relative z-10">Memverifikasi...</span>
      `;
      setMsg("");

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const uid = userCredential.user.uid;

        // Update status user (best effort)
        try {
          await updateDoc(doc(db, "users", uid), {
            onlineState: "online",
            lastActiveAt: serverTimestamp()
          });
        } catch (e) {
          console.log("Gagal update status, tapi login tetap lanjut", e);
        }

        window.location.href = "dashboard.html";
      } catch (err) {
        console.error(err);
        const code = err.code;

        if (code === "auth/invalid-credential") setMsg("Email atau Password salah.");
        else if (code === "auth/user-not-found") setMsg("Akun tidak ditemukan.");
        else if (code === "auth/wrong-password") setMsg("Password salah.");
        else if (code === "auth/too-many-requests") setMsg("Terlalu banyak percobaan. Coba nanti.");
        else setMsg("Gagal masuk. Periksa koneksi.");

        btn.disabled = false;
        btn.classList.remove("opacity-75", "cursor-not-allowed");
        btn.innerHTML = originalHTML;
      }
    }

    btn.addEventListener("click", doLogin);

    [emailEl, passEl].forEach(el => {
      el.addEventListener("keypress", (e) => { if (e.key === "Enter") doLogin(); });
    });
  </script>

</body>
</html>
