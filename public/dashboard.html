<!DOCTYPE html>
<html lang="id" class="scroll-smooth dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#050505">
  <title>KARTEJI | NEON_GRID OS</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Plus Jakarta Sans', 'sans-serif'],
            display: ['Syne', 'sans-serif'] 
          },
          colors: {
            // Cyberpunk Palette
            void: '#050505',
            'void-light': '#121212',
            neon: {
                teal: '#2DD4BF',    // Electric Turquoise
                purple: '#A855F7',  // Plasma Violet
                pink: '#EC4899'
            },
            surface: {
                dark: 'rgba(18, 18, 18, 0.8)',
                darker: 'rgba(0, 0, 0, 0.6)'
            }
          },
          animation: { 
            'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'glow': 'glow 2s ease-in-out infinite alternate',
            'popup': 'popup 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)',
          },
          keyframes: {
            glow: {
              '0%': { boxShadow: '0 0 5px #2DD4BF, 0 0 10px #2DD4BF' },
              '100%': { boxShadow: '0 0 20px #2DD4BF, 0 0 30px #A855F7' }
            },
            popup: { '0%': { transform: 'scale(0.9) translateY(20px)', opacity:0 }, '100%': { transform: 'scale(1) translateY(0)', opacity:1 } },
          }
        }
      }
    }
  </script>

  <style>
    /* Cyberpunk Aesthetics */
    body { 
        background-color: #050505; 
        color: #E2E8F0; 
        -webkit-tap-highlight-color: transparent; 
        /* Noise Texture */
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
    }
    
    .font-display { font-family: 'Syne', sans-serif; letter-spacing: -0.02em; }
    .no-scrollbar::-webkit-scrollbar { display: none; }

    /* Neon Glass Effect */
    .neon-glass {
        background: rgba(18, 18, 18, 0.7);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(45, 212, 191, 0.1); /* Subtle Teal Border */
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    }

    /* Glowing Borders & Text */
    .border-glow { border: 1px solid #2DD4BF; box-shadow: 0 0 10px -3px #2DD4BF; }
    .text-glow { text-shadow: 0 0 10px rgba(45, 212, 191, 0.5); }

    /* Advanced Card (The Cyber-Wallet) */
    .cyber-card {
        background: linear-gradient(135deg, rgba(45,212,191,0.1) 0%, rgba(168,85,247,0.1) 100%);
        position: relative; overflow: hidden;
        border: 1px solid transparent;
        background-clip: padding-box;
    }
    .cyber-card::before {
        content: ''; position: absolute; inset: 0; z-index: -1; margin: -1px; border-radius: inherit;
        background: linear-gradient(to right, #2DD4BF, #A855F7);
    }

    /* Interactions */
    .btn-cyber:active { transform: scale(0.96); filter: brightness(1.2); }
    .view-section { display: none; opacity: 0; animation: popup 0.3s forwards; }
    .view-section.active { display: block; }
    
    /* Nav Active State */
    .nav-btn.active .icon-box { 
        background: linear-gradient(to bottom right, #2DD4BF, #2DD4BF30); 
        color: #050505; 
        box-shadow: 0 0 15px #2DD4BF80; 
        transform: translateY(-4px) scale(1.1);
    }
    .nav-btn.active p { color: #2DD4BF; font-weight: 800; letter-spacing: 0.05em; }
  </style>
</head>

<body class="min-h-screen pb-32 overflow-x-hidden">

  <audio id="sfxClick" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
  <audio id="sfxWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
  <audio id="sfxShuffle" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3" loop></audio>

  <div id="toastContainer" class="fixed top-8 left-0 right-0 z-[120] flex flex-col items-center gap-2 pointer-events-none px-4"></div>
  
  <div id="globalLoader" class="fixed inset-0 bg-void z-[9999] flex items-center justify-center flex-col gap-6">
    <div class="relative w-24 h-24">
        <div class="absolute inset-0 rounded-full border-[6px] border-void-light"></div>
        <div class="absolute inset-0 rounded-full border-[6px] border-t-neon-teal border-r-neon-purple border-b-transparent border-l-transparent animate-spin blur-[2px]"></div>
        <div class="absolute inset-2 rounded-full bg-void-light flex items-center justify-center border-2 border-neon-teal/20">
            <span class="material-symbols-rounded text-3xl text-neon-teal animate-pulse">token</span>
        </div>
    </div>
    <p class="font-display font-bold text-neon-teal tracking-[0.3em] text-sm animate-pulse">INITIALIZING...</p>
  </div>

  <div id="crudModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4 bg-black/80 backdrop-blur-md transition-opacity">
    <div class="neon-glass w-full max-w-md rounded-[2rem] p-6 relative animate-popup overflow-hidden border-neon-teal/30">
      <div class="absolute top-0 left-1/2 -translate-x-1/2 w-1/3 h-1 bg-gradient-to-r from-transparent via-neon-teal to-transparent blur-sm"></div>
      
      <div class="flex justify-between items-center mb-8">
          <h2 id="modalTitle" class="font-display text-xl font-black text-white uppercase tracking-wider">Judul</h2>
          <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-void-light flex items-center justify-center hover:bg-neon-pink/20 hover:text-neon-pink transition-colors border border-white/5"><span class="material-symbols-rounded">close</span></button>
      </div>
      <div id="modalBody" class="space-y-5 max-h-[60vh] overflow-y-auto no-scrollbar pb-2"></div>
      <button id="modalSubmitBtn" class="mt-8 w-full rounded-xl bg-gradient-to-r from-neon-teal to-neon-teal/80 text-void py-4 text-sm font-black tracking-widest shadow-[0_0_20px_rgba(45,212,191,0.3)] btn-cyber font-display uppercase">EKSEKUSI</button>
    </div>
  </div>

  <div id="arisanOverlay" class="fixed inset-0 z-[80] hidden flex-col items-center justify-center bg-void/95 backdrop-blur-xl p-6">
      <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_rgba(168,85,247,0.2)_0%,_transparent_70%)] pointer-events-none"></div>
      <button onclick="closeArisan()" class="absolute top-8 right-8 w-12 h-12 bg-void-light rounded-full flex items-center justify-center text-white hover:text-neon-pink border border-white/10 transition-colors z-20"><span class="material-symbols-rounded">close</span></button>
      
      <div class="relative w-80 h-80 mb-10 z-10">
          <div class="absolute inset-0 border-[4px] border-neon-teal/30 rounded-full animate-[spin_4s_linear_infinite]" style="border-style: dashed;"></div>
          <div class="absolute inset-6 border-[4px] border-neon-purple/30 rounded-full animate-[spin_6s_linear_infinite_reverse]" style="border-style: dotted;"></div>
          
          <div class="absolute inset-12 bg-void rounded-full overflow-hidden flex items-center justify-center border-2 border-neon-teal/50 shadow-[0_0_40px_rgba(45,212,191,0.2)]">
              <img id="shufflerImg" src="https://via.placeholder.com/150" class="w-full h-full object-cover opacity-40 mix-blend-luminosity transition-all duration-100">
              <div class="absolute inset-0 bg-gradient-to-t from-void via-transparent to-void"></div>
              <span id="shufflerIcon" class="material-symbols-rounded text-7xl absolute text-neon-teal animate-pulse">deployed_code</span>
          </div>
      </div>

      <h2 id="shufflerName" class="font-display text-4xl font-black mb-4 text-center text-transparent bg-clip-text bg-gradient-to-r from-neon-teal to-neon-purple text-glow z-10 tracking-wider">SYSTEM READY</h2>
      <p class="text-neon-teal/70 text-sm mb-12 font-mono tracking-widest z-10">// MENGINISIALISASI PROTOKOL PENGUNDIAN //</p>
      
      <button id="btnSpin" onclick="spinArisan()" class="relative group bg-void-light text-neon-teal px-14 py-5 rounded-full font-display font-black text-lg border border-neon-teal/50 btn-cyber overflow-hidden z-10 tracking-widest">
          <span class="relative z-10 flex items-center gap-3"><span class="material-symbols-rounded animate-spin-slow">data_usage</span> AKTIVASI</span>
          <div class="absolute inset-0 bg-neon-teal/20 blur-xl group-hover:bg-neon-teal/40 transition-all opacity-50"></div>
      </button>
      
      <div id="winnerActions" class="hidden flex-col w-full max-w-xs gap-4 animate-popup z-10">
          <button onclick="saveWinner()" class="bg-gradient-to-r from-neon-teal to-green-500 text-void py-4 rounded-xl font-display font-black uppercase tracking-wider shadow-[0_0_20px_rgba(45,212,191,0.4)] btn-cyber">Konfirmasi Data</button>
          <button onclick="spinArisan()" class="bg-void-light border border-white/10 text-white py-4 rounded-xl font-display font-bold uppercase tracking-wider btn-cyber">Re-Roll System</button>
      </div>
  </div>

  <header class="sticky top-0 z-30 px-6 pt-8 pb-4 neon-glass rounded-b-[2rem] mb-8">
      <div class="flex justify-between items-center">
          <div class="flex items-center gap-4 cursor-pointer btn-cyber group" onclick="playSound('click'); switchView('profile')">
              <div class="relative">
                <div class="absolute -inset-1 bg-gradient-to-r from-neon-teal via-neon-purple to-neon-teal rounded-full opacity-70 blur-md group-hover:opacity-100 transition-opacity animate-pulse-slow"></div>
                <img id="headerPhoto" class="relative w-12 h-12 rounded-full bg-void-light object-cover border-2 border-void" src="https://via.placeholder.com/100">
                <div class="absolute bottom-0 right-0 w-4 h-4 bg-neon-teal border-2 border-void rounded-full shadow-[0_0_10px_#2DD4BF]"></div>
              </div>
              <div>
                  <p id="greeting" class="text-xs font-mono text-neon-teal/80 uppercase tracking-widest mb-1">// USER_LOGGED_IN</p>
                  <h1 id="headerName" class="font-display text-xl font-black text-white leading-none truncate w-40 text-glow">User</h1>
              </div>
          </div>
          <div class="w-12 h-12 rounded-full bg-void-light border border-neon-teal/20 flex items-center justify-center">
            <span class="material-symbols-rounded text-neon-teal animate-pulse-slow">hub</span>
          </div>
      </div>
  </header>

  <main class="px-5 relative z-10">

      <section id="view-home" class="view-section active">
          
          <div class="cyber-card w-full rounded-[2.5rem] p-8 text-white relative mb-10 group btn-cyber cursor-pointer" onclick="switchView('kas')">
              <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.2) 1px, transparent 0); background-size: 20px 20px;"></div>
              <div class="absolute bottom-0 right-0 p-6 opacity-20 text-neon-purple mix-blend-overlay"><span class="material-symbols-rounded text-9xl">account_balance_wallet</span></div>
              
              <div class="relative z-10">
                <div class="flex justify-between items-center mb-8">
                    <div class="flex items-center gap-3">
                        <span class="w-10 h-10 rounded-xl bg-neon-teal/20 border border-neon-teal/30 flex items-center justify-center backdrop-blur-md shadow-[0_0_15px_rgba(45,212,191,0.2)]"><span class="material-symbols-rounded text-neon-teal">account_balance</span></span>
                        <p class="text-xs font-mono font-bold uppercase tracking-widest text-neon-teal/80">Main_Vault // Kas</p>
                    </div>
                    <button onclick="event.stopPropagation(); togglePrivacy()" class="w-10 h-10 rounded-full bg-void-light/50 flex items-center justify-center hover:bg-neon-teal/20 text-neon-teal transition-all border border-neon-teal/20"><span id="privacyIcon" class="material-symbols-rounded text-lg">visibility</span></button>
                </div>
                
                <h2 id="cardBalance" class="font-display text-4xl font-black tracking-wider text-white mb-8 tabular-nums text-glow" style="text-shadow: 0 0 20px rgba(45,212,191,0.3);">Rp ...</h2>
                
                <div class="grid grid-cols-2 gap-4">
                   <div class="bg-void-light/50 px-5 py-4 rounded-2xl backdrop-blur-md border border-neon-teal/10 group-hover:border-neon-teal/30 transition-colors relative overflow-hidden">
                       <div class="absolute top-0 left-0 w-1 h-full bg-neon-teal"></div>
                       <div class="flex items-center gap-2 mb-2">
                           <span class="material-symbols-rounded text-neon-teal text-sm">arrow_downward</span>
                           <p class="text-[9px] font-mono uppercase font-bold text-neon-teal/70 tracking-wider">INFLOW</p>
                       </div>
                       <p id="cardIncome" class="font-display text-lg font-bold tracking-wide tabular-nums text-white">Rp 0</p>
                   </div>
                   <div class="bg-void-light/50 px-5 py-4 rounded-2xl backdrop-blur-md border border-neon-purple/10 group-hover:border-neon-purple/30 transition-colors relative overflow-hidden">
                       <div class="absolute top-0 left-0 w-1 h-full bg-neon-purple"></div>
                       <div class="flex items-center gap-2 mb-2">
                           <span class="material-symbols-rounded text-neon-purple text-sm">arrow_upward</span>
                           <p class="text-[9px] font-mono uppercase font-bold text-neon-purple/70 tracking-wider">OUTFLOW</p>
                       </div>
                       <p id="cardExpense" class="font-display text-lg font-bold tracking-wide tabular-nums text-white">Rp 0</p>
                   </div>
                </div>
              </div>
          </div>

          <div id="arisanWidget" class="hidden w-full bg-void-light rounded-full p-2 mb-10 border border-neon-purple/30 shadow-[0_0_20px_rgba(168,85,247,0.15)] btn-cyber cursor-pointer relative overflow-hidden" onclick="openArisanUI()">
             <div class="absolute inset-0 bg-gradient-to-r from-transparent via-neon-purple/10 to-transparent animate-[pulse_3s_ease-in-out_infinite] translate-x-[-100%]"></div>
             
             <div class="flex items-center gap-5 pr-4 relative z-10">
                <div class="relative">
                    <div class="absolute inset-0 bg-neon-purple rounded-full blur-md opacity-50 animate-pulse"></div>
                    <img id="arisanPhoto" src="https://via.placeholder.com/100" class="relative w-16 h-16 rounded-full border-2 border-void shadow-lg object-cover">
                    <span class="absolute -top-2 -right-1 text-2xl drop-shadow-[0_0_10px_rgba(255,215,0,0.8)]">ðŸ‘‘</span>
                </div>
                <div class="flex-1">
                    <p class="text-[10px] font-mono font-bold text-neon-purple uppercase tracking-widest mb-1">// LATEST_WINNER</p>
                    <h3 id="arisanName" class="font-display text-xl font-black text-white leading-none truncate tracking-wide">...</h3>
                </div>
                <div class="w-12 h-12 rounded-full bg-neon-purple/20 border border-neon-purple/50 flex items-center justify-center text-neon-purple animate-pulse-slow"><span class="material-symbols-rounded text-2xl">deployed_code</span></div>
             </div>
          </div>

          <h3 class="text-xs font-mono font-bold text-slate-500 uppercase tracking-widest mb-6 px-2 flex items-center gap-2">
              <span class="w-2 h-2 bg-neon-teal rounded-full animate-pulse"></span> CORE MODULES
          </h3>
          <div class="grid grid-cols-4 gap-5 mb-10">
              <div onclick="playSound('click'); switchView('kegiatan')" class="flex flex-col items-center gap-3 cursor-pointer btn-cyber group">
                  <div class="w-18 h-18 p-5 bg-void-light rounded-[1.5rem] border border-neon-teal/20 flex items-center justify-center text-neon-teal group-hover:border-neon-teal/60 group-hover:shadow-[0_0_15px_rgba(45,212,191,0.3)] transition-all relative overflow-hidden">
                      <div class="absolute inset-0 bg-neon-teal/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                      <span class="material-symbols-rounded text-3xl relative z-10">calendar_month</span>
                  </div>
                  <span class="text-[10px] font-mono font-bold text-slate-400 tracking-wider">ACARA</span>
              </div>
              
              <div onclick="playSound('click'); switchView('kas')" class="flex flex-col items-center gap-3 cursor-pointer btn-cyber group">
                  <div class="w-18 h-18 p-5 bg-void-light rounded-[1.5rem] border border-neon-teal/20 flex items-center justify-center text-neon-teal group-hover:border-neon-teal/60 group-hover:shadow-[0_0_15px_rgba(45,212,191,0.3)] transition-all relative overflow-hidden">
                      <div class="absolute inset-0 bg-neon-teal/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                      <span class="material-symbols-rounded text-3xl relative z-10">account_balance_wallet</span>
                  </div>
                  <span class="text-[10px] font-mono font-bold text-slate-400 tracking-wider">KAS</span>
              </div>
              
              <div onclick="playSound('click'); openArisanUI()" class="flex flex-col items-center gap-3 cursor-pointer btn-cyber group">
                  <div class="w-18 h-18 p-5 bg-void-light rounded-[1.5rem] border border-neon-purple/20 flex items-center justify-center text-neon-purple group-hover:border-neon-purple/60 group-hover:shadow-[0_0_15px_rgba(168,85,247,0.3)] transition-all relative overflow-hidden">
                      <div class="absolute inset-0 bg-neon-purple/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                      <span class="material-symbols-rounded text-3xl relative z-10">casino</span>
                  </div>
                  <span class="text-[10px] font-mono font-bold text-slate-400 tracking-wider">ARISAN</span>
              </div>
              
              <div onclick="playSound('click'); switchView('anggota')" class="flex flex-col items-center gap-3 cursor-pointer btn-cyber group">
                  <div class="w-18 h-18 p-5 bg-void-light rounded-[1.5rem] border border-neon-teal/20 flex items-center justify-center text-neon-teal group-hover:border-neon-teal/60 group-hover:shadow-[0_0_15px_rgba(45,212,191,0.3)] transition-all relative overflow-hidden">
                      <div class="absolute inset-0 bg-neon-teal/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                      <span class="material-symbols-rounded text-3xl relative z-10">groups</span>
                  </div>
                  <span class="text-[10px] font-mono font-bold text-slate-400 tracking-wider">GRUP</span>
              </div>
          </div>

          <div class="mb-8">
              <h3 class="text-xs font-mono font-bold text-slate-500 uppercase tracking-widest mb-4 px-2 flex items-center gap-2">
                  <span class="material-symbols-rounded text-base text-neon-purple">terminal</span> SYSTEM LOG
              </h3>
              <div id="homeNotice" class="bg-void-light p-6 rounded-[1.5rem] border border-white/5 shadow-sm text-sm text-neon-teal/80 font-mono leading-relaxed relative overflow-hidden">
                  <div class="absolute left-0 top-0 bottom-0 w-1 bg-neon-purple/50"></div>
                  <span class="text-neon-purple mr-2">root@karteji:~$</span> <span class="italic opacity-70">No new system messages.</span>
              </div>
          </div>
      </section>

      <section id="view-kas" class="view-section">
          <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="font-display text-3xl font-black text-white uppercase tracking-wide text-glow">Keuangan</h2>
                <p class="text-xs font-mono text-neon-teal/70 mt-1 tracking-widest">// DATA TRANSPARANSI</p>
            </div>
          </div>
          
          <div class="flex p-1.5 bg-void-light rounded-2xl mb-8 border border-white/5">
              <button onclick="filterFinance('all')" id="tab-all" class="flex-1 py-3 rounded-xl text-xs font-bold font-mono uppercase tracking-wider transition-all bg-neon-teal text-void shadow-[0_0_15px_rgba(45,212,191,0.3)]">Semua</button>
              <button onclick="filterFinance('income')" id="tab-income" class="flex-1 py-3 rounded-xl text-xs font-bold font-mono uppercase tracking-wider text-slate-500 transition-all hover:text-white">Masuk</button>
              <button onclick="filterFinance('expense')" id="tab-expense" class="flex-1 py-3 rounded-xl text-xs font-bold font-mono uppercase tracking-wider text-slate-500 transition-all hover:text-white">Keluar</button>
          </div>

          <div id="finList" class="space-y-4 pb-28"></div>
          
          <button id="fabFinance" onclick="openFinanceModal()" class="fixed bottom-32 right-8 w-16 h-16 bg-neon-teal text-void rounded-full flex items-center justify-center shadow-[0_0_30px_rgba(45,212,191,0.5)] btn-cyber hidden z-40 border-2 border-white/20"><span class="material-symbols-rounded text-3xl">add</span></button>
      </section>

      <section id="view-kegiatan" class="view-section">
          <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="font-display text-3xl font-black text-white uppercase tracking-wide text-glow">Agenda</h2>
                <p class="text-xs font-mono text-neon-teal/70 mt-1 tracking-widest">// JADWAL OPERASIONAL</p>
            </div>
          </div>
          <div id="actList" class="space-y-5 pb-28"></div>
          <button id="fabEvent" onclick="openEventModal()" class="fixed bottom-32 right-8 w-16 h-16 bg-neon-teal text-void rounded-full flex items-center justify-center shadow-[0_0_30px_rgba(45,212,191,0.5)] btn-cyber hidden z-40 border-2 border-white/20"><span class="material-symbols-rounded text-3xl">add</span></button>
      </section>

      <section id="view-anggota" class="view-section">
          <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="font-display text-3xl font-black text-white uppercase tracking-wide text-glow">Direktori</h2>
                <p class="text-xs font-mono text-neon-teal/70 mt-1 tracking-widest">// DATABASE UNIT</p>
            </div>
            <span id="memberCount" class="bg-void-light border border-neon-teal/30 text-neon-teal px-4 py-2 rounded-xl font-mono font-bold text-sm shadow-[0_0_10px_rgba(45,212,191,0.2)]">0 UNIT</span>
          </div>
          <div class="relative mb-8 group">
              <span class="material-symbols-rounded absolute top-4 left-5 text-slate-500 group-focus-within:text-neon-teal transition-colors">search</span>
              <input type="text" onkeyup="searchMember(this.value)" placeholder="Cari data unit..." class="w-full pl-14 pr-6 py-4 bg-void-light rounded-2xl text-sm font-bold border border-white/10 outline-none text-white placeholder-slate-600 focus:border-neon-teal/50 focus:shadow-[0_0_15px_rgba(45,212,191,0.2)] transition-all font-mono">
          </div>
          <div id="userList" class="grid grid-cols-1 gap-4 pb-28"></div>
      </section>

      <section id="view-profile" class="view-section">
          <div class="flex flex-col items-center pt-6">
              <div class="relative mb-8 group cursor-pointer btn-cyber" onclick="playSound('click'); $('profileUpload').click()">
                  <div class="absolute -inset-3 bg-gradient-to-tr from-neon-teal to-neon-purple rounded-full opacity-30 blur-xl animate-pulse-slow"></div>
                  <div class="relative w-36 h-36 p-1 bg-void-light rounded-full border-2 border-neon-teal/30 overflow-hidden">
                      <img id="profileImage" src="https://via.placeholder.com/150" class="w-full h-full rounded-full object-cover filter contrast-110">
                      <div class="absolute inset-0 bg-gradient-to-b from-transparent via-neon-teal/20 to-transparent h-[200%] w-full animate-[spin_4s_linear_infinite_reverse] opacity-50" style="animation-play-state: paused;"></div>
                  </div>
                  <div class="absolute bottom-0 right-0 w-12 h-12 bg-void-light text-neon-teal rounded-full flex items-center justify-center border-2 border-neon-teal/50 shadow-[0_0_10px_rgba(45,212,191,0.3)]"><span class="material-symbols-rounded">edit</span></div>
              </div>
              <input type="file" id="profileUpload" class="hidden" accept="image/*" onchange="previewProfileImage(this)">
              
              <h2 id="profileNameDisplay" class="font-display text-3xl font-black text-white uppercase tracking-wide text-glow text-center mb-2">...</h2>
              
              <div class="flex flex-wrap justify-center gap-3 mb-10">
                <span id="profileRoleDisplay" class="text-[10px] font-mono font-bold text-void uppercase tracking-widest bg-neon-teal px-4 py-2 rounded-lg shadow-[0_0_10px_rgba(45,212,191,0.3)]">...</span>
                <button onclick="copyID()" class="text-[10px] font-mono font-bold text-neon-purple uppercase tracking-widest bg-void-light border border-neon-purple/30 px-4 py-2 rounded-lg active:bg-neon-purple/20 transition-all flex items-center gap-2">ID: <span id="idDisplay">...</span> <span class="material-symbols-rounded text-sm">content_copy</span></button>
              </div>
              
              <div class="grid grid-cols-2 gap-5 w-full mb-10">
                  <button onclick="showIdCard()" class="bg-void-light p-6 rounded-[2rem] border border-neon-teal/20 flex flex-col items-center gap-3 btn-cyber group hover:border-neon-teal/50 hover:shadow-[0_0_20px_rgba(45,212,191,0.2)] transition-all relative overflow-hidden">
                      <div class="absolute inset-0 bg-neon-teal/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                      <span class="material-symbols-rounded text-4xl text-neon-teal relative z-10">badge</span>
                      <span class="text-xs font-mono font-bold text-slate-300 tracking-wider relative z-10">DIGITAL ID</span>
                  </button>
                  <button onclick="showQR()" class="bg-void-light p-6 rounded-[2rem] border border-neon-purple/20 flex flex-col items-center gap-3 btn-cyber group hover:border-neon-purple/50 hover:shadow-[0_0_20px_rgba(168,85,247,0.2)] transition-all relative overflow-hidden">
                      <div class="absolute inset-0 bg-neon-purple/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                      <span class="material-symbols-rounded text-4xl text-neon-purple relative z-10">qr_code_scanner</span>
                      <span class="text-xs font-mono font-bold text-slate-300 tracking-wider relative z-10">ACCESS QR</span>
                  </button>
              </div>

              <div class="w-full bg-void-light p-8 rounded-[2.5rem] border border-white/5 shadow-sm space-y-6 relative overflow-hidden">
                  <div class="absolute top-0 left-0 w-6 h-6 border-t-2 border-l-2 border-neon-teal/30 rounded-tl-2xl"></div>
                  <div class="absolute bottom-0 right-0 w-6 h-6 border-b-2 border-r-2 border-neon-purple/30 rounded-br-2xl"></div>

                  <div>
                      <label class="text-[10px] font-mono font-bold text-slate-500 uppercase tracking-wider ml-2 mb-2 block">Nama Lengkap</label>
                      <input id="editName" class="w-full p-5 bg-void rounded-2xl text-sm font-bold border-2 border-white/5 outline-none focus:border-neon-teal/50 focus:shadow-[0_0_15px_rgba(45,212,191,0.1)] transition-all text-white font-mono">
                  </div>
                  <div>
                      <label class="text-[10px] font-mono font-bold text-slate-500 uppercase tracking-wider ml-2 mb-2 block">WhatsApp Comms</label>
                      <input id="editPhone" type="tel" class="w-full p-5 bg-void rounded-2xl text-sm font-bold border-2 border-white/5 outline-none focus:border-neon-teal/50 focus:shadow-[0_0_15px_rgba(45,212,191,0.1)] transition-all text-white font-mono">
                  </div>
                  <div>
                      <label class="text-[10px] font-mono font-bold text-slate-500 uppercase tracking-wider ml-2 mb-2 block">Base Alamat</label>
                      <textarea id="editAddress" rows="2" class="w-full p-5 bg-void rounded-2xl text-sm font-medium border-2 border-white/5 outline-none focus:border-neon-teal/50 focus:shadow-[0_0_15px_rgba(45,212,191,0.1)] transition-all text-white font-mono resize-none"></textarea>
                  </div>
                  
                  <div class="pt-4 flex flex-col gap-4">
                      <button onclick="saveProfile()" class="w-full bg-gradient-to-r from-neon-teal to-neon-teal/80 text-void py-5 rounded-2xl font-display font-black uppercase tracking-widest shadow-[0_0_25px_rgba(45,212,191,0.4)] btn-cyber border border-white/20">UPDATE DATA</button>
                      <button id="logoutBtn" class="w-full text-rose-500 py-5 text-xs font-mono font-bold border-2 border-rose-500/20 hover:bg-rose-500/10 hover:border-rose-500/50 rounded-2xl transition-all flex items-center justify-center gap-3 uppercase tracking-widest btn-cyber"><span class="material-symbols-rounded text-lg">power_settings_new</span> TERMINATE SESSION</button>
                  </div>
              </div>
          </div>
      </section>

  </main>

  <nav class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 w-full max-w-md px-6">
      <div class="neon-glass rounded-full p-2 flex justify-between items-center relative overflow-hidden">
          <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-3/4 h-[2px] bg-gradient-to-r from-transparent via-neon-teal/50 to-transparent blur-sm"></div>

          <button onclick="playSound('click'); switchView('home')" class="nav-btn active flex-1 h-16 flex flex-col items-center justify-center gap-1 transition-all group relative" data-target="home">
              <div class="icon-box w-12 h-8 rounded-full flex items-center justify-center transition-all text-slate-500 group-hover:text-neon-teal"><span class="material-symbols-rounded text-2xl">grid_view</span></div>
              <p class="text-[9px] font-mono font-bold text-slate-500 transition-colors uppercase tracking-widest">Home</p>
          </button>
          
          <button onclick="playSound('click'); switchView('kegiatan')" class="nav-btn flex-1 h-16 flex flex-col items-center justify-center gap-1 transition-all group relative" data-target="kegiatan">
              <div class="icon-box w-12 h-8 rounded-full flex items-center justify-center transition-all text-slate-500 group-hover:text-neon-teal"><span class="material-symbols-rounded text-2xl">deployed_code</span></div>
              <p class="text-[9px] font-mono font-bold text-slate-500 transition-colors uppercase tracking-widest">Acara</p>
          </button>
          
          <button onclick="playSound('click'); openArisanUI()" class="w-14 h-14 -mt-8 bg-void rounded-full border-2 border-neon-purple/50 flex items-center justify-center text-neon-purple shadow-[0_0_20px_rgba(168,85,247,0.4)] btn-cyber relative z-10 group overflow-hidden mx-1">
              <div class="absolute inset-0 bg-neon-purple/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
              <span class="material-symbols-rounded text-3xl relative z-10 group-hover:rotate-180 transition-transform duration-500">casino</span>
          </button>

          <button onclick="playSound('click'); switchView('kas')" class="nav-btn flex-1 h-16 flex flex-col items-center justify-center gap-1 transition-all group relative" data-target="kas">
              <div class="icon-box w-12 h-8 rounded-full flex items-center justify-center transition-all text-slate-500 group-hover:text-neon-teal"><span class="material-symbols-rounded text-2xl">account_balance_wallet</span></div>
              <p class="text-[9px] font-mono font-bold text-slate-500 transition-colors uppercase tracking-widest">Kas</p>
          </button>
          
          <button onclick="playSound('click'); switchView('profile')" class="nav-btn flex-1 h-16 flex flex-col items-center justify-center gap-1 transition-all group relative" data-target="profile">
              <div class="icon-box w-12 h-8 rounded-full flex items-center justify-center transition-all text-slate-500 group-hover:text-neon-teal"><span class="material-symbols-rounded text-2xl">person_filled</span></div>
              <p class="text-[9px] font-mono font-bold text-slate-500 transition-colors uppercase tracking-widest">Saya</p>
          </button>
      </div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, deleteDoc, getDocs, query, orderBy, limit, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs", authDomain: "katar-9cac3.firebaseapp.com", projectId: "katar-9cac3", storageBucket: "katar-9cac3.firebasestorage.app", messagingSenderId: "1017734829960", appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); const CLOUD_NAME = "dbxktcwug"; const PRESET = "Karteji";

    window.$ = (id) => document.getElementById(id);
    let UID, ROLE, ME_DATA;
    let allFinData = [], allMembers = [];
    let isPrivacyMode = false;
    let candidates = [], tempWinner = null;
    const sfxClick=$('sfxClick'), sfxSuccess=$('sfxWin'), sfxShuffle=$('sfxShuffle');

    const PERMISSIONS = {
        'super_admin': { label:'Super Admin', canEditMoney:true, canEditEvent:true, canManageUser:true, canArisan:true, level:99 },
        'ketua':       { label:'Ketua Umum',  canEditMoney:true, canEditEvent:true, canManageUser:true, canArisan:true, level:50 },
        'wakil_ketua': { label:'Wakil Ketua', canEditMoney:false,canEditEvent:true, canManageUser:false,canArisan:true, level:40 },
        'bendahara':   { label:'Bendahara',   canEditMoney:true, canEditEvent:false,canManageUser:false,canArisan:true, level:30 },
        'koordinator': { label:'Koordinator', canEditMoney:false,canEditEvent:true, canManageUser:false,canArisan:true, level:30 },
        'sekretaris':  { label:'Sekretaris',  canEditMoney:false,canEditEvent:false,canManageUser:false,canArisan:false,level:30 },
        'anggota':     { label:'Anggota',     canEditMoney:false,canEditEvent:false,canManageUser:false,canArisan:false,level:10 }
    };

    window.toggleLoader=(s)=>$('globalLoader').style.display=s?'flex':'none';
    window.playSound=(t)=>{try{if(t==='click')sfxClick.play();else if(t==='win')sfxSuccess.play();}catch(e){}};
    window.vibrate=()=>{if(navigator.vibrate)navigator.vibrate(50)};
    // Toast Cyber Style
    window.showToast=(m,t='s')=>{const d=document.createElement('div');d.className=`${t==='e'?'bg-rose-900/80 border-rose-500/50 text-rose-200':'bg-void-light/90 border-neon-teal/50 text-neon-teal'} backdrop-blur-md border px-6 py-4 rounded-xl shadow-[0_0_20px_rgba(0,0,0,0.5)] fixed top-8 z-[120] text-sm font-mono font-bold animate-popup flex items-center gap-3 tracking-wider`;d.innerHTML=`<span class="material-symbols-rounded text-lg">${t==='e'?'error':'terminal'}</span>${m}`;$('toastContainer').appendChild(d);setTimeout(()=>d.remove(),3000)};
    
    window.togglePrivacy=()=>{isPrivacyMode=!isPrivacyMode;$('privacyIcon').innerText=isPrivacyMode?'visibility_off':'visibility';renderBalance()};
    window.copyID=()=>{navigator.clipboard.writeText(UID);showToast("ID TERSALIN KE CLIPBOARD");vibrate()};
    window.showQR=()=>{showModal("AKSES QR",`<div class='flex justify-center p-6 bg-white rounded-3xl border-4 border-neon-purple/50 shadow-[0_0_30px_rgba(168,85,247,0.3)]'><img src='https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${UID}' class='rounded-xl mix-blend-multiply'></div>`)};
    window.closeModal=()=>$('crudModal').classList.add('hidden');
    window.showModal=(t,b,f)=>{$('modalTitle').innerText=t;$('modalBody').innerHTML=b;$('crudModal').classList.remove('hidden');if(f){$('modalSubmitBtn').style.display='block';$('modalSubmitBtn').onclick=f}else{$('modalSubmitBtn').style.display='none'}};
    window.switchView=(v)=>{
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));$(`view-${v}`).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        const btn=document.querySelector(`.nav-btn[data-target="${v}"]`);if(btn)btn.classList.add('active');
        if(v==='profile')loadProfile();
    };

    onAuthStateChanged(auth, async user => {
        if(!user) return $('gate').classList.remove('hidden');
        UID = user.uid;
        onSnapshot(doc(db,"users",UID),(s)=>{if(s.exists()){ME_DATA=s.data();ROLE=ME_DATA.role||'anggota';setupUI();loadData()}});
        toggleLoader(false);
    });

    function setupUI(){
        const p=PERMISSIONS[ROLE]||PERMISSIONS['anggota'];
        $('headerName').innerText=ME_DATA.name; $('headerPhoto').src=ME_DATA.photo?.url||"https://via.placeholder.com/100"; $('idDisplay').innerText=UID.substring(0,6).toUpperCase();
        p.canEditMoney?$('fabFinance').classList.remove('hidden'):$('fabFinance').classList.add('hidden');
        p.canEditEvent?$('fabEvent').classList.remove('hidden'):$('fabEvent').classList.add('hidden');
    }

    function loadData(){
        const p=PERMISSIONS[ROLE]||PERMISSIONS['anggota'];
        // Finance
        onSnapshot(query(collection(db,"financial_records"),orderBy("createdAt","desc")),(snap)=>{
            allFinData=[];let bal=0,inc=0,exp=0;
            snap.forEach(d=>{const f=d.data();if(f.status==='approved'){const a=Number(f.amount);if(f.type==='income'){bal+=a;inc+=a}else{bal-=a;exp+=a}allFinData.push(f)}});
            window.balanceData={bal,inc,exp}; renderBalance(); filterFinance('all');
        });
        // Events
        onSnapshot(query(collection(db,"activities"),orderBy("date","asc")),(snap)=>{
            $('actList').innerHTML="";
            snap.forEach(d=>{const e=d.data();const del=p.canEditEvent?`<button onclick="delDoc('activities','${d.id}')" class="w-10 h-10 bg-void-light text-rose-500 rounded-full flex items-center justify-center hover:bg-rose-500/20 transition-all border border-rose-500/30"><span class="material-symbols-rounded text-lg">delete</span></button>`:'';
                $('actList').innerHTML+=`<div class="bg-void-light p-5 rounded-[1.5rem] border border-white/5 flex justify-between items-start hover:border-neon-teal/30 transition-all relative overflow-hidden group"><div class="absolute inset-0 bg-neon-teal/5 opacity-0 group-hover:opacity-100 transition-opacity"></div><div class="relative z-10"><span class="text-[10px] bg-neon-teal/10 text-neon-teal px-3 py-1.5 rounded-lg font-mono font-bold uppercase tracking-widest border border-neon-teal/30">${e.date}</span><h4 class="text-lg font-display font-black text-white mt-3 leading-tight tracking-wide">${e.title}</h4><p class="text-xs text-slate-400 mt-1 flex items-center gap-1 font-mono"><span class="material-symbols-rounded text-sm text-neon-teal">location_on</span> ${e.location}</p></div>${del}</div>`});
            if(snap.empty)$('actList').innerHTML=`<div class="text-center py-12 opacity-50 font-mono"><span class="material-symbols-rounded text-5xl mb-4 text-neon-teal/50 animate-pulse-slow">event_busy</span><p class="text-sm text-neon-teal uppercase tracking-widest">NO DATA FOUND</p></div>`;
        });
        // Members
        onSnapshot(query(collection(db,"users"),orderBy("name")),(snap)=>{
            $('userList').innerHTML=""; $('memberCount').innerText=snap.size + " UNIT"; allMembers=[];
            snap.forEach(d=>{const u=d.data(); allMembers.push(u);
                const tRole=u.role||'anggota'; const tPerm=PERMISSIONS[tRole]||PERMISSIONS['anggota'];
                let opts = ''; if(ROLE==='super_admin'){opts+=`<option value="super_admin" ${tRole==='super_admin'?'sel':''}>Super Admin</option><option value="ketua" ${tRole==='ketua'?'sel':''}>Ketua</option>`}
                opts+=`<option value="wakil_ketua" ${tRole==='wakil_ketua'?'sel':''}>Wakil</option><option value="sekretaris" ${tRole==='sekretaris'?'sel':''}>Sekretaris</option><option value="bendahara" ${tRole==='bendahara'?'sel':''}>Bendahara</option><option value="koordinator" ${tRole==='koordinator'?'sel':''}>Koord</option><option value="anggota" ${tRole==='anggota'?'sel':''}>Anggota</option>`;
                opts = opts.replace(/sel/g, 'selected');
                let canEdit=false; if(ROLE==='super_admin') canEdit=true; if(ROLE==='ketua' && tRole!=='super_admin' && d.id!==UID) canEdit=true;
                const ctrl = canEdit ? `<select onchange="updRole('${d.id}',this.value)" class="text-[10px] bg-void border border-white/20 p-2.5 rounded-xl font-mono font-bold text-neon-teal outline-none cursor-pointer focus:border-neon-teal/50 focus:shadow-[0_0_10px_rgba(45,212,191,0.3)] transition-all uppercase tracking-wider">${opts}</select>` : `<span class="text-[10px] text-slate-400 bg-void-light border border-white/10 px-3 py-1.5 rounded-lg font-mono font-bold uppercase tracking-wider">${tPerm.label}</span>`;
                $('userList').innerHTML+=`<div class="bg-void-light p-4 rounded-[1.5rem] border border-white/5 flex justify-between items-center hover:border-neon-purple/30 transition-all group relative overflow-hidden"><div class="absolute inset-0 bg-neon-purple/5 opacity-0 group-hover:opacity-100 transition-opacity"></div><div class="flex items-center gap-4 relative z-10"><img src="${u.photo?.url||'https://via.placeholder.com/100'}" class="w-14 h-14 rounded-xl object-cover bg-void border-2 border-white/10 group-hover:border-neon-purple/50 transition-all"><div><p class="text-sm font-display font-black text-white tracking-wide">${u.name}</p><a href="https://wa.me/${u.phone}" target="_blank" class="text-[10px] text-neon-purple font-mono font-bold flex items-center gap-1 mt-1 hover:underline decoration-neon-purple/50 tracking-wider"><span class="material-symbols-rounded text-sm">chat</span> COMMS LINK</a></div></div>${ctrl}</div>`;
            });
        });
        // Arisan
        onSnapshot(query(collection(db,"arisan_history"),orderBy("createdAt","desc")),(s)=>{
            if(!s.empty){const w=s.docs[0].data();$('arisanWidget').classList.remove('hidden');$('arisanName').innerText=w.name;if(w.photo)$('arisanPhoto').src=w.photo}else{$('arisanWidget').classList.add('hidden')}
        });
        // Notice
        onSnapshot(query(collection(db,"notifications"),orderBy("createdAt","desc"),limit(1)),s=>{
            if(!s.empty){ $('homeNotice').innerHTML = `<span class="text-neon-purple mr-2">root@karteji:~$</span> <span class="italic text-white">${s.docs[0].data().body}</span>`; }
        });
    }

    function renderBalance(){const d=window.balanceData||{bal:0,inc:0,exp:0};if(isPrivacyMode){$('cardBalance').innerText="Rp â€¢â€¢â€¢â€¢â€¢â€¢XXXX";$('cardIncome').innerText="â€¢â€¢â€¢â€¢";$('cardExpense').innerText="â€¢â€¢â€¢â€¢";$('cardBalance').classList.add('blur-sm')}else{$('cardBalance').innerText="Rp "+d.bal.toLocaleString('id-ID');$('cardIncome').innerText="Rp "+d.inc.toLocaleString('id-ID');$('cardExpense').innerText="Rp "+d.exp.toLocaleString('id-ID');$('cardBalance').classList.remove('blur-sm')}}
    window.filterFinance=(t)=>{
        const l=$('finList');l.innerHTML="";
        ['all','income','expense'].forEach(k=>{const btn=$(`tab-${k}`);if(k===t){btn.className="flex-1 py-3 rounded-xl text-xs font-bold font-mono uppercase tracking-wider transition-all bg-neon-teal text-void shadow-[0_0_15px_rgba(45,212,191,0.3)]"}else{btn.className="flex-1 py-3 rounded-xl text-xs font-bold font-mono uppercase tracking-wider text-slate-500 transition-all hover:text-white"}});
        const data=t==='all'?allFinData:allFinData.filter(x=>x.type===t);
        if(data.length===0)l.innerHTML='<div class="text-center py-12 opacity-50 font-mono"><span class="material-symbols-rounded text-5xl mb-4 text-neon-teal/50 animate-pulse-slow">receipt_long</span><p class="text-sm text-neon-teal uppercase tracking-widest">NO TRANSACTIONS</p></div>';
        data.forEach(f=>{const isIn=f.type==='income';l.innerHTML+=`<div class="bg-void-light p-5 rounded-[1.5rem] border border-white/5 flex justify-between items-center hover:border-white/20 transition-all"><div class="flex gap-4 items-center"><div class="w-12 h-12 rounded-xl ${isIn?'bg-emerald-500/10 text-emerald-500 border-emerald-500/30':'bg-rose-500/10 text-rose-500 border-rose-500/30'} border flex items-center justify-center"><span class="material-symbols-rounded text-xl">${isIn?'arrow_downward':'arrow_upward'}</span></div><div><p class="text-sm font-display font-bold text-white line-clamp-1 tracking-wide">${f.note}</p><p class="text-[10px] text-slate-400 font-mono font-medium mt-1">${new Date(f.createdAt?.seconds*1000).toLocaleDateString()} // ${new Date(f.createdAt?.seconds*1000).toLocaleTimeString().slice(0,5)}</p></div></div><span class="text-sm font-mono font-bold ${isIn?'text-emerald-400':'text-rose-400'}">${isIn?'+':'-'} ${Number(f.amount).toLocaleString()}</span></div>`});
    }

    window.openArisanUI=()=>{ $('arisanOverlay').classList.remove('hidden');$('arisanOverlay').classList.add('flex');candidates=allMembers;$('shufflerImg').src="https://via.placeholder.com/150";$('shufflerName').innerText="SYSTEM READY";$('winnerActions').classList.add('hidden');$('btnSpin').classList.remove('hidden') };
    window.closeArisan=()=>{$('arisanOverlay').classList.add('hidden');try{sfxShuffle.pause()}catch(e){}};
    window.spinArisan=()=>{
        if(candidates.length<2)return showToast("ERROR: INSUFFICIENT_DATA","e");
        vibrate();try{sfxShuffle.currentTime=0;sfxShuffle.play()}catch(e){}$('btnSpin').classList.add('hidden');$('winnerActions').classList.add('hidden');
        let dur=4000,start=null;
        function anim(t){
            if(!start)start=t;const p=t-start;const r=Math.floor(Math.random()*candidates.length);
            $('shufflerName').innerText=candidates[r].name;$('shufflerImg').src=candidates[r].photo?.url||"https://via.placeholder.com/150";$('shufflerImg').classList.remove('opacity-40','mix-blend-luminosity');
            if(p<dur)requestAnimationFrame(anim);
            else{
                tempWinner=candidates[Math.floor(Math.random()*candidates.length)];
                $('shufflerName').innerText=tempWinner.name;$('shufflerImg').src=tempWinner.photo?.url;
                try{sfxShuffle.pause();sfx.win.play()}catch(e){}confetti({particleCount:150,spread:70,origin:{y:0.6},colors:['#2DD4BF','#A855F7']});
                $('winnerActions').classList.remove('hidden');$('winnerActions').classList.add('flex');$('shufflerIcon').classList.remove('animate-pulse');
            }
        }requestAnimationFrame(anim);$('shufflerIcon').classList.add('animate-pulse');
    }
    window.saveWinner=async()=>{if(tempWinner){toggleLoader(true);await addDoc(collection(db,"arisan_history"),{name:tempWinner.name,photo:tempWinner.photo?.url,uid:tempWinner.id,createdAt:serverTimestamp()});closeArisan();showToast("DATA DIKONFIRMASI");toggleLoader(false)}}

    window.openFinanceModal=()=>showModal('INPUT KAS',`<select id="fT" class="w-full p-5 bg-void rounded-2xl mb-4 font-mono font-bold border-2 border-white/10 outline-none text-white focus:border-neon-teal/50 transition-all uppercase tracking-wider cursor-pointer"><option value="income">Pemasukan (+)</option><option value="expense">Pengeluaran (-)</option></select><input id="fA" type="number" class="w-full p-5 bg-void rounded-2xl mb-4 border-2 border-white/10 font-mono font-bold outline-none text-white text-xl focus:border-neon-teal/50 transition-all" placeholder="0.00"><input id="fN" class="w-full p-5 bg-void rounded-2xl mb-4 border-2 border-white/10 font-mono text-sm outline-none text-white focus:border-neon-teal/50 transition-all" placeholder="Keterangan Transaksi...">`,async()=>{if(!$('fA').value)return showToast("NOMINAL NULL","e");toggleLoader(true);try{await addDoc(collection(db,"financial_records"),{type:$('fT').value,amount:$('fA').value,note:$('fN').value,status:'approved',createdAt:serverTimestamp()});closeModal();showToast("TRANSAKSI TERCATAT");playSound('click')}catch(e){showToast("SYSTEM ERROR","e")}finally{toggleLoader(false)}});
    window.openEventModal=()=>showModal('AGENDA BARU',`<input id="eT" class="w-full p-5 bg-void rounded-2xl mb-4 font-display font-bold border-2 border-white/10 outline-none text-white focus:border-neon-teal/50 transition-all tracking-wide" placeholder="NAMA ACARA"><input id="eD" type="date" class="w-full p-5 bg-void rounded-2xl mb-4 border-2 border-white/10 font-mono font-bold outline-none text-white focus:border-neon-teal/50 transition-all uppercase"><input id="eL" class="w-full p-5 bg-void rounded-2xl mb-4 border-2 border-white/10 font-mono font-bold outline-none text-white focus:border-neon-teal/50 transition-all uppercase tracking-wide" placeholder="LOKASI">`,async()=>{if(!$('eT').value)return showToast("JUDUL NULL","e");toggleLoader(true);try{await addDoc(collection(db,"activities"),{title:$('eT').value,date:$('eD').value,location:$('eL').value,status:'approved',createdAt:serverTimestamp()});closeModal();showToast("JADWAL DIBUAT");playSound('click')}catch(e){showToast("SYSTEM ERROR","e")}finally{toggleLoader(false)}});
    window.updRole=async(i,r)=>{if(confirm("KONFIRMASI PERUBAHAN HAK AKSES?"))await updateDoc(doc(db,"users",i),{role:r})};
    window.delDoc=async(c,i)=>{if(confirm("HAPUS DATA PERMANEN?"))await deleteDoc(doc(db,c,i))};

    window.loadProfile=()=>{const p=PERMISSIONS[ROLE]||PERMISSIONS['anggota'];$('profileImage').src=ME_DATA.photo?.url||"https://via.placeholder.com/150";$('profileNameDisplay').innerText=ME_DATA.name;$('profileRoleDisplay').innerText=p.label;$('editName').value=ME_DATA.name||"";$('editPhone').value=ME_DATA.phone||"";$('editAddress').value=ME_DATA.address||""};
    window.showIdCard=()=>{const p=PERMISSIONS[ROLE]||PERMISSIONS['anggota'];showModal("DIGITAL ACCESS ID",`<div class="cyber-card p-6 rounded-[2rem] relative overflow-hidden shadow-[0_0_40px_rgba(45,212,191,0.2)] border border-neon-teal/30"><div class="absolute top-0 left-0 w-full h-full bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxjaXJjbGUgY3g9IjIwIiBjeT0iMjAiIHI9IjEiIGZpbGw9IiMyREQ0QkYiIGZpbGwtb3BhY2l0eT0iMC4yIi8+PC9nPjwvc3ZnPg==')] opacity-50"></div><div class="flex gap-5 items-center relative z-10"><img src="${ME_DATA.photo?.url||'https://via.placeholder.com/100'}" class="w-24 h-24 rounded-2xl border-2 border-neon-teal/50 bg-void object-cover shadow-[0_0_15px_rgba(45,212,191,0.3)]"><div><h2 class="text-2xl font-display font-black leading-none mb-3 text-white tracking-wide text-glow">${ME_DATA.name}</h2><span class="text-[10px] bg-neon-teal/20 border border-neon-teal/50 px-4 py-2 rounded-lg font-mono font-bold uppercase tracking-widest text-neon-teal">${p.label}</span></div></div><div class="mt-8 pt-6 border-t border-white/10 flex justify-between items-center"><span class="text-[10px] text-neon-teal/70 font-mono font-bold uppercase tracking-widest">UNIT ID CODE</span><span class="text-sm font-mono font-bold text-white tracking-widest">${UID.substring(0,8).toUpperCase()}</span></div><div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-neon-teal via-neon-purple to-neon-teal animate-pulse-slow"></div></div>`)};
    let newFile=null;window.previewProfileImage=(i)=>{if(i.files[0]){newFile=i.files[0];$('profileImage').src=URL.createObjectURL(newFile)}};
    async function upload(f){const fd=new FormData();fd.append("file",f);fd.append("upload_preset",PRESET);try{const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:"POST",body:fd});const j=await r.json();return {url:j.secure_url}}catch(e){return null}}
    window.saveProfile=async()=>{toggleLoader(true);try{let d={name:$('editName').value,phone:$('editPhone').value,address:$('editAddress').value};if(newFile){const u=await upload(newFile);if(u)d.photo=u}await updateDoc(doc(db,"users",UID),d);showToast("DATABASE UPDATED");playSound('click')}catch(e){showToast("UPLOAD FAILED","e")}finally{toggleLoader(false)}};
    
    $('logoutBtn').onclick=()=>signOut(auth).then(()=>location.href="login.html");
  </script>
</body>
</html>
