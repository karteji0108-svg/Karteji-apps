// ====== Feature HTML blocks (ringkas & siap pakai) ======
const helpHTML = () => `
  <div class="text-sm text-slate-600 dark:text-slate-200 space-y-2">
    <p class="font-bold">Panduan cepat:</p>
    <ul class="list-disc pl-5 text-xs space-y-1">
      <li>Gunakan menu cepat untuk akses fitur role.</li>
      <li>Kas: Bendahara input, Ketua/Super Admin ACC.</li>
      <li>Arsip Surat: Sekretaris mengelola dokumen.</li>
      <li>Aset: Wakil Ketua mengelola inventaris.</li>
    </ul>
    <p class="text-[11px] text-slate-400">Versi: v1.0 (role-based dashboard)</p>
  </div>
`;

const settingsHTML = () => `
  <div class="space-y-3">
    <div>
      <label class="text-[10px] font-bold text-slate-400 ml-1 uppercase">Nama Organisasi</label>
      <input id="setOrgName" class="input-field" placeholder="KARTEJI / Karang Taruna ...">
    </div>
    <div>
      <label class="text-[10px] font-bold text-slate-400 ml-1 uppercase">WA Admin</label>
      <input id="setAdminWA" class="input-field" placeholder="08xxxxxxxxxx">
    </div>
    <div>
      <label class="text-[10px] font-bold text-slate-400 ml-1 uppercase">Mode</label>
      <select id="setMode" class="input-field">
        <option value="normal">Normal</option>
        <option value="maintenance">Maintenance</option>
      </select>
    </div>
    <p class="text-xs text-slate-400">Catatan: ini disimpan ke koleksi <b>app_settings</b>.</p>
  </div>
`;

async function saveSettings() {
  toggleLoader(true, "MENYIMPAN...");
  try {
    await updateDoc(doc(db, "app_settings", "main"), {
      orgName: $("setOrgName").value,
      adminWA: $("setAdminWA").value,
      mode: $("setMode").value,
      updatedAt: serverTimestamp(),
      updatedBy: ME.uid,
    });
    await auditLog("SETTINGS_UPDATE", "Update app_settings/main");
    closeModal();
    alert("Settings tersimpan.");
  } catch(e) {
    alert("Gagal simpan settings.");
  }
  toggleLoader(false);
}

const cleanupHTML = () => `
  <div class="space-y-3 text-sm text-slate-600 dark:text-slate-200">
    <p class="font-bold">Data Cleanup (aman)</p>
    <p class="text-xs text-slate-400">Contoh aksi: hapus audit log lama (stub). Bisa kamu lanjutkan sesuai kebutuhan.</p>
    <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl">
      ${badge("Stub", "bg-orange-100 text-orange-700")}
      <p class="text-xs mt-2">Klik SIMPAN untuk jalankan contoh cleanup.</p>
    </div>
  </div>
`;

async function doCleanup() {
  // Stub: kamu bisa bikin query audit_logs older_than, lalu delete batch via Cloud Function.
  await auditLog("CLEANUP_RUN", "Cleanup stub executed");
  closeModal();
  alert("Cleanup stub dijalankan (log tersimpan).");
}

const templateHubHTML = () => `
  <div class="space-y-3 text-sm">
    <p class="font-bold text-slate-700 dark:text-slate-200">Template Hub</p>
    <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl text-xs text-slate-600 dark:text-slate-200">
      <p>✅ Ide: Template surat, format notulen, format proposal kegiatan.</p>
      <p class="mt-2">${badge("Stub", "bg-orange-100 text-orange-700")} nanti bisa disimpan ke koleksi <b>templates</b>.</p>
    </div>
  </div>
`;

const analyticsHTML = () => `
  <div class="text-xs text-slate-600 dark:text-slate-200 space-y-2">
    <p class="font-bold">Analitik Ringkas</p>
    <p>Gunakan Chart di Home untuk kas masuk/keluar.</p>
    <p>${badge("Next", "bg-blue-100 text-blue-700")} Bisa tambah grafik bulanan (group by month).</p>
  </div>
`;

async function loadAuditLogsHTML() {
  const snap = await getDocs(query(collection(db, "audit_logs"), orderBy("time","desc"), limit(30)));
  let html = `<div class="space-y-2">`;
  snap.forEach(d => {
    const x = d.data();
    html += `
      <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl">
        <div class="flex items-center justify-between gap-2">
          <p class="text-xs font-bold text-slate-700 dark:text-white">${x.action || "-"}</p>
          ${badge((x.role||"-").replaceAll("_"," "), "bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-white")}
        </div>
        <p class="text-[11px] text-slate-500 dark:text-slate-200 mt-1">${x.desc || ""}</p>
        <p class="text-[10px] text-slate-400 mt-1">${x.actor || "-"} • ${dateID(x.time)}</p>
      </div>
    `;
  });
  html += `</div>`;
  return html;
}

async function loadSystemHealthHTML() {
  const users = await getCount("users");
  const fin = await getCount("financial_records");
  const act = await getCount("activities");
  const inv = await getCount("inventory");
  const letc = await getCount("letters");
  const notif = await getCount("notifications");
  return `
    <div class="grid grid-cols-2 gap-3 text-xs">
      <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl">${badge("Users")} <p class="text-lg font-black mt-1">${users}</p></div>
      <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl">${badge("Kas")} <p class="text-lg font-black mt-1">${fin}</p></div>
      <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl">${badge("Kegiatan")} <p class="text-lg font-black mt-1">${act}</p></div>
      <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl">${badge("Aset")} <p class="text-lg font-black mt-1">${inv}</p></div>
      <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl">${badge("Surat")} <p class="text-lg font-black mt-1">${letc}</p></div>
      <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl">${badge("Info")} <p class="text-lg font-black mt-1">${notif}</p></div>
    </div>
  `;
}

// ====== Approval Center (basic real) ======
async function loadApprovalCenterHTML() {
  // Pending finance
  const finSnap = await getDocs(query(collection(db,"financial_records"), where("status","==","pending"), orderBy("createdAt","desc"), limit(20)));
  let finHTML = "";
  finSnap.forEach(d => {
    const f = d.data();
    finHTML += `
      <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-3 rounded-xl">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-xs font-bold">${f.note || "-"}</p>
            <p class="text-[10px] text-slate-400">${dateID(f.createdAt)} • ${f.type}</p>
            <p class="text-sm font-black ${f.type==="income"?"text-green-600":"text-red-500"}">${money(f.amount)}</p>
          </div>
          ${(isKetua()||isSuper()) ? `
            <button class="text-[10px] bg-green-500 text-white px-2 py-1 rounded-lg font-bold"
              onclick="approveFin('${d.id}')">ACC</button>` : ''
          }
        </div>
      </div>
    `;
  });

  return `
    <div class="space-y-3">
      <div class="flex items-center justify-between">
        <p class="text-sm font-extrabold text-slate-700 dark:text-white">Menunggu ACC</p>
        ${badge("Finance Pending")}
      </div>
      <div class="space-y-2">${finHTML || `<p class="text-xs text-slate-400 text-center">Tidak ada pending.</p>`}</div>
      <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl text-xs text-slate-600 dark:text-slate-200">
        <p>${badge("Next", "bg-blue-100 text-blue-700")} Tambah approval kegiatan / surat / aset (kalau perlu).</p>
      </div>
    </div>
  `;
}

// ====== Broadcast (real: create notifications) ======
function openBroadcastModal() {
  showModal("Broadcast Pengumuman", `
    <input id="bTitle" class="input-field mb-2" placeholder="Judul broadcast">
    <textarea id="bBody" class="input-field mb-2 h-24" placeholder="Isi broadcast..."></textarea>
    <select id="bLvl" class="input-field">
      <option value="normal">Info Biasa</option>
      <option value="important">Penting!</option>
    </select>
    <p class="text-[11px] text-slate-400 mt-2">Broadcast akan masuk ke Papan Info.</p>
  `, async () => {
    await addDoc(collection(db, "notifications"), {
      title: $("bTitle").value,
      body: $("bBody").value,
      level: $("bLvl").value,
      createdAt: serverTimestamp(),
      createdBy: ME.uid
    });
    await auditLog("BROADCAST", $("bTitle").value);
    closeModal();
    loadNotifications(50);
    loadHomeData();
  });
}

// ====== Ketua extras (mostly stub) ======
const reportHTML = () => `
  <div class="space-y-3">
    <p class="text-xs text-slate-500 dark:text-slate-200">Generate laporan ringkas (stub). Bisa dikembangkan jadi PDF detail.</p>
    <select id="rType" class="input-field">
      <option value="finance">Laporan Keuangan</option>
      <option value="activities">Laporan Kegiatan</option>
      <option value="inventory">Laporan Inventaris</option>
    </select>
    <p class="text-[11px] text-slate-400">Klik SIMPAN untuk generate.</p>
  </div>
`;
async function generateReport() {
  await auditLog("REPORT_GENERATE", `type=${$("rType").value}`);
  closeModal();
  alert("Report stub dibuat (log tersimpan).");
}

const kpiHTML = () => `
  <div class="text-xs text-slate-600 dark:text-slate-200 space-y-2">
    <p class="font-bold">KPI (stub)</p>
    <ul class="list-disc pl-5 space-y-1">
      <li>Anggota aktif</li>
      <li>Kegiatan per bulan</li>
      <li>Kas masuk/keluar bulanan</li>
    </ul>
  </div>
`;

const taskHTML = () => `
  <div class="space-y-3">
    <input id="tTitle" class="input-field" placeholder="Judul tugas">
    <textarea id="tDesc" class="input-field h-20" placeholder="Deskripsi tugas"></textarea>
    <select id="tTo" class="input-field">
      <option value="sekretaris">Sekretaris</option>
      <option value="bendahara">Bendahara</option>
      <option value="wakil_ketua">Wakil Ketua</option>
      <option value="anggota">Anggota</option>
    </select>
  </div>
`;
async function createTask() {
  await addDoc(collection(db, "tasks"), {
    title: $("tTitle").value,
    desc: $("tDesc").value,
    toRole: $("tTo").value,
    status: "open",
    createdAt: serverTimestamp(),
    createdBy: ME.uid
  });
  await auditLog("TASK_CREATE", $("tTitle").value);
  closeModal();
  alert("Tugas dibuat.");
}

const memberInsightHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} Insight anggota akan pakai data absensi/aktivitas.</div>`;
const budgetHTML = () => `
  <div class="space-y-3">
    <input id="bYear" type="number" class="input-field" placeholder="Tahun (mis: 2026)">
    <input id="bAmount" type="number" class="input-field" placeholder="Target total budget (Rp)">
    <p class="text-[11px] text-slate-400">Disimpan ke koleksi <b>budget_plans</b>.</p>
  </div>
`;
async function saveBudget() {
  await addDoc(collection(db,"budget_plans"), {
    year: Number($("bYear").value || 0),
    total: Number($("bAmount").value || 0),
    createdAt: serverTimestamp(),
    createdBy: ME.uid
  });
  await auditLog("BUDGET_CREATE", `${$("bYear").value} - ${$("bAmount").value}`);
  closeModal();
  alert("Budget plan tersimpan.");
}
const meetingHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} nanti tarik dari koleksi notulen.</div>`;
const signHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} tanda tangan digital bisa pakai canvas + upload.</div>`;

// ====== Wakil Ketua stubs + minimal collections ======
const borrowHTML = () => `
  <div class="space-y-3">
    <input id="brItem" class="input-field" placeholder="Nama barang">
    <input id="brQty" type="number" class="input-field" placeholder="Jumlah">
    <input id="brBorrower" class="input-field" placeholder="Nama peminjam">
    <p class="text-[11px] text-slate-400">Disimpan ke koleksi <b>borrows</b>.</p>
  </div>
`;
async function createBorrow() {
  await addDoc(collection(db,"borrows"), {
    item: $("brItem").value,
    qty: Number($("brQty").value || 0),
    borrower: $("brBorrower").value,
    status: "borrowed",
    createdAt: serverTimestamp(),
    createdBy: ME.uid
  });
  await auditLog("BORROW_CREATE", $("brItem").value);
  closeModal();
  alert("Peminjaman dicatat.");
}
const maintenanceHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} jadwal perawatan aset.</div>`;
async function saveMaintenance(){ await auditLog("MAINTENANCE_SAVE","stub"); closeModal(); alert("Saved (stub)"); }
const incidentHTML = () => `
  <div class="space-y-3">
    <input id="inTitle" class="input-field" placeholder="Judul insiden">
    <textarea id="inBody" class="input-field h-20" placeholder="Detail insiden..."></textarea>
  </div>
`;
async function createIncident(){
  await addDoc(collection(db,"incidents"), { title:$("inTitle").value, body:$("inBody").value, createdAt:serverTimestamp(), createdBy:ME.uid });
  await auditLog("INCIDENT_CREATE",$("inTitle").value);
  closeModal(); alert("Insiden dicatat.");
}
const scannerHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} scanner QR butuh library kamera (html5-qrcode).</div>`;
const attendanceHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} kontrol absensi kegiatan.</div>`;
const vendorHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} daftar vendor.</div>`;
const assetValueHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} depresiasi aset.</div>`;
const securityHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} jadwal keamanan.</div>`;
const mapsHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} peta lokasi kegiatan.</div>`;

// ====== Sekretaris (minimal real + stub) ======
const letterGenHTML = () => `
  <div class="space-y-3">
    <input id="lgSubject" class="input-field" placeholder="Perihal surat">
    <input id="lgNumber" class="input-field" placeholder="Nomor surat">
    <textarea id="lgBody" class="input-field h-24" placeholder="Isi singkat (opsional)..."></textarea>
    <p class="text-[11px] text-slate-400">Akan masuk ke Arsip Surat (tanpa file, text-only).</p>
  </div>
`;
async function createLetterFromTemplate(){
  await addDoc(collection(db,"letters"), {
    subject: $("lgSubject").value,
    number: $("lgNumber").value,
    body: $("lgBody").value,
    createdAt: serverTimestamp(),
    createdBy: ME.uid
  });
  await auditLog("LETTER_CREATE", $("lgNumber").value);
  closeModal();
  loadLetters();
  alert("Surat text-only tersimpan.");
}

const notulenHTML = () => `
  <div class="space-y-3">
    <input id="ntTitle" class="input-field" placeholder="Judul rapat">
    <textarea id="ntBody" class="input-field h-28" placeholder="Notulen..."></textarea>
    <p class="text-[11px] text-slate-400">Disimpan ke koleksi <b>notulen</b>.</p>
  </div>
`;
async function createNotulen(){
  await addDoc(collection(db,"notulen"), { title:$("ntTitle").value, body:$("ntBody").value, createdAt:serverTimestamp(), createdBy:ME.uid });
  await auditLog("NOTULEN_CREATE", $("ntTitle").value);
  closeModal(); alert("Notulen tersimpan.");
}
const agendaHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} agenda rapat.</div>`;
async function saveAgenda(){ await auditLog("AGENDA_SAVE","stub"); closeModal(); alert("Saved (stub)"); }
const incomingHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} surat masuk.</div>`;
const outgoingHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} surat keluar.</div>`;
const draftNotifHTML = () => `
  <div class="space-y-3">
    <input id="dnTitle" class="input-field" placeholder="Judul draft">
    <textarea id="dnBody" class="input-field h-24" placeholder="Isi draft..."></textarea>
    <p class="text-[11px] text-slate-400">Disimpan ke koleksi <b>notif_drafts</b>.</p>
  </div>
`;
async function createDraftNotif(){
  await addDoc(collection(db,"notif_drafts"), { title:$("dnTitle").value, body:$("dnBody").value, createdAt:serverTimestamp(), createdBy:ME.uid });
  await auditLog("DRAFT_NOTIF_CREATE", $("dnTitle").value);
  closeModal(); alert("Draft disimpan.");
}
const tagHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} tagging arsip.</div>`;

// ====== Bendahara stubs ======
const invoiceHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} invoice generator.</div>`;
const duesHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} manajemen iuran.</div>`;
const donationHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} campaign donasi.</div>`;
const budgetVsHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} budget vs aktual.</div>`;
const reconcileHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} rekonsil bank.</div>`;
const proofHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} validasi bukti.</div>`;
const taxHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} catatan pajak.</div>`;

// ====== Anggota minimal real (proposal & issue) ======
const rsvpHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} RSVP kegiatan.</div>`;
const proposalHTML = () => `
  <div class="space-y-3">
    <input id="pTitle" class="input-field" placeholder="Judul usulan">
    <textarea id="pBody" class="input-field h-24" placeholder="Detail usulan..."></textarea>
    <p class="text-[11px] text-slate-400">Disimpan ke koleksi <b>proposals</b>.</p>
  </div>
`;
async function submitProposal(){
  await addDoc(collection(db,"proposals"), { title:$("pTitle").value, body:$("pBody").value, status:"new", createdAt:serverTimestamp(), createdBy:ME.uid });
  await auditLog("PROPOSAL_SUBMIT", $("pTitle").value);
  closeModal(); alert("Usulan terkirim.");
}
const issueHTML = () => `
  <div class="space-y-3">
    <input id="isTitle" class="input-field" placeholder="Judul masalah">
    <textarea id="isBody" class="input-field h-24" placeholder="Detail masalah..."></textarea>
    <p class="text-[11px] text-slate-400">Disimpan ke koleksi <b>issues</b>.</p>
  </div>
`;
async function submitIssue(){
  await addDoc(collection(db,"issues"), { title:$("isTitle").value, body:$("isBody").value, status:"open", createdAt:serverTimestamp(), createdBy:ME.uid });
  await auditLog("ISSUE_SUBMIT", $("isTitle").value);
  closeModal(); alert("Laporan terkirim.");
}

const volunteerHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} daftar relawan.</div>`;
const votingHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} voting.</div>`;
const umkmHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} UMKM/marketplace.</div>`;
const badgeHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} badge & poin.</div>`;
const emergencyHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} kontak darurat.</div>`;
const chatHTML = () => `<div class="text-xs text-slate-600 dark:text-slate-200">${badge("Stub","bg-orange-100 text-orange-700")} forum internal.</div>`;
