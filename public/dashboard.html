<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KARTEJI SUPER APP</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          colors: {
            brand: { primary: '#0F172A', secondary: '#1E293B', light: '#334155' },
            accent: { DEFAULT: '#F97316', hover: '#EA580C', light: '#FFEDD5' },
          },
          animation: { 'slide-up': 'slideUp 0.3s ease-out', 'bounce-slow': 'bounce 3s infinite' },
          keyframes: {
            slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #F1F5F9; color: #1E293B; -webkit-tap-highlight-color: transparent; user-select: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    /* GLASSMORPHISM */
    .glass-nav {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-top: 1px solid rgba(255,255,255,0.3);
      box-shadow: 0 -4px 30px rgba(0,0,0,0.05);
    }
    
    /* PAGE TRANSITION */
    .view-section { display: none; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* NAV ACTIVE STATE */
    .nav-btn.active span { font-variation-settings: 'FILL' 1; color: #F97316; transform: scale(1.1); transition: 0.2s; }
    .nav-btn.active p { color: #0F172A; font-weight: 800; }
    
    /* ANIMASI UNDIAN */
    .shaking { animation: shake 0.5s infinite; }
    @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
  </style>
</head>

<body class="min-h-screen relative overflow-x-hidden pb-32">

  <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
     <div class="absolute -top-20 -left-20 w-80 h-80 bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
     <div class="absolute top-40 -right-20 w-80 h-80 bg-orange-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
  </div>

  <div id="toastContainer" class="fixed top-4 left-1/2 -translate-x-1/2 z-[10000] flex flex-col gap-2 w-[90%] max-w-sm pointer-events-none"></div>

  <div id="globalLoader" class="fixed inset-0 bg-white z-[9999] flex items-center justify-center flex-col gap-4 transition-opacity duration-500">
    <div class="w-14 h-14 border-4 border-slate-100 border-t-accent rounded-full animate-spin"></div>
    <p class="text-xs font-bold text-slate-400 tracking-[0.2em] animate-pulse">MEMUAT SYSTEM...</p>
  </div>

  <div id="crudModal" class="fixed inset-0 z-[60] hidden items-end sm:items-center justify-center bg-slate-900/60 backdrop-blur-sm transition-all p-0 sm:p-4">
    <div class="bg-white w-full sm:max-w-md rounded-t-[2rem] sm:rounded-[2rem] p-6 relative shadow-2xl animate-slide-up max-h-[90vh] flex flex-col">
      <div class="flex justify-between items-center mb-6 shrink-0">
          <h2 id="modalTitle" class="text-xl font-extrabold text-brand-primary">Judul</h2>
          <button onclick="closeModal()" class="w-9 h-9 rounded-full bg-slate-50 flex items-center justify-center hover:bg-slate-100 text-slate-500 active:scale-90"><span class="material-symbols-rounded">close</span></button>
      </div>
      <div id="modalBody" class="space-y-4 overflow-y-auto no-scrollbar pb-2"></div>
      <div class="mt-4 pt-4 border-t border-slate-100 shrink-0">
         <button id="modalSubmitBtn" class="w-full rounded-2xl bg-brand-primary text-white py-4 text-sm font-bold shadow-xl shadow-slate-300 hover:scale-[1.01] active:scale-95 transition-all">SIMPAN</button>
      </div>
    </div>
  </div>

  <header class="sticky top-0 z-30 px-6 pt-10 pb-4 bg-gradient-to-b from-[#F1F5F9] via-[#F1F5F9] to-transparent">
      <div class="flex justify-between items-center">
          <div class="flex items-center gap-3.5">
              <button onclick="switchView('profile')" class="relative group active:scale-95 transition-transform">
                <div class="absolute -inset-1 bg-gradient-to-tr from-accent to-blue-400 rounded-full opacity-40 blur group-hover:opacity-75 transition duration-200"></div>
                <img id="headerPhoto" class="relative w-12 h-12 rounded-full border-2 border-white object-cover" src="https://via.placeholder.com/100">
                <div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full z-10"></div>
              </button>
              <div>
                  <p id="greetingText" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">Halo,</p>
                  <h1 id="headerName" class="text-xl font-extrabold text-brand-primary leading-none truncate max-w-[160px]">User</h1>
                  <span id="headerRoleBadge" class="text-[9px] bg-accent/10 text-accent font-bold px-2 py-0.5 rounded-md mt-1 inline-block">MEMBER</span>
              </div>
          </div>
          <button id="logoutBtn" class="w-10 h-10 rounded-full bg-white border border-slate-200 shadow-sm flex items-center justify-center text-red-500 hover:bg-red-50 active:scale-90 transition-all">
            <span class="material-symbols-rounded">logout</span>
          </button>
      </div>
  </header>

  <main class="px-5 mt-2 relative z-10 min-h-[75vh]">

      <section id="view-home" class="view-section active">
          <div id="homeBalanceCard" class="w-full bg-brand-primary rounded-[2.5rem] p-6 text-white relative overflow-hidden shadow-2xl shadow-slate-300 mb-6 transition-all group">
              <div class="absolute -right-12 -bottom-12 w-56 h-56 opacity-20 pointer-events-none group-hover:scale-110 transition-transform duration-700"><canvas id="miniChart"></canvas></div>
              <div class="relative z-10">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1">Total Saldo Kas</p>
                        <h2 id="cardBalance" class="text-4xl font-black tracking-tight">Rp 0</h2>
                    </div>
                </div>
                <div class="flex gap-3">
                   <div class="bg-white/5 backdrop-blur-sm px-4 py-3 rounded-2xl flex-1 border border-white/5">
                       <p class="text-[9px] uppercase font-bold text-slate-400 mb-0.5">Masuk</p>
                       <p id="cardIncome" class="text-sm font-bold text-white truncate">Rp 0</p>
                   </div>
                   <div class="bg-white/5 backdrop-blur-sm px-4 py-3 rounded-2xl flex-1 border border-white/5">
                       <p class="text-[9px] uppercase font-bold text-slate-400 mb-0.5">Keluar</p>
                       <p id="cardExpense" class="text-sm font-bold text-white truncate">Rp 0</p>
                   </div>
                </div>
              </div>
          </div>

          <h3 class="text-sm font-bold text-brand-primary mb-3 px-1">Menu Cepat</h3>
          <div id="shortcutsGrid" class="grid grid-cols-4 gap-3 mb-6"></div>

          <div class="flex justify-between items-end mb-3 px-1">
             <h3 class="text-sm font-bold text-brand-primary">Info Terbaru</h3>
          </div>
          <div id="homeInfoList" class="space-y-3 pb-24"></div>
      </section>

      <section id="view-finance" class="view-section">
          <div class="flex justify-between items-center mb-6 px-1 sticky top-0 bg-[#F1F5F9]/90 py-2 z-20 backdrop-blur-sm">
            <div>
                <h2 class="text-2xl font-bold text-brand-primary">Laporan Kas</h2>
                <p class="text-xs text-slate-400">Transparansi Dana</p>
            </div>
            <button id="addFinBtn" class="hidden w-11 h-11 bg-brand-primary text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-transform"><span class="material-symbols-rounded">add</span></button>
          </div>
          
          <div id="finList" class="space-y-3 pb-24"></div>
      </section>

      <section id="view-events" class="view-section">
          <div class="flex justify-between items-center mb-6 px-1 sticky top-0 bg-[#F1F5F9]/90 py-2 z-20 backdrop-blur-sm">
            <div>
                <h2 class="text-2xl font-bold text-brand-primary">Kegiatan</h2>
                <p class="text-xs text-slate-400">Jadwal & ACC Acara</p>
            </div>
            <button id="addEventBtn" class="hidden w-11 h-11 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-transform"><span class="material-symbols-rounded">add</span></button>
          </div>
          <div id="eventList" class="space-y-4 pb-24"></div>
      </section>

      <section id="view-secretariat" class="view-section">
          <div class="flex justify-between items-center mb-4 px-1 sticky top-0 bg-[#F1F5F9]/90 py-2 z-20 backdrop-blur-sm">
            <div>
                <h2 class="text-2xl font-bold text-brand-primary">Arsip Digital</h2>
                <p class="text-xs text-slate-400">Surat & Notulen</p>
            </div>
            <button onclick="openSecModal(currentSecTab)" class="w-11 h-11 bg-slate-800 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90"><span class="material-symbols-rounded">add</span></button>
          </div>
          
          <div class="flex bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100 mb-4">
              <button onclick="loadSecretariat('minutes')" class="flex-1 py-2.5 rounded-xl text-[10px] font-bold bg-brand-primary text-white transition-all shadow-md" id="tabMin">NOTULEN</button>
              <button onclick="loadSecretariat('letters')" class="flex-1 py-2.5 rounded-xl text-[10px] font-bold text-slate-400 transition-all hover:text-brand-primary" id="tabLet">SURAT</button>
              <button onclick="loadSecretariat('archives')" class="flex-1 py-2.5 rounded-xl text-[10px] font-bold text-slate-400 transition-all hover:text-brand-primary" id="tabArc">FILE</button>
          </div>
          <div id="secList" class="space-y-3 pb-24"></div>
      </section>

      <section id="view-raffle" class="view-section">
          <h2 class="text-2xl font-bold text-brand-primary mb-4 px-1">Titik Kumpul</h2>
          <div class="w-full bg-slate-900 rounded-[2.5rem] p-8 text-white text-center relative overflow-hidden shadow-xl mb-6">
              <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 20px 20px;"></div>
              
              <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-4">TUAN RUMAH BERIKUTNYA</p>
              
              <div class="bg-white/10 p-4 rounded-2xl backdrop-blur-md border border-white/10 mb-6">
                  <h2 id="raffleWinner" class="text-2xl font-black text-accent tracking-wide animate-pulse">BELUM DIUNDI</h2>
              </div>

              <button id="raffleBtn" onclick="runRaffle()" class="w-full py-4 bg-accent hover:bg-orange-500 text-white rounded-2xl font-bold shadow-lg shadow-orange-500/30 active:scale-95 transition-all flex items-center justify-center gap-2">
                  <span class="material-symbols-rounded">casino</span> KOCOK UNDIAN
              </button>
          </div>
          
          <div class="px-1 mb-2 font-bold text-sm text-brand-primary">Riwayat Terpilih</div>
          <div id="raffleHistory" class="space-y-2 pb-24"></div>
      </section>

      <section id="view-inventory" class="view-section">
          <div class="flex justify-between items-center mb-6 px-1">
            <h2 class="text-2xl font-bold text-brand-primary">Inventaris</h2>
            <button onclick="openInventoryModal()" class="w-11 h-11 bg-purple-600 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90"><span class="material-symbols-rounded">add</span></button>
          </div>
          <div id="invList" class="grid grid-cols-2 gap-3 pb-24"></div>
      </section>

      <section id="view-users" class="view-section">
          <div class="flex justify-between items-center mb-4 px-1">
             <h2 class="text-2xl font-bold text-brand-primary">Anggota</h2>
             <div class="bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100 text-xs font-bold text-brand-primary"><span id="userCount">0</span> Orang</div>
          </div>
          <div class="relative mb-4 group">
              <span class="material-symbols-rounded absolute left-4 top-3 text-slate-400">search</span>
              <input type="text" onkeyup="filterUsers(this.value)" placeholder="Cari nama..." class="w-full bg-white pl-11 pr-4 py-3 rounded-2xl shadow-sm border-none outline-none focus:ring-2 focus:ring-accent/20 transition-all text-sm font-semibold">
          </div>
          <div id="userList" class="grid grid-cols-1 gap-3 pb-24"></div>
      </section>

      <section id="view-profile" class="view-section">
        <div class="flex flex-col items-center pt-6 pb-24">
            <div class="relative group cursor-pointer active:scale-95 transition-transform" onclick="$('profileUpload').click()">
                <div class="absolute -inset-1 bg-gradient-to-tr from-accent to-blue-500 rounded-full blur opacity-40 group-hover:opacity-75 transition duration-500"></div>
                <img id="profileImage" src="https://via.placeholder.com/150" class="relative w-32 h-32 rounded-full object-cover border-4 border-white shadow-xl bg-white">
                <div class="absolute bottom-2 right-2 bg-slate-800 text-white p-2 rounded-full border-2 border-white shadow-sm z-10"><span class="material-symbols-rounded text-sm block">edit</span></div>
            </div>
            <input type="file" id="profileUpload" class="hidden" accept="image/*" onchange="previewProfileImage(this)">
            
            <h2 id="pName" class="text-2xl font-black text-brand-primary mt-5 mb-1 text-center">User Name</h2>
            <p id="pEmail" class="text-sm text-slate-400 font-medium mb-4">user@email.com</p>
            
            <button onclick="showIdCard()" class="flex items-center gap-2 bg-white px-5 py-2.5 rounded-2xl shadow-sm border border-slate-100 text-brand-primary font-bold text-xs hover:bg-slate-50 transition-colors active:scale-95">
                <span class="material-symbols-rounded text-accent">badge</span> LIHAT ID CARD
            </button>

            <div id="adminPanelContainer"></div>

            <div class="w-full mt-8 space-y-4 px-1">
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 space-y-5">
                    <div class="group">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block group-focus-within:text-accent">Nama Lengkap</label>
                        <input id="editName" type="text" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-brand-primary outline-none focus:bg-slate-50 transition-all border-none">
                    </div>
                    <div class="group">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block group-focus-within:text-accent">WhatsApp</label>
                        <input id="editPhone" type="tel" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-brand-primary outline-none focus:bg-slate-50 transition-all border-none">
                    </div>
                    <div class="group">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block group-focus-within:text-accent">Alamat</label>
                        <textarea id="editAddress" rows="2" class="w-full p-3 bg-slate-50 rounded-xl font-medium text-brand-primary outline-none focus:bg-slate-50 transition-all border-none resize-none"></textarea>
                    </div>
                </div>
                <button onclick="saveProfile()" class="w-full bg-brand-primary text-white py-4 rounded-2xl font-bold shadow-xl shadow-slate-300 hover:scale-[1.01] active:scale-95 transition-all">SIMPAN PROFIL</button>
            </div>
        </div>
      </section>

  </main>

  <nav class="fixed bottom-0 w-full glass-nav pb-6 pt-2 px-4 z-50 rounded-t-[2rem]">
      <div id="navContainer" class="flex justify-between items-center max-w-sm mx-auto"></div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, addDoc, getDocs, query, orderBy, limit, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // --- 1. FIREBASE CONFIG (Ganti dengan punya Anda jika berbeda) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
      authDomain: "katar-9cac3.firebaseapp.com",
      projectId: "katar-9cac3",
      storageBucket: "katar-9cac3.firebasestorage.app",
      messagingSenderId: "1017734829960",
      appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Cloudinary
    const CLOUD_NAME = "dbxktcwug";
    const UPLOAD_PRESET = "Karteji";

    // --- 2. GLOBAL STATE ---
    window.$ = (id) => document.getElementById(id);
    let ME = null;
    let ROLE = "anggota";
    let REAL_ROLE = "anggota";
    let newProfileFile = null;
    let currentSecTab = 'minutes';
    let chartInstance = null;

    // --- 3. ROLE CONFIGURATION (Sesuai Struktur File Lama) ---
    const ROLES = {
        super_admin: { label: "Super Admin", nav: ['home','users','finance','inventory','profile'] },
        ketua: { label: "Ketua", nav: ['home','events','users','finance','profile'] },
        wakil_ketua: { label: "Wakil Ketua", nav: ['home','events','users','finance','profile'] },
        bendahara: { label: "Bendahara", nav: ['home','raffle','finance','profile'] },
        sekretaris: { label: "Sekretaris", nav: ['home','secretariat','users','profile'] },
        anggota: { label: "Anggota", nav: ['home','events','finance','profile'] }
    };

    const MENUS = {
        home: { icon: 'grid_view', label: 'Home' },
        users: { icon: 'group', label: 'Tim' },
        finance: { icon: 'account_balance_wallet', label: 'Kas' },
        events: { icon: 'calendar_month', label: 'Acara' },
        inventory: { icon: 'inventory_2', label: 'Aset' },
        profile: { icon: 'person', label: 'Profil' },
        raffle: { icon: 'location_on', label: 'Undi' },
        secretariat: { icon: 'folder', label: 'Arsip' }
    };

    // --- 4. AUTHENTICATION & INIT ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) return window.location.href = "login.html";
        try {
            const snap = await getDoc(doc(db, "users", user.uid));
            if(!snap.exists()) { signOut(auth); showToast("User tidak ditemukan!", "error"); return; }
            ME = { uid: user.uid, ...snap.data() };
            REAL_ROLE = ME.role || "anggota";
            ROLE = REAL_ROLE; // Set awal role
            if(!ROLES[ROLE]) ROLE = "anggota";
            initApp();
        } catch(e) { console.error(e); }
    });

    function initApp() {
        updateHeader();
        renderNav();
        renderShortcuts();
        // Hide Loader
        const l = $("globalLoader");
        l.style.opacity = '0';
        setTimeout(() => l.style.display = 'none', 500);
        switchView('home');
    }

    // --- 5. UI CORE FUNCTIONS ---
    function updateHeader() {
        const h = new Date().getHours();
        $("greetingText").textContent = h<12?"Selamat Pagi,":h<15?"Selamat Siang,":h<19?"Selamat Sore,":"Selamat Malam,";
        $("headerName").textContent = ME.name.split(' ')[0];
        $("pName").textContent = ME.name;
        $("pEmail").textContent = ME.email;
        $("headerRoleBadge").textContent = ROLES[ROLE].label.toUpperCase();
        if(ME.photo?.url) { $("headerPhoto").src = ME.photo.url; $("profileImage").src = ME.photo.url; }
        $("editName").value = ME.name||""; $("editPhone").value = ME.phone||""; $("editAddress").value = ME.address||"";
        
        // ADMIN SWITCHER PANEL
        const container = $("adminPanelContainer");
        if(REAL_ROLE === 'super_admin') {
            container.innerHTML = `
                <div class="w-full mt-4 bg-slate-800 p-4 rounded-2xl border border-slate-700">
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-2">MODE TAMPILAN (ADMIN ONLY)</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="switchSimulation('ketua')" class="p-2 bg-slate-700 rounded-lg text-[10px] text-white font-bold hover:bg-accent">KETUA</button>
                        <button onclick="switchSimulation('wakil_ketua')" class="p-2 bg-slate-700 rounded-lg text-[10px] text-white font-bold hover:bg-accent">WAKIL</button>
                        <button onclick="switchSimulation('bendahara')" class="p-2 bg-slate-700 rounded-lg text-[10px] text-white font-bold hover:bg-accent">BENDAHARA</button>
                        <button onclick="switchSimulation('sekretaris')" class="p-2 bg-slate-700 rounded-lg text-[10px] text-white font-bold hover:bg-accent">SEKRETARIS</button>
                        <button onclick="switchSimulation('anggota')" class="p-2 bg-slate-700 rounded-lg text-[10px] text-white font-bold hover:bg-accent">ANGGOTA</button>
                        <button onclick="switchSimulation('super_admin')" class="p-2 bg-red-600 rounded-lg text-[10px] text-white font-bold">RESET</button>
                    </div>
                </div>`;
        } else {
            container.innerHTML = "";
        }
    }

    window.switchSimulation = (simRole) => {
        ROLE = simRole;
        updateHeader(); renderNav(); renderShortcuts(); switchView('home');
        showToast(`Mode Tampilan: ${ROLES[simRole].label}`, "success");
    }

    function renderNav() {
        const c = $("navContainer"); c.innerHTML = "";
        ROLES[ROLE].nav.forEach(key => {
            const m = MENUS[key];
            const isCenter = key === 'profile';
            if(isCenter) c.innerHTML += `<div class="relative -top-6"><button onclick="switchView('${key}')" class="nav-btn w-14 h-14 bg-brand-primary text-white rounded-full flex items-center justify-center shadow-xl hover:scale-105 transition-all ring-4 ring-white" data-target="${key}"><span class="material-symbols-rounded text-3xl">${m.icon}</span></button></div>`;
            else c.innerHTML += `<button onclick="switchView('${key}')" class="nav-btn flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="${key}"><span class="material-symbols-rounded text-2xl text-slate-300 transition-colors">${m.icon}</span><p class="text-[9px] font-medium text-slate-300 transition-colors">${m.label}</p></button>`;
        });
    }

    function renderShortcuts() {
        const grid = $("shortcutsGrid"); grid.innerHTML = "";
        const adds = [];
        
        // Dynamic Shortcuts based on Role capabilities
        if(['sekretaris','super_admin'].includes(ROLE)) adds.push({icon:'folder_open', label:'Arsip', bg:'bg-blue-50', color:'text-blue-600', act:"switchView('secretariat')"});
        if(['bendahara','super_admin'].includes(ROLE)) adds.push({icon:'casino', label:'Undi', bg:'bg-purple-50', color:'text-purple-600', act:"switchView('raffle')"});
        if(['wakil_ketua','super_admin'].includes(ROLE)) adds.push({icon:'verified', label:'ACC', bg:'bg-green-50', color:'text-green-600', act:"switchView('finance')"});
        
        // Defaults
        adds.push({icon:'qr_code_scanner', label:'Scan', bg:'bg-slate-100', color:'text-brand-primary', act:"showToast('Fitur Scan segera hadir!')"});
        adds.push({icon:'logout', label:'Keluar', bg:'bg-red-50', color:'text-red-500', act:"$('#logoutBtn').click()"});

        adds.forEach(a => grid.innerHTML += `<div onclick="${a.act}" class="flex flex-col items-center gap-2 cursor-pointer active:scale-90 transition-transform"><div class="w-12 h-12 rounded-2xl ${a.bg} flex items-center justify-center shadow-sm"><span class="material-symbols-rounded ${a.color} text-xl">${a.icon}</span></div><span class="text-[10px] font-bold text-slate-500">${a.label}</span></div>`);
    }

    window.switchView = (id) => {
        document.querySelectorAll('.view-section').forEach(el => { el.classList.remove('active'); setTimeout(()=>{if(!el.classList.contains('active'))el.style.display='none'},200); });
        const t = $(`view-${id}`); if(t){ t.style.display='block'; setTimeout(()=>t.classList.add('active'),10); }
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        const nav = document.querySelector(`.nav-btn[data-target="${id}"]`); if(nav) nav.classList.add('active');

        // LOADERS
        if(id==='home') loadDashboard();
        if(id==='finance') loadFinance();
        if(id==='users') loadUsers();
        if(id==='events') loadEvents();
        if(id==='inventory') loadInventory();
        if(id==='secretariat') loadSecretariat('minutes');
        if(id==='raffle') loadRaffle();
    }

    // --- 6. LOGIC PER MODULE ---

    // MODULE: HOME & CHART
    async function loadDashboard() {
        const snap = await getDocs(query(collection(db,"financial_records"), where("status","==","approved")));
        let inc=0, exp=0; snap.forEach(d=>{ if(d.data().type==='income') inc+=Number(d.data().amount); else exp+=Number(d.data().amount); });
        
        $("cardBalance").textContent = "Rp " + (inc-exp).toLocaleString('id-ID');
        $("cardIncome").textContent = "Rp " + inc.toLocaleString('id-ID');
        $("cardExpense").textContent = "Rp " + exp.toLocaleString('id-ID');
        
        const ctx = $("miniChart").getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, { type:'doughnut', data:{ labels:['Masuk','Keluar'], datasets:[{ data:[inc,exp], backgroundColor:['rgba(255,255,255,0.2)','rgba(255,255,255,0.05)'], borderWidth:0 }] }, options:{ responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:false} } });

        const iSnap = await getDocs(query(collection(db,"activities"), orderBy("createdAt","desc"), limit(2)));
        $("homeInfoList").innerHTML = "";
        iSnap.forEach(d => {
             const x = d.data();
             $("homeInfoList").innerHTML += `<div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex gap-3"><div class="bg-blue-50 text-blue-500 p-2 rounded-xl shrink-0"><span class="material-symbols-rounded text-lg">event</span></div><div><h4 class="text-xs font-bold text-brand-primary">${x.title}</h4><p class="text-[10px] text-slate-500">${x.date || 'Segera'}</p></div></div>`;
        });
    }

    // MODULE: FINANCE (Bendahara)
    async function loadFinance() {
        const btn = $("addFinBtn");
        if(['super_admin','bendahara'].includes(ROLE)) { btn.classList.remove('hidden'); btn.onclick = openFinanceModal; } else btn.classList.add('hidden');
        
        const list = $("finList"); list.innerHTML = "";
        const snap = await getDocs(query(collection(db,"financial_records"), orderBy("createdAt","desc"), limit(50)));
        
        snap.forEach(d => {
            const f = d.data();
            const isInc = f.type==='income';
            const isPending = f.status==='pending';
            
            let actBtn = '';
            // Bendahara/Admin bisa hapus
            if(['super_admin','bendahara'].includes(ROLE)) actBtn += `<button onclick="deleteDocData('financial_records','${d.id}')" class="text-red-500 text-[10px] font-bold">Hapus</button>`;
            // Wakil/Admin bisa ACC
            if(['super_admin','wakil_ketua'].includes(ROLE) && isPending) actBtn += `<button onclick="approveDoc('financial_records','${d.id}')" class="text-green-500 text-[10px] font-bold ml-2 bg-green-50 px-2 py-0.5 rounded">ACC</button>`;

            list.innerHTML += `
                <div class="bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-100 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full ${isInc?'bg-green-50 text-green-500':'bg-red-50 text-red-500'} flex items-center justify-center shrink-0"><span class="material-symbols-rounded text-xl">${isInc?'arrow_downward':'arrow_upward'}</span></div>
                        <div>
                            <p class="text-xs font-bold text-brand-primary line-clamp-1">${f.note}</p>
                            <div class="flex gap-2 items-center">
                                <span class="text-[10px] ${isPending?'text-orange-500 font-bold':'text-slate-400'}">${isPending?'Menunggu ACC':'Terverifikasi'}</span>
                                ${actBtn}
                            </div>
                        </div>
                    </div>
                    <span class="text-xs font-bold ${isInc?'text-green-500':'text-red-500'}">${isInc?'+':'-'} ${Number(f.amount).toLocaleString('id-ID')}</span>
                </div>`;
        });
    }

    window.openFinanceModal = () => {
        const html = `
            <select id="fType" class="w-full p-4 bg-slate-50 rounded-xl mb-3 font-bold text-sm outline-none"><option value="income">Pemasukan (+)</option><option value="expense">Pengeluaran (-)</option></select>
            <input id="fAmt" type="number" class="w-full p-4 bg-slate-50 rounded-xl mb-3 font-bold outline-none" placeholder="Nominal (Rp)">
            <input id="fNote" class="w-full p-4 bg-slate-50 rounded-xl outline-none" placeholder="Catatan Transaksi">`;
        showModal("Catat Kas", html, async () => {
            if(!$("fAmt").value) return showToast("Isi nominal!", "error");
            await addDoc(collection(db,"financial_records"), { type:$("fType").value, amount:$("fAmt").value, note:$("fNote").value, status:(ROLE==='bendahara'||ROLE==='super_admin'?'approved':'pending'), createdAt:serverTimestamp() });
            closeModal(); loadFinance(); showToast("Transaksi disimpan!", "success");
        });
    }

    // MODULE: USERS
    async function loadUsers() {
        const list = $("userList"); list.innerHTML="";
        const snap = await getDocs(query(collection(db,"users"), orderBy("name")));
        $("userCount").textContent = snap.size;
        
        // Cek apakah user berhak edit role
        const canEdit = ['super_admin','ketua'].includes(ROLE);

        snap.forEach(d => {
            const u = d.data();
            // Dropdown Role khusus Admin/Ketua
            let roleBadge = `<span class="text-[9px] bg-slate-100 px-1.5 py-0.5 rounded font-bold uppercase text-slate-500">${u.role||'Anggota'}</span>`;
            if(canEdit && d.id !== ME.uid && u.role !== 'super_admin') {
                roleBadge = `
                <select onchange="changeUserRole('${d.id}', this.value)" class="text-[9px] bg-slate-50 font-bold p-1 rounded mt-1 border border-slate-200">
                    <option value="anggota" ${u.role==='anggota'?'selected':''}>ANGGOTA</option>
                    <option value="sekretaris" ${u.role==='sekretaris'?'selected':''}>SEKRETARIS</option>
                    <option value="bendahara" ${u.role==='bendahara'?'selected':''}>BENDAHARA</option>
                    <option value="wakil_ketua" ${u.role==='wakil_ketua'?'selected':''}>WAKIL</option>
                    <option value="ketua" ${u.role==='ketua'?'selected':''}>KETUA</option>
                </select>`;
            }

            list.innerHTML += `<div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-3"><img src="${u.photo?.url||'https://via.placeholder.com/50'}" class="w-10 h-10 rounded-full object-cover"><div><h4 class="text-xs font-bold text-brand-primary">${u.name}</h4>${roleBadge}</div></div>`;
        });
    }

    // MODULE: EVENTS (Acara)
    async function loadEvents() {
        const list = $("eventList"); list.innerHTML="";
        const btn = $("addEventBtn");
        if(['super_admin','ketua','sekretaris'].includes(ROLE)) { btn.classList.remove('hidden'); btn.onclick = openEventModal; } else btn.classList.add('hidden');

        const snap = await getDocs(query(collection(db,"activities"), orderBy("createdAt","desc")));
        snap.forEach(d => {
            const x = d.data();
            const isPending = x.status==='pending';
            let actBtn = '';
            
            // Delete: Admin/Ketua
            if(['super_admin','ketua'].includes(ROLE)) actBtn += `<button onclick="deleteDocData('activities','${d.id}')" class="absolute bottom-3 right-3 text-red-500 bg-red-50 p-1.5 rounded-full"><span class="material-symbols-rounded text-lg">delete</span></button>`;
            // ACC: Wakil/Admin
            if(['super_admin','wakil_ketua'].includes(ROLE) && isPending) actBtn += `<button onclick="approveDoc('activities','${d.id}')" class="absolute top-3 right-3 bg-green-500 text-white p-1.5 rounded-full shadow-lg animate-pulse"><span class="material-symbols-rounded text-lg">check</span></button>`;
            
            list.innerHTML += `<div class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-100 relative overflow-hidden group"><div class="absolute top-0 left-0 w-1.5 h-full ${isPending?'bg-orange-400':'bg-green-500'}"></div><h3 class="text-sm font-bold text-brand-primary pr-8">${x.title}</h3><p class="text-xs text-slate-500 mt-1 font-medium">${x.date} | ${x.location}</p>${actBtn}</div>`;
        });
    }
    
    window.openEventModal = () => {
        const html = `<input id="eTitle" class="w-full p-3 bg-slate-50 rounded-xl mb-3 font-bold outline-none" placeholder="Nama Acara"><input id="eDate" type="date" class="w-full p-3 bg-slate-50 rounded-xl mb-3 outline-none text-xs font-bold text-slate-500"><input id="eLoc" class="w-full p-3 bg-slate-50 rounded-xl outline-none font-bold" placeholder="Lokasi">`;
        showModal("Buat Acara", html, async () => {
            if(!$("eTitle").value) return showToast("Judul wajib diisi!", "error");
            await addDoc(collection(db,"activities"), { title:$("eTitle").value, date:$("eDate").value, location:$("eLoc").value, status:(ROLE==='ketua'||ROLE==='super_admin'?'approved':'pending'), createdAt:serverTimestamp() });
            closeModal(); loadEvents(); showToast("Acara ditambahkan!", "success");
        });
    }

    // MODULE: SEKRETARIAT (Arsip)
    window.loadSecretariat = async (type) => {
        currentSecTab = type;
        ['Min','Let','Arc'].forEach(t => $(`tab${t}`).className = "flex-1 py-2.5 rounded-xl text-[10px] font-bold text-slate-400 hover:text-brand-primary transition-all");
        $(`tab${type.substring(0,3).charAt(0).toUpperCase() + type.substring(1,3)}`).className = "flex-1 py-2.5 rounded-xl text-[10px] font-bold bg-brand-primary text-white shadow-md transition-all";
        
        const list = $("secList"); list.innerHTML = "";
        const colMap = { minutes: 'minutes', letters: 'letters', archives: 'archives' };
        
        const snap = await getDocs(query(collection(db, colMap[type]), orderBy("createdAt","desc")));
        snap.forEach(d => {
            const x = d.data();
            list.innerHTML += `<div class="bg-white p-4 rounded-2xl border border-slate-100 relative shadow-sm"><h4 class="font-bold text-sm text-brand-primary pr-6">${x.title||x.subject}</h4><p class="text-xs text-slate-400 mt-1">${x.body||x.number||'File Arsip'}</p>${x.file?`<a href="${x.file.url}" target="_blank" class="text-[10px] text-blue-600 font-bold mt-2 inline-block bg-blue-50 px-2 py-1 rounded">DOWNLOAD FILE</a>`:''}<button onclick="deleteDocData('${colMap[type]}','${d.id}')" class="absolute top-3 right-3 text-red-400 hover:text-red-600"><span class="material-symbols-rounded text-lg">close</span></button></div>`;
        });
    }
    
    window.openSecModal = (type) => {
        let html = '';
        if(type==='minutes') html = `<input id="sT" class="w-full p-3 bg-slate-50 rounded-xl mb-2 font-bold outline-none" placeholder="Judul Rapat"><textarea id="sB" class="w-full p-3 bg-slate-50 rounded-xl h-24 outline-none" placeholder="Hasil rapat..."></textarea>`;
        else if(type==='letters') html = `<input id="sS" class="w-full p-3 bg-slate-50 rounded-xl mb-2 font-bold outline-none" placeholder="Perihal"><input id="sN" class="w-full p-3 bg-slate-50 rounded-xl outline-none" placeholder="No. Surat">`;
        else html = `<input id="sT" class="w-full p-3 bg-slate-50 rounded-xl mb-2 font-bold outline-none" placeholder="Nama Dokumen"><input id="sF" type="file" class="text-xs w-full">`;
        
        showModal("Tambah Data", html, async () => {
            let d = { createdAt:serverTimestamp() };
            if(type==='minutes') { d.title=$("sT").value; d.body=$("sB").value; }
            else if(type==='letters') { d.subject=$("sS").value; d.number=$("sN").value; }
            else { d.title=$("sT").value; if($("sF").files[0]) d.file = await upload($("sF").files[0]); }
            
            await addDoc(collection(db, type==='minutes'?'minutes':type==='letters'?'letters':'archives'), d); 
            closeModal(); loadSecretariat(type); showToast("Data disimpan", "success");
        });
    }

    // MODULE: RAFFLE (Titik Kumpul)
    async function loadRaffle() {
        const hSnap = await getDocs(query(collection(db,"raffle_history"), orderBy("createdAt","desc")));
        if(!hSnap.empty) $("raffleWinner").textContent = hSnap.docs[0].data().winnerName;
        const list = $("raffleHistory"); list.innerHTML = "";
        hSnap.forEach(d => list.innerHTML += `<div class="flex justify-between p-3 bg-white rounded-xl border border-slate-100 shadow-sm"><span class="text-xs font-bold text-brand-primary">${d.data().winnerName}</span><span class="text-[10px] text-slate-400 font-medium">${new Date(d.data().createdAt.seconds*1000).toLocaleDateString()}</span></div>`);
    }

    window.runRaffle = async () => {
        const btn = $("raffleBtn"); btn.classList.add('shaking'); btn.disabled=true; btn.innerHTML = "MENGACAK...";
        const uSnap = await getDocs(collection(db,"users"));
        const users = []; uSnap.forEach(d=>users.push(d.data()));
        
        setTimeout(async()=>{
            const win = users[Math.floor(Math.random()*users.length)];
            await addDoc(collection(db,"raffle_history"), { winnerName: win.name, createdAt:serverTimestamp() });
            $("raffleWinner").textContent = win.name;
            btn.classList.remove('shaking'); btn.disabled=false; btn.innerHTML = '<span class="material-symbols-rounded">casino</span> KOCOK UNDIAN';
            loadRaffle();
            showToast(`Terpilih: ${win.name}`, "success");
        }, 2000);
    }

    // MODULE: INVENTORY
    async function loadInventory() {
        const list = $("invList"); list.innerHTML = "";
        const snap = await getDocs(collection(db,"inventory"));
        snap.forEach(d => {
            const i = d.data();
            list.innerHTML += `<div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm relative"><h4 class="font-bold text-sm text-brand-primary">${i.name}</h4><p class="text-xs text-slate-500">${i.qty} Unit</p><button onclick="deleteDocData('inventory','${d.id}')" class="absolute bottom-3 right-3 text-red-500 text-[10px] bg-red-50 px-2 py-0.5 rounded font-bold">Hapus</button></div>`;
        });
    }
    window.openInventoryModal = () => {
        const html = `<input id="iN" class="w-full p-3 bg-slate-50 rounded-xl mb-2 font-bold outline-none" placeholder="Nama Barang"><input id="iQ" class="w-full p-3 bg-slate-50 rounded-xl outline-none" placeholder="Jumlah">`;
        showModal("Tambah Aset", html, async()=>{ await addDoc(collection(db,"inventory"), {name:$("iN").value, qty:$("iQ").value}); closeModal(); loadInventory(); showToast("Aset ditambah", "success"); });
    }

    // --- 7. GLOBAL UTILS ---
    window.showToast = (msg, type='info') => {
        const c = $("toastContainer"); const el = document.createElement("div");
        const color = type==='error'?'bg-red-500':(type==='success'?'bg-green-500':'bg-brand-primary');
        const icon = type==='error'?'error':(type==='success'?'check_circle':'info');
        el.className = `flex items-center gap-3 p-4 rounded-2xl shadow-xl text-white ${color} animate-[slideUp_0.3s_ease-out] backdrop-blur-md bg-opacity-95`;
        el.innerHTML = `<span class="material-symbols-rounded">${icon}</span><p class="text-xs font-bold">${msg}</p>`;
        c.appendChild(el); c.style.pointerEvents = 'auto';
        setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
    }

    window.showModal = (t,b,f) => { $("modalTitle").innerText=t; $("modalBody").innerHTML=b; const btn=$("modalSubmitBtn"); if(f){ btn.style.display='block'; const n=btn.cloneNode(true); btn.parentNode.replaceChild(n,btn); n.onclick=f; } else btn.style.display='none'; $("crudModal").classList.remove('hidden'); $("crudModal").classList.add('flex'); }
    window.closeModal = () => $("crudModal").classList.add('hidden');
    
    window.deleteDocData = async (c,i) => { if(confirm("Hapus permanen?")) { await deleteDoc(doc(db,c,i)); switchView(c==='minutes'||c==='letters'||c==='archives'?'secretariat':c); showToast("Dihapus", "success"); } }
    window.approveDoc = async (c,i) => { await updateDoc(doc(db,c,i), {status:'approved'}); switchView(c); showToast("Disetujui!", "success"); }
    window.changeUserRole = async (uid, r) => { await updateDoc(doc(db,"users",uid), {role:r}); showToast("Role diupdate", "success"); }
    
    window.upload = async (f) => { const fd=new FormData(); fd.append("file",f); fd.append("upload_preset",UPLOAD_PRESET); const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:"POST",body:fd}); const d=await r.json(); return {url:d.secure_url}; }
    window.filterUsers = (q) => { Array.from($("userList").children).forEach(e => e.style.display = e.innerText.toLowerCase().includes(q.toLowerCase()) ? 'flex' : 'none'); }
    
    window.saveProfile = async () => {
         try {
             const d = { name:$("editName").value, phone:$("editPhone").value, address:$("editAddress").value };
             if(newProfileFile) d.photo = await upload(newProfileFile);
             await updateDoc(doc(db,"users", ME.uid), d);
             showToast("Profil berhasil disimpan", "success"); setTimeout(()=>location.reload(),1000);
         } catch(e) { showToast("Gagal menyimpan", "error"); }
    }
    window.previewProfileImage = (i) => { if(i.files[0]) { newProfileFile = i.files[0]; const r=new FileReader(); r.onload=(e)=>$("profileImage").src=e.target.result; r.readAsDataURL(i.files[0]); } }
    
    window.showIdCard = () => {
        const html = `<div class="w-full aspect-[1.586] rounded-2xl relative overflow-hidden text-white shadow-2xl transition-transform hover:scale-105 duration-500"><div class="absolute inset-0 bg-gradient-to-br from-slate-900 to-black"></div><div class="absolute inset-0 p-5 flex flex-col justify-between z-10"><div class="flex justify-between"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded bg-white/10 backdrop-blur-md flex items-center justify-center font-black text-xs">K</div><span class="text-[10px] tracking-[0.2em] font-bold opacity-70">KARTEJI MEMBER</span></div></div><div class="flex gap-4 items-center mt-4"><div class="w-16 h-16 rounded-xl overflow-hidden border-2 border-white/20 shadow-lg"><img src="${ME.photo?.url||'https://via.placeholder.com/100'}" class="w-full h-full object-cover"></div><div><h3 class="text-lg font-bold leading-none mb-1 uppercase">${ME.name}</h3><p class="text-[10px] text-accent font-bold tracking-wider">${ROLES[ROLE].label.toUpperCase()}</p><p class="text-[8px] text-slate-400 mt-1 font-mono">${ME.uid.substring(0,12).toUpperCase()}</p></div></div></div></div><p class="text-center text-xs text-slate-400 mt-4">Tunjukkan kartu ini saat kegiatan.</p>`;
        showModal("ID Card Digital", html, null);
    }
    
    $("logoutBtn").onclick = () => signOut(auth).then(()=>location.href="login.html");
  </script>
</body>
</html>
