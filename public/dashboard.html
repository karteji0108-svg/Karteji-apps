<!DOCTYPE html>
<html lang="id" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Dashboard Ultimate | KARTEJI</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          colors: {
            brand: { primary: '#0F172A', secondary: '#1E293B' },
            accent: { DEFAULT: '#F97316', hover: '#EA580C' },
            dark: { bg: '#0F172A', card: '#1E293B', text: '#F8FAFC' }
          },
          animation: { 
            'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
            'marquee': 'marquee 15s linear infinite'
          },
          keyframes: {
            slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
            marquee: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(-100%)' } }
          }
        }
      }
    }
  </script>

  <style>
    /* Base Styles */
    body { -webkit-tap-highlight-color: transparent; transition: background-color 0.3s, color 0.3s; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    /* Dark Mode Transitions */
    .light body { background-color: #F8FAFC; color: #1E293B; }
    .dark body { background-color: #0F172A; color: #F8FAFC; }
    
    /* Glass Components */
    .glass-nav {
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      border-top: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 -4px 30px rgba(0,0,0,0.1);
    }
    .light .glass-nav { background: rgba(255, 255, 255, 0.85); border-top-color: rgba(255,255,255,0.5); }
    .dark .glass-nav { background: rgba(15, 23, 42, 0.85); border-top-color: rgba(255,255,255,0.05); }

    /* Cards */
    .card { transition: all 0.3s ease; }
    .light .card { background: white; border: 1px solid #F1F5F9; }
    .dark .card { background: #1E293B; border: 1px solid #334155; }
    
    /* View Transition */
    .view-section { display: none; opacity: 0; transform: translateY(10px); transition: all 0.4s ease; }
    .view-section.active { display: block; opacity: 1; transform: translateY(0); }

    /* Utilities */
    .nav-btn.active span { font-variation-settings: 'FILL' 1; color: #F97316; }
    .chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 13px; line-height: 1.5; margin-bottom: 6px; }
    .chat-me { background: linear-gradient(135deg, #F97316, #EA580C); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-other { align-self: flex-start; border-bottom-left-radius: 4px; }
    .light .chat-other { background: white; border: 1px solid #E2E8F0; color: #334155; }
    .dark .chat-other { background: #334155; border: 1px solid #475569; color: white; }

    /* Animations */
    .animate-spin-slow { animation: spin 3s linear infinite; }
  </style>
</head>

<body class="min-h-screen relative overflow-x-hidden pb-28 font-sans">

  <div class="bg-brand-primary text-white text-[10px] py-1 overflow-hidden sticky top-0 z-50">
      <div class="whitespace-nowrap animate-marquee font-bold tracking-wider">
          ðŸ“¢ PENGUMUMAN: Rapat bulanan diadakan tanggal 25 â€¢ Iuran kas harap dilunasi sebelum tgl 10 â€¢ Jaga kebersihan lingkungan bersama! â€¢ Info lebih lanjut hubungi Sekretaris.
      </div>
  </div>

  <div id="globalLoader" class="fixed inset-0 bg-white/90 dark:bg-slate-900/90 z-[9999] flex items-center justify-center flex-col gap-4 backdrop-blur-md hidden">
    <div class="w-16 h-16 border-4 border-slate-200 border-t-accent rounded-full animate-spin"></div>
    <p class="text-xs font-bold animate-pulse">MEMUAT SYSTEM...</p>
  </div>
  
  <div id="sosOverlay" class="fixed inset-0 bg-red-600/95 z-[9998] hidden flex-col items-center justify-center text-white text-center p-8 z-[10000] backdrop-blur-xl">
      <span class="material-symbols-rounded text-8xl animate-pulse mb-4">campaign</span>
      <h1 class="text-4xl font-black mb-2">DARURAT!</h1>
      <p class="text-lg" id="sosMessage">Seseorang membutuhkan bantuan.</p>
      <button onclick="stopSOS()" class="mt-10 bg-white text-red-600 px-10 py-4 rounded-full font-bold shadow-2xl">SAYA MENGERTI</button>
  </div>

  <div id="crudModal" class="fixed inset-0 z-[60] hidden items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm transition-all p-4">
    <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-[2rem] p-6 relative shadow-2xl animate-slide-up">
      <div class="flex justify-between items-center mb-6">
          <h2 id="modalTitle" class="text-lg font-bold text-brand-primary dark:text-white uppercase">Judul</h2>
          <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center"><span class="material-symbols-rounded text-xl">close</span></button>
      </div>
      <div id="modalBody" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar"></div>
      <button id="modalSubmitBtn" class="mt-6 w-full rounded-2xl bg-brand-primary text-white py-4 text-sm font-bold shadow-lg">SIMPAN</button>
    </div>
  </div>

  <header class="sticky top-6 z-30 px-6 pt-4 pb-2">
      <div class="flex justify-between items-center">
          <div class="flex items-center gap-3">
              <button onclick="switchView('profile')" class="relative active:scale-95 transition-transform">
                <img id="headerPhoto" class="w-10 h-10 rounded-full border-2 border-white dark:border-slate-600 shadow-sm object-cover" src="https://via.placeholder.com/100">
                <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full"></div>
              </button>
              <div>
                  <div class="flex items-center gap-1.5">
                    <p id="headerRole" class="text-[9px] font-bold text-accent uppercase tracking-widest bg-orange-50 dark:bg-slate-700 px-2 py-0.5 rounded-full w-fit">...</p>
                    <div id="xpBadge" class="text-[9px] font-black text-white bg-gradient-to-r from-blue-500 to-indigo-600 px-2 py-0.5 rounded-full">LVL 1</div>
                  </div>
                  <h1 id="headerName" class="text-lg font-extrabold leading-tight truncate max-w-[150px]">...</h1>
              </div>
          </div>
          <div class="flex gap-2">
            <button onclick="toggleTheme()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-700 dark:text-yellow-400 flex items-center justify-center transition-colors">
                <span class="material-symbols-rounded text-lg" id="themeIcon">dark_mode</span>
            </button>
            <button onclick="triggerKentongan()" class="w-9 h-9 rounded-full bg-red-50 text-red-500 border border-red-100 flex items-center justify-center hover:bg-red-500 hover:text-white transition-colors shadow-sm">
                <span class="material-symbols-rounded text-lg">campaign</span>
            </button>
          </div>
      </div>
  </header>

  <main class="px-5 mt-4 relative z-10 pb-10" id="mainContainer">
      
      <section id="view-home" class="view-section active">
          
          <div class="bg-gradient-to-r from-blue-500 to-cyan-400 rounded-3xl p-5 text-white shadow-lg mb-4 flex justify-between items-center relative overflow-hidden">
              <div class="absolute -right-5 -bottom-5 opacity-20"><span class="material-symbols-rounded text-8xl">cloud</span></div>
              <div>
                  <p class="text-xs font-medium opacity-90" id="currentDate">Senin, 1 Jan</p>
                  <h2 class="text-3xl font-black mt-1" id="clockDisplay">00:00</h2>
                  <p class="text-sm font-bold mt-1 flex items-center gap-1"><span class="material-symbols-rounded text-sm">location_on</span> Jakarta, 29Â°C</p>
              </div>
              <div class="text-right z-10">
                  <span class="material-symbols-rounded text-4xl mb-1">partly_cloudy_day</span>
                  <p class="text-[10px] font-bold uppercase tracking-widest">Cerah Berawan</p>
              </div>
          </div>

          <div id="homeContentArea"></div>
          
          <div class="grid grid-cols-2 gap-3 mt-4">
               <div class="card p-4 rounded-2xl shadow-sm">
                   <div class="flex items-center gap-2 mb-2 text-brand-primary dark:text-white">
                       <span class="material-symbols-rounded text-purple-500">local_police</span>
                       <h3 class="font-bold text-xs">Piket Hari Ini</h3>
                   </div>
                   <p id="rondaDisplay" class="text-sm font-bold text-slate-500 dark:text-slate-400">Memuat...</p>
               </div>
               
               <div class="card p-4 rounded-2xl shadow-sm">
                   <div class="flex items-center gap-2 mb-2 text-brand-primary dark:text-white">
                       <span class="material-symbols-rounded text-pink-500">cake</span>
                       <h3 class="font-bold text-xs">Ultah Bulan Ini</h3>
                   </div>
                   <div id="bdayList" class="flex -space-x-2 overflow-hidden">
                       <div class="w-6 h-6 rounded-full bg-slate-200 border-2 border-white flex items-center justify-center text-[8px]">0</div>
                   </div>
                   <p class="text-[9px] text-slate-400 mt-1" id="bdayCount">Tidak ada</p>
               </div>
          </div>

          <div class="mt-6">
              <h3 class="font-bold text-brand-primary dark:text-white mb-3 px-1">Menu Cepat</h3>
              <div class="grid grid-cols-4 gap-3">
                  <button onclick="switchView('playground')" class="card p-3 rounded-2xl flex flex-col items-center gap-2 active:scale-95 group">
                      <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center group-hover:bg-blue-500 group-hover:text-white transition-colors"><span class="material-symbols-rounded">poll</span></div>
                      <span class="text-[10px] font-bold text-slate-500">Voting</span>
                  </button>
                  <button onclick="switchView('finance')" class="card p-3 rounded-2xl flex flex-col items-center gap-2 active:scale-95 group">
                      <div class="w-10 h-10 rounded-full bg-green-50 text-green-500 flex items-center justify-center group-hover:bg-green-500 group-hover:text-white transition-colors"><span class="material-symbols-rounded">payments</span></div>
                      <span class="text-[10px] font-bold text-slate-500">Bayar</span>
                  </button>
                  <button onclick="switchView('events')" class="card p-3 rounded-2xl flex flex-col items-center gap-2 active:scale-95 group">
                      <div class="w-10 h-10 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center group-hover:bg-purple-500 group-hover:text-white transition-colors"><span class="material-symbols-rounded">event</span></div>
                      <span class="text-[10px] font-bold text-slate-500">Acara</span>
                  </button>
                  <button onclick="openReportModal()" class="card p-3 rounded-2xl flex flex-col items-center gap-2 active:scale-95 group">
                      <div class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center group-hover:bg-red-500 group-hover:text-white transition-colors"><span class="material-symbols-rounded">report_problem</span></div>
                      <span class="text-[10px] font-bold text-slate-500">Lapor</span>
                  </button>
              </div>
          </div>
      </section>

      <section id="view-finance" class="view-section">
          <div class="flex justify-between items-center mb-6">
            <div><h2 class="text-xl font-extrabold text-brand-primary dark:text-white">Keuangan</h2><p class="text-xs text-slate-400">Laporan Kas</p></div>
            <div class="flex gap-2">
                <button onclick="toggleCalc()" class="w-8 h-8 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center"><span class="material-symbols-rounded text-lg">calculate</span></button>
                <button onclick="window.print()" class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center"><span class="material-symbols-rounded text-lg">print</span></button>
                <div id="financeControls"></div>
            </div>
          </div>

          <div class="card p-4 rounded-3xl mb-4 relative">
              <h3 class="font-bold text-sm mb-2 text-center dark:text-white">Arus Kas Bulan Ini</h3>
              <div class="h-48 relative"><canvas id="financeChart"></canvas></div>
          </div>
          
          <div id="simpleCalc" class="hidden card p-4 rounded-2xl mb-4 bg-slate-800 text-white">
              <input id="calcRes" readonly class="w-full bg-transparent text-right text-2xl font-mono mb-2 border-b border-slate-600" value="0">
              <div class="grid grid-cols-4 gap-2 text-center text-sm font-bold">
                  <div onclick="$('calcRes').value=''" class="bg-red-500 p-2 rounded">C</div>
                  <div onclick="$('calcRes').value+='/'" class="bg-slate-600 p-2 rounded">/</div>
                  <div onclick="$('calcRes').value+='*'" class="bg-slate-600 p-2 rounded">x</div>
                  <div onclick="$('calcRes').value=eval($('calcRes').value)" class="bg-green-500 p-2 rounded">=</div>
                  <div onclick="$('calcRes').value+='1'" class="bg-slate-700 p-2 rounded">1</div>
                  <div onclick="$('calcRes').value+='2'" class="bg-slate-700 p-2 rounded">2</div>
                  <div onclick="$('calcRes').value+='3'" class="bg-slate-700 p-2 rounded">3</div>
                  <div onclick="$('calcRes').value+='+'" class="bg-slate-600 p-2 rounded">+</div>
                  <div onclick="$('calcRes').value+='0'" class="bg-slate-700 p-2 rounded col-span-2">0</div>
                  <div onclick="$('calcRes').value+='-'" class="bg-slate-600 p-2 rounded">-</div>
              </div>
          </div>

          <div class="card p-3 rounded-xl mb-4 flex items-center justify-between bg-yellow-50 border-yellow-200">
              <div class="flex items-center gap-3">
                  <span class="material-symbols-rounded text-yellow-600 text-2xl">emoji_events</span>
                  <div><p class="text-xs font-bold text-yellow-800">Top Sultan (Donatur)</p><p id="topSultanName" class="text-[10px] text-yellow-600">Memuat...</p></div>
              </div>
          </div>

          <div id="finList" class="space-y-3 pb-20"></div>
      </section>

      <section id="view-playground" class="view-section">
          <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-[2rem] p-6 text-white shadow-lg relative overflow-hidden mb-6">
              <h2 class="text-2xl font-black mb-1">Zona Seru</h2>
              <p class="text-indigo-100 text-xs">Misi harian, voting, dan pasar warga.</p>
          </div>
          
          <div class="card rounded-[2rem] p-5 shadow-sm mb-4">
              <h3 class="font-bold dark:text-white flex items-center gap-2 mb-4"><span class="material-symbols-rounded text-yellow-500">task_alt</span> Misi Harian</h3>
              <div onclick="claimMission('login')" class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-xl mb-2 cursor-pointer active:scale-95">
                  <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><span class="material-symbols-rounded text-sm">login</span></div><div><p class="text-xs font-bold dark:text-white">Login Harian</p></div></div>
                  <span class="text-[10px] font-bold text-slate-400 bg-white dark:bg-slate-800 px-2 py-1 rounded">+10 XP</span>
              </div>
          </div>

          <div class="card rounded-[2rem] p-5 shadow-sm">
             <div class="flex justify-between items-center mb-4">
                 <h3 class="font-bold dark:text-white flex items-center gap-2"><span class="material-symbols-rounded text-blue-500">how_to_vote</span> Voting</h3>
                 <button onclick="createPoll()" class="text-[10px] font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded-lg">+ Buat</button>
             </div>
             <div id="pollList" class="space-y-4"></div>
          </div>
      </section>

      <section id="view-users" class="view-section">
          <h2 class="text-xl font-extrabold text-brand-primary dark:text-white mb-4">Anggota</h2>
          <div id="userList" class="space-y-3 pb-20"></div>
      </section>

      <section id="view-events" class="view-section">
           <div class="flex justify-between items-center mb-6">
            <div><h2 class="text-xl font-extrabold text-brand-primary dark:text-white">Agenda</h2></div>
            <div id="eventControls"></div>
          </div>
          <div id="actList" class="grid grid-cols-1 gap-4 pb-20"></div>
      </section>

      <section id="view-profile" class="view-section">
        <div class="flex flex-col items-center pt-8 pb-20">
            <img id="profileImage" src="https://via.placeholder.com/150" class="w-28 h-28 rounded-full object-cover border-4 border-white dark:border-slate-700 shadow-xl mb-4">
            <h2 id="profileNameDisplay" class="text-xl font-black text-brand-primary dark:text-white mb-1">User</h2>
            <div class="flex gap-2 mb-6">
                <div id="profileRoleBadge" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-[10px] font-extrabold uppercase">ROLE</div>
                <div id="profileXpDisplay" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-[10px] font-extrabold uppercase">0 XP</div>
            </div>
            
            <button onclick="showIdCard()" class="bg-slate-800 text-white px-6 py-3 rounded-2xl text-xs font-bold flex gap-2 shadow-lg w-full justify-center max-w-xs mb-6"><span class="material-symbols-rounded text-sm">badge</span> ID CARD DIGITAL</button>
            
            <div class="w-full max-w-xs space-y-3">
                 <input id="editName" class="w-full p-4 card rounded-2xl text-sm font-bold dark:text-white dark:bg-slate-700" placeholder="Nama">
                 <input id="editPhone" class="w-full p-4 card rounded-2xl text-sm font-bold dark:text-white dark:bg-slate-700" placeholder="No HP">
                 <button onclick="saveProfile()" class="w-full bg-brand-primary text-white py-4 rounded-2xl font-bold shadow-lg">SIMPAN</button>
            </div>
        </div>
      </section>

  </main>

  <div id="chatWidget" class="fixed z-[90] bottom-24 right-5 flex flex-col items-end gap-3">
      <div id="chatWindow" class="bg-white dark:bg-slate-800 w-80 h-[400px] rounded-[2rem] shadow-2xl border border-slate-100 dark:border-slate-700 hidden flex-col overflow-hidden animate-slide-up origin-bottom-right">
          <div class="bg-brand-primary text-white p-4 flex justify-between items-center">
              <h3 class="font-bold text-sm">Grup Warga</h3>
              <button onclick="toggleChat()" class="text-white hover:bg-white/10 rounded-full p-1"><span class="material-symbols-rounded">expand_more</span></button>
          </div>
          <div id="chatMessages" class="flex-1 overflow-y-auto p-4 bg-slate-50 dark:bg-slate-900 flex flex-col gap-2"></div>
          <form onsubmit="sendMessage(event)" class="p-3 border-t dark:border-slate-700 bg-white dark:bg-slate-800 flex gap-2">
              <input id="chatInput" class="flex-1 bg-slate-100 dark:bg-slate-700 dark:text-white rounded-full px-4 py-2 text-sm outline-none" autocomplete="off" placeholder="Pesan...">
              <button type="submit" class="w-9 h-9 bg-accent text-white rounded-full flex items-center justify-center"><span class="material-symbols-rounded text-sm">send</span></button>
          </form>
      </div>
      <button onclick="toggleChat()" class="w-14 h-14 bg-brand-primary text-white rounded-2xl flex items-center justify-center shadow-2xl border-4 border-white/20 relative">
          <span class="material-symbols-rounded text-2xl">forum</span>
          <span id="unreadChatBadge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white hidden animate-bounce"></span>
      </button>
  </div>

  <nav class="fixed bottom-0 w-full glass-nav pb-8 pt-3 px-6 z-50 rounded-t-[2.5rem]">
      <div class="flex justify-between items-center max-w-sm mx-auto" id="bottomNavContainer"></div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, addDoc, getDocs, onSnapshot, query, orderBy, limit, where, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs", authDomain: "katar-9cac3.firebaseapp.com", projectId: "katar-9cac3", storageBucket: "katar-9cac3.firebasestorage.app", messagingSenderId: "1017734829960", appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
    const audioBeep = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 

    window.$ = (id) => document.getElementById(id);
    let UID = null, CURRENT_ROLE = null, CURRENT_USER_DATA = null, financeChart = null;

    // --- UTILS & DARK MODE ---
    window.toggleLoader = (show) => { const l=$("globalLoader"); show?(l.classList.remove('hidden'),l.classList.add('flex')):(l.classList.add('hidden'),l.classList.remove('flex')); };
    window.toggleTheme = () => { document.documentElement.classList.toggle('dark'); $("themeIcon").innerText = document.documentElement.classList.contains('dark') ? 'light_mode' : 'dark_mode'; };
    window.closeModal = () => $("crudModal").classList.add('hidden');
    window.showModal = (title, bodyHtml, onSave) => { $("modalTitle").textContent=title; $("modalBody").innerHTML=bodyHtml; $("crudModal").classList.remove('hidden'); $("crudModal").classList.add('flex'); const btn=$("modalSubmitBtn"); const newBtn=btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn); onSave?(newBtn.onclick=onSave,newBtn.style.display='block'):(newBtn.style.display='none'); };

    // --- AUTH ---
    onAuthStateChanged(auth, async user => {
        if(!user) return location.href = "login.html";
        toggleLoader(true);
        try {
            const snap = await getDoc(doc(db,"users",user.uid));
            if(!snap.exists()) { alert("User error"); return signOut(auth); }
            UID = user.uid; CURRENT_USER_DATA = snap.data(); CURRENT_ROLE = CURRENT_USER_DATA.role || "anggota";
            
            $("headerName").textContent = CURRENT_USER_DATA.name;
            $("headerRole").textContent = CURRENT_ROLE.replace('_',' ');
            $("headerPhoto").src = CURRENT_USER_DATA.photo?.url || "https://via.placeholder.com/150";
            
            initFeatures(); buildNav(); switchView('home'); loadProfile();
        } catch(e) { console.error(e); } finally { toggleLoader(false); }
    });

    function initFeatures() {
        startClock(); loadRonda(); startPresence(); initChat(); initSOS();
    }

    // --- FEATURE 2: WEATHER & CLOCK ---
    function startClock() {
        setInterval(() => {
            const now = new Date();
            $("clockDisplay").innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            $("currentDate").innerText = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'short'});
        }, 1000);
    }

    // --- FEATURE 4: JADWAL RONDA OTOMATIS ---
    function loadRonda() {
        const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const today = days[new Date().getDay()];
        const teams = { "Senin": "Blok A", "Selasa": "Blok B", "Rabu": "Blok C", "Kamis": "Blok D", "Jumat": "Blok E", "Sabtu": "Blok F", "Minggu": "Libur / Bebas" };
        $("rondaDisplay").innerText = `${today}: Tim ${teams[today] || 'Umum'}`;
    }

    // --- FEATURE 5: BIRTHDAY REMINDER ---
    async function checkBirthdays() {
        // Mock logic: Fetch users and check if current month matches birth month
        // In real app, store birthDate in user doc
        const snap = await getDocs(collection(db, "users"));
        let count = 0;
        snap.forEach(d => {
            // Simulated check randomly for demo purposes or check actual field
            if(Math.random() > 0.8) count++; 
        });
        if(count > 0) {
            $("bdayCount").innerText = `${count} Warga Ulang Tahun`;
            $("bdayList").innerHTML = `<div class="w-6 h-6 rounded-full bg-pink-500 text-white flex items-center justify-center text-[9px] font-bold">${count}</div>`;
        }
    }

    // --- FEATURE 6: CHART.JS & FEATURE 7: SULTAN ---
    async function loadFinance() {
        const l = $("finList"); l.innerHTML = 'Loading...';
        const snap = await getDocs(query(collection(db,"financial_records"), orderBy("createdAt","desc")));
        l.innerHTML = '';
        let inc = 0, exp = 0;
        const donors = {}; // For Sultan

        snap.forEach(d => {
            const f = d.data();
            const amt = Number(f.amount);
            if(f.type === 'income') { inc += amt; if(f.note) donors[f.note] = (donors[f.note]||0) + amt; }
            else exp += amt;
            
            l.innerHTML += `<div class="card p-3 rounded-xl flex justify-between items-center"><div class="flex gap-3"><div class="w-8 h-8 rounded-full ${f.type==='income'?'bg-green-100 text-green-600':'bg-red-100 text-red-500'} flex items-center justify-center"><span class="material-symbols-rounded text-sm">${f.type==='income'?'arrow_downward':'arrow_upward'}</span></div><div><p class="text-sm font-bold dark:text-white">${f.note}</p><p class="text-[10px] text-slate-400">${f.status}</p></div></div><p class="font-bold ${f.type==='income'?'text-green-600':'text-red-500'}">${f.type==='income'?'+':'-'} ${amt.toLocaleString()}</p></div>`;
        });

        // Update Chart
        const ctx = $("financeChart").getContext('2d');
        if(financeChart) financeChart.destroy();
        financeChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Masuk', 'Keluar'], datasets: [{ data: [inc, exp], backgroundColor: ['#22c55e', '#ef4444'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });

        // Update Sultan
        let topSultan = "-", maxDonation = 0;
        for(const [name, val] of Object.entries(donors)) { if(val > maxDonation) { maxDonation = val; topSultan = name; } }
        $("topSultanName").innerText = topSultan !== "-" ? `${topSultan} (Rp ${maxDonation.toLocaleString()})` : "Belum ada data";

        // Controls
        const canEdit = ['bendahara','super_admin'].includes(CURRENT_ROLE);
        if(canEdit) $("financeControls").innerHTML = `<button onclick="openFinanceModal()" class="w-8 h-8 bg-brand-primary text-white rounded-full flex items-center justify-center shadow">+</button>`;
    }
    
    // FEATURE 8: KALKULATOR
    window.toggleCalc = () => $("simpleCalc").classList.toggle("hidden");

    // FEATURE 9: LAPOR KERUSAKAN
    window.openReportModal = () => {
        const html = `<select id="rType" class="w-full p-3 border rounded-xl mb-2"><option>Lampu Jalan Mati</option><option>Jalan Rusak</option><option>Sampah Numpuk</option><option>Keamanan</option></select><textarea id="rDesc" class="w-full p-3 border rounded-xl" placeholder="Detail Lokasi..."></textarea>`;
        showModal("Lapor Masalah", html, async () => { await addDoc(collection(db,"reports"), {type:$("rType").value, desc:$("rDesc").value, reporter:CURRENT_USER_DATA.name, createdAt:serverTimestamp()}); closeModal(); alert("Laporan diterima!"); });
    }

    // --- STANDARD LOGIC ---
    function startPresence() { updateDoc(doc(db, "users", UID), { lastSeen: serverTimestamp() }); setInterval(() => updateDoc(doc(db, "users", UID), { lastSeen: serverTimestamp() }), 60000); }
    window.createPoll = () => showModal("Buat Voting", `<input id="pq" class="w-full p-3 border rounded-xl mb-2" placeholder="Tanya apa?"><input id="po1" class="w-full p-3 border rounded-xl mb-2" placeholder="Opsi A"><input id="po2" class="w-full p-3 border rounded-xl" placeholder="Opsi B">`, async()=>{ await addDoc(collection(db,"polls"),{q:$("pq").value, ops:{$("po1").value:0, $("po2").value:0}, by:CURRENT_USER_DATA.name, createdAt:serverTimestamp()}); closeModal(); loadPolls(); });
    function loadPolls() { onSnapshot(query(collection(db,"polls"), orderBy("createdAt","desc"), limit(3)), s => { $("pollList").innerHTML = ""; s.forEach(d => { const p=d.data(); let h=`<div class="card p-4 rounded-xl mb-2"><h4 class="font-bold text-sm mb-2 dark:text-white">${p.q}</h4>`; for(let[k,v]of Object.entries(p.ops)) h+=`<div onclick="vote('${d.id}','${k}')" class="bg-slate-100 dark:bg-slate-700 p-2 rounded mb-1 text-xs flex justify-between cursor-pointer"><span>${k}</span><b>${v}</b></div>`; $("pollList").innerHTML+=h+"</div>"; }) }); }
    window.vote = async(id,op) => { const r=doc(db,"polls",id); const s=await getDoc(r); if(s.exists()){ const o=s.data().ops; o[op]++; await updateDoc(r,{ops:o}); } }
    window.claimMission = (k) => { if(localStorage.getItem('m_'+k)) return alert("Sudah diklaim!"); localStorage.setItem('m_'+k,1); updateDoc(doc(db,"users",UID),{xp:increment(10)}); alert("XP +10!"); }

    window.triggerKentongan = async () => { if(confirm("BUNYIKAN SIRINE BAHAYA?")) await addDoc(collection(db,"notifications"), {body:`${CURRENT_USER_DATA.name} BUTUH BANTUAN!`, level:"sos", senderUid:UID, createdAt:serverTimestamp()}); }
    function initSOS() { onSnapshot(query(collection(db,"notifications"), where("level","==","sos"), orderBy("createdAt","desc"), limit(1)), s => { s.docChanges().forEach(c => { if(c.type==="added" && Date.now()-c.doc.data().createdAt.toMillis()<10000 && c.doc.data().senderUid!==UID) { $("sosOverlay").classList.remove("hidden"); $("sosOverlay").classList.add("flex"); $("sosMessage").textContent=c.doc.data().body; audioBeep.play(); } }) }); }
    window.stopSOS = () => { $("sosOverlay").classList.add("hidden"); $("sosOverlay").classList.remove("flex"); audioBeep.pause(); }

    function initChat() { onSnapshot(query(collection(db,"public_chats"), orderBy("createdAt","desc"), limit(30)), s => { const l=$("chatMessages"); l.innerHTML=''; const m=[]; s.forEach(d=>m.push(d.data())); m.reverse().forEach(x=>{ l.innerHTML+=`<div class="chat-bubble ${x.uid===UID?'chat-me':'chat-other'}">${x.text}</div>`; }); l.scrollTop=l.scrollHeight; }); }
    window.toggleChat = () => { $("chatWindow").classList.toggle("hidden"); $("chatWindow").classList.toggle("flex"); }
    window.sendMessage = async(e) => { e.preventDefault(); if($("chatInput").value.trim()){ await addDoc(collection(db,"public_chats"),{text:$("chatInput").value, uid:UID, createdAt:serverTimestamp()}); $("chatInput").value=''; } }

    async function loadUsers() {
        const l=$("userList"); l.innerHTML='Loading...'; const s=await getDocs(query(collection(db,"users"), orderBy("name"))); l.innerHTML='';
        s.forEach(d=>{ const u=d.data(); l.innerHTML+=`<div class="card p-3 rounded-xl flex items-center gap-3"><img src="${u.photo?.url||'https://via.placeholder.com/50'}" class="w-10 h-10 rounded-full object-cover"><div><p class="font-bold text-sm dark:text-white">${u.name}</p><p class="text-[10px] text-slate-500 uppercase">${u.role||'Anggota'}</p></div></div>`; });
    }
    
    async function loadEvents() {
        const l=$("actList"); l.innerHTML=''; const s=await getDocs(query(collection(db,"activities"), orderBy("createdAt","desc")));
        s.forEach(d=>{ const x=d.data(); l.innerHTML+=`<div class="card p-4 rounded-xl flex gap-3"><div class="bg-blue-50 text-blue-600 p-3 rounded-lg text-center min-w-[60px]"><b class="block text-lg">${new Date(x.date).getDate()}</b><small>${new Date(x.date).toLocaleString('default',{month:'short'})}</small></div><div><h4 class="font-bold dark:text-white">${x.title}</h4><p class="text-xs text-slate-400">${x.location}</p></div></div>`; });
        if(['koordinator','super_admin'].includes(CURRENT_ROLE)) $("eventControls").innerHTML=`<button onclick="openEventModal()" class="w-8 h-8 bg-purple-600 text-white rounded-full flex items-center justify-center shadow">+</button>`;
    }
    window.openEventModal = () => showModal("Agenda", `<input id="et" class="w-full p-3 border rounded-xl mb-2" placeholder="Judul"><input type="date" id="ed" class="w-full p-3 border rounded-xl mb-2"><input id="el" class="w-full p-3 border rounded-xl" placeholder="Lokasi">`, async()=>{ await addDoc(collection(db,"activities"),{title:$("et").value, date:$("ed").value, location:$("el").value, createdAt:serverTimestamp()}); closeModal(); loadEvents(); });
    window.openFinanceModal = () => showModal("Kas", `<select id="ft" class="w-full p-3 border rounded-xl mb-2"><option value="income">Masuk</option><option value="expense">Keluar</option></select><input id="fa" type="number" class="w-full p-3 border rounded-xl mb-2" placeholder="Jumlah"><input id="fn" class="w-full p-3 border rounded-xl" placeholder="Ket">`, async()=>{ await addDoc(collection(db,"financial_records"),{type:$("ft").value, amount:$("fa").value, note:$("fn").value, status:'pending', createdAt:serverTimestamp()}); closeModal(); loadFinance(); });

    function buildNav() {
        const m=[{id:'home',i:'dashboard',l:'Home'},{id:'playground',i:'rocket_launch',l:'Seru'},{id:'users',i:'group',l:'Warga'},{id:'finance',i:'account_balance_wallet',l:'Kas'},{id:'profile',i:'person',l:'Saya'}];
        $("bottomNavContainer").innerHTML = m.map(x=>`<button onclick="switchView('${x.id}')" class="nav-btn flex flex-col items-center gap-1 w-14" data-target="${x.id}"><span class="material-symbols-rounded text-2xl text-slate-400 transition-colors">${x.i}</span></button>`).join('');
    }
    window.switchView = (id) => {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); $(`view-${id}`).classList.add('active');
        document.querySelectorAll('.nav-btn span').forEach(s=>s.style.color=''); document.querySelector(`[data-target="${id}"] span`).style.color='#F97316';
        if(id==='finance') loadFinance(); if(id==='users') loadUsers(); if(id==='events') loadEvents(); if(id==='playground') loadPolls(); if(id==='home') { checkBirthdays(); }
    }
    async function loadProfile() { $("editName").value=CURRENT_USER_DATA.name; $("editPhone").value=CURRENT_USER_DATA.phone; }
    window.saveProfile = async () => { toggleLoader(true); await updateDoc(doc(db,"users",UID),{name:$("editName").value, phone:$("editPhone").value}); toggleLoader(false); alert("Disimpan"); }
    window.showIdCard = () => showModal("ID Card", `<div class="bg-slate-800 text-white p-6 rounded-2xl text-center"><h2 class="text-2xl font-bold">${CURRENT_USER_DATA.name}</h2><p>${CURRENT_ROLE}</p></div>`, null);
    $("logoutBtn").onclick = () => signOut(auth);
  </script>
</body>
</html>
