<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KARTEJI ULTIMATE | Sistem Organisasi Terpadu</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/id.js"></script> <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          colors: {
            brand: { dark: '#0F172A', primary: '#334155', light: '#F8FAFC' },
            accent: { DEFAULT: '#F97316', hover: '#EA580C', soft: '#FFEDD5' },
            success: '#10B981', danger: '#EF4444', warning: '#F59E0B', info: '#3B82F6'
          },
          animation: {
            'blob': 'blob 10s infinite',
            'float': 'float 6s ease-in-out infinite',
            'spin-slow': 'spin 3s linear infinite',
            'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards'
          },
          keyframes: {
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
              '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            pop: {
              '0%': { transform: 'scale(0.5)', opacity: 0 },
              '100%': { transform: 'scale(1)', opacity: 1 }
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Custom Scrollbar & Glassmorphism */
    body { -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .glass {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .dark .glass {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .glass-strong {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(0,0,0,0.05);
    }
    .dark .glass-strong {
      background: rgba(15, 23, 42, 0.95);
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .nav-item.active { color: #F97316; }
    .nav-item.active .icon-box { background-color: #FFEDD5; color: #F97316; }
    .dark .nav-item.active .icon-box { background-color: #7c2d12; color: #fb923c; }
    
    /* Transitions */
    .view-section { display: none; opacity: 0; transform: translateY(10px); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .view-section.active { display: block; opacity: 1; transform: translateY(0); }
  </style>
</head>

<body class="bg-brand-light dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen relative overflow-x-hidden selection:bg-accent selection:text-white transition-colors duration-300">

  <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
    <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-blue-400/20 rounded-full mix-blend-multiply filter blur-[100px] animate-blob"></div>
    <div class="absolute top-[20%] right-[-10%] w-96 h-96 bg-orange-400/20 rounded-full mix-blend-multiply filter blur-[100px] animate-blob animation-delay-2000"></div>
    <div class="absolute bottom-[-10%] left-[20%] w-96 h-96 bg-purple-400/20 rounded-full mix-blend-multiply filter blur-[100px] animate-blob animation-delay-4000"></div>
  </div>

  <div id="globalLoader" class="fixed inset-0 bg-white/90 dark:bg-slate-900/90 z-[9999] flex items-center justify-center flex-col gap-4 backdrop-blur-md transition-all duration-300">
    <div class="relative w-20 h-20">
      <div class="absolute inset-0 border-4 border-slate-200 dark:border-slate-700 rounded-full"></div>
      <div class="absolute inset-0 border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
      <div class="absolute inset-0 flex items-center justify-center">
        <span class="material-symbols-rounded text-accent animate-pulse">bolt</span>
      </div>
    </div>
    <p class="text-xs font-bold text-slate-400 tracking-widest animate-pulse">KARTEJI SYSTEM</p>
  </div>

  <section id="authScreen" class="fixed inset-0 z-[5000] bg-brand-light dark:bg-slate-900 flex items-center justify-center p-6">
    <div class="w-full max-w-sm glass rounded-[2.5rem] p-8 shadow-2xl relative overflow-hidden animate-pop">
      <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-accent to-purple-500"></div>
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-br from-accent to-orange-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-orange-500/30 mb-4 transform rotate-3 hover:rotate-0 transition-all duration-500">
          <span class="material-symbols-rounded text-4xl text-white">diversity_3</span>
        </div>
        <h1 class="text-3xl font-black text-slate-800 dark:text-white tracking-tight">KARTEJI</h1>
        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Sistem Organisasi Terpadu</p>
      </div>

      <div class="space-y-4">
        <div class="group">
          <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Email Akses</label>
          <div class="relative">
            <span class="material-symbols-rounded absolute left-4 top-3.5 text-slate-400 group-focus-within:text-accent transition-colors">mail</span>
            <input type="email" id="loginEmail" class="w-full pl-12 pr-4 py-3.5 bg-slate-50 dark:bg-slate-800 border-2 border-transparent focus:border-accent rounded-xl outline-none text-sm font-bold transition-all" placeholder="nama@organisasi.com">
          </div>
        </div>
        <div class="group">
          <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Kode Sandi</label>
          <div class="relative">
            <span class="material-symbols-rounded absolute left-4 top-3.5 text-slate-400 group-focus-within:text-accent transition-colors">lock</span>
            <input type="password" id="loginPass" class="w-full pl-12 pr-4 py-3.5 bg-slate-50 dark:bg-slate-800 border-2 border-transparent focus:border-accent rounded-xl outline-none text-sm font-bold transition-all" placeholder="••••••••">
          </div>
        </div>
        <button id="btnLogin" class="w-full bg-gradient-to-r from-accent to-orange-600 text-white py-4 rounded-xl font-bold text-sm shadow-xl shadow-orange-500/30 hover:shadow-orange-500/50 active:scale-95 transition-all mt-4 flex items-center justify-center gap-2">
          MASUK SISTEM <span class="material-symbols-rounded">login</span>
        </button>
      </div>
      <p class="text-center text-[10px] text-slate-400 mt-8">© 2025 Karteji Ultimate v3.0</p>
    </div>
  </section>

  <div id="appContainer" class="hidden relative z-10 pb-24">
    
    <header class="sticky top-0 z-40 px-6 pt-6 pb-2 glass-strong transition-all duration-300">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="relative cursor-pointer group" onclick="app.router('profile')">
            <img id="headAvatar" src="https://via.placeholder.com/100" class="w-12 h-12 rounded-full object-cover border-2 border-white dark:border-slate-700 shadow-md group-hover:scale-105 transition-transform">
            <div id="headStatus" class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-success border-2 border-white dark:border-slate-800 rounded-full"></div>
            <div class="absolute -top-1 -right-1 bg-gradient-to-r from-blue-600 to-purple-600 text-[8px] text-white px-1.5 py-0.5 rounded-md font-bold shadow-sm z-10">LV.<span id="headLvl">1</span></div>
          </div>
          <div>
            <div class="flex items-center gap-2">
              <span id="headRole" class="text-[9px] font-black uppercase tracking-widest bg-accent/10 text-accent px-2 py-0.5 rounded-md">MEMBER</span>
              <span id="headExp" class="text-[9px] font-bold text-slate-400">0 XP</span>
            </div>
            <h1 id="headName" class="text-lg font-extrabold leading-none text-slate-800 dark:text-white mt-0.5 truncate max-w-[150px]">Memuat...</h1>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="toggleTheme()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-slate-300 active:scale-90 transition-transform">
            <span class="material-symbols-rounded text-xl" id="themeIcon">dark_mode</span>
          </button>
          <button onclick="app.modals.logout()" class="w-10 h-10 rounded-full bg-red-50 dark:bg-red-900/20 flex items-center justify-center text-danger active:scale-90 transition-transform">
            <span class="material-symbols-rounded text-xl">logout</span>
          </button>
        </div>
      </div>
    </header>

    <main class="px-5 mt-4">
      
      <section id="view-home" class="view-section active space-y-6">
        <div class="relative w-full overflow-hidden rounded-[2.5rem] shadow-2xl group transition-all">
          <div class="absolute inset-0 bg-gradient-to-br from-slate-800 to-black dark:from-slate-900 dark:to-black"></div>
          <div class="absolute top-0 right-0 p-8 opacity-10 group-hover:opacity-20 transition-opacity duration-700 transform group-hover:scale-125">
             <span class="material-symbols-rounded text-9xl text-white">dataset</span>
          </div>
          
          <div class="relative z-10 p-8 text-white">
             <div id="dashContent">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Saldo Kas Organisasi</p>
                <h2 id="totalBalance" class="text-4xl font-black mb-6 tracking-tight">Rp 0</h2>
                
                <div class="grid grid-cols-2 gap-3">
                  <div class="bg-white/10 backdrop-blur-md rounded-2xl p-3 border border-white/5 hover:bg-white/20 transition-colors">
                     <div class="flex items-center gap-1 mb-1 opacity-80"><span class="material-symbols-rounded text-sm text-success">arrow_downward</span><span class="text-[10px] font-bold uppercase">Pemasukan</span></div>
                     <p id="totalInc" class="text-sm font-bold">Rp 0</p>
                  </div>
                  <div class="bg-white/10 backdrop-blur-md rounded-2xl p-3 border border-white/5 hover:bg-white/20 transition-colors">
                     <div class="flex items-center gap-1 mb-1 opacity-80"><span class="material-symbols-rounded text-sm text-danger">arrow_upward</span><span class="text-[10px] font-bold uppercase">Pengeluaran</span></div>
                     <p id="totalExp" class="text-sm font-bold">Rp 0</p>
                  </div>
                </div>
             </div>
          </div>
          <div class="absolute bottom-0 left-0 h-1.5 bg-gradient-to-r from-accent to-purple-500 transition-all duration-1000" id="xpBar" style="width: 0%"></div>
        </div>

        <div>
          <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3 px-1">Menu Cepat</h3>
          <div id="quickMenu" class="grid grid-cols-4 gap-3">
             </div>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-[2rem] p-5 shadow-sm border border-slate-100 dark:border-slate-700">
           <div class="flex justify-between items-center mb-4">
             <h3 class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><span class="material-symbols-rounded text-accent">pie_chart</span> Analitik</h3>
             <select onchange="updateChart(this.value)" class="text-xs bg-slate-100 dark:bg-slate-700 rounded-lg px-2 py-1 outline-none font-bold">
               <option value="finance">Keuangan</option>
               <option value="attendance">Kehadiran</option>
             </select>
           </div>
           <div class="relative h-48 w-full">
             <canvas id="mainChart"></canvas>
           </div>
        </div>

        <div>
          <div class="flex justify-between items-center mb-3 px-1">
             <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Info Terbaru</h3>
             <button onclick="app.router('notifications')" class="text-xs text-accent font-bold">Lihat Semua</button>
          </div>
          <div id="homeFeed" class="space-y-3">
             </div>
        </div>
      </section>

      <section id="view-finance" class="view-section pb-20">
         <div class="flex justify-between items-end mb-6">
           <div>
             <h2 class="text-2xl font-black text-slate-800 dark:text-white">Keuangan</h2>
             <p class="text-xs text-slate-500">Transparansi Dana</p>
           </div>
           <div class="flex gap-2">
             <button onclick="app.features.exportExcel('finance')" class="w-10 h-10 bg-green-100 dark:bg-green-900/30 text-green-600 rounded-xl flex items-center justify-center active:scale-95"><span class="material-symbols-rounded">table_view</span></button>
             <button id="btnAddFinance" onclick="app.modals.addFinance()" class="w-10 h-10 bg-brand-dark text-white rounded-xl flex items-center justify-center shadow-lg active:scale-95"><span class="material-symbols-rounded">add</span></button>
           </div>
         </div>
         <div class="sticky top-20 z-20 mb-4">
           <input type="text" id="searchFinance" onkeyup="app.utils.filter('finList', this.value)" placeholder="Cari transaksi..." class="w-full bg-white dark:bg-slate-800 shadow-sm border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 outline-none focus:ring-2 ring-accent/50 transition-all text-sm font-bold">
         </div>
         <div id="finList" class="space-y-3"></div>
      </section>

      <section id="view-events" class="view-section pb-20">
         <div class="flex justify-between items-end mb-6">
           <div>
             <h2 class="text-2xl font-black text-slate-800 dark:text-white">Kegiatan</h2>
             <p class="text-xs text-slate-500">Jadwal & Presensi</p>
           </div>
           <button id="btnAddEvent" onclick="app.modals.addEvent()" class="w-10 h-10 bg-accent text-white rounded-xl flex items-center justify-center shadow-lg shadow-accent/30 active:scale-95"><span class="material-symbols-rounded">add</span></button>
         </div>
         <div id="eventList" class="space-y-4"></div>
      </section>

      <section id="view-members" class="view-section pb-20">
         <div class="flex justify-between items-end mb-6">
           <div>
             <h2 class="text-2xl font-black text-slate-800 dark:text-white">Anggota</h2>
             <p class="text-xs text-slate-500">Database & Level</p>
           </div>
           <div class="flex gap-2">
              <span class="bg-green-100 text-green-700 text-[10px] font-bold px-3 py-1.5 rounded-full flex items-center gap-1"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> <span id="onlineCount">0</span> Online</span>
           </div>
         </div>
         <div id="memberList" class="grid grid-cols-2 gap-3"></div>
      </section>

      <section id="view-docs" class="view-section pb-20">
         <div class="flex justify-between items-end mb-6">
            <div>
              <h2 class="text-2xl font-black text-slate-800 dark:text-white">Arsip</h2>
              <p class="text-xs text-slate-500">Surat & Dokumen</p>
            </div>
            <button onclick="app.modals.addDoc()" class="w-10 h-10 bg-purple-600 text-white rounded-xl flex items-center justify-center shadow-lg active:scale-95"><span class="material-symbols-rounded">upload_file</span></button>
         </div>
         <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-2">
            <button onclick="app.render.docs('all')" class="px-4 py-2 bg-slate-800 text-white rounded-lg text-xs font-bold whitespace-nowrap">Semua</button>
            <button onclick="app.render.docs('surat')" class="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-bold whitespace-nowrap">Surat</button>
            <button onclick="app.render.docs('notulen')" class="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-bold whitespace-nowrap">Notulen</button>
         </div>
         <div id="docList" class="space-y-3"></div>
      </section>

      <section id="view-profile" class="view-section pb-20">
         <div class="flex flex-col items-center pt-6">
            <div class="relative group cursor-pointer" onclick="$('profileInput').click()">
               <div class="absolute inset-0 bg-gradient-to-tr from-accent to-purple-500 rounded-full animate-spin-slow opacity-70 blur-md"></div>
               <img id="profImgLarge" src="https://via.placeholder.com/150" class="relative w-32 h-32 rounded-full object-cover border-4 border-white dark:border-slate-800 shadow-2xl z-10">
               <div class="absolute bottom-2 right-2 z-20 bg-slate-800 text-white p-2 rounded-full shadow-lg border-2 border-white"><span class="material-symbols-rounded text-sm">edit</span></div>
            </div>
            <input type="file" id="profileInput" class="hidden" accept="image/*" onchange="app.features.uploadProfile(this)">
            
            <h2 id="profNameDisplay" class="text-2xl font-black mt-6 text-center text-slate-800 dark:text-white">Nama User</h2>
            <div class="flex items-center gap-2 mt-2">
               <span id="profRoleBadge" class="px-3 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-full text-[10px] font-extrabold uppercase tracking-wide">ROLE</span>
               <span class="px-3 py-1 bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300 rounded-full text-[10px] font-extrabold uppercase tracking-wide flex items-center gap-1"><span class="material-symbols-rounded text-xs">military_tech</span> LV. <span id="profLevel">1</span></span>
            </div>

            <div class="w-full mt-8 bg-gradient-to-r from-slate-800 to-slate-900 text-white p-6 rounded-3xl shadow-xl relative overflow-hidden">
               <div class="absolute top-0 right-0 p-4 opacity-10"><span class="material-symbols-rounded text-8xl">stadia_controller</span></div>
               <div class="flex justify-between items-end relative z-10">
                  <div>
                     <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Experience Points</p>
                     <h3 class="text-3xl font-black"><span id="profExp">0</span> <span class="text-sm font-medium text-slate-400">/ 1000 XP</span></h3>
                  </div>
                  <div class="text-right">
                     <p class="text-[10px] font-bold text-accent uppercase">Next Level</p>
                     <p class="text-lg font-bold">Legendary</p>
                  </div>
               </div>
               <div class="w-full h-3 bg-slate-700 rounded-full mt-4 overflow-hidden">
                  <div id="profExpBar" class="h-full bg-gradient-to-r from-accent to-purple-500 w-0 transition-all duration-1000"></div>
               </div>
            </div>

            <button onclick="app.features.generateIDCard()" class="mt-6 w-full py-4 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl flex items-center justify-center gap-3 font-bold text-slate-700 dark:text-slate-300 shadow-sm active:scale-95 transition-all">
               <span class="material-symbols-rounded text-accent">badge</span> LIHAT KARTU ANGGOTA DIGITAL
            </button>

            <div class="w-full mt-6 space-y-4">
               <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm space-y-4">
                  <div class="group">
                     <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">Nama Lengkap</label>
                     <input id="editName" class="w-full p-3 bg-slate-50 dark:bg-slate-900/50 rounded-xl font-bold outline-none focus:ring-2 ring-accent/50 transition-all text-sm dark:text-white">
                  </div>
                  <div class="group">
                     <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">No. WhatsApp</label>
                     <input id="editPhone" class="w-full p-3 bg-slate-50 dark:bg-slate-900/50 rounded-xl font-bold outline-none focus:ring-2 ring-accent/50 transition-all text-sm dark:text-white">
                  </div>
                  <div class="group">
                     <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">Alamat</label>
                     <textarea id="editAddress" rows="2" class="w-full p-3 bg-slate-50 dark:bg-slate-900/50 rounded-xl font-bold outline-none focus:ring-2 ring-accent/50 transition-all text-sm resize-none dark:text-white"></textarea>
                  </div>
               </div>
               <button onclick="app.actions.saveProfile()" class="w-full bg-brand-dark text-white py-4 rounded-2xl font-bold shadow-lg shadow-slate-400/30 active:scale-95 transition-all">SIMPAN PERUBAHAN</button>
            </div>
         </div>
      </section>

      <section id="view-inventory" class="view-section pb-20">
         <div class="flex justify-between items-end mb-6">
            <div>
              <h2 class="text-2xl font-black text-slate-800 dark:text-white">Inventaris</h2>
              <p class="text-xs text-slate-500">Aset & Barang</p>
            </div>
            <button onclick="app.modals.addItem()" class="w-10 h-10 bg-purple-600 text-white rounded-xl flex items-center justify-center shadow-lg active:scale-95"><span class="material-symbols-rounded">add</span></button>
         </div>
         <div id="invList" class="grid grid-cols-2 gap-3"></div>
      </section>

      <section id="view-arisan" class="view-section pb-20">
         <div class="w-full bg-gradient-to-br from-purple-900 to-indigo-900 rounded-[2.5rem] p-8 text-center relative overflow-hidden shadow-2xl mb-6">
             <div class="absolute inset-0 opacity-30" style="background-image: radial-gradient(#ffffff 1px, transparent 1px); background-size: 20px 20px;"></div>
             <div class="relative z-10">
                 <div class="w-20 h-20 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center mx-auto mb-4 border border-white/20">
                    <span class="material-symbols-rounded text-4xl text-yellow-400 animate-pulse">casino</span>
                 </div>
                 <h2 class="text-2xl font-black text-white mb-1">GILIRAN TUAN RUMAH</h2>
                 <p class="text-xs text-indigo-200 mb-6">Undi siapa yang beruntung bulan ini!</p>
                 
                 <div class="bg-black/30 rounded-2xl p-4 mb-6 border border-white/10 backdrop-blur-sm">
                    <h1 id="arisanWinner" class="text-3xl font-black text-yellow-400 tracking-wider">???</h1>
                 </div>

                 <button onclick="app.features.spinArisan()" id="btnSpin" class="w-full py-4 bg-gradient-to-r from-pink-500 to-orange-500 text-white rounded-xl font-bold shadow-lg shadow-pink-500/40 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <span class="material-symbols-rounded">autorenew</span> PUTAR RODA
                 </button>
             </div>
         </div>
         <div class="px-1 mb-2 font-bold text-slate-500 text-sm">Riwayat Pemenang</div>
         <div id="arisanHistory" class="space-y-2"></div>
      </section>

    </main>

    <nav class="fixed bottom-4 left-4 right-4 h-[72px] glass-strong rounded-[2rem] shadow-2xl shadow-slate-300/20 z-50 flex justify-around items-center px-2">
      <button onclick="app.router('home')" class="nav-item active flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="home">
        <div class="icon-box w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-300"><span class="material-symbols-rounded text-2xl">grid_view</span></div>
      </button>
      <button onclick="app.router('events')" class="nav-item flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="events">
        <div class="icon-box w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-300"><span class="material-symbols-rounded text-2xl">calendar_month</span></div>
      </button>
      
      <div class="relative -top-8">
        <button onclick="app.router('profile')" class="w-16 h-16 bg-gradient-to-br from-brand-dark to-slate-900 text-white rounded-full flex items-center justify-center shadow-xl shadow-slate-800/40 hover:scale-110 active:scale-95 transition-all ring-4 ring-white dark:ring-slate-900">
           <span class="material-symbols-rounded text-3xl">person</span>
        </button>
      </div>

      <button onclick="app.router('finance')" class="nav-item flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="finance">
        <div class="icon-box w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-300"><span class="material-symbols-rounded text-2xl">account_balance_wallet</span></div>
      </button>
      <button onclick="app.router('members')" class="nav-item flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="members">
        <div class="icon-box w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-300"><span class="material-symbols-rounded text-2xl">groups</span></div>
      </button>
    </nav>

  </div> <div id="modalContainer" class="fixed inset-0 z-[6000] hidden items-end sm:items-center justify-center bg-slate-900/60 backdrop-blur-sm p-0 sm:p-4 transition-all">
     <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-6 relative shadow-2xl animate-slide-up max-h-[85vh] overflow-y-auto no-scrollbar">
        <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-6 sm:hidden"></div>
        <div class="flex justify-between items-center mb-6">
           <h2 id="mTitle" class="text-xl font-black text-slate-800 dark:text-white uppercase tracking-tight">Judul Modal</h2>
           <button onclick="app.modals.close()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center hover:bg-red-50 hover:text-red-500 transition-colors">
              <span class="material-symbols-rounded">close</span>
           </button>
        </div>
        <div id="mBody" class="space-y-4"></div>
        <div id="mFooter" class="mt-6 pt-4 border-t border-slate-100 dark:border-slate-800">
           <button id="mBtn" class="w-full bg-brand-dark text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all">SIMPAN</button>
        </div>
     </div>
  </div>

  <div id="toastContainer" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[7000] flex flex-col items-center gap-2 pointer-events-none w-full max-w-xs px-4"></div>

  <script type="module">
    // --- FIREBASE SETUP ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, addDoc, getDocs, query, orderBy, limit, where, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
      authDomain: "katar-9cac3.firebaseapp.com",
      projectId: "katar-9cac3",
      storageBucket: "katar-9cac3.firebasestorage.app",
      messagingSenderId: "1017734829960",
      appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d"
    };

    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);
    const CLOUD_NAME = "dbxktcwug";
    const PRESET = "Karteji";

    // --- STATE MANAGEMENT ---
    window.$ = (id) => document.getElementById(id);
    let ME = null; // Current User Data
    let CHART_INSTANCE = null;
    let REALTIME_UNSUBSCRIBES = [];

    // --- APP CONTROLLER ---
    window.app = {
      // 1. UTILITIES
      utils: {
        toggleLoader: (show) => {
           if(show) { $('globalLoader').classList.remove('hidden'); $('globalLoader').classList.add('flex'); }
           else { $('globalLoader').classList.add('hidden'); $('globalLoader').classList.remove('flex'); }
        },
        toast: (msg, type='success') => {
           const el = document.createElement('div');
           const colors = { success: 'bg-emerald-500', error: 'bg-rose-500', info: 'bg-blue-500' };
           const icons = { success: 'check_circle', error: 'error', info: 'info' };
           el.className = `${colors[type]} text-white px-4 py-3 rounded-2xl shadow-xl flex items-center gap-3 animate-pop pointer-events-auto backdrop-blur-md bg-opacity-90 min-w-[280px]`;
           el.innerHTML = `<span class="material-symbols-rounded">${icons[type]}</span><p class="text-xs font-bold">${msg}</p>`;
           $('toastContainer').appendChild(el);
           setTimeout(() => { el.style.opacity='0'; el.style.transform='translateY(-20px)'; setTimeout(()=>el.remove(),300) }, 3000);
        },
        fmtMoney: (n) => "Rp " + Number(n||0).toLocaleString('id-ID'),
        filter: (id, term) => {
           const list = $(id); if(!list) return;
           Array.from(list.children).forEach(item => {
              item.style.display = item.innerText.toLowerCase().includes(term.toLowerCase()) ? (item.tagName==='TR'?'table-row':'flex') : 'none';
           });
        }
      },

      // 2. ROUTER & VIEWS
      router: (viewId) => {
        // Hide all views
        document.querySelectorAll('.view-section').forEach(el => {
           el.classList.remove('active');
           setTimeout(() => { if(!el.classList.contains('active')) el.style.display = 'none'; }, 300);
        });
        
        // Show target
        const target = $(`view-${viewId}`);
        if(target) {
           target.style.display = 'block';
           setTimeout(() => target.classList.add('active'), 10);
        }

        // Update Nav
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navBtn = document.querySelector(`.nav-item[data-target="${viewId}"]`);
        if(navBtn) navBtn.classList.add('active');

        // Logic Loaders
        if(viewId === 'home') app.render.home();
        if(viewId === 'finance') app.render.finance();
        if(viewId === 'events') app.render.events();
        if(viewId === 'members') app.render.members();
        if(viewId === 'docs') app.render.docs();
        if(viewId === 'inventory') app.render.inventory();
        if(viewId === 'arisan') app.render.arisan();
      },

      // 3. ACTIONS (Logic)
      actions: {
        login: async () => {
           const email = $('loginEmail').value;
           const pass = $('loginPass').value;
           if(!email || !pass) return app.utils.toast("Isi email dan sandi!", "error");
           
           app.utils.toggleLoader(true);
           try {
              await signInWithEmailAndPassword(auth, email, pass);
              // Auth State Observer will handle the rest
           } catch(e) {
              app.utils.toggleLoader(false);
              app.utils.toast("Login Gagal: " + e.message, "error");
           }
        },
        uploadCloudinary: async (file) => {
           const fd = new FormData();
           fd.append("file", file); fd.append("upload_preset", PRESET);
           try {
              const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, { method: "POST", body: fd });
              const d = await res.json();
              if(d.error) throw new Error(d.error.message);
              return d.secure_url;
           } catch(e) { throw e; }
        },
        saveProfile: async () => {
           app.utils.toggleLoader(true);
           try {
              const file = $('profileInput').files[0];
              let data = {
                 name: $('editName').value,
                 phone: $('editPhone').value,
                 address: $('editAddress').value
              };
              if(file) data.photo = { url: await app.actions.uploadCloudinary(file) };
              
              await updateDoc(doc(db, "users", ME.uid), data);
              ME = { ...ME, ...data }; // Local update
              app.render.profileHeader();
              app.utils.toast("Profil disimpan!");
           } catch(e) { app.utils.toast("Gagal: "+e.message, "error"); }
           finally { app.utils.toggleLoader(false); }
        },
        deleteDoc: async (col, id, cb) => {
           if(!confirm("Hapus permanen?")) return;
           app.utils.toggleLoader(true);
           try { await deleteDoc(doc(db, col, id)); app.utils.toast("Terhapus"); if(cb) cb(); }
           catch(e){ app.utils.toast("Error", "error"); }
           finally { app.utils.toggleLoader(false); }
        },
        approve: async (col, id, cb) => {
           if(!confirm("Setujui data ini?")) return;
           try { await updateDoc(doc(db, col, id), { status: 'approved' }); app.utils.toast("Disetujui!"); if(cb) cb(); }
           catch(e){ app.utils.toast("Gagal", "error"); }
        }
      },

      // 4. RENDERERS (UI Updates)
      render: {
        profileHeader: () => {
           if(!ME) return;
           $('headName').textContent = ME.name;
           $('profNameDisplay').textContent = ME.name;
           $('headRole').textContent = ME.role.replace('_',' ').toUpperCase();
           $('profRoleBadge').textContent = ME.role.replace('_',' ').toUpperCase();
           if(ME.photo?.url) {
              $('headAvatar').src = ME.photo.url;
              $('profImgLarge').src = ME.photo.url;
           }
           // Gamification
           const xp = ME.xp || 0;
           const lvl = Math.floor(xp / 100) + 1;
           $('headLvl').textContent = lvl;
           $('profLevel').textContent = lvl;
           $('headExp').textContent = `${xp} XP`;
           $('profExp').textContent = xp;
           $('profExpBar').style.width = `${Math.min((xp % 1000) / 10, 100)}%`;
           
           // Edit Form Populate
           $('editName').value = ME.name || "";
           $('editPhone').value = ME.phone || "";
           $('editAddress').value = ME.address || "";
        },
        quickMenu: () => {
           const container = $('quickMenu');
           const role = ME.role;
           // Define menus
           const menus = [
             { label: "Arisan", icon: "casino", color: "text-purple-500", bg: "bg-purple-50", action: "app.router('arisan')", roles: ['all'] },
             { label: "Inventaris", icon: "inventory_2", color: "text-blue-500", bg: "bg-blue-50", action: "app.router('inventory')", roles: ['all'] },
             { label: "Dokumen", icon: "folder", color: "text-orange-500", bg: "bg-orange-50", action: "app.router('docs')", roles: ['sekretaris', 'ketua', 'wakil_ketua', 'super_admin'] },
             { label: "Scan QR", icon: "qr_code_scanner", color: "text-slate-700", bg: "bg-slate-100", action: "alert('Fitur Scan Camera')", roles: ['koordinator', 'super_admin'] }
           ];
           
           container.innerHTML = menus.filter(m => m.roles.includes('all') || m.roles.includes(role)).map(m => `
              <div onclick="${m.action}" class="bg-white dark:bg-slate-800 p-3 rounded-2xl flex flex-col items-center justify-center gap-2 shadow-sm active:scale-95 transition-all cursor-pointer border border-slate-100 dark:border-slate-700">
                 <div class="${m.bg} ${m.color} w-10 h-10 rounded-full flex items-center justify-center"><span class="material-symbols-rounded text-xl">${m.icon}</span></div>
                 <span class="text-[10px] font-bold text-slate-600 dark:text-slate-300">${m.label}</span>
              </div>
           `).join('');
        },
        home: async () => {
           // Realtime Listener for Finances
           const unsubFin = onSnapshot(query(collection(db, "financial_records")), (snap) => {
              let bal=0, inc=0, exp=0;
              snap.forEach(d => {
                 const f=d.data();
                 if(f.status==='approved'){
                    if(f.type==='income') { bal+=Number(f.amount); inc+=Number(f.amount); }
                    else { bal-=Number(f.amount); exp+=Number(f.amount); }
                 }
              });
              $('totalBalance').textContent = app.utils.fmtMoney(bal);
              $('totalInc').textContent = app.utils.fmtMoney(inc);
              $('totalExp').textContent = app.utils.fmtMoney(exp);
              
              // Update Chart
              app.features.renderChart([inc, exp]);
           });
           REALTIME_UNSUBSCRIBES.push(unsubFin);
           
           // Load Recent Notifs
           const notifs = await getDocs(query(collection(db, "notifications"), orderBy("createdAt","desc"), limit(3)));
           $('homeFeed').innerHTML = notifs.empty ? '<p class="text-xs text-slate-400 italic">Tidak ada info baru.</p>' : '';
           notifs.forEach(d => {
              const n = d.data();
              const isImp = n.level === 'important';
              $('homeFeed').innerHTML += `
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border-l-4 ${isImp?'border-red-500':'border-accent'} shadow-sm">
                    <h4 class="font-bold text-xs uppercase text-slate-700 dark:text-slate-200">${n.title}</h4>
                    <p class="text-xs text-slate-500 dark:text-slate-400 line-clamp-2 mt-1">${n.body}</p>
                 </div>
              `;
           });
        },
        finance: async () => {
           const snap = await getDocs(query(collection(db, "financial_records"), orderBy("createdAt","desc"), limit(50)));
           const list = $('finList');
           list.innerHTML = "";
           snap.forEach(d => {
              const f = d.data();
              const isInc = f.type === 'income';
              const isApp = f.status === 'approved';
              list.innerHTML += `
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl flex justify-between items-center border border-slate-100 dark:border-slate-700 shadow-sm">
                    <div class="flex items-center gap-3">
                       <div class="w-10 h-10 rounded-full ${isInc?'bg-green-100 text-green-600':'bg-red-100 text-red-500'} flex items-center justify-center shrink-0">
                          <span class="material-symbols-rounded">${isInc?'arrow_downward':'arrow_upward'}</span>
                       </div>
                       <div>
                          <p class="text-sm font-bold text-slate-800 dark:text-white line-clamp-1">${f.note}</p>
                          <p class="text-[10px] text-slate-400">${new Date(f.createdAt?.seconds*1000).toLocaleDateString()}</p>
                          ${!isApp ? '<span class="text-[9px] bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded font-bold">MENUNGGU</span>' : ''}
                       </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold ${isInc?'text-green-600':'text-red-500'}">${isInc?'+':'-'} ${Number(f.amount).toLocaleString()}</p>
                        ${(!isApp && ['bendahara','super_admin','ketua'].includes(ME.role)) ? 
                          `<button onclick="app.actions.approve('financial_records','${d.id}',()=>app.render.finance())" class="text-[10px] bg-green-500 text-white px-2 py-1 rounded mt-1">ACC</button>` : ''}
                    </div>
                 </div>
              `;
           });
        },
        events: async () => {
            const snap = await getDocs(query(collection(db, "activities"), orderBy("date", "asc")));
            const list = $('eventList');
            list.innerHTML = "";
            snap.forEach(d => {
               const x = d.data();
               list.innerHTML += `
                  <div class="bg-white dark:bg-slate-800 rounded-2xl overflow-hidden border border-slate-100 dark:border-slate-700 shadow-sm group">
                     ${x.cover ? `<div class="h-32 w-full bg-slate-100"><img src="${x.cover.url}" class="w-full h-full object-cover"></div>` : ''}
                     <div class="p-4">
                        <div class="flex justify-between items-start">
                           <div>
                              <span class="text-[10px] font-bold text-blue-500 bg-blue-50 dark:bg-blue-900/30 px-2 py-0.5 rounded mb-1 inline-block">${x.date || 'Segera'}</span>
                              <h3 class="font-bold text-slate-800 dark:text-white">${x.title}</h3>
                              <p class="text-xs text-slate-400 flex items-center gap-1 mt-1"><span class="material-symbols-rounded text-sm">location_on</span> ${x.location}</p>
                           </div>
                        </div>
                     </div>
                  </div>
               `;
            });
        },
        members: async () => {
            const snap = await getDocs(query(collection(db, "users"), orderBy("name")));
            const list = $('memberList');
            list.innerHTML = "";
            let online = 0;
            const now = Date.now();
            snap.forEach(d => {
               const u = d.data();
               const isOnline = u.lastSeen?.toDate ? (now - u.lastSeen.toDate().getTime() < 120000) : false;
               if(isOnline) online++;
               list.innerHTML += `
                  <div class="bg-white dark:bg-slate-800 p-3 rounded-2xl flex flex-col items-center gap-2 border border-slate-100 dark:border-slate-700 shadow-sm relative">
                      <div class="relative">
                         <img src="${u.photo?.url || 'https://via.placeholder.com/100'}" class="w-14 h-14 rounded-full object-cover border-2 border-slate-100 dark:border-slate-600 ${!isOnline?'grayscale':''}">
                         ${isOnline ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>' : ''}
                      </div>
                      <div class="text-center">
                         <p class="text-xs font-bold text-slate-800 dark:text-white truncate w-24">${u.name}</p>
                         <p class="text-[10px] text-slate-400 uppercase">${u.role.replace('_',' ')}</p>
                         <span class="text-[9px] text-purple-500 font-bold">LV.${Math.floor((u.xp||0)/100)+1}</span>
                      </div>
                  </div>
               `;
            });
            $('onlineCount').textContent = online;
        },
        docs: async (filter='all') => {
             const list = $('docList');
             list.innerHTML = "";
             
             // Combined Fetch
             let items = [];
             if(filter==='all' || filter==='surat') {
                 const s = await getDocs(collection(db, "letters"));
                 s.forEach(d => items.push({...d.data(), id:d.id, type:'surat'}));
             }
             if(filter==='all' || filter==='notulen') {
                 const n = await getDocs(collection(db, "minutes"));
                 n.forEach(d => items.push({...d.data(), id:d.id, type:'notulen'}));
             }
             
             items.forEach(x => {
                 list.innerHTML += `
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border-l-4 ${x.type==='surat'?'border-blue-500':'border-purple-500'} shadow-sm relative group">
                        <div class="flex justify-between">
                           <span class="text-[10px] font-bold uppercase text-slate-400">${x.type}</span>
                           <span class="text-[10px] text-slate-400">${new Date(x.createdAt?.seconds*1000).toLocaleDateString()}</span>
                        </div>
                        <h3 class="font-bold text-slate-800 dark:text-white mt-1">${x.title || x.subject}</h3>
                        ${x.type==='notulen' ? `<p class="text-xs text-slate-500 line-clamp-2 mt-1">${x.body}</p>` : ''}
                        ${x.type==='surat' ? `<p class="text-xs text-slate-500 mt-1">No: ${x.number}</p>` : ''}
                    </div>
                 `;
             });
        },
        inventory: async () => {
             const snap = await getDocs(collection(db, "inventory"));
             const list = $('invList');
             list.innerHTML = "";
             snap.forEach(d => {
                const i = d.data();
                list.innerHTML += `
                   <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm relative">
                      <div class="flex justify-between items-start mb-2">
                         <span class="material-symbols-rounded text-blue-500 bg-blue-50 dark:bg-blue-900/30 p-2 rounded-lg">package_2</span>
                         <span class="text-[10px] font-bold ${i.status==='good'?'bg-green-100 text-green-600':'bg-red-100 text-red-600'} px-2 py-0.5 rounded">${i.qty} UNIT</span>
                      </div>
                      <h4 class="font-bold text-slate-800 dark:text-white text-sm">${i.name}</h4>
                      <p class="text-[10px] text-slate-400 line-clamp-1">${i.desc}</p>
                   </div>
                `;
             });
        },
        arisan: async () => {
             const snap = await getDocs(query(collection(db, "arisan_history"), orderBy("createdAt", "desc")));
             const list = $('arisanHistory');
             list.innerHTML = "";
             snap.forEach(d => {
                const w = d.data();
                list.innerHTML += `
                   <div class="bg-white dark:bg-slate-800 p-3 rounded-xl flex items-center justify-between border border-slate-100 dark:border-slate-700">
                      <div class="flex items-center gap-3">
                         <div class="bg-yellow-100 text-yellow-600 w-8 h-8 rounded-full flex items-center justify-center"><span class="material-symbols-rounded text-sm">emoji_events</span></div>
                         <span class="text-sm font-bold text-slate-700 dark:text-slate-200">${w.name}</span>
                      </div>
                      <span class="text-[10px] text-slate-400">${new Date(w.createdAt.seconds*1000).toLocaleDateString()}</span>
                   </div>
                `;
             });
        }
      },

      // 5. FEATURES (100+ items logic grouped)
      features: {
         renderChart: (data) => {
            const ctx = $('mainChart').getContext('2d');
            if(CHART_INSTANCE) CHART_INSTANCE.destroy();
            CHART_INSTANCE = new Chart(ctx, {
               type: 'doughnut',
               data: {
                  labels: ['Masuk', 'Keluar'],
                  datasets: [{ data: data, backgroundColor: ['#10B981', '#EF4444'], borderWidth: 0 }]
               },
               options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'right' } } }
            });
         },
         exportExcel: (type) => {
            app.utils.toast("Mengunduh Excel...", "info");
            // Simulation logic for SheetJS
            const ws = XLSX.utils.json_to_sheet([{Data: "Sample Export", Date: new Date()}]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, type);
            XLSX.writeFile(wb, `${type}_export.xlsx`);
         },
         generateIDCard: async () => {
             // Use HTML2Canvas to capture profile view as card (Simplified)
             app.utils.toast("Membuat Kartu...", "info");
             // In real app, render a hidden DIV template then canvas it
             alert("Fitur ID Card akan mendownload gambar profil dengan template watermark.");
         },
         spinArisan: async () => {
             const btn = $('btnSpin');
             btn.disabled = true;
             
             // Simulation
             const names = ["Ahmad", "Budi", "Siti", "Dewi", "Reza", ME.name];
             let i = 0;
             const interval = setInterval(() => {
                $('arisanWinner').innerText = names[i % names.length];
                i++;
             }, 100);
             
             setTimeout(async () => {
                 clearInterval(interval);
                 const winner = names[Math.floor(Math.random() * names.length)];
                 $('arisanWinner').innerText = winner;
                 confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                 
                 // Save to DB
                 await addDoc(collection(db, "arisan_history"), { name: winner, createdAt: serverTimestamp() });
                 app.render.arisan();
                 btn.disabled = false;
             }, 3000);
         },
         uploadProfile: (input) => {
             if(input.files[0]) {
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     $('profImgLarge').src = e.target.result;
                 }
                 reader.readAsDataURL(input.files[0]);
             }
         }
      },

      // 6. MODALS
      modals: {
         close: () => { $('modalContainer').classList.add('hidden'); $('modalContainer').classList.remove('flex'); },
         open: (title, body, action) => {
            $('mTitle').innerText = title;
            $('mBody').innerHTML = body;
            const btn = $('mBtn');
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = async () => {
               app.utils.toggleLoader(true);
               await action();
               app.utils.toggleLoader(false);
               app.modals.close();
            };
            $('modalContainer').classList.remove('hidden');
            $('modalContainer').classList.add('flex');
         },
         addFinance: () => {
             const html = `
                <select id="fType" class="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl mb-3"><option value="income">Pemasukan (+)</option><option value="expense">Pengeluaran (-)</option></select>
                <input id="fAmt" type="number" class="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl mb-3" placeholder="Jumlah (Rp)">
                <textarea id="fNote" class="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl" placeholder="Keterangan"></textarea>
             `;
             app.modals.open("Catat Keuangan", html, async () => {
                 await addDoc(collection(db, "financial_records"), {
                     type: $('fType').value, amount: $('fAmt').value, note: $('fNote').value, 
                     status: (['bendahara','super_admin'].includes(ME.role)) ? 'approved' : 'pending',
                     createdAt: serverTimestamp()
                 });
                 app.utils.toast("Transaksi dicatat!");
                 app.render.finance();
             });
         },
         addEvent: () => {
             const html = `
                <input id="evTitle" class="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl mb-3" placeholder="Nama Acara">
                <input id="evDate" type="date" class="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl mb-3">
                <input id="evLoc" class="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl" placeholder="Lokasi">
             `;
             app.modals.open("Tambah Kegiatan", html, async () => {
                 await addDoc(collection(db, "activities"), {
                    title: $('evTitle').value, date: $('evDate').value, location: $('evLoc').value, createdAt: serverTimestamp()
                 });
                 app.render.events();
             });
         },
         addItem: () => {
             const html = `
                 <input id="iName" class="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl mb-3" placeholder="Nama Barang">
                 <input id="iQty" type="number" class="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl mb-3" placeholder="Jumlah">
                 <select id="iStat" class="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl"><option value="good">Baik</option><option value="bad">Rusak</option></select>
             `;
             app.modals.open("Aset Baru", html, async () => {
                 await addDoc(collection(db, "inventory"), {
                    name: $('iName').value, qty: $('iQty').value, status: $('iStat').value, desc: "Aset Organisasi"
                 });
                 app.render.inventory();
             });
         },
         logout: () => {
            if(confirm("Keluar dari sistem?")) signOut(auth).then(()=>window.location.reload());
         }
      }
    };

    // --- EVENT LISTENERS ---
    window.toggleTheme = () => {
       document.documentElement.classList.toggle('dark');
       const isDark = document.documentElement.classList.contains('dark');
       $('themeIcon').innerText = isDark ? 'light_mode' : 'dark_mode';
    };

    $('btnLogin').onclick = app.actions.login;

    // --- INITIALIZATION ---
    onAuthStateChanged(auth, async (user) => {
       if(user) {
          // Logged In
          const snap = await getDoc(doc(db, "users", user.uid));
          if(!snap.exists()) { alert("User data not found"); return; }
          ME = { ...snap.data(), uid: user.uid };
          
          // Hide Auth, Show App
          $('authScreen').classList.add('hidden');
          $('appContainer').classList.remove('hidden');
          
          // Initial Renders
          app.render.profileHeader();
          app.render.quickMenu();
          app.router('home'); // Default view
          
          // Online Presence Loop
          setInterval(() => updateDoc(doc(db, "users", ME.uid), { lastSeen: serverTimestamp() }), 60000);
          
       } else {
          // Logged Out
          $('appContainer').classList.add('hidden');
          $('authScreen').classList.remove('hidden');
       }
       app.utils.toggleLoader(false);
    });

  </script>
</body>
</html>
