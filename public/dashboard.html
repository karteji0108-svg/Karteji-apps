<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KARTEJI Super App</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          colors: {
            brand: { primary: '#0F172A', light: '#334155', dark: '#020617' },
            accent: { DEFAULT: '#F97316', light: '#FFEDD5', dark: '#C2410C' },
            glass: { 
              light: 'rgba(255, 255, 255, 0.7)', 
              dark: 'rgba(15, 23, 42, 0.6)',
              border: 'rgba(255, 255, 255, 0.2)'
            }
          },
          animation: { 'blob': 'blob 10s infinite', 'slideUp': 'slideUp 0.3s ease-out' },
          keyframes: {
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
              '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            slideUp: {
              '0%': { transform: 'translateY(100%)', opacity: 0 },
              '100%': { transform: 'translateY(0)', opacity: 1 },
            }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #F0F4F8; color: #1E293B; -webkit-tap-highlight-color: transparent; }
    .dark body { background-color: #020617; color: #F8FAFC; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    .glass-panel {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
    }
    
    .dark .glass-panel {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.05);
      color: white;
    }

    .glass-nav {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(0,0,0,0.05);
    }
    .dark .glass-nav {
      background: rgba(2, 6, 23, 0.9);
      border-top: 1px solid rgba(255,255,255,0.05);
    }

    .view-section { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
    .view-section.active { display: block; opacity: 1; transform: translateY(0); }
    
    .nav-btn.active span { font-variation-settings: 'FILL' 1; color: #F97316; transform: translateY(-2px); }
    .nav-btn.active p { color: #0F172A; font-weight: 800; }
    .dark .nav-btn.active p { color: white; }

    /* Utilities */
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>

<body class="min-h-screen relative overflow-x-hidden pb-32 selection:bg-orange-200 selection:text-orange-900 transition-colors duration-300">

  <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
    <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-blue-200/40 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob dark:bg-blue-900/20"></div>
    <div class="absolute top-[30%] right-[-10%] w-80 h-80 bg-orange-200/40 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-2000 dark:bg-orange-900/20"></div>
    <div class="absolute bottom-[-10%] left-[20%] w-96 h-96 bg-purple-200/40 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-4000 dark:bg-purple-900/20"></div>
  </div>

  <div id="globalLoader" class="fixed inset-0 bg-white/90 dark:bg-slate-950/90 z-[9999] flex items-center justify-center flex-col gap-4 backdrop-blur-md hidden">
    <div class="relative">
        <div class="w-16 h-16 border-4 border-slate-200 dark:border-slate-800 border-t-accent rounded-full animate-spin"></div>
        <div class="absolute inset-0 flex items-center justify-center font-bold text-xs text-accent">KT</div>
    </div>
    <p id="loaderText" class="text-xs font-bold text-slate-400 animate-pulse tracking-widest">MEMUAT SYSTEM...</p>
  </div>

  <div id="crudModal" class="fixed inset-0 z-[60] hidden items-end sm:items-center justify-center p-0 sm:p-4 bg-slate-900/60 backdrop-blur-sm transition-all">
    <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-t-[2rem] sm:rounded-[2rem] p-6 relative shadow-2xl animate-slideUp border border-slate-100 dark:border-slate-800">
      <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-6 sm:hidden"></div>
      <div class="flex justify-between items-center mb-6">
          <h2 id="modalTitle" class="text-xl font-extrabold text-brand-primary dark:text-white uppercase tracking-tight">Judul</h2>
          <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors text-slate-500">
            <span class="material-symbols-rounded text-xl">close</span>
          </button>
      </div>
      <div id="modalBody" class="space-y-4 max-h-[70vh] overflow-y-auto no-scrollbar pb-10 sm:pb-0 text-brand-primary dark:text-slate-200"></div>
      <button id="modalSubmitBtn" class="mt-6 w-full rounded-xl bg-brand-primary dark:bg-accent text-white py-4 text-sm font-bold shadow-lg shadow-slate-300 dark:shadow-orange-900/20 hover:scale-[1.02] active:scale-95 transition-all">SIMPAN</button>
    </div>
  </div>

  <header class="sticky top-0 z-30 px-6 pt-6 pb-2">
      <div class="flex justify-between items-center glass-panel p-3 rounded-2xl">
          <div class="flex items-center gap-3" onclick="switchView('profile')">
              <div class="relative">
                <img id="headerPhoto" class="w-10 h-10 rounded-full border border-white shadow-sm object-cover" src="https://via.placeholder.com/100">
                <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
              </div>
              <div class="flex flex-col">
                  <p id="headerRole" class="text-[9px] font-extrabold text-accent uppercase tracking-widest leading-none mb-1">...</p>
                  <h1 id="headerName" class="text-sm font-bold text-brand-primary dark:text-white leading-none truncate w-32">Memuat...</h1>
              </div>
          </div>
          <div class="flex gap-2">
            <button onclick="toggleDarkMode()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 dark:text-slate-300 transition-all active:scale-90">
                <span class="material-symbols-rounded text-lg">dark_mode</span>
            </button>
            <button id="sosBtn" onclick="triggerSOS()" class="w-9 h-9 rounded-full bg-red-100 text-red-600 flex items-center justify-center animate-pulse border border-red-200 active:scale-90 hidden">
                <span class="material-symbols-rounded text-lg">sos</span>
            </button>
          </div>
      </div>
  </header>

  <main class="px-5 mt-4 relative z-10 min-h-[80vh]">
      
      <section id="view-home" class="view-section active">
          <div class="w-full bg-brand-primary dark:bg-slate-900 rounded-[2rem] p-6 text-white relative overflow-hidden shadow-xl shadow-slate-300 dark:shadow-none mb-6 group transition-all">
              <div class="absolute -right-4 -top-4 w-32 h-32 bg-accent/20 rounded-full blur-2xl group-hover:bg-accent/30 transition-all"></div>
              <div class="relative z-10">
                <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1">Saldo Kas Organisasi</p>
                <h2 id="cardBalance" class="text-4xl font-black tracking-tighter mb-6">Rp 0</h2>
                <div class="flex gap-2" id="quickStats">
                    </div>
              </div>
          </div>

          <div class="mb-2 flex justify-between items-center px-1">
             <h3 class="text-sm font-bold text-brand-primary dark:text-white">Akses Cepat</h3>
          </div>
          <div id="actionGrid" class="grid grid-cols-4 gap-3 mb-8">
             </div>

          <div id="homeModules" class="space-y-6">
             </div>
      </section>

      <section id="view-list" class="view-section">
          <div class="flex justify-between items-center mb-4 px-1 sticky top-0 py-2 z-10 glass-panel rounded-xl">
             <div>
                <h2 id="listTitle" class="text-lg font-bold text-brand-primary dark:text-white">Daftar</h2>
                <p id="listSubtitle" class="text-[10px] text-slate-400">Manage data</p>
             </div>
             <div class="flex gap-2" id="listActions">
                </div>
          </div>
          <div class="mb-4 relative">
             <span class="material-symbols-rounded absolute left-3 top-2.5 text-slate-400 text-lg">search</span>
             <input type="text" id="searchInput" onkeyup="globalSearch(this.value)" placeholder="Cari data..." class="w-full pl-10 pr-4 py-2 bg-white dark:bg-slate-800 border-none rounded-xl text-sm outline-none shadow-sm text-brand-primary dark:text-white transition-all focus:ring-2 focus:ring-accent">
          </div>
          <div id="listContainer" class="space-y-3 pb-24 grid-cols-1 md:grid-cols-2"></div>
      </section>

      <section id="view-profile" class="view-section">
        <div class="flex flex-col items-center pt-4 pb-20">
            <div class="relative group cursor-pointer active:scale-95 transition-transform" onclick="$('profileUpload').click()">
                <img id="profileImage" src="https://via.placeholder.com/150" class="w-28 h-28 rounded-full object-cover border-4 border-white dark:border-slate-700 shadow-xl">
                <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="material-symbols-rounded text-white">photo_camera</span>
                </div>
            </div>
            <input type="file" id="profileUpload" class="hidden" accept="image/*" onchange="previewProfileImage(this)">
            
            <h2 id="profileNameDisplay" class="text-xl font-bold text-brand-primary dark:text-white mt-4 mb-0.5">User</h2>
            <div id="profileRoleBadge" class="px-3 py-0.5 bg-accent/10 text-accent rounded-full text-[10px] font-extrabold uppercase tracking-wide mb-1 border border-accent/20">ROLE</div>
            
            <div class="flex gap-2 mt-4">
                <button onclick="showIdCard()" class="text-[10px] font-bold bg-brand-primary dark:bg-slate-700 text-white px-4 py-2 rounded-xl flex items-center gap-2 active:scale-95 shadow-lg">
                    <span class="material-symbols-rounded text-sm">badge</span> DIGITAL ID
                </button>
                <button id="logoutBtn" class="text-[10px] font-bold bg-red-50 dark:bg-red-900/30 text-red-500 px-4 py-2 rounded-xl flex items-center gap-2 active:scale-95 border border-red-100 dark:border-red-900">
                    <span class="material-symbols-rounded text-sm">logout</span> KELUAR
                </button>
            </div>

            <div class="w-full mt-8 space-y-4 px-1">
                <div class="glass-panel p-5 rounded-3xl space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 ml-1 uppercase">Nama Lengkap</label>
                        <input id="editName" class="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl border-none text-sm font-bold mt-1 outline-none focus:ring-2 focus:ring-accent dark:text-white">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 ml-1 uppercase">No. WhatsApp</label>
                        <input id="editPhone" type="tel" class="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl border-none text-sm font-bold mt-1 outline-none focus:ring-2 focus:ring-accent dark:text-white">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 ml-1 uppercase">Bio</label>
                        <textarea id="editBio" rows="2" class="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl border-none text-sm mt-1 outline-none focus:ring-2 focus:ring-accent resize-none dark:text-white"></textarea>
                    </div>
                    <div id="sigPadContainer" class="hidden">
                         <label class="text-[10px] font-bold text-slate-400 ml-1 uppercase">Tanda Tangan Digital</label>
                         <div class="h-24 bg-white border rounded-xl mt-1 flex items-center justify-center text-xs text-slate-300">Area Tanda Tangan (Coming Soon)</div>
                    </div>
                </div>
                <button onclick="saveProfile()" class="w-full bg-brand-primary dark:bg-accent text-white py-4 rounded-2xl font-bold shadow-lg shadow-slate-300 dark:shadow-orange-900/20 active:scale-95 transition-all">SIMPAN PERUBAHAN</button>
            </div>
        </div>
      </section>

  </main>

  <nav class="fixed bottom-0 w-full glass-nav pb-6 pt-2 px-2 z-50 rounded-t-[2rem]">
      <div class="flex justify-around items-center max-w-md mx-auto" id="navContainer">
          </div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, addDoc, getDocs, query, orderBy, limit, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
      authDomain: "katar-9cac3.firebaseapp.com",
      projectId: "katar-9cac3",
      storageBucket: "katar-9cac3.firebasestorage.app",
      messagingSenderId: "1017734829960",
      appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const CLOUD_NAME = "dbxktcwug";
    const UPLOAD_PRESET = "Karteji";

    // --- STATE MANAGEMENT ---
    window.$ = (id) => document.getElementById(id);
    let CURRENT_USER = null;
    let CURRENT_ROLE = null;
    let newProfileFile = null;
    let activeListener = null;

    // --- CONFIG ROLE & FEATURES ---
    const ROLE_CONFIG = {
        'super_admin': {
            label: 'Super Admin',
            color: 'text-purple-600 bg-purple-100',
            nav: ['home', 'users', 'finance', 'activity', 'inventory', 'profile'],
            actions: ['users', 'finance', 'activity', 'notif', 'inventory', 'logs', 'settings', 'export']
        },
        'ketua': {
            label: 'Ketua',
            color: 'text-blue-600 bg-blue-100',
            nav: ['home', 'users', 'finance', 'activity', 'profile'],
            actions: ['task', 'poll', 'approve_override', 'broadcast']
        },
        'wakil_ketua': {
            label: 'Wakil Ketua',
            color: 'text-cyan-600 bg-cyan-100',
            nav: ['home', 'users', 'finance', 'activity', 'profile'],
            actions: ['approve_center', 'monitor_staff', 'feedback']
        },
        'bendahara': {
            label: 'Bendahara',
            color: 'text-green-600 bg-green-100',
            nav: ['home', 'finance', 'dues', 'raffle', 'profile'],
            actions: ['input_kas', 'catat_hutang', 'laporan', 'qr_code']
        },
        'sekretaris': {
            label: 'Sekretaris',
            color: 'text-pink-600 bg-pink-100',
            nav: ['home', 'surat', 'notulen', 'arsip', 'profile'],
            actions: ['buat_surat', 'catat_rapat', 'upload_arsip', 'absensi']
        },
        'anggota': {
            label: 'Anggota',
            color: 'text-slate-600 bg-slate-100',
            nav: ['home', 'activity', 'marketplace', 'profile'],
            actions: ['marketplace', 'rsvp', 'id_card', 'saran']
        }
    };

    // --- UI HELPERS ---
    window.toggleLoader = (show, msg) => {
        if(msg) $("loaderText").innerText = msg;
        const l = $("globalLoader");
        show ? l.classList.remove('hidden') : l.classList.add('hidden');
    };

    window.toggleDarkMode = () => {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    };
    if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');

    window.closeModal = () => $("crudModal").classList.add('hidden');
    window.showModal = (title, body, onSave) => {
        $("modalTitle").innerText = title;
        $("modalBody").innerHTML = body;
        const btn = $("modalSubmitBtn");
        btn.style.display = onSave ? 'block' : 'none';
        if(onSave) {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = onSave;
        }
        $("crudModal").classList.remove('hidden');
        $("crudModal").classList.add('flex');
    };

    // --- NAVIGATION ---
    window.switchView = async (viewId) => {
        document.querySelectorAll('.view-section').forEach(el => {
            el.classList.remove('active');
            setTimeout(() => { if(!el.classList.contains('active')) el.style.display = 'none'; }, 200);
        });
        
        const target = $(`view-${viewId}`) || $("view-list"); // Fallback to generic list
        if(!$(`view-${viewId}`)) { 
            // Generic Handler
            $("view-list").classList.add('active');
            $("view-list").style.display = 'block';
            loadGenericList(viewId); 
        } else {
            target.style.display = 'block';
            setTimeout(() => target.classList.add('active'), 10);
            if(viewId === 'home') loadHome();
        }

        // Nav Active State
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`.nav-btn[data-target="${viewId}"]`);
        if(activeBtn) activeBtn.classList.add('active');
    };

    // --- DATA LOADING & LOGIC ---
    
    // 1. HOME DASHBOARD
    async function loadHome() {
        const role = ROLE_CONFIG[CURRENT_ROLE];
        const grid = $("actionGrid");
        const modules = $("homeModules");
        
        // Load Finance Summary (All Roles see this, logic varies)
        const finSnap = await getDocs(query(collection(db, "financial_records"), where("status","==","approved")));
        let inc = 0, exp = 0;
        finSnap.forEach(d => { const f=d.data(); f.type==='income'? inc+=Number(f.amount) : exp+=Number(f.amount); });
        $("cardBalance").innerText = `Rp ${(inc-exp).toLocaleString('id-ID')}`;
        const quickStats = $("quickStats");
        quickStats.innerHTML = `
            <div class="bg-white/10 px-3 py-1 rounded-lg border border-white/10 text-xs flex items-center gap-1"><span class="material-symbols-rounded text-green-300 text-sm">arrow_downward</span> Rp ${inc.toLocaleString()}</div>
            <div class="bg-white/10 px-3 py-1 rounded-lg border border-white/10 text-xs flex items-center gap-1"><span class="material-symbols-rounded text-red-300 text-sm">arrow_upward</span> Rp ${exp.toLocaleString()}</div>
        `;

        // Render Quick Actions based on Role Config
        grid.innerHTML = "";
        role.actions.forEach(act => {
             const meta = getActionMeta(act);
             grid.innerHTML += `
                <div onclick="${meta.fn}" class="bg-white dark:bg-slate-800 p-3 rounded-2xl flex flex-col items-center justify-center gap-2 shadow-sm active:scale-95 transition-all h-24 border border-slate-50 dark:border-slate-700">
                    <div class="${meta.bg} ${meta.color} w-10 h-10 rounded-full flex items-center justify-center"><span class="material-symbols-rounded text-xl">${meta.icon}</span></div>
                    <span class="text-[10px] font-bold text-center leading-tight dark:text-slate-300">${meta.label}</span>
                </div>
             `;
        });

        // Modules: Notifications & Role Specific Widgets
        modules.innerHTML = "";
        
        // Widget: Iuran Status (Bendahara/Anggota)
        if(CURRENT_ROLE === 'anggota' || CURRENT_ROLE === 'bendahara') {
            modules.innerHTML += `
                <div class="glass-panel p-4 rounded-2xl">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-sm dark:text-white">Status Iuran Bulanan</h4>
                        <span class="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded font-bold">LUNAS</span>
                    </div>
                    <div class="w-full bg-slate-100 dark:bg-slate-700 h-2 rounded-full overflow-hidden">
                        <div class="bg-green-500 h-full w-[80%]"></div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1 text-right">8/12 Bulan</p>
                </div>
            `;
        }
        
        // Widget: Task / Kegiatan (All)
        const actSnap = await getDocs(query(collection(db, "activities"), limit(3)));
        let actHtml = "";
        actSnap.forEach(d => {
            const a = d.data();
            actHtml += `<div class="flex items-center gap-3 py-2 border-b border-slate-100 dark:border-slate-700 last:border-0">
                <div class="bg-blue-50 text-blue-600 w-10 h-10 rounded-lg flex items-center justify-center font-bold text-xs flex-shrink-0">${a.date.split('-')[2]||'??'}</div>
                <div><h5 class="text-xs font-bold dark:text-white line-clamp-1">${a.title}</h5><p class="text-[10px] text-slate-400">${a.location}</p></div>
            </div>`;
        });
        modules.innerHTML += `
            <div class="glass-panel p-4 rounded-2xl">
                <h4 class="font-bold text-sm mb-2 dark:text-white">Agenda Terdekat</h4>
                <div class="space-y-1">${actHtml || '<p class="text-xs text-slate-400">Belum ada agenda.</p>'}</div>
            </div>
        `;
    }

    // 2. GENERIC LIST LOADER (Powerful abstraction)
    async function loadGenericList(type) {
        const container = $("listContainer");
        const title = $("listTitle");
        const sub = $("listSubtitle");
        const actions = $("listActions");
        
        container.innerHTML = `<div class="col-span-2 flex justify-center py-10"><div class="w-8 h-8 border-4 border-accent border-t-transparent rounded-full animate-spin"></div></div>`;
        actions.innerHTML = "";

        // Definitions per type
        if(type === 'users') {
            title.innerText = "Anggota"; sub.innerText = "Manajemen User";
            if(['super_admin','ketua'].includes(CURRENT_ROLE)) actions.innerHTML = `<button onclick="exportData('users')" class="bg-green-100 text-green-600 w-8 h-8 rounded-full flex items-center justify-center"><span class="material-symbols-rounded text-sm">download</span></button>`;
            
            const snap = await getDocs(collection(db, "users"));
            container.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                container.innerHTML += `
                    <div class="bg-white dark:bg-slate-800 p-3 rounded-2xl flex items-center gap-3 border border-slate-100 dark:border-slate-700 shadow-sm">
                        <img src="${u.photo?.url || 'https://via.placeholder.com/50'}" class="w-10 h-10 rounded-full object-cover">
                        <div>
                            <h4 class="text-sm font-bold dark:text-white">${u.name}</h4>
                            <span class="text-[10px] bg-slate-100 dark:bg-slate-700 dark:text-slate-300 px-2 py-0.5 rounded uppercase font-bold">${u.role.replace('_',' ')}</span>
                        </div>
                    </div>
                `;
            });
        }
        else if(type === 'finance') {
            title.innerText = "Kas Organisasi"; sub.innerText = "Riwayat Transaksi";
            if(['super_admin','bendahara'].includes(CURRENT_ROLE)) actions.innerHTML = `<button onclick="openFinanceModal()" class="bg-brand-primary text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg"><span class="material-symbols-rounded text-sm">add</span></button>`;
            
            const snap = await getDocs(query(collection(db, "financial_records"), orderBy("createdAt", "desc")));
            container.innerHTML = "";
            snap.forEach(d => {
                const f = d.data();
                const isInc = f.type === 'income';
                container.innerHTML += `
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl flex justify-between items-center border border-slate-100 dark:border-slate-700 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full ${isInc?'bg-green-50 text-green-600':'bg-red-50 text-red-500'} flex items-center justify-center"><span class="material-symbols-rounded">${isInc?'arrow_downward':'arrow_upward'}</span></div>
                            <div><h4 class="text-xs font-bold dark:text-white">${f.note}</h4><p class="text-[10px] text-slate-400">${f.status}</p></div>
                        </div>
                        <span class="font-bold text-xs ${isInc?'text-green-600':'text-red-500'}">${isInc?'+':'-'} ${Number(f.amount).toLocaleString()}</span>
                    </div>
                `;
            });
        }
        else if (type === 'marketplace') { // FITUR BARU ANGGOTA
             title.innerText = "Pasar Warga"; sub.innerText = "Jual Beli Anggota";
             actions.innerHTML = `<button onclick="postItem()" class="bg-accent text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg"><span class="material-symbols-rounded text-sm">add_business</span></button>`;
             
             // Mockup data if empty
             const snap = await getDocs(collection(db, "marketplace"));
             container.innerHTML = "";
             if(snap.empty) container.innerHTML = `<p class="col-span-2 text-center text-xs text-slate-400">Belum ada barang dijual.</p>`;
             snap.forEach(d => {
                 const m = d.data();
                 container.innerHTML += `
                    <div class="bg-white dark:bg-slate-800 p-3 rounded-2xl border border-slate-100 dark:border-slate-700">
                        <div class="h-24 bg-slate-200 rounded-xl mb-2 overflow-hidden"><img src="${m.img||'https://via.placeholder.com/150'}" class="w-full h-full object-cover"></div>
                        <h4 class="font-bold text-sm dark:text-white">${m.name}</h4>
                        <p class="text-accent font-bold text-xs">Rp ${Number(m.price).toLocaleString()}</p>
                        <button class="w-full mt-2 bg-green-50 text-green-600 text-[10px] font-bold py-1.5 rounded-lg">WhatsApp Penjual</button>
                    </div>
                 `;
             });
        }
        // ... Add blocks for 'surat', 'activity', 'inventory' similarly
    }

    // --- FEATURE HELPERS ---
    window.getActionMeta = (key) => {
        const map = {
            'users': { label:'Anggota', icon:'group', bg:'bg-blue-50', color:'text-blue-600', fn:"switchView('users')" },
            'finance': { label:'Kas', icon:'payments', bg:'bg-green-50', color:'text-green-600', fn:"switchView('finance')" },
            'activity': { label:'Acara', icon:'event', bg:'bg-purple-50', color:'text-purple-600', fn:"switchView('activity')" },
            'inventory': { label:'Barang', icon:'inventory_2', bg:'bg-orange-50', color:'text-orange-600', fn:"switchView('inventory')" },
            'notif': { label:'Info', icon:'campaign', bg:'bg-red-50', color:'text-red-600', fn:"openNotifModal()" },
            'task': { label:'Tugas', icon:'task', bg:'bg-indigo-50', color:'text-indigo-600', fn:"alert('Fitur Task Manager')" }, // Fitur Baru
            'poll': { label:'Voting', icon:'how_to_vote', bg:'bg-teal-50', color:'text-teal-600', fn:"alert('Fitur Voting')" }, // Fitur Baru
            'marketplace': { label:'Pasar', icon:'storefront', bg:'bg-yellow-50', color:'text-yellow-600', fn:"switchView('marketplace')" }, // Fitur Baru
            'input_kas': { label:'Catat', icon:'add_card', bg:'bg-green-50', color:'text-green-600', fn:"openFinanceModal()" },
            'raffle': { label:'Arisan', icon:'casino', bg:'bg-pink-50', color:'text-pink-600', fn:"alert('Undi Arisan')" },
            'id_card': { label:'ID Card', icon:'badge', bg:'bg-slate-50', color:'text-slate-600', fn:"showIdCard()" },
            'surat': { label:'Surat', icon:'mail', bg:'bg-cyan-50', color:'text-cyan-600', fn:"switchView('surat')" },
            'arsip': { label:'Arsip', icon:'folder', bg:'bg-amber-50', color:'text-amber-600', fn:"switchView('arsip')" },
            'logs': { label:'Logs', icon:'history', bg:'bg-gray-50', color:'text-gray-600', fn:"alert('System Logs')" }
        };
        return map[key] || { label: key, icon: 'circle', bg:'bg-slate-50', color:'text-slate-500', fn:"" };
    }

    window.openFinanceModal = () => {
        const html = `
            <select id="finType" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-800 border-none mb-3 font-bold dark:text-white"><option value="income">Pemasukan (+)</option><option value="expense">Pengeluaran (-)</option></select>
            <input id="finAmt" type="number" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-800 border-none mb-3 font-bold text-lg dark:text-white" placeholder="Nominal (Rp)">
            <textarea id="finNote" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-800 border-none mb-3 dark:text-white" placeholder="Catatan..."></textarea>
        `;
        showModal("Catat Kas", html, async () => {
            toggleLoader(true);
            try {
                await addDoc(collection(db, "financial_records"), {
                    type: $("finType").value, amount: $("finAmt").value, note: $("finNote").value, status: (['super_admin','bendahara'].includes(CURRENT_ROLE)?'approved':'pending'), createdAt: serverTimestamp()
                });
                closeModal(); switchView('finance');
            } catch(e){ alert("Error"); }
            toggleLoader(false);
        });
    }

    window.showIdCard = () => {
        // Fitur Digital ID Anggota
        const html = `
            <div class="bg-gradient-to-br from-brand-primary to-slate-900 text-white p-6 rounded-2xl relative overflow-hidden shadow-xl">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
                <div class="flex justify-between items-start mb-4">
                    <img src="https://via.placeholder.com/40" class="w-10 h-10 rounded-lg">
                    <span class="text-xs font-bold tracking-[0.2em] opacity-70">MEMBER CARD</span>
                </div>
                <h2 class="text-xl font-bold uppercase mb-1">${CURRENT_USER.name}</h2>
                <p class="text-xs opacity-70 mb-4">${CURRENT_ROLE.replace('_',' ').toUpperCase()}</p>
                <div class="bg-white p-2 w-fit rounded-lg"><div id="qrcode"></div></div>
                <p class="text-[9px] mt-4 opacity-50 text-center">Scan QR untuk presensi kegiatan</p>
            </div>
        `;
        showModal("Digital ID", html, null);
        setTimeout(() => new QRCode($("qrcode"), { text: CURRENT_USER.uid, width: 80, height: 80 }), 100);
    }

    window.triggerSOS = () => {
        if(confirm("Kirim sinyal darurat ke admin? Gunakan hanya saat mendesak!")) {
            alert("Sinyal SOS terkirim! Admin akan segera menghubungi.");
            // Logic addDoc notification urgent
        }
    }

    // --- AUTH LISTENER ---
    onAuthStateChanged(auth, async user => {
        if(!user) return location.href = "login.html";
        
        // Initial Load
        if(!CURRENT_USER) {
            const snap = await getDoc(doc(db, "users", user.uid));
            if(!snap.exists()) return alert("User error");
            CURRENT_USER = { uid: user.uid, ...snap.data() };
            CURRENT_ROLE = CURRENT_USER.role;
            
            // Setup UI based on Role
            $("headerName").innerText = CURRENT_USER.name;
            $("headerRole").innerText = ROLE_CONFIG[CURRENT_ROLE].label;
            $("headerPhoto").src = CURRENT_USER.photo?.url || "https://via.placeholder.com/150";
            
            // Render Nav
            const nav = $("navContainer");
            nav.innerHTML = "";
            ROLE_CONFIG[CURRENT_ROLE].nav.forEach(n => {
                const meta = getActionMeta(n); // Reuse meta for icons
                // Custom icons map for Nav specifically if needed
                const icons = { home:'grid_view', users:'group', finance:'account_balance_wallet', activity:'event', profile:'person', inventory:'inventory_2', surat:'mail', notulen:'edit_note', arsip:'folder', dues:'savings', raffle:'casino', marketplace:'storefront' };
                nav.innerHTML += `
                     <button onclick="switchView('${n}')" class="nav-btn flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="${n}">
                        <span class="material-symbols-rounded text-2xl text-slate-400 dark:text-slate-500 transition-transform duration-300">${icons[n]||'circle'}</span>
                        <p class="text-[9px] font-medium text-slate-400 dark:text-slate-500 transition-colors">${n.charAt(0).toUpperCase() + n.slice(1)}</p>
                    </button>
                `;
            });

            // Show SOS for Anggota
            if(CURRENT_ROLE === 'anggota') $("sosBtn").classList.remove('hidden');

            loadHome();
        }
    });
    
    // --- UPLOAD LOGIC ---
    window.previewProfileImage = (input) => {
        if (input.files && input.files[0]) {
           newProfileFile = input.files[0];
           const reader = new FileReader();
           reader.onload = (e) => $("profileImage").src = e.target.result;
           reader.readAsDataURL(input.files[0]);
        }
    }

    window.saveProfile = async () => {
        toggleLoader(true, "Menyimpan...");
        try {
            let data = { name: $("editName").value, phone: $("editPhone").value, bio: $("editBio").value };
            if(newProfileFile) {
                const fd = new FormData(); fd.append("file", newProfileFile); fd.append("upload_preset", UPLOAD_PRESET);
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {method:"POST", body:fd});
                const json = await res.json();
                data.photo = { url: json.secure_url };
            }
            await updateDoc(doc(db, "users", CURRENT_USER.uid), data);
            location.reload();
        } catch(e) { alert("Gagal"); toggleLoader(false); }
    }
  </script>
</body>
</html>
