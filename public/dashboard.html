<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KARTEJI Super App v3.0</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script> <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          colors: {
            brand: { primary: '#0F172A', light: '#334155', dark: '#020617' },
            accent: { DEFAULT: '#F97316', light: '#FFEDD5', hover: '#ea580c' },
          },
          animation: { 'blob': 'blob 10s infinite', 'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)' },
          keyframes: {
            blob: { '0%': { transform: 'translate(0px, 0px) scale(1)' }, '33%': { transform: 'translate(30px, -50px) scale(1.1)' }, '66%': { transform: 'translate(-20px, 20px) scale(0.9)' }, '100%': { transform: 'translate(0px, 0px) scale(1)' } },
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
          }
        }
      }
    }
  </script>

  <style>
    /* CORE */
    body { background-color: #F8FAFC; color: #1E293B; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
    html.dark body { background-color: #020617; color: #F8FAFC; }
    #app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.1); overflow-x: hidden; padding-bottom: 100px; }
    
    /* UTILS */
    .glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); border-top: 1px solid rgba(0,0,0,0.05); }
    html.dark .glass-nav { background: rgba(15, 23, 42, 0.85); border-top: 1px solid rgba(255,255,255,0.05); }
    .card-std { @apply bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 transition-all; }
    .btn-primary { @apply bg-brand-primary dark:bg-accent text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform w-full; }
    .input-std { @apply w-full p-3 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-xl text-sm outline-none focus:ring-2 focus:ring-accent dark:text-white transition-all; }
    
    /* NAVIGATION */
    .view-section { display: none; opacity: 0; transform: scale(0.98); transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .view-section.active { display: block; opacity: 1; transform: scale(1); }
    .nav-btn.active span { font-variation-settings: 'FILL' 1; color: #F97316; transform: translateY(-2px); }
    .nav-btn.active p { color: #0F172A; font-weight: 700; }
    html.dark .nav-btn.active p { color: #F8FAFC; }

    /* SKELETON LOADING */
    .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
    html.dark .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* BOTTOM SHEET MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9990; display: none; align-items: flex-end; backdrop-filter: blur(4px); }
    .modal-overlay.open { display: flex; }
    .modal-content { background: white; width: 100%; max-width: 480px; margin: 0 auto; border-radius: 2rem 2rem 0 0; padding: 1.5rem; animation: slideUp 0.3s forwards; max-height: 85vh; overflow-y: auto; position: relative; }
    html.dark .modal-content { background: #0f172a; color: white; }

    /* CUSTOM SCROLLBAR */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>

<body class="bg-slate-100 dark:bg-black">
<div id="app-container" class="bg-slate-50 dark:bg-slate-950 transition-colors">

  <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
    <div class="absolute -top-20 -left-20 w-80 h-80 bg-blue-400/20 dark:bg-blue-600/20 rounded-full blur-3xl animate-blob"></div>
    <div class="absolute top-40 -right-20 w-80 h-80 bg-orange-400/20 dark:bg-orange-600/20 rounded-full blur-3xl animate-blob animation-delay-2000"></div>
  </div>

  <div id="globalLoader" class="fixed inset-0 bg-white/90 dark:bg-slate-950/90 z-[9999] flex items-center justify-center flex-col gap-4 backdrop-blur-md hidden">
    <div class="w-12 h-12 border-4 border-slate-200 border-t-accent rounded-full animate-spin"></div>
    <p class="text-xs font-bold text-slate-400 tracking-widest animate-pulse">MEMUAT...</p>
  </div>

  <div id="sosOverlay" class="fixed inset-0 bg-red-600 z-[10000] hidden flex-col items-center justify-center text-white text-center p-6 animate-pulse">
      <span class="material-symbols-rounded text-9xl mb-4 animate-bounce">campaign</span>
      <h1 class="text-4xl font-black mb-2">BAHAYA!</h1>
      <p class="text-xl font-bold mb-8" id="sosMessage">Seseorang butuh bantuan!</p>
      <button onclick="stopSOS()" class="bg-white text-red-600 px-10 py-4 rounded-full font-bold shadow-2xl text-lg hover:scale-105 transition-transform">SAYA MENGERTI</button>
  </div>

  <div id="crudModal" class="modal-overlay">
    <div class="modal-content shadow-2xl">
      <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-6"></div>
      <div class="flex justify-between items-center mb-6">
          <h2 id="modalTitle" class="text-2xl font-extrabold text-brand-primary dark:text-white uppercase tracking-tight">Judul</h2>
          <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500">
            <span class="material-symbols-rounded">close</span>
          </button>
      </div>
      <div id="modalBody" class="space-y-4 mb-4"></div>
      <div id="modalFooter">
          <button id="modalSubmitBtn" class="btn-primary">SIMPAN</button>
      </div>
    </div>
  </div>

  <header class="sticky top-0 z-30 px-6 pt-6 pb-2 bg-white/80 dark:bg-slate-950/80 backdrop-blur-md border-b border-slate-100 dark:border-slate-800 transition-colors">
      <div class="flex justify-between items-center">
          <div class="flex items-center gap-3" onclick="switchView('profile')">
              <div class="relative group">
                <img id="headerPhoto" class="w-11 h-11 rounded-full border-2 border-white dark:border-slate-800 shadow-md object-cover transition-transform group-active:scale-95" src="https://via.placeholder.com/100">
                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-slate-800 rounded-full animate-pulse"></div>
              </div>
              <div class="flex flex-col">
                  <span id="headerRole" class="text-[9px] font-bold text-accent dark:text-accent uppercase tracking-widest">Loading...</span>
                  <h1 id="headerName" class="text-lg font-extrabold text-brand-primary dark:text-white leading-none truncate w-32">...</h1>
              </div>
          </div>
          <div class="flex gap-2">
            <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 flex items-center justify-center text-slate-600 dark:text-yellow-400 active:scale-90 transition-all">
                <span class="material-symbols-rounded" id="darkModeIcon">dark_mode</span>
            </button>
            <button id="logoutBtn" class="w-10 h-10 rounded-full bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900/50 flex items-center justify-center text-red-500 active:scale-90 transition-all">
                <span class="material-symbols-rounded">logout</span>
            </button>
          </div>
      </div>
  </header>

  <main class="px-5 mt-4 relative z-10" id="mainContainer">
      
      <section id="view-home" class="view-section active">
          <div id="homeContentArea" class="mb-6">
              <div class="w-full h-40 skeleton"></div>
          </div> 
          
          <div class="grid grid-cols-4 gap-3 mb-8">
              <button onclick="switchView('market')" class="flex flex-col items-center gap-1 group">
                  <div class="w-14 h-14 bg-white dark:bg-slate-900 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm flex items-center justify-center group-active:scale-90 transition-all">
                      <span class="material-symbols-rounded text-2xl text-emerald-500">storefront</span>
                  </div>
                  <span class="text-[10px] font-bold dark:text-slate-300">Warung</span>
              </button>
              <button onclick="switchView('news')" class="flex flex-col items-center gap-1 group">
                  <div class="w-14 h-14 bg-white dark:bg-slate-900 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm flex items-center justify-center group-active:scale-90 transition-all">
                      <span class="material-symbols-rounded text-2xl text-blue-500">newspaper</span>
                  </div>
                  <span class="text-[10px] font-bold dark:text-slate-300">Mading</span>
              </button>
              <button onclick="switchView('events')" class="flex flex-col items-center gap-1 group">
                  <div class="w-14 h-14 bg-white dark:bg-slate-900 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm flex items-center justify-center group-active:scale-90 transition-all">
                      <span class="material-symbols-rounded text-2xl text-purple-500">qr_code_scanner</span>
                  </div>
                  <span class="text-[10px] font-bold dark:text-slate-300">Absen</span>
              </button>
              <button onclick="triggerKentongan()" class="flex flex-col items-center gap-1 group">
                  <div class="w-14 h-14 bg-red-50 dark:bg-red-900/30 rounded-2xl border border-red-100 dark:border-red-800 shadow-sm flex items-center justify-center group-active:scale-90 transition-all">
                      <span class="material-symbols-rounded text-2xl text-red-600 animate-pulse">campaign</span>
                  </div>
                  <span class="text-[10px] font-bold text-red-500">SOS</span>
              </button>
          </div>

          <div class="mb-6">
              <div class="flex justify-between items-end mb-3 px-1">
                  <h3 class="font-bold text-lg dark:text-white">Info Terbaru</h3>
                  <button onclick="switchView('news')" class="text-xs text-brand-primary dark:text-accent font-bold">Lihat Semua</button>
              </div>
              <div id="homeNewsPreview" class="flex gap-4 overflow-x-auto pb-4 no-scrollbar snap-x">
                  <div class="min-w-[200px] h-32 skeleton rounded-xl"></div>
                  <div class="min-w-[200px] h-32 skeleton rounded-xl"></div>
              </div>
          </div>
      </section>

      <section id="view-market" class="view-section">
          <div class="flex justify-between items-center mb-4 sticky top-0 bg-[#F8FAFC] dark:bg-[#020617] py-2 z-10 backdrop-blur-sm">
             <div><h2 class="text-2xl font-bold dark:text-white">Warung</h2><p class="text-xs text-slate-400">Jajan & Merchandise</p></div>
             <div class="relative" onclick="openCart()">
                 <span class="material-symbols-rounded text-2xl dark:text-white">shopping_cart</span>
                 <span id="cartBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full font-bold hidden">0</span>
             </div>
          </div>
          <div id="productList" class="grid grid-cols-2 gap-3 pb-20"></div>
      </section>

      <section id="view-news" class="view-section">
          <div class="flex justify-between items-center mb-4 sticky top-0 bg-[#F8FAFC] dark:bg-[#020617] py-2 z-10">
             <div><h2 class="text-2xl font-bold dark:text-white">Mading</h2><p class="text-xs text-slate-400">Berita Organisasi</p></div>
             <div id="newsControls"></div>
          </div>
          <div id="newsList" class="space-y-6 pb-20"></div>
      </section>

      <section id="view-users" class="view-section">
          <div class="flex justify-between items-end mb-4 px-1">
              <h2 class="text-2xl font-bold dark:text-white">Warga</h2>
              <div class="text-[10px] font-bold text-green-500 bg-green-50 px-2 py-1 rounded-full flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> Online</div>
          </div>
          <div id="userList" class="space-y-3"></div>
      </section>

      <section id="view-finance" class="view-section">
          <div class="flex justify-between items-center mb-4 px-1 sticky top-0 bg-[#F8FAFC] dark:bg-[#020617] py-2 z-10">
            <div><h2 class="text-2xl font-bold dark:text-white">Keuangan</h2><p class="text-xs text-slate-400">Transparan 100%</p></div>
            <div id="financeControls"></div>
          </div>
          <div class="card-std mb-6 h-56 relative"><canvas id="financeChart"></canvas></div>
          <div id="finList" class="space-y-3"></div>
      </section>

      <section id="view-events" class="view-section">
          <div class="flex justify-between items-center mb-4 px-1">
            <div><h2 class="text-2xl font-bold dark:text-white">Kegiatan</h2><p class="text-xs text-slate-400">Jadwal & Absensi</p></div>
            <div id="eventControls"></div>
          </div>
          <div id="actList" class="grid grid-cols-1 gap-4"></div>
      </section>

      <section id="view-profile" class="view-section">
        <div class="flex flex-col items-center pt-4">
            <div class="relative group cursor-pointer active:scale-95 transition-transform" onclick="$('profileUpload').click()">
                <img id="profileImage" src="https://via.placeholder.com/150" class="w-32 h-32 rounded-full object-cover border-4 border-white dark:border-slate-800 shadow-2xl">
                <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><span class="material-symbols-rounded text-white">photo_camera</span></div>
            </div>
            <input type="file" id="profileUpload" class="hidden" accept="image/*" onchange="window.previewProfileImage(this)">
            
            <h2 id="profileNameDisplay" class="text-2xl font-black dark:text-white mt-4">...</h2>
            <p id="profileRoleBadge" class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">...</p>
            
            <div class="grid grid-cols-2 gap-3 w-full mb-6">
                <div class="card-std text-center py-4">
                    <p class="text-[10px] text-slate-400 uppercase font-bold">Level</p>
                    <p id="lvlDisplay" class="text-2xl font-black text-brand-primary dark:text-white">1</p>
                </div>
                <div class="card-std text-center py-4">
                    <p class="text-[10px] text-slate-400 uppercase font-bold">XP Total</p>
                    <p id="xpDisplay" class="text-2xl font-black text-purple-500">0</p>
                </div>
            </div>

            <button onclick="showIdCard()" class="btn-primary flex items-center justify-center gap-2 mb-8"><span class="material-symbols-rounded">badge</span> TAMPILKAN ID CARD</button>

            <div class="w-full space-y-4 card-std">
                 <h3 class="font-bold dark:text-white">Edit Profil</h3>
                 <input id="editName" type="text" class="input-std" placeholder="Nama Lengkap">
                 <input id="editPhone" type="tel" class="input-std" placeholder="No WhatsApp">
                 <textarea id="editAddress" rows="3" class="input-std resize-none" placeholder="Alamat"></textarea>
                 <button onclick="saveProfile()" class="w-full bg-slate-800 dark:bg-slate-700 text-white py-3 rounded-xl font-bold">Update Data</button>
            </div>
        </div>
      </section>

  </main>

  <button onclick="toggleChat()" class="fixed z-[90] bottom-24 right-5 w-14 h-14 bg-brand-primary dark:bg-accent text-white rounded-full flex items-center justify-center shadow-2xl hover:scale-110 active:scale-95 transition-all border-4 border-white dark:border-slate-900">
      <span class="material-symbols-rounded text-2xl">forum</span>
      <span id="unreadChatBadge" class="absolute top-0 right-0 w-4 h-4 bg-red-500 rounded-full border-2 border-white dark:border-slate-900 hidden"></span>
  </button>
  
  <div id="chatWindow" class="fixed z-[100] bottom-24 right-5 bg-white dark:bg-slate-900 w-80 h-[450px] rounded-3xl shadow-2xl border border-slate-200 dark:border-slate-800 hidden flex-col overflow-hidden animate-slide-up origin-bottom-right">
      <div class="bg-brand-primary dark:bg-slate-950 text-white p-4 flex justify-between items-center">
          <h3 class="font-bold">Obrolan Warga</h3>
          <button onclick="toggleChat()"><span class="material-symbols-rounded">close</span></button>
      </div>
      <div id="chatMessages" class="flex-1 overflow-y-auto p-4 bg-slate-50 dark:bg-black flex flex-col gap-2"></div>
      <form onsubmit="sendMessage(event)" class="p-3 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 flex gap-2">
          <input id="chatInput" type="text" placeholder="Ketik pesan..." class="flex-1 bg-slate-100 dark:bg-slate-800 dark:text-white rounded-full px-4 py-2 text-xs outline-none" autocomplete="off">
          <button type="submit" class="w-8 h-8 bg-accent text-white rounded-full flex items-center justify-center shadow"><span class="material-symbols-rounded text-sm">send</span></button>
      </form>
  </div>

  <nav class="fixed bottom-0 w-full glass-nav pb-6 pt-3 px-6 z-50 rounded-t-[2rem]">
      <div class="flex justify-between items-center mx-auto max-w-md" id="bottomNavContainer"></div>
  </nav>

</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, addDoc, getDocs, onSnapshot, query, orderBy, limit, where, serverTimestamp, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
      authDomain: "katar-9cac3.firebaseapp.com",
      projectId: "katar-9cac3",
      storageBucket: "katar-9cac3.firebasestorage.app",
      messagingSenderId: "1017734829960",
      appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const CLOUD_NAME = "dbxktcwug"; // Your Cloudinary Name
    const UPLOAD_PRESET = "Karteji"; // Your Preset

    // --- GLOBAL VARS ---
    window.$ = (id) => document.getElementById(id);
    let UID = null;
    let ROLE = null;
    let USER = null;
    let CART = [];
    let CHART_INSTANCE = null;
    let PROFILE_FILE = null;
    const AUDIO_BEEP = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

    // --- UI UTILITIES ---
    window.toggleLoader = (show) => { const l = $("globalLoader"); show ? l.classList.remove('hidden') : l.classList.add('hidden'); }
    window.formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
    window.notify = (title, icon = 'success') => Swal.fire({ title, icon, toast: true, position: 'top', timer: 3000, showConfirmButton: false });

    // --- THEME ---
    window.toggleDarkMode = () => {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        $("darkModeIcon").textContent = isDark ? 'light_mode' : 'dark_mode';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };
    if(localStorage.getItem('theme') === 'dark') window.toggleDarkMode();

    // --- MODAL SYSTEM (BOTTOM SHEET) ---
    window.closeModal = () => { $("crudModal").classList.remove('open'); }
    window.showModal = (title, bodyHtml, onSave) => {
        $("modalTitle").textContent = title;
        $("modalBody").innerHTML = bodyHtml;
        $("crudModal").classList.add('open');
        const btn = $("modalSubmitBtn");
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        if(onSave) { newBtn.onclick = onSave; newBtn.style.display = 'block'; }
        else { newBtn.style.display = 'none'; }
    }

    async function upload(file) {
        if(!file) return null;
        const fd = new FormData(); fd.append("file", file); fd.append("upload_preset", UPLOAD_PRESET);
        try {
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{ method:"POST", body:fd });
            const data = await res.json();
            return { url: data.secure_url };
        } catch(e) { notify("Gagal Upload", "error"); throw e; }
    }

    // --- AUTH & INIT ---
    onAuthStateChanged(auth, async user => {
        if(!user) return location.href = "login.html";
        toggleLoader(true);
        try {
            const snap = await getDoc(doc(db,"users",user.uid));
            if(!snap.exists()) { alert("Akun tidak terdaftar DB"); return signOut(auth); }
            
            UID = user.uid;
            USER = snap.data();
            ROLE = USER.role || "anggota";

            // Update Header
            $("headerName").textContent = USER.name;
            $("headerRole").textContent = ROLE.replace('_',' ');
            $("headerPhoto").src = USER.photo?.url || "https://via.placeholder.com/150";

            // Daily Login Streak Logic
            checkDailyStreak();
            
            // Start Systems
            startPresence();
            initChat();
            initSOS();
            buildNav();
            switchView('home');

        } catch(e) { console.error(e); }
        toggleLoader(false);
    });

    async function checkDailyStreak() {
        const last = USER.lastLogin?.toDate().toDateString();
        const today = new Date().toDateString();
        if(last !== today) {
            await updateDoc(doc(db, "users", UID), { lastLogin: serverTimestamp(), xp: increment(10) });
            notify("Bonus Login Harian: +10 XP!", "info");
            confetti();
        }
    }
    
    function startPresence() { setInterval(() => updateDoc(doc(db, "users", UID), { lastSeen: serverTimestamp() }), 60000); }

    // --- NAVIGATION ---
    window.switchView = (id) => {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        const t = $(`view-${id}`); if(t) { t.style.display='block'; setTimeout(()=>t.classList.add('active'),10); }
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        const b = document.querySelector(`.nav-btn[data-target="${id}"]`); if(b) b.classList.add('active');

        // Logic Loaders
        if(id === 'home') renderHome();
        if(id === 'market') loadMarket();
        if(id === 'news') loadNews();
        if(id === 'users') loadUsers();
        if(id === 'finance') loadFinance();
        if(id === 'events') loadEvents();
        if(id === 'profile') loadProfile();
    }

    function buildNav() {
        const menus = [
            {id:'home', icon:'home_app_logo', txt:'Home'},
            {id:'market', icon:'storefront', txt:'Warung'},
            {id:'news', icon:'newspaper', txt:'Mading'},
            {id:'finance', icon:'account_balance_wallet', txt:'Kas'},
            {id:'profile', icon:'person', txt:'Saya'}
        ];
        const c = $("bottomNavContainer"); c.innerHTML = '';
        menus.forEach(m => {
            const active = m.id === 'home';
            c.innerHTML += `
                <button onclick="switchView('${m.id}')" data-target="${m.id}" class="nav-btn flex flex-col items-center gap-1 p-2 transition-all ${active?'active':''}">
                    <span class="material-symbols-rounded text-2xl text-slate-400 dark:text-slate-600 transition-colors">${m.icon}</span>
                    <p class="text-[10px] font-medium text-slate-400 dark:text-slate-600 transition-colors">${m.txt}</p>
                </button>`;
        });
    }

    // --- MODULE: HOME ---
    async function renderHome() {
        // Welcome Banner
        const xp = USER.xp || 0;
        $("homeContentArea").innerHTML = `
            <div class="bg-brand-primary dark:bg-slate-900 rounded-[2rem] p-6 text-white relative overflow-hidden shadow-xl">
                <div class="absolute -right-5 -top-5 opacity-10"><span class="material-symbols-rounded text-9xl">verified</span></div>
                <div class="relative z-10">
                    <p class="text-xs text-slate-300 mb-1">Selamat Datang,</p>
                    <h2 class="text-2xl font-bold mb-4">${USER.name.split(' ')[0]} ðŸ‘‹</h2>
                    <div class="flex gap-3">
                        <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm flex-1">
                            <p class="text-[10px] uppercase text-slate-400">Level</p>
                            <p class="text-xl font-black text-yellow-400">${Math.floor(xp/100)+1}</p>
                        </div>
                        <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm flex-1">
                            <p class="text-[10px] uppercase text-slate-400">Total XP</p>
                            <p class="text-xl font-black text-purple-300">${xp}</p>
                        </div>
                    </div>
                </div>
            </div>`;
        
        // News Preview
        const q = query(collection(db,"news"), orderBy("createdAt","desc"), limit(3));
        const s = await getDocs(q);
        const nc = $("homeNewsPreview"); nc.innerHTML = '';
        s.forEach(d => {
            const n = d.data();
            nc.innerHTML += `
                <div onclick="switchView('news')" class="min-w-[220px] h-32 rounded-xl bg-cover bg-center relative overflow-hidden shrink-0 shadow-sm cursor-pointer" style="background-image: url('${n.image?.url || 'https://via.placeholder.com/300'}')">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent flex flex-col justify-end p-3">
                        <p class="text-white text-xs font-bold line-clamp-2">${n.title}</p>
                        <p class="text-[9px] text-slate-300">${new Date(n.createdAt.toMillis()).toLocaleDateString()}</p>
                    </div>
                </div>`;
        });
    }

    // --- MODULE: MARKET (WARUNG) ---
    async function loadMarket() {
        const list = $("productList"); list.innerHTML = Array(4).fill('<div class="h-40 skeleton"></div>').join('');
        const snap = await getDocs(collection(db, "products"));
        list.innerHTML = "";
        
        snap.forEach(d => {
            const p = d.data();
            list.innerHTML += `
                <div class="card-std p-0 overflow-hidden group">
                    <div class="h-32 bg-slate-100 dark:bg-slate-800 bg-cover bg-center" style="background-image: url('${p.image?.url || 'https://via.placeholder.com/150'}')"></div>
                    <div class="p-3">
                        <h4 class="font-bold text-sm dark:text-white truncate">${p.name}</h4>
                        <p class="text-xs text-slate-500 mb-2">${formatRupiah(p.price)}</p>
                        <button onclick="addToCart('${d.id}', '${p.name}', ${p.price})" class="w-full bg-slate-100 dark:bg-slate-800 text-brand-primary dark:text-white text-[10px] font-bold py-2 rounded-lg hover:bg-brand-primary hover:text-white transition-colors">TAMBAH +</button>
                    </div>
                </div>`;
        });

        if(['admin','koordinator'].includes(ROLE)) {
            list.innerHTML += `<button onclick="addProduct()" class="card-std flex flex-col items-center justify-center border-dashed border-2 border-slate-300 min-h-[200px]"><span class="material-symbols-rounded text-4xl text-slate-300">+</span><span class="text-xs font-bold text-slate-400">Jual Barang</span></button>`;
        }
    }

    window.addToCart = (id, name, price) => {
        CART.push({id, name, price});
        $("cartBadge").textContent = CART.length;
        $("cartBadge").classList.remove('hidden');
        notify(`${name} masuk keranjang!`);
    }

    window.openCart = () => {
        if(CART.length === 0) return notify("Keranjang kosong", "info");
        const total = CART.reduce((a,b)=>a+b.price,0);
        const html = `
            <div class="space-y-2 mb-4">
                ${CART.map(i => `<div class="flex justify-between text-sm border-b pb-1"><span>${i.name}</span><span>${formatRupiah(i.price)}</span></div>`).join('')}
                <div class="flex justify-between font-bold text-lg mt-2 pt-2 border-t"><span>Total</span><span>${formatRupiah(total)}</span></div>
            </div>`;
        showModal("Keranjang Belanja", html, async () => {
            toggleLoader(true);
            // 1. Save Order
            await addDoc(collection(db, "orders"), { uid: UID, items: CART, total, createdAt: serverTimestamp(), status: 'paid' });
            // 2. Auto-Entry to Finance (Income)
            await addDoc(collection(db, "financial_records"), { type: 'income', amount: total, note: `Penjualan Warung: ${USER.name}`, status: 'approved', createdAt: serverTimestamp() });
            
            CART = []; $("cartBadge").classList.add('hidden');
            toggleLoader(false); closeModal(); notify("Pembelian Berhasil!", "success"); confetti();
        });
    }

    window.addProduct = () => {
        const html = `<input id="pName" class="input-std mb-2" placeholder="Nama Barang"><input id="pPrice" type="number" class="input-std mb-2" placeholder="Harga"><input type="file" id="pImg" class="text-xs">`;
        showModal("Tambah Produk", html, async () => {
            toggleLoader(true);
            const img = await upload($("pImg").files[0]);
            await addDoc(collection(db,"products"), { name:$("pName").value, price:Number($("pPrice").value), image:img });
            toggleLoader(false); closeModal(); loadMarket();
        });
    }

    // --- MODULE: NEWS (MADING) ---
    async function loadNews() {
        const list = $("newsList"); list.innerHTML = Array(3).fill('<div class="h-48 skeleton"></div>').join('');
        const q = query(collection(db, "news"), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        list.innerHTML = "";

        if(['admin','sekretaris','ketua'].includes(ROLE)) {
            $("newsControls").innerHTML = `<button onclick="postNews()" class="bg-brand-primary text-white px-3 py-1 rounded-lg text-xs font-bold">+ Tulis</button>`;
        }

        snap.forEach(d => {
            const n = d.data();
            list.innerHTML += `
                <div class="card-std p-0 overflow-hidden">
                    <img src="${n.image?.url}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg dark:text-white leading-tight">${n.title}</h3>
                            <span class="text-[10px] bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-slate-500">${new Date(n.createdAt.toMillis()).toLocaleDateString()}</span>
                        </div>
                        <p class="text-sm text-slate-600 dark:text-slate-400 line-clamp-3">${n.content}</p>
                        <button onclick="readNews('${n.title}', '${n.content}')" class="text-brand-primary dark:text-accent text-xs font-bold mt-2">Baca Selengkapnya</button>
                    </div>
                </div>`;
        });
    }

    window.postNews = () => {
        const html = `<input id="nTitle" class="input-std mb-2" placeholder="Judul Berita"><textarea id="nContent" class="input-std mb-2 h-24" placeholder="Isi Berita"></textarea><input type="file" id="nImg" class="text-xs">`;
        showModal("Tulis Mading", html, async () => {
            toggleLoader(true);
            const img = await upload($("nImg").files[0]);
            await addDoc(collection(db, "news"), { title: $("nTitle").value, content: $("nContent").value, image: img, createdAt: serverTimestamp() });
            toggleLoader(false); closeModal(); loadNews(); notify("Berita Terbit!");
        });
    }

    window.readNews = (t, c) => Swal.fire({ title: t, text: c, width: '90%', confirmButtonColor: '#0F172A' });

    // --- MODULE: USERS ---
    async function loadUsers() {
        const list = $("userList"); list.innerHTML = Array(5).fill('<div class="h-16 skeleton"></div>').join('');
        const snap = await getDocs(query(collection(db, "users"), orderBy("name")));
        list.innerHTML = "";
        snap.forEach(d => {
            const u = d.data();
            const isOnline = (Date.now() - (u.lastSeen?.toMillis()||0)) < 120000;
            list.innerHTML += `
                <div class="bg-white dark:bg-slate-900 p-3 rounded-xl border border-slate-100 dark:border-slate-800 flex items-center gap-3">
                    <div class="relative"><img src="${u.photo?.url||'https://via.placeholder.com/50'}" class="w-10 h-10 rounded-full object-cover ${!isOnline?'grayscale':''}"><span class="absolute bottom-0 right-0 w-2.5 h-2.5 ${isOnline?'bg-green-500':'bg-slate-300'} border-2 border-white dark:border-slate-800 rounded-full"></span></div>
                    <div><p class="text-sm font-bold dark:text-white">${u.name}</p><p class="text-[10px] text-slate-400 uppercase font-bold">${u.role}</p></div>
                </div>`;
        });
    }

    // --- MODULE: FINANCE ---
    async function loadFinance() {
        const list = $("finList"); list.innerHTML = '<div class="h-12 skeleton"></div>';
        const snap = await getDocs(query(collection(db, "financial_records"), orderBy("createdAt", "desc")));
        list.innerHTML = '';
        
        let inc = 0, exp = 0;
        snap.forEach(d => {
            const f = d.data();
            if(f.status==='approved') f.type==='income' ? inc+=Number(f.amount) : exp+=Number(f.amount);
            list.innerHTML += `
                <div class="flex justify-between items-center py-3 border-b border-slate-100 dark:border-slate-800 last:border-0">
                    <div><p class="text-sm font-bold dark:text-white">${f.note}</p><p class="text-[10px] text-slate-400">${new Date(f.createdAt?.toMillis()).toLocaleDateString()}</p></div>
                    <span class="font-bold text-sm ${f.type==='income'?'text-green-500':'text-red-500'}">${f.type==='income'?'+':'-'} ${formatRupiah(f.amount)}</span>
                </div>`;
        });

        // Controls
        if(['admin','bendahara'].includes(ROLE)) {
            $("financeControls").innerHTML = `<button onclick="addFinance()" class="bg-brand-primary text-white w-8 h-8 rounded-full shadow flex items-center justify-center text-lg font-bold">+</button>`;
        }

        // Chart
        if(CHART_INSTANCE) CHART_INSTANCE.destroy();
        CHART_INSTANCE = new Chart($("financeChart"), {
            type: 'doughnut',
            data: { labels: ['Masuk', 'Keluar'], datasets: [{ data: [inc, exp], backgroundColor: ['#10B981', '#EF4444'], borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, color: document.documentElement.classList.contains('dark')?'white':'#333' } } } }
        });
    }

    window.addFinance = () => {
        const html = `<select id="fType" class="input-std mb-2"><option value="income">Pemasukan (+)</option><option value="expense">Pengeluaran (-)</option></select><input id="fAmt" type="number" class="input-std mb-2" placeholder="Rp"><input id="fNote" class="input-std" placeholder="Catatan">`;
        showModal("Catat Keuangan", html, async () => {
             await addDoc(collection(db,"financial_records"), { type:$("fType").value, amount:$("fAmt").value, note:$("fNote").value, status:'approved', createdAt: serverTimestamp() });
             closeModal(); loadFinance();
        });
    }

    // --- MODULE: EVENTS & ABSENSI QR ---
    async function loadEvents() {
        const list = $("actList"); list.innerHTML = "";
        const snap = await getDocs(query(collection(db, "activities"), orderBy("createdAt", "desc")));
        
        if(['admin','ketua'].includes(ROLE)) $("eventControls").innerHTML = `<button onclick="addEvent()" class="bg-brand-primary text-white w-8 h-8 rounded-full flex items-center justify-center shadow">+</button>`;

        snap.forEach(d => {
            const x = d.data();
            list.innerHTML += `
                <div class="card-std flex gap-3 items-center">
                    <div class="bg-blue-50 dark:bg-blue-900/30 w-16 h-16 rounded-2xl flex flex-col items-center justify-center text-blue-600 dark:text-blue-400 font-bold"><span class="text-xl">${x.date?.split('-')[2]||'??'}</span><span class="text-[10px] uppercase">${x.date ? new Date(x.date).toLocaleString('default', { month: 'short' }) : 'TBA'}</span></div>
                    <div class="flex-1">
                        <h4 class="font-bold dark:text-white text-sm">${x.title}</h4>
                        <p class="text-xs text-slate-400 flex items-center gap-1 mb-2"><span class="material-symbols-rounded text-sm">location_on</span> ${x.location}</p>
                        <button onclick="showQR('${x.title}')" class="bg-slate-800 text-white text-[10px] px-3 py-1.5 rounded-full font-bold flex items-center gap-1 w-fit"><span class="material-symbols-rounded text-xs">qr_code</span> Tiket Absen</button>
                    </div>
                </div>`;
        });
    }

    window.addEvent = () => {
        const html = `<input id="eT" class="input-std mb-2" placeholder="Nama Acara"><input type="date" id="eD" class="input-std mb-2"><input id="eL" class="input-std" placeholder="Lokasi">`;
        showModal("Agenda Baru", html, async () => { await addDoc(collection(db,"activities"),{title:$("eT").value, date:$("eD").value, location:$("eL").value, createdAt:serverTimestamp()}); closeModal(); loadEvents(); });
    }

    window.showQR = (title) => {
        // Generate Unique QR Content: EVENT_NAME|USER_UID|TIMESTAMP
        const code = `${title}|${UID}|${Date.now()}`;
        const html = `<div id="qrcode" class="flex justify-center mb-4"></div><p class="text-center text-xs text-slate-400">Tunjukkan QR ini ke panitia saat acara.</p>`;
        showModal("Tiket Absensi", html, null);
        setTimeout(() => new QRCode($("qrcode"), { text: code, width: 200, height: 200 }), 100);
    }

    // --- MODULE: PROFILE ---
    async function loadProfile() {
        $("profileNameDisplay").textContent = USER.name;
        $("profileRoleBadge").textContent = ROLE;
        $("lvlDisplay").textContent = Math.floor((USER.xp||0)/100) + 1;
        $("xpDisplay").textContent = USER.xp || 0;
        $("editName").value = USER.name; $("editPhone").value = USER.phone||""; $("editAddress").value = USER.address||"";
    }

    window.previewProfileImage = (input) => { if(input.files[0]){ const r=new FileReader(); r.onload=(e)=>$("profileImage").src=e.target.result; r.readAsDataURL(input.files[0]); PROFILE_FILE=input.files[0]; } }
    window.saveProfile = async () => {
        toggleLoader(true);
        let u = { name:$("editName").value, phone:$("editPhone").value, address:$("editAddress").value };
        if(PROFILE_FILE) u.photo = await upload(PROFILE_FILE);
        await updateDoc(doc(db,"users",UID), u);
        toggleLoader(false); notify("Profil Disimpan");
    }
    
    window.showIdCard = () => {
        const html = `
            <div class="bg-gradient-to-br from-slate-800 to-black text-white p-6 rounded-2xl relative overflow-hidden shadow-2xl transform rotate-1 hover:rotate-0 transition-transform">
                <div class="absolute top-0 right-0 p-4 opacity-10"><span class="material-symbols-rounded text-8xl">verified_user</span></div>
                <div class="flex items-center gap-4 mb-6">
                    <img src="${USER.photo?.url}" class="w-16 h-16 rounded-full border-2 border-white/30">
                    <div><h2 class="text-xl font-bold uppercase tracking-wider">${USER.name}</h2><p class="text-xs text-brand-accent font-mono">${UID.substring(0,8)}</p></div>
                </div>
                <div class="border-t border-white/10 pt-4 flex justify-between items-end">
                    <div><p class="text-[10px] text-slate-400 uppercase">Jabatan</p><p class="font-bold text-yellow-500 uppercase">${ROLE}</p></div>
                    <div class="bg-white/10 px-3 py-1 rounded text-xs">KARANG TARUNA</div>
                </div>
            </div>`;
        showModal("ID Card Resmi", html, null);
    }

    // --- SOS & CHAT ---
    window.triggerKentongan = async () => { if(await Swal.fire({title:'Yakin Bahaya?', icon:'warning', showCancelButton:true})) { await addDoc(collection(db,"notifications"),{level:'sos', sender:USER.name, uid:UID, createdAt:serverTimestamp()}); notify("Alert Terkirim!","warning"); } }
    function initSOS() { onSnapshot(query(collection(db,"notifications"),where("level","==","sos"),orderBy("createdAt","desc"),limit(1)),s=>{ s.docChanges().forEach(c=>{ if(c.type==='added'){ const d=c.doc.data(); if((Date.now()-(d.createdAt?.toMillis()||0))<15000 && d.uid!==UID){ $("sosOverlay").classList.remove("hidden"); $("sosOverlay").classList.add("flex"); $("sosMessage").textContent=`${d.sender} membunyikan kentongan!`; AUDIO_BEEP.loop=true; AUDIO_BEEP.play().catch(()=>{}); } } }) }); }
    window.stopSOS = () => { $("sosOverlay").classList.add("hidden"); $("sosOverlay").classList.remove("flex"); AUDIO_BEEP.pause(); }
    
    // Chat Logic
    window.toggleChat = () => { $("chatWindow").classList.toggle("hidden"); $("chatWindow").classList.toggle("flex"); scrollToBottom(); }
    window.sendMessage = async(e) => { e.preventDefault(); const t=$("chatInput").value.trim(); if(!t)return; $("chatInput").value=''; await addDoc(collection(db,"public_chats"),{text:t, uid:UID, name:USER.name, createdAt:serverTimestamp()}); }
    function initChat() { onSnapshot(query(collection(db,"public_chats"),orderBy("createdAt","desc"),limit(50)),s=>{ const l=$("chatMessages"); l.innerHTML=''; const msgs=[]; s.forEach(d=>msgs.push(d.data())); msgs.reverse().forEach(m=>{ const me=m.uid===UID; l.innerHTML+=`<div class="max-w-[85%] p-3 rounded-2xl text-xs mb-1 ${me?'bg-brand-primary dark:bg-accent text-white self-end ml-auto rounded-br-sm':'bg-slate-100 dark:bg-slate-800 dark:text-white self-start rounded-bl-sm'}"><b>${me?'':m.name+'<br>'}</b>${m.text}</div>`}); scrollToBottom(); }); }
    function scrollToBottom() { const d=$("chatMessages"); d.scrollTop=d.scrollHeight; }

    $("logoutBtn").onclick = () => signOut(auth);
  </script>
</body>
</html>
