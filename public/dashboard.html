<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Dashboard Super App | KARTEJI</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          colors: {
            brand: { primary: '#0F172A', light: '#334155' },
            accent: { DEFAULT: '#F97316', light: '#FFEDD5' },
            purple: { DEFAULT: '#8B5CF6', light: '#EDE9FE' },
            cyber: { 500: '#06b6d4', 900: '#083344' }
          },
          animation: { 'blob': 'blob 10s infinite', 'bounce-slow': 'bounce 3s infinite', 'slide-up': 'slideUp 0.3s ease-out', 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite' },
          keyframes: {
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
              '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #F8FAFC; color: #1E293B; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .glass-nav {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(15, 23, 42, 0.05);
      box-shadow: 0 -10px 40px rgba(0,0,0,0.05);
    }
    .view-section { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
    .view-section.active { display: block; opacity: 1; transform: translateY(0); }
    .nav-btn.active span { font-variation-settings: 'FILL' 1; color: #F97316; }
    .nav-btn.active p { color: #0F172A; font-weight: 700; }
    
    /* Chat Bubble Styles */
    .chat-bubble { max-width: 75%; padding: 8px 12px; border-radius: 16px; font-size: 13px; line-height: 1.4; position: relative; margin-bottom: 4px; }
    .chat-me { background-color: #F97316; color: white; border-bottom-right-radius: 4px; align-self: flex-end; margin-left: auto; }
    .chat-other { background-color: #F1F5F9; color: #334155; border-bottom-left-radius: 4px; align-self: flex-start; }
    .chat-meta { font-size: 9px; margin-top: 2px; opacity: 0.7; }

    /* SOS Alert Animation */
    @keyframes flashRed { 0%, 100% { background-color: rgba(239, 68, 68, 0); } 50% { background-color: rgba(239, 68, 68, 0.3); } }
    .sos-active { animation: flashRed 1s infinite; }
  </style>
</head>

<body class="min-h-screen relative overflow-x-hidden pb-32 selection:bg-orange-200 selection:text-orange-900" id="bodyMain">

  <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
    <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-blue-100 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob"></div>
    <div class="absolute top-[20%] right-[-10%] w-96 h-96 bg-orange-100 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-2000"></div>
  </div>

  <div id="globalLoader" class="fixed inset-0 bg-white/80 z-[9999] flex items-center justify-center flex-col gap-4 backdrop-blur-md hidden">
    <div class="w-12 h-12 border-4 border-slate-200 border-t-accent rounded-full animate-spin"></div>
    <p class="text-xs font-bold text-slate-400 animate-pulse">MEMUAT SYSTEM...</p>
  </div>
  
  <div id="sosOverlay" class="fixed inset-0 bg-red-600/90 z-[9998] hidden flex-col items-center justify-center text-white text-center p-6 animate-pulse z-[10000]">
      <span class="material-symbols-rounded text-9xl mb-4 animate-bounce">campaign</span>
      <h1 class="text-4xl font-black mb-2">BAHAYA / DARURAT!</h1>
      <p class="text-xl font-bold" id="sosMessage">Seseorang membunyikan kentongan digital!</p>
      <button onclick="stopSOS()" class="mt-8 bg-white text-red-600 px-8 py-3 rounded-full font-bold shadow-xl">SAYA MENGERTI</button>
  </div>

  <div id="crudModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm transition-all">
    <div class="bg-white w-full max-w-md rounded-[2rem] p-6 relative shadow-2xl animate-[slideUp_0.3s_ease-out]">
      <div class="flex justify-between items-center mb-6">
          <h2 id="modalTitle" class="text-xl font-extrabold text-brand-primary uppercase tracking-tight">Judul</h2>
          <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200 transition-colors text-slate-500">
            <span class="material-symbols-rounded text-xl">close</span>
          </button>
      </div>
      <div id="modalBody" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar"></div>
      <button id="modalSubmitBtn" class="mt-6 w-full rounded-xl bg-brand-primary text-white py-4 text-sm font-bold shadow-lg shadow-slate-300 hover:bg-slate-800 active:scale-95 transition-all">SIMPAN</button>
    </div>
  </div>

  <header class="sticky top-0 z-30 px-6 pt-8 pb-4 bg-gradient-to-b from-[#F8FAFC] via-[#F8FAFC] to-transparent">
      <div class="flex justify-between items-center">
          <div class="flex items-center gap-3">
              <button onclick="switchView('profile')" class="relative group active:scale-95 transition-transform">
                <img id="headerPhoto" class="w-11 h-11 rounded-full border-2 border-white shadow-md object-cover" src="https://via.placeholder.com/100">
                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full animate-pulse"></div>
              </button>
              <div>
                  <div class="flex items-center gap-1">
                    <p id="headerRole" class="text-[10px] font-bold text-accent uppercase tracking-widest bg-accent-light px-2 py-0.5 rounded-full w-fit mb-0.5">Memuat...</p>
                    <div id="xpBadge" class="text-[9px] font-black text-white bg-gradient-to-r from-blue-500 to-purple-500 px-2 py-0.5 rounded-full">LVL 1</div>
                  </div>
                  <h1 id="headerName" class="text-xl font-extrabold text-brand-primary leading-none">...</h1>
              </div>
          </div>
          <button id="logoutBtn" class="w-10 h-10 rounded-full bg-white border border-slate-100 shadow-sm flex items-center justify-center text-red-500 hover:bg-red-50 hover:border-red-100 transition-all active:scale-95">
            <span class="material-symbols-rounded text-xl">logout</span>
          </button>
      </div>
  </header>

  <main class="px-5 mt-2 relative z-10" id="mainContainer">
      
      <section id="view-home" class="view-section active">
          <div id="homeContentArea"></div> 
          
          <div class="mt-6">
              <h3 class="font-bold text-slate-800 mb-3 px-1">Zona Seru (New!)</h3>
              <div class="grid grid-cols-4 gap-2">
                  <button onclick="switchView('playground')" class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-1 active:scale-95">
                      <span class="material-symbols-rounded text-2xl text-purple-500">sports_esports</span>
                      <span class="text-[9px] font-bold">Games</span>
                  </button>
                  <button onclick="switchView('playground')" class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-1 active:scale-95">
                      <span class="material-symbols-rounded text-2xl text-pink-500">favorite</span>
                      <span class="text-[9px] font-bold">Kudos</span>
                  </button>
                  <button onclick="switchView('playground')" class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-1 active:scale-95">
                      <span class="material-symbols-rounded text-2xl text-yellow-500">mood</span>
                      <span class="text-[9px] font-bold">Vibe</span>
                  </button>
                  <button onclick="triggerKentongan()" class="bg-red-50 p-3 rounded-2xl shadow-sm border border-red-100 flex flex-col items-center gap-1 active:scale-95">
                      <span class="material-symbols-rounded text-2xl text-red-600 animate-pulse">campaign</span>
                      <span class="text-[9px] font-bold text-red-600">SOS</span>
                  </button>
              </div>
          </div>
      </section>

      <section id="view-playground" class="view-section">
          <div class="flex flex-col gap-6 pb-24">
              
              <div class="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-[2rem] p-6 text-white shadow-lg relative overflow-hidden">
                  <div class="absolute top-0 right-0 p-4 opacity-20"><span class="material-symbols-rounded text-8xl">sentiment_satisfied</span></div>
                  <h3 class="font-bold text-lg mb-1">Vibe Check Hari Ini</h3>
                  <p class="text-xs text-indigo-100 mb-4">Gimana perasaanmu hari ini?</p>
                  
                  <div class="flex justify-between gap-2 relative z-10" id="moodSelector">
                      <button onclick="submitMood('happy')" class="bg-white/20 hover:bg-white/40 backdrop-blur-md p-3 rounded-2xl flex-1 text-3xl transition-transform hover:scale-110">üî•</button>
                      <button onclick="submitMood('neutral')" class="bg-white/20 hover:bg-white/40 backdrop-blur-md p-3 rounded-2xl flex-1 text-3xl transition-transform hover:scale-110">üòê</button>
                      <button onclick="submitMood('sad')" class="bg-white/20 hover:bg-white/40 backdrop-blur-md p-3 rounded-2xl flex-1 text-3xl transition-transform hover:scale-110">‚õàÔ∏è</button>
                  </div>
                  <div id="moodResult" class="hidden mt-4 bg-white/10 rounded-xl p-3 text-center text-xs font-bold">
                      Vibe Organisasi: <span id="orgVibeScore">Loading...</span>
                  </div>
              </div>

              <div class="bg-white border border-slate-100 rounded-[2rem] p-5 shadow-sm">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="font-bold text-brand-primary flex items-center gap-2">
                          <span class="material-symbols-rounded text-yellow-500">military_tech</span> Top Suhu
                      </h3>
                      <span class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500">Minggu Ini</span>
                  </div>
                  <div id="xpLeaderboard" class="space-y-3">
                      </div>
              </div>

              <div>
                   <div class="flex justify-between items-center mb-3">
                       <h3 class="font-bold text-slate-800">Pojok Apresiasi</h3>
                       <button onclick="openKudosModal()" class="text-xs font-bold text-pink-500">+ Kirim Respect</button>
                   </div>
                   <div id="kudosList" class="flex overflow-x-auto gap-3 pb-2 no-scrollbar">
                       </div>
              </div>

              <div class="bg-slate-800 rounded-[2rem] p-6 text-white relative overflow-hidden">
                   <span class="material-symbols-rounded absolute -right-5 -bottom-5 text-8xl opacity-10">lock</span>
                   <h3 class="font-bold text-lg mb-2">Kotak Curhat (Anonim)</h3>
                   <p class="text-xs text-slate-400 mb-4">Kirim masukan ke pengurus tanpa ketahuan identitasmu. Aman 100%.</p>
                   <textarea id="confessInput" class="w-full bg-slate-700 rounded-xl p-3 text-sm text-white outline-none focus:ring-2 focus:ring-accent mb-3" rows="2" placeholder="Tulis uneg-uneg..."></textarea>
                   <button onclick="sendConfess()" class="w-full bg-white text-slate-900 font-bold py-3 rounded-xl hover:bg-slate-200">Kirim Rahasia</button>
              </div>

          </div>
      </section>

      <section id="view-users" class="view-section">
          <div class="flex justify-between items-end mb-4 px-1">
              <div><h2 class="text-2xl font-bold text-brand-primary">Anggota</h2><p class="text-xs text-slate-400">Status & Manajemen</p></div>
              <div class="flex gap-2" id="userExportContainer"></div>
          </div>
          <div class="flex gap-4 mb-4 text-[10px] font-bold text-slate-500 px-1">
              <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Online</div>
              <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-300"></span> Offline</div>
          </div>
          <div id="userList" class="space-y-3 pb-20"></div>
      </section>

      <section id="view-finance" class="view-section">
          <div class="flex justify-between items-center mb-6 px-1 sticky top-0 bg-[#F8FAFC] py-2 z-10">
            <div><h2 class="text-2xl font-bold text-brand-primary">Keuangan</h2><p class="text-xs text-slate-400">Laporan Kas</p></div>
            <div class="flex gap-2" id="financeControls"></div>
          </div>
          <div id="finList" class="space-y-3 pb-20"></div>
      </section>

      <section id="view-events" class="view-section">
          <div class="flex justify-between items-center mb-6 px-1 sticky top-0 bg-[#F8FAFC] py-2 z-10">
            <div><h2 class="text-2xl font-bold text-brand-primary">Kegiatan</h2><p class="text-xs text-slate-400">Agenda Organisasi</p></div>
            <div id="eventControls"></div>
          </div>
          <div id="actList" class="grid grid-cols-1 gap-4 pb-20"></div>
      </section>

      <section id="view-documents" class="view-section">
         <div class="bg-white p-1 rounded-xl shadow-sm border border-slate-100 mb-4 flex">
             <button onclick="loadDocuments('surat')" class="flex-1 py-2 text-xs font-bold rounded-lg bg-brand-primary text-white">Surat</button>
             <button onclick="loadDocuments('notulen')" class="flex-1 py-2 text-xs font-bold text-slate-500">Notulen</button>
             <button onclick="loadDocuments('arsip')" class="flex-1 py-2 text-xs font-bold text-slate-500">Arsip</button>
         </div>
         <div class="flex justify-end mb-4"><button onclick="openDocModal()" class="bg-blue-600 text-white text-xs px-4 py-2 rounded-lg font-bold">+ Tambah</button></div>
         <div id="docList" class="space-y-3 pb-20"></div>
      </section>

      <section id="view-arisan" class="view-section">
        <div class="w-full bg-purple-600 rounded-[2.5rem] p-7 text-white text-center relative overflow-hidden shadow-xl mb-6">
             <h2 class="text-2xl font-black mb-2">Arisan & Undian</h2>
             <div id="raffleArea" class="bg-white/10 rounded-xl p-4 mb-4 backdrop-blur-sm"><h3 class="text-3xl font-bold" id="raffleDisplay">???</h3></div>
             <button onclick="runRaffle()" id="btnSpin" class="bg-white text-purple-600 w-full py-3 rounded-xl font-bold shadow-lg">PUTAR (KOCOK)</button>
        </div>
        <div id="arisanHistory" class="space-y-2 pb-20"></div>
      </section>

      <section id="view-inventory" class="view-section">
        <div class="flex justify-between mb-4"><h2 class="text-xl font-bold">Inventaris</h2><button onclick="openInvModal()" class="bg-brand-primary text-white px-3 rounded-lg text-xs font-bold">+ Barang</button></div>
        <div id="invList" class="grid grid-cols-2 gap-3 pb-20"></div>
      </section>

      <section id="view-profile" class="view-section">
        <div class="flex flex-col items-center pt-4 pb-20">
            <div class="relative group cursor-pointer active:scale-95 transition-transform" onclick="$('profileUpload').click()">
                <img id="profileImage" src="https://via.placeholder.com/150" class="w-28 h-28 rounded-full object-cover border-4 border-white shadow-xl">
                <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><span class="material-symbols-rounded text-white">photo_camera</span></div>
            </div>
            <input type="file" id="profileUpload" class="hidden" accept="image/*" onchange="previewProfileImage(this)">
            
            <h2 id="profileNameDisplay" class="text-xl font-bold text-brand-primary mt-4 mb-0.5">User</h2>
            <div class="flex gap-2">
                <div id="profileRoleBadge" class="px-3 py-0.5 bg-blue-100 text-blue-700 rounded-full text-[10px] font-extrabold uppercase tracking-wide mb-1">ROLE</div>
                <div id="profileXpDisplay" class="px-3 py-0.5 bg-purple-100 text-purple-700 rounded-full text-[10px] font-extrabold uppercase tracking-wide mb-1">0 XP</div>
            </div>
            <p id="profileEmailDisplay" class="text-sm text-slate-400">email@user.com</p>

            <button onclick="showIdCard()" class="mt-4 bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold flex gap-2"><span class="material-symbols-rounded text-sm">badge</span> ID CARD DIGITAL</button>

            <div class="w-full mt-8 space-y-4 px-1 bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                 <input id="editName" type="text" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border border-slate-100" placeholder="Nama Lengkap">
                 <input id="editPhone" type="tel" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border border-slate-100" placeholder="No HP">
                 <textarea id="editAddress" rows="2" class="w-full p-3 bg-slate-50 rounded-xl text-sm border border-slate-100" placeholder="Alamat"></textarea>
                 <button onclick="saveProfile()" class="w-full bg-brand-primary text-white py-4 rounded-2xl font-bold shadow-lg">SIMPAN PROFIL</button>
            </div>
        </div>
      </section>

  </main>

  <div id="chatWidget" class="fixed z-[90] bottom-24 right-4 flex flex-col items-end gap-2">
      <div id="chatWindow" class="bg-white w-80 h-96 rounded-2xl shadow-2xl border border-slate-200 hidden flex-col overflow-hidden animate-slide-up origin-bottom-right">
          <div class="bg-brand-primary text-white p-3 flex justify-between items-center">
              <div>
                  <h3 class="font-bold text-sm">Obrolan Warga</h3>
                  <p class="text-[10px] text-slate-300 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-400 rounded-full"></span> Online</p>
              </div>
              <button onclick="toggleChat()" class="text-white hover:bg-white/10 rounded-full p-1"><span class="material-symbols-rounded">close</span></button>
          </div>
          <div id="chatMessages" class="flex-1 overflow-y-auto p-4 bg-slate-50 flex flex-col gap-2"></div>
          <form onsubmit="sendMessage(event)" class="p-2 border-t border-slate-100 bg-white flex gap-2">
              <input id="chatInput" type="text" placeholder="Ketik pesan..." class="flex-1 bg-slate-100 rounded-full px-4 py-2 text-sm outline-none focus:ring-1 focus:ring-accent" autocomplete="off">
              <button type="submit" class="w-9 h-9 bg-accent text-white rounded-full flex items-center justify-center shadow-lg active:scale-90"><span class="material-symbols-rounded text-lg">send</span></button>
          </form>
      </div>

      <button onclick="toggleChat()" class="w-14 h-14 bg-brand-primary text-white rounded-full flex items-center justify-center shadow-2xl hover:scale-105 active:scale-95 transition-all border-4 border-white relative">
          <span class="material-symbols-rounded text-2xl">forum</span>
          <span id="unreadChatBadge" class="absolute top-0 right-0 w-4 h-4 bg-red-500 rounded-full border-2 border-white hidden"></span>
      </button>
  </div>

  <nav class="fixed bottom-0 w-full glass-nav pb-6 pt-2 px-4 z-50 rounded-t-[2rem]">
      <div class="flex justify-between items-center max-w-sm mx-auto" id="bottomNavContainer">
          </div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, addDoc, getDocs, onSnapshot, query, orderBy, limit, where, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
      authDomain: "katar-9cac3.firebaseapp.com",
      projectId: "katar-9cac3",
      storageBucket: "katar-9cac3.firebasestorage.app",
      messagingSenderId: "1017734829960",
      appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const CLOUD_NAME = "dbxktcwug";
    const UPLOAD_PRESET = "Karteji";

    window.$ = (id) => document.getElementById(id);
    let UID = null;
    let CURRENT_ROLE = null;
    let CURRENT_USER_DATA = null;
    let newProfileFile = null;
    
    // SOUNDS
    const audioBeep = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 

    // --- 1. UTILITIES ---
    window.toggleLoader = (show) => {
        const l = $("globalLoader");
        if(show) { l.classList.remove('hidden'); l.classList.add('flex'); }
        else { l.classList.add('hidden'); l.classList.remove('flex'); }
    };

    window.closeModal = () => $("crudModal").classList.add('hidden');
    window.showModal = (title, bodyHtml, onSave) => {
        $("modalTitle").textContent = title;
        $("modalBody").innerHTML = bodyHtml;
        $("crudModal").classList.remove('hidden'); $("crudModal").classList.add('flex');
        const btn = $("modalSubmitBtn");
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        if(onSave) { newBtn.onclick = onSave; newBtn.style.display = 'block'; }
        else { newBtn.style.display = 'none'; }
    };

    async function upload(file) {
        if(!file) return null;
        const fd = new FormData(); fd.append("file", file); fd.append("upload_preset", UPLOAD_PRESET);
        try {
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{ method:"POST", body:fd });
            const data = await res.json();
            return { url: data.secure_url };
        } catch(e) { alert("Upload Gagal"); throw e; }
    }

    // --- 2. AUTH, PRESENCE & INIT ---
    onAuthStateChanged(auth, async user => {
        if(!user) return location.href = "login.html";
        toggleLoader(true);
        try {
            const snap = await getDoc(doc(db,"users",user.uid));
            if(!snap.exists()) { alert("User tidak ditemukan"); return signOut(auth); }
            
            UID = user.uid;
            CURRENT_USER_DATA = snap.data();
            CURRENT_ROLE = CURRENT_USER_DATA.role || "anggota";

            // Update UI Header
            $("headerName").textContent = CURRENT_USER_DATA.name || "User";
            $("headerRole").textContent = CURRENT_ROLE.replace('_',' ');
            $("headerPhoto").src = CURRENT_USER_DATA.photo?.url || "https://via.placeholder.com/150";
            
            // Add XP Reward for Login (Once per session)
            addXP(10);

            // Init Systems
            startPresenceSystem();
            initChatListener();
            initSOSListener(); // KENTONGAN LISTENER
            buildNavigation();
            switchView('home');
            loadProfileData();

        } catch(e) { console.error(e); }
        toggleLoader(false);
    });

    // === SYSTEM: PRESENCE ===
    function startPresenceSystem() {
        updateDoc(doc(db, "users", UID), { lastSeen: serverTimestamp() });
        setInterval(() => { if(UID) updateDoc(doc(db, "users", UID), { lastSeen: serverTimestamp() }); }, 60000);
    }

    // === SYSTEM: GAMIFICATION (XP) ===
    async function addXP(amount) {
        if(!UID) return;
        try {
            await updateDoc(doc(db, "users", UID), { xp: increment(amount) });
            // Update local UI
            const newXp = (CURRENT_USER_DATA.xp || 0) + amount;
            $("xpBadge").textContent = `LVL ${Math.floor(newXp/100) + 1}`;
            $("profileXpDisplay").textContent = `${newXp} XP`;
        } catch(e) { console.log("XP Error", e); }
    }

    // === FEATURE 1: KENTONGAN DIGITAL (SOS) ===
    window.triggerKentongan = async () => {
        if(confirm("BUNYIKAN KENTONGAN DARURAT? Semua anggota akan menerima notifikasi suara.")) {
             await addDoc(collection(db, "notifications"), {
                 title: "BAHAYA / SOS",
                 body: `${CURRENT_USER_DATA.name} membunyikan kentongan!`,
                 level: "sos",
                 senderUid: UID,
                 createdAt: serverTimestamp()
             });
             alert("Kentongan dibunyikan!");
             addXP(5); // Reward for activity (but warn abuse)
        }
    }

    function initSOSListener() {
        const q = query(collection(db, "notifications"), where("level", "==", "sos"), orderBy("createdAt", "desc"), limit(1));
        onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    const now = Date.now();
                    const msgTime = data.createdAt ? data.createdAt.toMillis() : 0;
                    // Only alert if SOS is recent (last 10 seconds)
                    if (now - msgTime < 10000 && data.senderUid !== UID) {
                        playSOSAlert(data.body);
                    }
                }
            });
        });
    }

    function playSOSAlert(msg) {
        $("sosOverlay").classList.remove("hidden");
        $("sosOverlay").classList.add("flex");
        $("sosMessage").textContent = msg;
        audioBeep.loop = true;
        audioBeep.play().catch(e => console.log("Audio play failed interaction required"));
    }

    window.stopSOS = () => {
        $("sosOverlay").classList.add("hidden");
        $("sosOverlay").classList.remove("flex");
        audioBeep.pause();
        audioBeep.currentTime = 0;
    }

    // === FEATURE 2: MOOD METER ===
    window.submitMood = async (mood) => {
        $("moodSelector").classList.add("hidden");
        $("moodResult").classList.remove("hidden");
        
        // Simpan ke DB (Anonim-ish statistics)
        await addDoc(collection(db, "mood_logs"), { mood, uid: UID, createdAt: serverTimestamp() });
        addXP(5);
        
        // Hitung Vibe (Dummy logic for UX)
        const vibes = { happy: "üî•üî•üî• ON FIRE!", neutral: "üëå Chill", sad: "üåßÔ∏è Mellow" };
        $("orgVibeScore").textContent = vibes[mood];
    }

    // === FEATURE 3: KOTAK CURHAT (GHOST MAIL) ===
    window.sendConfess = async () => {
        const txt = $("confessInput").value;
        if(!txt) return;
        
        if(confirm("Kirim pesan ini secara anonim?")) {
            await addDoc(collection(db, "confessions"), {
                text: txt,
                createdAt: serverTimestamp(),
                // NO UID LOGGED HERE for anonymity
            });
            $("confessInput").value = "";
            alert("Pesan rahasia terkirim.");
        }
    }

    // === FEATURE 4: KUDOS CARDS ===
    window.openKudosModal = () => {
        const html = `
            <input id="kTo" class="w-full p-3 border rounded mb-2" placeholder="Nama Penerima">
            <textarea id="kMsg" class="w-full p-3 border rounded mb-2" placeholder="Pesan Apresiasi (mis: Makasih bantuannya!)"></textarea>
            <select id="kStyle" class="w-full p-3 border rounded"><option value="bg-pink-100 text-pink-600">üíñ Love</option><option value="bg-blue-100 text-blue-600">üî• Respect</option></select>
        `;
        showModal("Kirim Kudos", html, async () => {
            await addDoc(collection(db, "kudos"), {
                to: $("kTo").value, from: CURRENT_USER_DATA.name, msg: $("kMsg").value, style: $("kStyle").value, createdAt: serverTimestamp()
            });
            closeModal();
            addXP(20);
        });
    }

    function loadKudos() {
        const q = query(collection(db, "kudos"), orderBy("createdAt", "desc"), limit(10));
        onSnapshot(q, (snap) => {
            const list = $("kudosList"); list.innerHTML = "";
            snap.forEach(d => {
                const k = d.data();
                list.innerHTML += `
                    <div class="min-w-[150px] p-3 rounded-xl ${k.style} border border-white/50 shadow-sm flex flex-col justify-between h-24">
                        <p class="text-[10px] font-bold uppercase">To: ${k.to}</p>
                        <p class="text-xs font-bold leading-tight">"${k.msg}"</p>
                        <p class="text-[8px] text-right opacity-70">fr: ${k.from}</p>
                    </div>
                `;
            });
        });
    }

    // === FEATURE 5: LEADERBOARD SUHU ===
    async function loadLeaderboard() {
        const q = query(collection(db, "users"), orderBy("xp", "desc"), limit(5));
        const snap = await getDocs(q);
        const list = $("xpLeaderboard"); list.innerHTML = "";
        let rank = 1;
        snap.forEach(d => {
            const u = d.data();
            list.innerHTML += `
                <div class="flex items-center justify-between bg-slate-50 p-2 rounded-lg">
                    <div class="flex items-center gap-2">
                        <span class="font-black text-slate-300 w-4 text-center">${rank++}</span>
                        <img src="${u.photo?.url || 'https://via.placeholder.com/30'}" class="w-8 h-8 rounded-full object-cover">
                        <p class="text-xs font-bold text-slate-700">${u.name}</p>
                    </div>
                    <span class="text-xs font-bold text-purple-600">${u.xp || 0} XP</span>
                </div>
            `;
        });
    }

    // --- SYSTEM: CHAT ---
    window.toggleChat = () => {
        const win = $("chatWindow");
        if(win.classList.contains("hidden")) {
            win.classList.remove("hidden"); win.classList.add("flex");
            $("unreadChatBadge").classList.add("hidden"); scrollToBottom();
        } else {
            win.classList.add("hidden"); win.classList.remove("flex");
        }
    }

    function initChatListener() {
        const q = query(collection(db, "public_chats"), orderBy("createdAt", "desc"), limit(50));
        onSnapshot(q, (snapshot) => {
            const list = $("chatMessages");
            const messages = [];
            snapshot.forEach(d => messages.push({id: d.id, ...d.data()}));
            messages.reverse();
            
            list.innerHTML = '';
            messages.forEach(msg => {
                const isMe = msg.uid === UID;
                list.innerHTML += `
                    <div class="chat-bubble ${isMe ? 'chat-me' : 'chat-other'}">
                        ${!isMe ? `<span class="block text-[9px] font-bold text-accent mb-0.5">${msg.senderName}</span>` : ''}
                        ${msg.text}
                    </div>
                `;
            });
            scrollToBottom();
            if($("chatWindow").classList.contains("hidden")) $("unreadChatBadge").classList.remove("hidden");
        });
    }

    function scrollToBottom() { const d = $("chatMessages"); d.scrollTop = d.scrollHeight; }

    window.sendMessage = async (e) => {
        e.preventDefault();
        const input = $("chatInput"); const text = input.value.trim();
        if(!text) return;
        input.value = '';
        await addDoc(collection(db, "public_chats"), {
            text: text, uid: UID, senderName: CURRENT_USER_DATA.name || "User", role: CURRENT_ROLE, createdAt: serverTimestamp()
        });
        addXP(2); // Chat gives small XP
    }

    // --- NAVIGATION ---
    function buildNavigation() {
        const nav = $("bottomNavContainer"); nav.innerHTML = '';
        const menus = [
            { id: 'home', icon: 'grid_view', label: 'Home', roles: ['all'] },
            { id: 'playground', icon: 'sports_esports', label: 'Zona Seru', roles: ['all'] }, // NEW MENU
            { id: 'users', icon: 'group', label: 'Anggota', roles: ['super_admin', 'ketua', 'wakil_ketua', 'sekretaris', 'anggota'] },
            { id: 'finance', icon: 'account_balance_wallet', label: 'Kas', roles: ['all'] },
            { id: 'profile', icon: 'person', label: 'Saya', roles: ['all'] }
        ];

        menus.forEach(m => {
            if(m.roles.includes('all') || m.roles.includes(CURRENT_ROLE)) {
                const isProfile = m.id === 'profile';
                const btn = document.createElement('button');
                btn.className = `nav-btn flex flex-col items-center gap-1 p-2 w-14 transition-all ${isProfile ? '-top-5 relative' : ''}`;
                btn.dataset.target = m.id;
                btn.onclick = () => switchView(m.id);
                if(isProfile) {
                    btn.innerHTML = `<div class="w-12 h-12 bg-brand-primary text-white rounded-full flex items-center justify-center shadow-xl border-4 border-white"><span class="material-symbols-rounded text-2xl">${m.icon}</span></div>`;
                } else {
                    btn.innerHTML = `<span class="material-symbols-rounded text-2xl text-slate-400 transition-colors">${m.icon}</span><p class="text-[10px] font-medium text-slate-400 transition-colors">${m.label}</p>`;
                }
                nav.appendChild(btn);
            }
        });
    }

    window.switchView = (viewId) => {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        const target = $(`view-${viewId}`);
        if(target) { target.style.display = 'block'; setTimeout(() => target.classList.add('active'), 10); }
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`.nav-btn[data-target="${viewId}"]`);
        if(activeBtn) activeBtn.classList.add('active');

        if(viewId === 'home') renderHome();
        if(viewId === 'users') loadUsers();
        if(viewId === 'finance') loadFinance();
        if(viewId === 'events') loadEvents();
        if(viewId === 'documents') loadDocuments('surat');
        if(viewId === 'arisan') loadArisanHistory();
        if(viewId === 'inventory') loadInventory();
        if(viewId === 'playground') { loadLeaderboard(); loadKudos(); }
    }

    // === USERS LOAD ===
    async function loadUsers() {
        const list = $("userList"); list.innerHTML = '<p class="text-center text-xs text-slate-400">Memuat anggota...</p>';
        const q = query(collection(db, "users"), orderBy("name"));
        const snap = await getDocs(q);
        list.innerHTML = '';
        
        const amIEditor = ['super_admin', 'ketua', 'wakil_ketua'].includes(CURRENT_ROLE);
        const roles = ["anggota", "koordinator", "sekretaris", "bendahara", "wakil_ketua", "ketua", "super_admin"];
        const now = Date.now();

        snap.forEach(d => {
            const u = d.data();
            const lastSeenTime = u.lastSeen?.toMillis ? u.lastSeen.toMillis() : 0;
            const isOnline = (now - lastSeenTime) < 120000;

            let roleControl = `<span class="text-xs font-bold bg-slate-100 px-2 py-1 rounded text-slate-500 uppercase">${u.role}</span>`;
            if(amIEditor && u.role !== 'super_admin' && d.id !== UID) {
                const options = roles.map(r => `<option value="${r}" ${u.role===r?'selected':''}>${r.replace('_',' ')}</option>`).join('');
                roleControl = `<select onchange="updateRole('${d.id}',this.value)" class="text-xs border p-1 rounded uppercase">${options}</select>`;
            }

            list.innerHTML += `
                <div class="bg-white p-3 rounded-xl border border-slate-100 flex items-center gap-3 relative">
                    <div class="relative">
                        <img src="${u.photo?.url || 'https://via.placeholder.com/50'}" class="w-10 h-10 rounded-full object-cover ${!isOnline ? 'grayscale opacity-70' : ''}">
                        ${isOnline ? '<span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></span>' : ''}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <p class="text-sm font-bold text-brand-primary">${u.name}</p>
                            <span class="text-[9px] font-bold text-purple-500">${u.xp || 0} XP</span>
                        </div>
                        ${roleControl}
                        <p class="text-[9px] text-slate-400 mt-0.5">${isOnline ? 'Sedang Aktif' : (u.lastSeen ? 'Terakhir dilihat ' + new Date(lastSeenTime).toLocaleDateString() : 'Offline')}</p>
                    </div>
                </div>
            `;
        });
    }

    window.updateRole = async (uid, newRole) => { if(confirm("Ubah role user ini?")) { await updateDoc(doc(db,"users",uid), {role: newRole}); loadUsers(); } }

    async function renderHome() {
        const container = $("homeContentArea");
        const xp = CURRENT_USER_DATA.xp || 0;
        container.innerHTML = `<div class="p-6 bg-white rounded-3xl shadow-sm"><h2 class="text-xl font-bold mb-2">Halo, ${CURRENT_USER_DATA.name}!</h2><p class="text-slate-500 text-xs">Anda login sebagai <span class="font-bold uppercase text-accent">${CURRENT_ROLE.replace('_',' ')}</span>. XP Anda: <span class="font-bold text-purple-600">${xp}</span></p></div>`;
        if(['super_admin', 'bendahara', 'ketua'].includes(CURRENT_ROLE)) {
            const finSnap = await getDocs(query(collection(db, "financial_records"), where("status", "==", "approved")));
            let bal = 0; finSnap.forEach(d => { const f=d.data(); bal += f.type==='income'?Number(f.amount):-Number(f.amount) });
            container.innerHTML += `
                <div class="mt-4 bg-brand-primary text-white p-6 rounded-3xl shadow-xl relative overflow-hidden">
                    <div class="absolute right-0 top-0 opacity-10 p-4"><span class="material-symbols-rounded text-8xl">wallet</span></div>
                    <p class="text-xs text-slate-300 uppercase font-bold tracking-widest">Saldo Organisasi</p>
                    <h2 class="text-4xl font-black mt-1">Rp ${bal.toLocaleString('id-ID')}</h2>
                </div>
            `;
        }
    }

    async function loadFinance() {
        const list = $("finList"); list.innerHTML = 'Loading...';
        const snap = await getDocs(query(collection(db, "financial_records"), orderBy("createdAt", "desc")));
        list.innerHTML = '';
        const canEdit = ['super_admin', 'bendahara'].includes(CURRENT_ROLE);
        const canApprove = ['ketua', 'wakil_ketua'].includes(CURRENT_ROLE);
        const controls = $("financeControls");
        controls.innerHTML = '';
        if(canEdit) controls.innerHTML += `<button onclick="openFinanceModal()" class="bg-brand-primary text-white w-8 h-8 rounded-full flex items-center justify-center shadow">+<button>`;
        
        snap.forEach(d => {
            const f = d.data();
            const isInc = f.type === 'income';
            const isPending = f.status === 'pending';
            let actionBtn = '';
            if(isPending && canApprove) actionBtn = `<button onclick="approveData('financial_records','${d.id}')" class="bg-green-500 text-white text-[10px] px-2 py-1 rounded font-bold">ACC</button>`;
            if(canEdit) actionBtn += `<button onclick="deleteData('financial_records','${d.id}')" class="text-red-500 ml-2"><span class="material-symbols-rounded text-lg">delete</span></button>`;
            list.innerHTML += `
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center relative overflow-hidden">
                    ${isPending ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-orange-400"></div>' : ''}
                    <div class="flex items-center gap-3">
                         <div class="w-10 h-10 rounded-full ${isInc?'bg-green-50 text-green-600':'bg-red-50 text-red-500'} flex items-center justify-center"><span class="material-symbols-rounded">${isInc?'arrow_downward':'arrow_upward'}</span></div>
                         <div><p class="text-sm font-bold text-brand-primary">${f.note}</p><p class="text-[10px] text-slate-400">${isPending ? 'MENUNGGU ACC' : 'Verified'}</p></div>
                    </div>
                    <div class="text-right"><p class="text-sm font-bold ${isInc?'text-green-600':'text-red-500'}">${isInc?'+':'-'} ${Number(f.amount).toLocaleString()}</p><div class="mt-1">${actionBtn}</div></div>
                </div>
            `;
        });
    }

    window.openFinanceModal = () => {
        const html = `<select id="fType" class="w-full p-3 border rounded mb-2"><option value="income">Pemasukan (+)</option><option value="expense">Pengeluaran (-)</option></select><input id="fAmt" type="number" class="w-full p-3 border rounded mb-2" placeholder="Jumlah (Rp)"><input id="fNote" class="w-full p-3 border rounded mb-2" placeholder="Keterangan">`;
        showModal("Catat Kas", html, async () => {
            await addDoc(collection(db,"financial_records"), { type:$("fType").value, amount:$("fAmt").value, note:$("fNote").value, status:'pending', createdAt: serverTimestamp() });
            closeModal(); loadFinance(); addXP(10);
        });
    }

    // EVENTS
    async function loadEvents() {
        const list = $("actList"); list.innerHTML = "";
        const snap = await getDocs(query(collection(db, "activities"), orderBy("createdAt", "desc")));
        snap.forEach(d => {
             const x = d.data();
             list.innerHTML += `<div class="bg-white border rounded-[1.5rem] p-4 flex gap-4"><div class="bg-blue-50 p-3 rounded-xl h-fit text-blue-600 font-bold text-xs text-center">${x.date || 'TBA'}</div><div><h4 class="font-bold text-brand-primary">${x.title}</h4><p class="text-xs text-slate-400 mt-1">${x.location || '-'}</p></div></div>`;
        });
        if(['koordinator', 'super_admin', 'ketua'].includes(CURRENT_ROLE)) $("eventControls").innerHTML = `<button onclick="openEventModal()" class="w-8 h-8 bg-purple-500 text-white rounded-full shadow flex items-center justify-center">+</button>`;
    }
    window.openEventModal = () => {
        const html = `<input id="eTitle" class="w-full p-3 border rounded mb-2" placeholder="Judul"><input type="date" id="eDate" class="w-full p-3 border rounded mb-2"><input id="eLoc" class="w-full p-3 border rounded" placeholder="Lokasi">`;
        showModal("Tambah Acara", html, async () => { await addDoc(collection(db,"activities"),{title:$("eTitle").value, date:$("eDate").value, location:$("eLoc").value, status:"approved", createdAt:serverTimestamp()}); closeModal(); loadEvents(); addXP(15); });
    }

    // DOCUMENTS
    window.loadDocuments = async (type) => {
        const list = $("docList"); list.innerHTML = "Loading...";
        const colMap = { surat: 'letters', notulen: 'minutes', arsip: 'archives' };
        const snap = await getDocs(query(collection(db, colMap[type]), orderBy("createdAt", "desc")));
        list.innerHTML = "";
        snap.forEach(d => { const x=d.data(); list.innerHTML += `<div class="bg-white p-3 rounded-xl border border-slate-100 mb-2"><h4 class="font-bold">${x.title || x.subject}</h4><p class="text-xs text-slate-400">${type}</p>${x.file?.url ? `<a href="${x.file.url}" target="_blank" class="text-blue-500 text-xs">Download</a>` : ''}</div>`; });
    }
    window.openDocModal = () => {
         const html = `<input id="dTitle" class="w-full p-3 border rounded mb-2" placeholder="Judul"><select id="dType" class="w-full p-3 border rounded mb-2"><option value="letters">Surat</option><option value="minutes">Notulen</option><option value="archives">Arsip</option></select><input type="file" id="dFile" class="text-xs">`;
         showModal("Upload Dokumen", html, async () => {
             const file = $("dFile").files[0]; let fileData = null;
             if(file) fileData = await upload(file);
             await addDoc(collection(db, $("dType").value), { title: $("dTitle").value, subject: $("dTitle").value, file: fileData, createdAt: serverTimestamp() });
             closeModal(); addXP(10);
         });
    }

    // ARISAN
    async function loadArisanHistory() { $("arisanHistory").innerHTML = `<div class="text-center text-xs text-slate-400">Riwayat kosong</div>`; }
    window.runRaffle = () => { $("raffleDisplay").innerText = "MENGACAK..."; setTimeout(() => { $("raffleDisplay").innerText = "PEMENANG!"; confetti(); addXP(5); }, 2000); }

    // INVENTORY
    async function loadInventory() {
        const list = $("invList"); list.innerHTML = "";
        const snap = await getDocs(collection(db, "inventory"));
        snap.forEach(d => { const i=d.data(); list.innerHTML += `<div class="bg-white p-3 rounded-xl border shadow-sm"><h4 class="font-bold text-sm">${i.name}</h4><span class="text-xs bg-slate-100 px-2 rounded">${i.qty} Unit</span></div>`; });
    }
    window.openInvModal = () => {
        const html = `<input id="iName" class="w-full p-3 border rounded mb-2" placeholder="Nama Barang"><input id="iQty" type="number" class="w-full p-3 border rounded" placeholder="Jumlah">`;
        showModal("Tambah Barang", html, async () => { await addDoc(collection(db, "inventory"), {name:$("iName").value, qty:$("iQty").value}); closeModal(); loadInventory(); addXP(5); });
    }

    // PROFILE
    async function loadProfileData() {
        if(!CURRENT_USER_DATA) return;
        $("profileNameDisplay").textContent = CURRENT_USER_DATA.name;
        $("profileEmailDisplay").textContent = CURRENT_USER_DATA.email;
        $("profileRoleBadge").textContent = CURRENT_ROLE.toUpperCase();
        $("profileXpDisplay").textContent = `${CURRENT_USER_DATA.xp || 0} XP`;
        $("editName").value = CURRENT_USER_DATA.name || "";
        $("editPhone").value = CURRENT_USER_DATA.phone || "";
        $("editAddress").value = CURRENT_USER_DATA.address || "";
    }
    window.saveProfile = async () => {
        toggleLoader(true);
        let updateData = { name: $("editName").value, phone: $("editPhone").value, address: $("editAddress").value };
        await updateDoc(doc(db, "users", UID), updateData);
        alert("Tersimpan"); toggleLoader(false);
    }
    window.showIdCard = () => {
        const html = `<div class="bg-slate-800 text-white p-4 rounded-xl text-center"><h3 class="font-bold mb-4">ID CARD</h3><h2 class="text-xl">${CURRENT_USER_DATA.name}</h2><p>${CURRENT_ROLE}</p><p class="text-xs mt-2 text-purple-300">XP: ${CURRENT_USER_DATA.xp || 0}</p></div>`;
        showModal("ID Card", html, null);
    }

    window.deleteData = async (col, id) => { if(confirm("Hapus?")) { await deleteDoc(doc(db, col, id)); location.reload(); } }
    window.approveData = async (col, id) => { if(confirm("Setujui?")) { await updateDoc(doc(db, col, id), {status: 'approved'}); switchView('finance'); addXP(5); } }

    $("logoutBtn").onclick = () => signOut(auth);

  </script>
</body>
</html>
