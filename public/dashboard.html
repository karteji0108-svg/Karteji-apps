<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#18181b">
  <title>KARTEJI | Modern Super App</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          colors: {
            app: { 
                bg: '#ECFCCB', // Lime-50 (Background terang)
                dark: '#18181B', // Zinc-900 (Kartu Gelap)
                accent: '#D9F99D', // Lime-200 (Aksen)
                primary: '#3F6212', // Lime-800 (Text Aksen)
                surface: '#FFFFFF' 
            }
          },
          animation: { 
            'popup': 'popup 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
            'slide-up': 'slideUp 0.5s cubic-bezier(0.19, 1, 0.22, 1)',
            'spin-slow': 'spin 8s linear infinite',
          },
          keyframes: {
            popup: { '0%': { transform: 'scale(0.9)', opacity:0 }, '100%': { transform: 'scale(1)', opacity:1 } },
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #ECFCCB; color: #18181B; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    /* Modern Card Styles matching the image */
    .black-card {
        background: radial-gradient(circle at top right, #27272a, #18181b);
        box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
    }
    
    /* Navigation Pill */
    .nav-pill {
        background: #18181B;
        padding: 0.5rem 1.5rem;
        border-radius: 9999px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .nav-item.active { color: #D9F99D; }
    .nav-item { color: #71717A; transition: all 0.3s; }
    
    /* Bottom Sheet Style */
    .bottom-sheet {
        background: white;
        border-top-left-radius: 2.5rem;
        border-top-right-radius: 2.5rem;
        box-shadow: 0 -10px 40px rgba(0,0,0,0.05);
        min-height: 50vh;
    }

    .view-section { display: none; opacity: 0; animation: popup 0.3s forwards; }
    .view-section.active { display: block; }

    /* Print */
    @media print { body * { visibility: hidden; } #printArea, #printArea * { visibility: visible; } #printArea { position: absolute; left: 0; top: 0; width: 100%; background: white; z-index: 9999; } }
  </style>
</head>

<body class="min-h-screen pb-32 relative selection:bg-lime-300 selection:text-lime-900">

  <audio id="sfxClick" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
  <audio id="sfxWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
  <audio id="sfxShuffle" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3" loop></audio>

  <div id="toastContainer" class="fixed top-6 left-0 right-0 z-[120] flex flex-col items-center gap-2 pointer-events-none px-4"></div>
  <div id="globalLoader" class="fixed inset-0 bg-[#ECFCCB] z-[9999] flex items-center justify-center flex-col gap-4">
    <div class="w-16 h-16 border-8 border-lime-300 border-t-black rounded-full animate-spin"></div>
    <p class="text-xs font-bold text-lime-800 tracking-[0.2em] animate-pulse">KARTEJI</p>
  </div>

  <div id="gate" class="fixed inset-0 bg-black/90 z-[9998] hidden items-center justify-center p-6 text-center backdrop-blur-md">
    <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl max-w-sm w-full animate-popup">
        <div class="w-16 h-16 bg-lime-100 rounded-full flex items-center justify-center mx-auto mb-4 text-lime-600"><span class="material-symbols-rounded text-3xl">lock</span></div>
        <h2 class="text-xl font-black text-slate-800 mb-2">Akses Terbatas</h2>
        <a href="login.html" class="block w-full bg-black text-white py-4 rounded-2xl font-bold mt-6 hover:scale-105 transition-transform">Login Sekarang</a>
    </div>
  </div>

  <div id="crudModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-all">
    <div class="bg-[#F8FAFC] w-full max-w-md rounded-[2.5rem] p-6 relative shadow-2xl animate-popup">
      <div class="flex justify-between items-center mb-6 pl-2">
          <h2 id="modalTitle" class="text-lg font-extrabold text-slate-800">Action</h2>
          <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-slate-400 hover:text-red-500"><span class="material-symbols-rounded">close</span></button>
      </div>
      <div id="modalBody" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar pb-2"></div>
      <button id="modalSubmitBtn" class="mt-6 w-full rounded-[1.5rem] bg-black text-lime-300 py-4 text-sm font-bold shadow-xl active:scale-95 transition-all">SIMPAN PERUBAHAN</button>
    </div>
  </div>

  <div id="arisanOverlay" class="fixed inset-0 z-[80] hidden flex-col items-center justify-center bg-black/95 text-white p-6">
      <button onclick="closeArisan()" class="absolute top-8 right-8 w-10 h-10 bg-white/10 rounded-full flex items-center justify-center"><span class="material-symbols-rounded">close</span></button>
      <div class="relative w-64 h-64 mb-10">
          <div class="absolute inset-0 border-4 border-lime-400 rounded-full animate-spin-slow border-dashed"></div>
          <div class="absolute inset-2 bg-slate-900 rounded-full overflow-hidden flex items-center justify-center border-4 border-slate-800 shadow-[0_0_50px_#bef264]">
              <img id="shufflerImg" src="https://via.placeholder.com/150" class="w-full h-full object-cover opacity-80">
              <span id="shufflerIcon" class="material-symbols-rounded text-6xl absolute text-lime-400">casino</span>
          </div>
      </div>
      <h2 id="shufflerName" class="text-3xl font-black mb-2 text-center text-lime-300">SIAP?</h2>
      <p class="text-slate-400 text-sm mb-8">Sistem Pengundian Adil</p>
      <button id="btnSpin" onclick="spinArisan()" class="bg-lime-400 text-black px-12 py-4 rounded-full font-black text-lg shadow-[0_0_30px_rgba(190,242,100,0.4)] active:scale-95 transition-transform">PUTAR SEKARANG</button>
      <div id="winnerActions" class="hidden flex-col w-full max-w-xs gap-3">
          <button onclick="saveWinner()" class="bg-lime-500 text-black py-3 rounded-2xl font-bold">Simpan Pemenang</button>
          <button onclick="spinArisan()" class="bg-slate-800 text-white py-3 rounded-2xl font-bold">Putar Ulang</button>
      </div>
  </div>

  <header class="sticky top-0 z-30 px-6 pt-8 pb-2 bg-[#ECFCCB]">
      <div class="flex justify-between items-center">
          <div class="flex items-center gap-3" onclick="switchView('profile')">
              <img id="headerPhoto" class="w-12 h-12 rounded-full border-2 border-black object-cover" src="https://via.placeholder.com/100">
              <div>
                  <p id="greeting" class="text-[10px] font-bold text-lime-800 uppercase tracking-widest mb-0.5">Welcome Back,</p>
                  <h1 id="headerName" class="text-xl font-black text-slate-900 leading-none truncate w-40">User</h1>
              </div>
          </div>
          <button onclick="playSound('click'); togglePrivacy()" class="w-12 h-12 rounded-full bg-white border border-lime-200 flex items-center justify-center text-slate-800 shadow-sm active:scale-90 transition-transform">
            <span class="material-symbols-rounded" id="privacyIcon">visibility</span>
          </button>
      </div>
  </header>

  <main class="mt-6">

      <section id="view-home" class="view-section active px-6">
          
          <div class="black-card w-full rounded-[2.5rem] p-7 text-white relative overflow-hidden mb-8 transition-transform active:scale-[0.98]">
              <div class="absolute top-10 right-10 text-lime-400 opacity-20"><span class="material-symbols-rounded text-9xl">stars</span></div>
              
              <div class="relative z-10 flex flex-col h-full justify-between min-h-[180px]">
                  <div class="flex justify-between items-start">
                      <div>
                          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total Balance</p>
                          <h2 id="cardBalance" class="text-3xl font-mono font-bold tracking-tight text-white tabular-nums">$ 0</h2>
                      </div>
                      <button id="btnSetBudget" onclick="openFinanceModal()" class="hidden bg-lime-300 text-black px-4 py-2 rounded-full text-[10px] font-bold flex items-center gap-1 hover:bg-white transition-colors">
                          <span class="material-symbols-rounded text-sm">add</span> Catat
                      </button>
                  </div>

                  <div class="mt-6 flex items-end justify-between">
                      <div>
                          <p class="text-slate-400 text-[10px] mb-1">User ID</p>
                          <p class="font-mono text-sm tracking-widest">**** **** <span id="idLast4">0000</span></p>
                      </div>
                      <div class="w-10 h-16 border border-slate-600 rounded-lg flex flex-col justify-center items-center bg-white/5 backdrop-blur-sm">
                          <div class="w-6 h-6 rounded-full border-2 border-white/30 flex items-center justify-center"><div class="w-3 h-3 bg-lime-400 rounded-full"></div></div>
                      </div>
                  </div>
              </div>
          </div>

          <div class="flex justify-between items-start px-2 mb-8">
              <div onclick="switchView('kas')" class="flex flex-col items-center gap-2 cursor-pointer active:scale-90 transition-transform">
                  <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg shadow-lime-200/50 text-slate-800 border-2 border-white">
                      <span class="material-symbols-rounded text-2xl">account_balance_wallet</span>
                  </div>
                  <span class="text-xs font-bold text-slate-600">Keuangan</span>
              </div>
              
              <div onclick="switchView('kegiatan')" class="flex flex-col items-center gap-2 cursor-pointer active:scale-90 transition-transform">
                  <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg shadow-lime-200/50 text-slate-800 border-2 border-white">
                      <span class="material-symbols-rounded text-2xl">receipt_long</span>
                  </div>
                  <span class="text-xs font-bold text-slate-600">Agenda</span>
              </div>

              <div onclick="switchView('anggota')" class="flex flex-col items-center gap-2 cursor-pointer active:scale-90 transition-transform">
                  <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg shadow-lime-200/50 text-slate-800 border-2 border-white">
                      <span class="material-symbols-rounded text-2xl">groups</span>
                  </div>
                  <span class="text-xs font-bold text-slate-600">Grup</span>
              </div>

              <div onclick="openArisanUI()" class="flex flex-col items-center gap-2 cursor-pointer active:scale-90 transition-transform">
                  <div class="w-16 h-16 bg-lime-300 rounded-full flex items-center justify-center shadow-lg shadow-lime-400/50 text-black border-2 border-lime-100">
                      <span class="material-symbols-rounded text-2xl">casino</span>
                  </div>
                  <span class="text-xs font-bold text-slate-600">Arisan</span>
              </div>
          </div>

          <div class="mb-4">
              <div class="flex justify-between items-center mb-3">
                  <h3 class="text-sm font-bold text-slate-800">Anggota Online</h3>
                  <button onclick="switchView('anggota')" class="text-[10px] font-bold text-slate-500">Lihat Semua ></button>
              </div>
              <div id="quickMemberList" class="flex gap-4 overflow-x-auto no-scrollbar py-2">
                  <div class="flex flex-col items-center gap-1 min-w-[50px] opacity-50"><div class="w-12 h-12 rounded-full bg-white border-2 border-lime-200"></div><div class="w-8 h-2 bg-slate-200 rounded"></div></div>
              </div>
          </div>

      </section>

      <div class="bottom-sheet pb-32">
          <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mt-3 mb-6"></div>
          
          <div id="homeWidgetArea" class="px-6 mb-6">
             <h3 class="text-sm font-bold text-slate-800 mb-3 px-1">Papan Info</h3>
             <div id="homeNotice" class="bg-slate-50 p-5 rounded-3xl border border-slate-100 text-xs text-slate-500 leading-relaxed italic text-center">
                  Tidak ada pengumuman terbaru.
             </div>
          </div>

          <div id="dynamicContent" class="px-6 min-h-[300px]">
              
              <div id="view-kas" class="view-section">
                  <div class="flex justify-between items-center mb-4">
                      <h2 class="text-xl font-black text-slate-900">Riwayat Kas</h2>
                      <button onclick="printArea()" class="bg-slate-100 p-2 rounded-full"><span class="material-symbols-rounded text-sm">print</span></button>
                  </div>
                  <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar">
                      <button onclick="filterFinance('all')" class="bg-black text-white px-4 py-2 rounded-full text-xs font-bold">Semua</button>
                      <button onclick="filterFinance('income')" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-full text-xs font-bold">Masuk</button>
                      <button onclick="filterFinance('expense')" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-full text-xs font-bold">Keluar</button>
                  </div>
                  <div id="printArea"><div id="finList" class="space-y-4"></div></div>
              </div>

              <div id="view-kegiatan" class="view-section">
                  <div class="flex justify-between items-center mb-4">
                      <h2 class="text-xl font-black text-slate-900">Agenda</h2>
                      <button id="btnAddEvent" onclick="openEventModal()" class="hidden bg-black text-lime-300 px-3 py-1 rounded-full text-xs font-bold">+ Baru</button>
                  </div>
                  <div id="actList" class="space-y-4"></div>
              </div>

              <div id="view-anggota" class="view-section">
                  <div class="flex justify-between items-center mb-4">
                      <h2 class="text-xl font-black text-slate-900">Direktori</h2>
                      <span id="memberCount" class="bg-lime-100 text-lime-800 px-2 py-1 rounded-md text-xs font-bold">0</span>
                  </div>
                  <input type="text" onkeyup="searchMember(this.value)" placeholder="Cari nama..." class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border-none mb-4 focus:ring-2 focus:ring-lime-300">
                  <div id="userList" class="space-y-3"></div>
              </div>

              <div id="view-profile" class="view-section">
                  <h2 class="text-xl font-black text-slate-900 mb-6">Edit Profil</h2>
                  <div class="space-y-4">
                      <div class="relative w-24 h-24 mx-auto mb-6" onclick="$('profileUpload').click()">
                          <img id="profileImageEdit" src="https://via.placeholder.com/150" class="w-full h-full rounded-full object-cover border-4 border-slate-100">
                          <div class="absolute bottom-0 right-0 bg-black text-white p-1.5 rounded-full"><span class="material-symbols-rounded text-sm">edit</span></div>
                      </div>
                      <input type="file" id="profileUpload" class="hidden" accept="image/*" onchange="previewProfileImage(this)">
                      
                      <input id="editName" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-slate-800 border-none outline-none focus:ring-2 focus:ring-lime-300" placeholder="Nama Lengkap">
                      <input id="editPhone" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-slate-800 border-none outline-none focus:ring-2 focus:ring-lime-300" placeholder="WhatsApp">
                      <textarea id="editAddress" class="w-full p-4 bg-slate-50 rounded-2xl font-medium text-slate-800 border-none outline-none focus:ring-2 focus:ring-lime-300 resize-none" rows="2" placeholder="Alamat"></textarea>
                      
                      <button onclick="saveProfile()" class="w-full bg-black text-lime-300 py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition-transform mt-4">SIMPAN PERUBAHAN</button>
                      
                      <div class="grid grid-cols-2 gap-3 mt-4">
                          <button onclick="showIdCard()" class="bg-lime-100 text-lime-900 py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2"><span class="material-symbols-rounded">badge</span> ID Card</button>
                          <button onclick="logout()" class="bg-red-50 text-red-500 py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2"><span class="material-symbols-rounded">logout</span> Keluar</button>
                      </div>
                  </div>
              </div>

          </div>
      </div>

  </main>

  <div class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50">
      <div class="nav-pill flex items-center gap-6">
          <button onclick="switchView('home')" class="nav-item active flex flex-col items-center" data-target="home">
              <span class="material-symbols-rounded text-2xl">grid_view</span>
          </button>
          
          <button onclick="switchView('kegiatan')" class="nav-item flex flex-col items-center" data-target="kegiatan">
              <span class="material-symbols-rounded text-2xl">calendar_month</span>
          </button>

          <button onclick="showQR()" class="w-12 h-12 bg-[#D9F99D] rounded-full flex items-center justify-center text-black -mt-8 border-4 border-[#ECFCCB] shadow-lg active:scale-90 transition-transform">
              <span class="material-symbols-rounded text-2xl">qr_code_scanner</span>
          </button>

          <button onclick="switchView('kas')" class="nav-item flex flex-col items-center" data-target="kas">
              <span class="material-symbols-rounded text-2xl">account_balance_wallet</span>
          </button>

          <button onclick="switchView('profile')" class="nav-item flex flex-col items-center" data-target="profile">
              <span class="material-symbols-rounded text-2xl">person</span>
          </button>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, deleteDoc, getDocs, query, orderBy, limit, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
      authDomain: "katar-9cac3.firebaseapp.com",
      projectId: "katar-9cac3",
      storageBucket: "katar-9cac3.firebasestorage.app",
      messagingSenderId: "1017734829960",
      appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const CLOUD_NAME = "dbxktcwug"; const PRESET = "Karteji";

    window.$ = (id) => document.getElementById(id);
    let UID, ROLE, ME_DATA;
    let allFinData = [], allMembers = [];
    let isPrivacy = false;
    let candidates = [], tempWinner = null;
    const sfx = { click: $('sfxClick'), win: $('sfxWin'), shuffle: $('sfxShuffle') };

    // PERMISSIONS
    const PERMISSIONS = {
        'super_admin': { label:'Super Admin', money:true, event:true, admin:true, level:99 },
        'ketua':       { label:'Ketua Umum',  money:true, event:true, admin:true, level:50 },
        'wakil_ketua': { label:'Wakil Ketua', money:false,event:true, admin:false,level:40 },
        'bendahara':   { label:'Bendahara',   money:true, event:false,admin:false,level:30 },
        'koordinator': { label:'Koordinator', money:false,event:true, admin:false,level:30 },
        'sekretaris':  { label:'Sekretaris',  money:false,event:false,admin:false,level:30 },
        'anggota':     { label:'Anggota',     money:false,event:false,admin:false,level:10 }
    };

    // UTILS
    const playSound = (k) => { try{ sfx[k].currentTime=0; sfx[k].play(); }catch(e){} };
    const vibrate = () => { if(navigator.vibrate) navigator.vibrate(50); };
    window.toggleLoader = (s) => $('globalLoader').style.display = s ? 'flex' : 'none';
    window.showToast = (m,t='s') => { const d=document.createElement('div'); d.className=`${t==='e'?'bg-red-500':'bg-black'} text-white px-6 py-3 rounded-full shadow-2xl fixed top-6 z-[120] text-xs font-bold animate-popup flex gap-2`; d.innerHTML=`<span class="material-symbols-rounded text-sm">${t==='e'?'error':'check_circle'}</span>${m}`; $('toastContainer').appendChild(d); setTimeout(()=>d.remove(),3000); };
    window.togglePrivacy = () => { isPrivacy=!isPrivacy; $('privacyIcon').innerText=isPrivacy?'visibility_off':'visibility'; renderBalance(); };
    window.showQR = () => showModal("QR Code Saya", `<div class='flex justify-center p-4 bg-white rounded-3xl'><img src='https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${UID}' class='rounded-xl'></div>`);
    window.logout = () => signOut(auth).then(()=>location.href="login.html");
    window.printArea = () => window.print();

    window.closeModal = () => $('crudModal').classList.add('hidden');
    window.showModal = (t,b,f) => { $('modalTitle').innerText=t; $('modalBody').innerHTML=b; $('crudModal').classList.remove('hidden'); if(f){$('modalSubmitBtn').style.display='block';$('modalSubmitBtn').onclick=f;}else{$('modalSubmitBtn').style.display='none'} };
    window.switchView = (v) => { 
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); 
        if(v==='home'){ $('view-home').classList.add('active'); $('homeWidgetArea').style.display='block'; $('dynamicContent').style.display='none'; }
        else { $('view-home').classList.remove('active'); $('homeWidgetArea').style.display='none'; $('dynamicContent').style.display='block'; $(`view-${v}`).classList.add('active'); }
        
        document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active')); 
        const btn = document.querySelector(`.nav-item[data-target="${v}"]`); if(btn) btn.classList.add('active');
        if(v==='profile') loadProfile();
    };

    // AUTH
    onAuthStateChanged(auth, async user => {
        if(!user) return $('gate').classList.remove('hidden');
        UID = user.uid;
        const h = new Date().getHours(); $('greeting').innerText = h<12?"Good Morning,":h<18?"Good Afternoon,":"Good Evening,";
        onSnapshot(doc(db,"users",UID), (s) => { if(s.exists()){ ME_DATA=s.data(); ROLE=ME_DATA.role||'anggota'; setupUI(); loadData(); } });
        toggleLoader(false);
    });

    function setupUI() {
        const p = PERMISSIONS[ROLE]||PERMISSIONS['anggota'];
        $('headerName').innerText = ME_DATA.name;
        $('headerPhoto').src = ME_DATA.photo?.url || "https://via.placeholder.com/100";
        $('idLast4').innerText = UID.slice(-4).toUpperCase();
        
        // Buttons
        if(p.money) $('btnSetBudget').classList.remove('hidden');
        if(p.event) $('btnAddEvent').classList.remove('hidden');
    }

    function loadData() {
        const p = PERMISSIONS[ROLE]||PERMISSIONS['anggota'];

        // Finance
        onSnapshot(query(collection(db,"financial_records"), orderBy("createdAt","desc")), (snap) => {
            allFinData=[]; let bal=0, inc=0, exp=0;
            snap.forEach(d => { const f=d.data(); if(f.status==='approved'){ const a=Number(f.amount); if(f.type==='income'){bal+=a;inc+=a;}else{bal-=a;exp+=a;} allFinData.push(f); } });
            window.balanceData = {bal,inc,exp}; renderBalance(); filterFinance('all');
        });

        // Events
        onSnapshot(query(collection(db,"activities"), orderBy("date","asc")), (snap) => {
            $('actList').innerHTML="";
            snap.forEach(d => { const e=d.data(); 
                const del = p.event ? `<button onclick="delDoc('activities','${d.id}')" class="w-8 h-8 bg-red-50 text-red-500 rounded-full flex items-center justify-center"><span class="material-symbols-rounded text-sm">delete</span></button>` : '';
                $('actList').innerHTML+=`<div class="bg-slate-50 p-4 rounded-3xl border border-slate-100 flex justify-between items-center"><div class="flex items-center gap-3"><div class="bg-white p-2 rounded-2xl text-center min-w-[50px] shadow-sm"><p class="text-[10px] font-bold text-red-500 uppercase">${new Date(e.date).toLocaleString('default',{month:'short'})}</p><p class="text-lg font-black text-slate-800">${new Date(e.date).getDate()}</p></div><div><h4 class="text-sm font-bold text-slate-800">${e.title}</h4><p class="text-[10px] text-slate-400 flex items-center gap-1"><span class="material-symbols-rounded text-[10px]">location_on</span> ${e.location}</p></div></div>${del}</div>`; 
            });
        });

        // Users & Quick Send
        onSnapshot(query(collection(db,"users"), orderBy("name")), (snap) => {
            $('userList').innerHTML=""; $('quickMemberList').innerHTML=""; $('memberCount').innerText=snap.size; allMembers=[];
            snap.forEach(d => { const u=d.data(); allMembers.push(u);
                // Quick List
                $('quickMemberList').innerHTML+=`<div class="flex flex-col items-center gap-1 min-w-[60px] cursor-pointer" onclick="showUserCard('${u.name}','${u.role}')"><img src="${u.photo?.url||'https://via.placeholder.com/100'}" class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm"><p class="text-[9px] font-bold text-slate-600 truncate w-full text-center">${u.name.split(' ')[0]}</p></div>`;
                // List
                const canEdit = p.admin && (p.level > (PERMISSIONS[u.role||'anggota']?.level||0)) && d.id!==UID;
                const roleBadge = `<span class="text-[10px] bg-slate-200 px-2 py-0.5 rounded font-bold uppercase text-slate-600">${u.role||'anggota'}</span>`;
                const editCtrl = canEdit ? `<button onclick="editRole('${d.id}')" class="text-slate-400 hover:text-black"><span class="material-symbols-rounded">edit</span></button>` : '';
                $('userList').innerHTML+=`<div class="bg-white p-3 rounded-2xl border border-slate-100 flex items-center justify-between shadow-sm"><div class="flex items-center gap-3"><img src="${u.photo?.url||'https://via.placeholder.com/100'}" class="w-10 h-10 rounded-full object-cover bg-slate-200"><div><p class="text-xs font-bold text-slate-800">${u.name}</p>${roleBadge}</div></div>${editCtrl}</div>`;
            });
        });

        // Notice
        onSnapshot(query(collection(db,"notifications"), orderBy("createdAt","desc"), limit(1)), s => {
            if(!s.empty) $('homeNotice').innerText = s.docs[0].data().body;
        });
    }

    function renderBalance() {
        const d = window.balanceData || {bal:0,inc:0,exp:0};
        if(isPrivacy) { $('cardBalance').innerText="Rp ••••••"; $('cardIncome').innerText="••••"; $('cardExpense').innerText="••••"; }
        else { $('cardBalance').innerText="Rp "+d.bal.toLocaleString(); $('cardIncome').innerText="Rp "+d.inc.toLocaleString(); $('cardExpense').innerText="Rp "+d.exp.toLocaleString(); }
    }

    // ACTIONS
    window.openFinanceModal = () => showModal('Input Kas', `
        <div class="bg-slate-100 p-1 rounded-xl flex mb-4"><button onclick="setType('income')" id="btnInc" class="flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm transition-all">Pemasukan</button><button onclick="setType('expense')" id="btnExp" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-400 transition-all">Pengeluaran</button></div>
        <input id="fAmt" type="number" class="w-full text-3xl font-black bg-transparent text-center border-none focus:ring-0 mb-4" placeholder="0">
        <input id="fNote" class="w-full p-4 bg-slate-100 rounded-2xl text-sm font-bold border-none outline-none" placeholder="Catatan transaksi...">
        <input type="hidden" id="fType" value="income">
    `, async()=>{
        if(!$('fAmt').value) return showToast("Isi nominal!","e");
        toggleLoader(true); try{await addDoc(collection(db,"financial_records"),{type:$('fType').value, amount:$('fAmt').value, note:$('fNote').value, status:'approved', createdAt:serverTimestamp()}); closeModal(); showToast("Berhasil"); playSound('click');}catch(e){showToast("Error","e")}finally{toggleLoader(false);}
    });
    window.setType=(t)=>{ $('fType').value=t; if(t==='income'){$('btnInc').className="flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm transition-all"; $('btnExp').className="flex-1 py-2 rounded-lg text-xs font-bold text-slate-400 transition-all"} else {$('btnExp').className="flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm transition-all"; $('btnInc').className="flex-1 py-2 rounded-lg text-xs font-bold text-slate-400 transition-all"} };

    window.openEventModal = () => showModal('Event Baru', `<input id="evT" class="w-full p-4 bg-slate-100 rounded-2xl mb-3 font-bold border-none outline-none" placeholder="Nama Acara"><input id="evD" type="date" class="w-full p-4 bg-slate-100 rounded-2xl mb-3 font-bold border-none outline-none"><input id="evL" class="w-full p-4 bg-slate-100 rounded-2xl font-bold border-none outline-none" placeholder="Lokasi">`, async()=>{
        if(!$('evT').value) return showToast("Judul wajib!","e");
        toggleLoader(true); try{await addDoc(collection(db,"activities"),{title:$('evT').value, date:$('evD').value, location:$('evL').value, status:'approved', createdAt:serverTimestamp()}); closeModal(); showToast("Disimpan"); playSound('click');}catch(e){}finally{toggleLoader(false);}
    });

    window.editRole = (uid) => {
        const opts = `<div class="space-y-2">
            ${['anggota','koordinator','bendahara','sekretaris','wakil_ketua'].map(r=>`<button onclick="setRole('${uid}','${r}')" class="w-full p-3 bg-slate-100 rounded-xl text-xs font-bold uppercase hover:bg-slate-200 text-left">${r.replace('_',' ')}</button>`).join('')}
            ${ROLE==='super_admin'?`<button onclick="setRole('${uid}','ketua')" class="w-full p-3 bg-slate-900 text-lime-300 rounded-xl text-xs font-bold uppercase">KETUA UMUM</button>`:''}
        </div>`;
        showModal("Ubah Jabatan", opts);
    }
    window.setRole = async(uid,r)=>{ if(confirm("Ubah akses?")){ await updateDoc(doc(db,"users",uid),{role:r}); closeModal(); showToast("Akses diubah"); } };
    window.delDoc = async(c,i)=>{ if(confirm("Hapus?")) await deleteDoc(doc(db,c,i)); };

    // PROFILE
    window.loadProfile = () => {
        $('profileImageEdit').src=ME_DATA.photo?.url||"https://via.placeholder.com/150";
        $('editName').value=ME_DATA.name||""; $('editPhone').value=ME_DATA.phone||""; $('editAddress').value=ME_DATA.address||"";
    }
    window.showIdCard = () => {
        const p = PERMISSIONS[ROLE]||PERMISSIONS['anggota'];
        showModal("Kartu Digital", `<div class="bg-slate-900 text-white p-6 rounded-[2rem] relative overflow-hidden shadow-2xl"><div class="absolute -top-10 -right-10 w-32 h-32 bg-lime-400/20 rounded-full blur-2xl"></div><div class="flex gap-4 items-center relative z-10"><img src="${ME_DATA.photo?.url}" class="w-16 h-16 rounded-2xl border-2 border-slate-700 bg-slate-800 object-cover"><div><h2 class="text-xl font-black leading-none mb-1 text-lime-300">${ME_DATA.name}</h2><p class="text-xs font-bold text-slate-400 uppercase tracking-widest">${p.label}</p></div></div><div class="mt-6 pt-4 border-t border-slate-800 flex justify-between"><span class="text-[10px] text-slate-500 font-bold">MEMBER ID</span><span class="text-xs font-mono text-lime-100">${UID.slice(0,8).toUpperCase()}</span></div></div>`);
    }
    
    // ARISAN
    window.openArisanUI = () => { $('arisanOverlay').classList.remove('hidden'); $('arisanOverlay').classList.add('flex'); candidates = allMembers; $('shufflerImg').src="https://via.placeholder.com/150"; $('shufflerName').innerText="SIAP?"; $('winnerActions').classList.add('hidden'); $('btnSpin').classList.remove('hidden'); };
    window.closeArisan = () => { $('arisanOverlay').classList.add('hidden'); try{sfx.shuffle.pause()}catch(e){} };
    window.spinArisan = () => {
        if(candidates.length<2) return showToast("Peserta kurang!","e");
        vibrate(); try{sfx.shuffle.currentTime=0; sfx.shuffle.play();}catch(e){} $('btnSpin').classList.add('hidden'); $('winnerActions').classList.add('hidden');
        let dur=4000, start=null;
        function anim(t){
            if(!start) start=t; const p=t-start;
            const r = Math.floor(Math.random()*candidates.length);
            $('shufflerName').innerText=candidates[r].name; $('shufflerImg').src=candidates[r].photo?.url||"https://via.placeholder.com/150";
            if(p<dur) requestAnimationFrame(anim);
            else {
                tempWinner=candidates[Math.floor(Math.random()*candidates.length)];
                $('shufflerName').innerText=tempWinner.name; $('shufflerImg').src=tempWinner.photo?.url;
                try{sfx.shuffle.pause(); sfx.win.play();}catch(e){} confetti({particleCount:150,spread:70});
                $('winnerActions').classList.remove('hidden'); $('winnerActions').classList.add('flex');
            }
        } requestAnimationFrame(anim);
    }
    window.saveWinner = async()=>{ if(tempWinner){ toggleLoader(true); await addDoc(collection(db,"arisan_history"),{name:tempWinner.name, photo:tempWinner.photo?.url, uid:tempWinner.id, createdAt:serverTimestamp()}); closeArisan(); showToast("Disimpan"); toggleLoader(false); } }

    // UPLOAD
    let newFile=null; window.previewProfileImage=(i)=>{ if(i.files[0]){ newFile=i.files[0]; $('profileImageEdit').src=URL.createObjectURL(newFile); } };
    async function upload(f){ const fd=new FormData(); fd.append("file",f); fd.append("upload_preset",PRESET); try{const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:"POST",body:fd}); const j=await r.json(); return {url:j.secure_url};}catch(e){return null;} }
    window.saveProfile=async()=>{ toggleLoader(true); let d={name:$('editName').value,phone:$('editPhone').value,address:$('editAddress').value}; if(newFile){const u=await upload(newFile); if(u)d.photo=u;} await updateDoc(doc(db,"users",UID),d); showToast("Disimpan"); toggleLoader(false); }

  </script>
</body>
</html>
