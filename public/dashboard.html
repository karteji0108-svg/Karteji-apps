<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0B1120" />
  <title>Verifikasi Akses | KARTEJI</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24..48,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      darkMode: ['class', '[data-theme="dark"]'],
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'system-ui', 'Segoe UI', 'Roboto', 'sans-serif'] },
          colors: {
            brand: { primary: '#0F172A' },
            accent: { DEFAULT: '#F97316', glow: '#FDBA74' }
          },
          animation: {
            'slide-up': 'slideUp .6s cubic-bezier(.16, 1, .3, 1) both',
            'blob': 'blob 11s ease-in-out infinite',
            'pulse-fast': 'pulse 1.35s cubic-bezier(.4,0,.6,1) infinite',
            'sheen': 'sheen 1.2s ease-out both',
          },
          keyframes: {
            slideUp: { '0%': { transform: 'translateY(28px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.08)' },
              '66%': { transform: 'translate(-20px, 20px) scale(.92)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            sheen: { '0%': { transform: 'translateX(-120%)' }, '100%': { transform: 'translateX(120%)' } }
          }
        }
      }
    }
  </script>

  <style>
    :root{
      color-scheme: light;
      --bg0:#f8fafc; --bg1:#ffffff;
      --fg0:#0f172a; --fg1:rgba(15,23,42,.68);
      --glass: rgba(255,255,255,.78);
      --glassBorder: rgba(255,255,255,.55);
      --glassShadow: 0 18px 60px rgba(2,6,23,.16);
      --ring: rgba(249,115,22,.35);
    }
    html[data-theme="dark"]{
      color-scheme: dark;
      --bg0:#050814; --bg1:#0b1223;
      --fg0:#e5e7eb; --fg1:rgba(229,231,235,.72);
      --glass: rgba(15,23,42,.55);
      --glassBorder: rgba(148,163,184,.18);
      --glassShadow: 0 18px 70px rgba(0,0,0,.45);
      --ring: rgba(253,186,116,.30);
    }

    body { font-family:"Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; -webkit-font-smoothing: antialiased; }
    body::-webkit-scrollbar { display:none; }
    *{ -webkit-tap-highlight-color: transparent; }

    .glass-card{
      background: var(--glass);
      backdrop-filter: blur(18px) saturate(130%);
      -webkit-backdrop-filter: blur(18px) saturate(130%);
      border: 1px solid var(--glassBorder);
      box-shadow: var(--glassShadow);
    }
    .glass-inset{
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,0));
      border: 1px solid rgba(255,255,255,.10);
    }

    .tap{ transition: transform .16s ease, box-shadow .16s ease, filter .16s ease; will-change: transform; }
    .tap:active{ transform: scale(.992); }

    .focus-ring:focus{ outline:none; }
    .focus-ring:focus-visible{ box-shadow: 0 0 0 6px var(--ring); }

    .ad-2000{ animation-delay:2000ms; }

    @media (prefers-reduced-motion: reduce){
      * { animation:none !important; transition:none !important; scroll-behavior:auto !important; }
    }
  </style>

  <script>
    // Theme bootstrap (before paint)
    (function(){
      const saved = localStorage.getItem('kte_theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
</head>

<body class="h-screen w-screen overflow-hidden relative">

  <!-- Liquid background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0"
      style="
        background:
          radial-gradient(1200px 600px at 18% 8%, rgba(59,130,246,.16), transparent 55%),
          radial-gradient(900px 520px at 92% 18%, rgba(249,115,22,.14), transparent 55%),
          radial-gradient(900px 520px at 42% 96%, rgba(99,102,241,.14), transparent 55%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
      ">
    </div>

    <div class="absolute inset-0 overflow-hidden pointer-events-none">
      <div class="absolute top-[-12%] left-[-12%] w-96 h-96 rounded-full filter blur-3xl opacity-30 animate-blob"
           style="background: rgba(59,130,246,.55)"></div>
      <div class="absolute bottom-[-12%] right-[-12%] w-96 h-96 rounded-full filter blur-3xl opacity-25 animate-blob ad-2000"
           style="background: rgba(249,115,22,.55)"></div>
    </div>

    <!-- subtle grain -->
    <div class="absolute inset-0 opacity-[.06] pointer-events-none"
      style="background-image: url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22%3E%3Cfilter id=%22n%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.9%22 numOctaves=%222%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22120%22 height=%22120%22 filter=%22url(%23n)%22 opacity=%220.35%22/%3E%3C/svg%3E');">
    </div>
  </div>

  <!-- Top bar -->
  <div class="absolute top-0 left-0 right-0 z-40 pt-6 px-6">
    <div class="flex items-center justify-end">
      <button id="btn-theme"
        class="tap focus-ring inline-flex items-center gap-2 font-extrabold text-sm py-2 px-3 rounded-full glass-inset"
        style="color: var(--fg1)"
        aria-label="Ganti tema">
        <span id="themeIcon" class="material-symbols-rounded text-lg" aria-hidden="true">dark_mode</span>
      </button>
    </div>
  </div>

  <section class="absolute inset-0 z-30 flex flex-col justify-center items-center px-6">

    <div class="glass-card w-full max-w-[360px] rounded-[2rem] p-8 text-center animate-slide-up relative z-10">

      <div class="relative w-20 h-20 mx-auto mb-6">
        <div class="absolute inset-0 rounded-full animate-ping opacity-60"
             style="background: rgba(59,130,246,.18)"></div>

        <div class="relative w-full h-full rounded-full flex items-center justify-center shadow-sm"
             style="background: rgba(148,163,184,.10); border: 1px solid rgba(148,163,184,.18);">
          <span id="statusIcon" class="material-symbols-rounded text-4xl animate-pulse-fast" style="color: var(--fg0)">security</span>
        </div>
      </div>

      <h1 class="text-xl font-extrabold mb-2" style="color: var(--fg0)">Security Check</h1>
      <p class="text-sm mb-6 leading-relaxed" style="color: var(--fg1)">
        Sistem sedang memverifikasi identitas dan hak akses akun Anda.
      </p>

      <div class="flex items-center justify-center gap-2 mb-4">
        <div class="w-2 h-2 rounded-full animate-bounce" style="background: #F97316"></div>
        <span id="msg" class="text-xs font-extrabold tracking-wide uppercase" style="color: rgba(148,163,184,.95)">
          Menghubungkan...
        </span>
      </div>

      <div class="h-2 w-full rounded-full overflow-hidden mb-2" style="background: rgba(148,163,184,.18)">
        <div id="loadingBar"
          class="h-full rounded-full transition-all duration-700 ease-out"
          style="width: 6%; background: linear-gradient(135deg, #0F172A, #111c33);">
        </div>
      </div>

      <div id="stepHint" class="text-[11px] font-extrabold tracking-widest uppercase"
           style="color: rgba(148,163,184,.85)">
        STEP 1/3
      </div>

      <button id="backBtn"
        class="hidden tap focus-ring mt-6 w-full text-white font-extrabold py-3.5 rounded-xl transition-all text-sm flex items-center justify-center gap-2 active:scale-95 relative overflow-hidden group"
        style="background: linear-gradient(135deg, #0F172A, #111c33); box-shadow: 0 18px 60px rgba(2,6,23,.18);">
        <span class="material-symbols-rounded text-lg">logout</span>
        <span>Keluar / Login Ulang</span>

        <span class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity">
          <span class="absolute -left-1/2 top-0 h-full w-1/2 bg-white/15 skew-x-[-18deg] animate-sheen"></span>
        </span>
      </button>

    </div>

    <p class="absolute bottom-8 text-[10px] font-extrabold tracking-widest opacity-60"
       style="color: rgba(148,163,184,.95)">
      KARTEJI SECURE GATEWAY
    </p>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
      authDomain: "katar-9cac3.firebaseapp.com",
      projectId: "katar-9cac3",
      storageBucket: "katar-9cac3.firebasestorage.app",
      messagingSenderId: "1017734829960",
      appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const msgEl = document.getElementById("msg");
    const backBtn = document.getElementById("backBtn");
    const loadingBar = document.getElementById("loadingBar");
    const stepHint = document.getElementById("stepHint");
    const statusIcon = document.getElementById("statusIcon");

    // Theme toggle
    const btnTheme = document.getElementById("btn-theme");
    const themeIcon = document.getElementById("themeIcon");
    function getTheme(){ return document.documentElement.getAttribute('data-theme') || 'light'; }
    function setTheme(next){
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('kte_theme', next);
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta) meta.setAttribute('content', next === 'dark' ? '#0B1120' : '#F8FAFC');
      themeIcon.textContent = (next === 'dark') ? 'light_mode' : 'dark_mode';
    }
    function toggleTheme(){ setTheme(getTheme() === 'dark' ? 'light' : 'dark'); }
    setTheme(getTheme());
    btnTheme?.addEventListener('click', toggleTheme);

    function setProgress(pct, stepText){
      loadingBar.style.width = pct + "%";
      if(stepText) stepHint.textContent = stepText;
    }

    function setState(text, icon){
      msgEl.textContent = text;
      if(icon) statusIcon.textContent = icon;
    }

    // Routing map
    const routeByRole = {
      "super_admin": "dashboards/super-admin.html",
      "ketua": "dashboards/ketua.html",
      "wakil_ketua": "dashboards/wakil-ketua.html",
      "sekretaris": "dashboards/sekretaris.html",
      "bendahara": "dashboards/bendahara.html",
      "koordinator": "dashboards/koordinator.html",
      "anggota": "dashboards/anggota.html"
    };

    function normalizeRole(role){
      if(!role) return "anggota";
      let r = String(role).trim().toLowerCase().replace(/[\s-]/g, "_");
      const alias = {
        "superadmin": "super_admin",
        "admin": "super_admin",
        "wakil": "wakil_ketua",
        "wakilketua": "wakil_ketua",
        "member": "anggota"
      };
      return alias[r] || r;
    }

    async function showError(message){
      setState(message || "Gagal memuat profil.", "error");
      msgEl.style.color = "#ef4444";
      backBtn.classList.remove("hidden");
      setProgress(100, "ERROR");
      loadingBar.style.background = "linear-gradient(135deg, #ef4444, #fb7185)";

      backBtn.onclick = async () => {
        await signOut(auth);
        window.location.href = "login.html";
      };
    }

    // Start anim
    setTimeout(() => setProgress(28, "STEP 1/3"), 120);

    onAuthStateChanged(auth, async (user) => {
      if(!user) return window.location.href = "login.html";

      try{
        setState("MENGAMBIL DATA PROFIL...", "manage_accounts");
        setProgress(62, "STEP 2/3");

        const snap = await getDoc(doc(db, "users", user.uid));
        if(!snap.exists()) return showError("Akun tidak ditemukan di database.");

        const data = snap.data();
        const role = normalizeRole(data?.role);
        const targetPage = routeByRole[role] || routeByRole["anggota"];

        setState("MENGALIHKAN...", "lock_open");
        setProgress(100, "STEP 3/3");

        setTimeout(() => window.location.replace(targetPage), 650);
      } catch(e){
        console.error("Routing Error:", e);
        showError("Koneksi bermasalah. Coba lagi.");
      }
    });
  </script>

</body>
</html>
