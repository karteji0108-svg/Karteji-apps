<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bendahara | KARTEJI</title>

  <link rel="stylesheet" href="../../dist/assets/css/app.css">
  <link rel="icon" href="../assets/img/logo.png">
</head>

<body class="min-h-full bg-slate-950 text-slate-100">

<header class="sticky top-0 z-20 border-b border-white/10 bg-slate-950/70 backdrop-blur-xl">
  <div class="mx-auto max-w-6xl px-6 py-4 flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <img src="../assets/img/logo.png" class="h-10 w-10 rounded-2xl border border-white/10" alt="Logo">
      <div>
        <div class="text-sm font-extrabold">KARTEJI</div>
        <div class="text-xs text-slate-400">Dashboard Bendahara</div>
      </div>
    </div>

    <button id="logoutBtn"
      class="rounded-2xl bg-rose-500 px-4 py-2 text-xs font-extrabold hover:bg-rose-400 active:scale-[.99]">
      Logout
    </button>
  </div>
</header>

<main class="mx-auto max-w-6xl px-6 py-6 space-y-6">

  <!-- Gate -->
  <section id="gate" class="hidden">
    <div class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl">
      <h1 class="text-xl font-extrabold">Akses ditolak</h1>
      <p class="mt-2 text-sm text-slate-300" id="gateMsg">Halaman ini khusus Bendahara.</p>
      <div class="mt-5 flex gap-3">
        <a href="../login.html" class="rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300">
          Login
        </a>
        <a href="../index.html" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm font-semibold hover:bg-white/10">
          Kembali
        </a>
      </div>
    </div>
  </section>

  <!-- Content -->
  <section id="content" class="hidden space-y-6">

    <!-- Profile -->
    <section class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-lg font-extrabold">Profil Bendahara</h2>
          <p class="text-sm text-slate-300">Ubah nama & foto profil.</p>
          <p class="mt-1 text-xs text-slate-400" id="statusMsg"></p>
        </div>

        <div class="flex items-center gap-3">
          <img id="mePhoto" class="h-14 w-14 rounded-2xl border border-white/10 object-cover" src="https://via.placeholder.com/120" alt="Foto">
          <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3">
            <div class="text-xs text-slate-400">Login sebagai</div>
            <div class="text-sm font-extrabold" id="meNameText">-</div>
            <div class="text-xs text-slate-400" id="meEmail">-</div>
          </div>
        </div>
      </div>

      <div class="mt-5 grid gap-3 sm:grid-cols-3">
        <div>
          <label class="block text-xs font-medium text-slate-400 mb-1">Nama</label>
          <input id="meName"
            class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
            placeholder="Nama"/>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-400 mb-1">Foto Profil (Cloudinary)</label>
          <input id="mePhotoInput" type="file" accept="image/*"
            class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none" />
        </div>

        <div class="flex items-end">
          <button id="saveProfileBtn"
            class="w-full rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300 active:scale-[.99]">
            Simpan Profil
          </button>
        </div>
      </div>
    </section>

    <!-- Summary -->
    <section class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl">
      <h2 class="text-lg font-extrabold">Ringkasan Kas (50 terakhir)</h2>
      <div class="mt-4 grid gap-3 sm:grid-cols-3">
        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
          <div class="text-xs text-slate-400">Total Kas Masuk</div>
          <div class="text-xl font-extrabold mt-1" id="sumIncome">Rp 0</div>
        </div>
        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
          <div class="text-xs text-slate-400">Total Kas Keluar</div>
          <div class="text-xl font-extrabold mt-1" id="sumExpense">Rp 0</div>
        </div>
        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
          <div class="text-xs text-slate-400">Saldo (Masuk - Keluar)</div>
          <div class="text-xl font-extrabold mt-1" id="sumBalance">Rp 0</div>
        </div>
      </div>
    </section>

    <!-- Finance CRUD -->
    <section class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl space-y-4">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-lg font-extrabold">Transaksi Keuangan (CRUD)</h2>
          <p class="text-sm text-slate-300">Tambah kas masuk/keluar + bukti transaksi.</p>
        </div>
        <button id="refreshBtn"
          class="rounded-2xl bg-white/10 px-4 py-2 text-xs font-extrabold hover:bg-white/15 active:scale-[.99]">
          Refresh
        </button>
      </div>

      <!-- Form -->
      <div class="grid gap-3 sm:grid-cols-6">
        <select id="finType"
          class="sm:col-span-1 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400">
          <option value="income">Kas Masuk</option>
          <option value="expense">Kas Keluar</option>
        </select>

        <input id="finAmt" type="number"
          class="sm:col-span-1 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          placeholder="Nominal" />

        <input id="finCat"
          class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          placeholder="Kategori (Operasional/Event/Donasi)" />

        <input id="finNote"
          class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          placeholder="Catatan" />

        <input id="finProof" type="file"
          class="sm:col-span-4 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none" />

        <button id="finCreateBtn"
          class="sm:col-span-2 rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300 active:scale-[.99]">
          Tambah
        </button>
      </div>

      <!-- Table -->
      <div class="mt-2 overflow-hidden rounded-2xl border border-white/10">
        <div class="grid grid-cols-12 bg-white/5 px-4 py-3 text-xs font-semibold text-slate-200">
          <div class="col-span-7">Transaksi</div>
          <div class="col-span-2">Status</div>
          <div class="col-span-3 text-right">Aksi</div>
        </div>
        <div id="finList" class="divide-y divide-white/10"></div>
      </div>

      <!-- Edit Panel -->
      <div id="editPanel" class="hidden rounded-3xl border border-white/10 bg-white/5 p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-extrabold">Edit Transaksi</div>
            <div class="text-xs text-slate-400" id="editId">-</div>
          </div>
          <button id="closeEditBtn" class="text-xs text-slate-300 hover:text-white">Tutup</button>
        </div>

        <div class="mt-3 grid gap-3 sm:grid-cols-6">
          <select id="editStatus" class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400">
            <option value="pending">pending</option>
            <option value="approved">approved</option>
            <option value="rejected">rejected</option>
          </select>

          <input id="editCat" class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400" placeholder="Kategori"/>
          <input id="editNote" class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400" placeholder="Catatan"/>

          <button id="saveEditBtn" class="sm:col-span-6 rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300 active:scale-[.99]">
            Simpan Perubahan
          </button>
        </div>
      </div>
    </section>

  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    doc, getDoc, updateDoc, deleteDoc,
    collection, addDoc, getDocs,
    query, orderBy, limit,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
    authDomain: "katar-9cac3.firebaseapp.com",
    projectId: "katar-9cac3",
    storageBucket: "katar-9cac3.firebasestorage.app",
    messagingSenderId: "1017734829960",
    appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d",
    measurementId: "G-M4F9J10TTE"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Cloudinary
  const CLOUD_NAME = "dbxktcwug";
  const PRESET_PROFILE = "Karteji";
  const PRESET_FINANCE = "Karteji Finance";

  async function uploadToCloudinary(file, preset, folder="karteji") {
    const endpoint = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
    const form = new FormData();
    form.append("file", file);
    form.append("upload_preset", preset);
    form.append("folder", folder);

    const res = await fetch(endpoint, { method: "POST", body: form });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.error?.message || "Upload Cloudinary gagal");
    return { url: data.secure_url, publicId: data.public_id, bytes: data.bytes, format: data.format };
  }

  // UI helpers
  const $ = (id) => document.getElementById(id);
  const esc = (s) => String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
  const fmtIDR = (n) => Number(n||0).toLocaleString("id-ID");
  const setStatus = (t) => $("statusMsg").textContent = t || "";

  let ME_UID = null;
  let EDIT_ID = null;

  // Gate
  onAuthStateChanged(auth, async (user) => {
    if (!user) return deny("Belum login.");

    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists()) return deny("Profil tidak ditemukan.");

    const me = snap.data();
    if (me?.role !== "bendahara") return deny("Khusus Bendahara.");

    ME_UID = user.uid;

    $("gate").classList.add("hidden");
    $("content").classList.remove("hidden");

    $("meNameText").textContent = me?.name || "Bendahara";
    $("meEmail").textContent = me?.email || user.email || "-";
    $("meName").value = me?.name || "";
    $("mePhoto").src = me?.photo?.url || "https://via.placeholder.com/120";

    await loadFinance();
    setStatus("Siap ✅");
  });

  function deny(msg){
    $("content").classList.add("hidden");
    $("gate").classList.remove("hidden");
    $("gateMsg").textContent = msg || "Akses ditolak.";
  }

  // Logout
  $("logoutBtn").addEventListener("click", async () => {
    await signOut(auth);
    location.href = "../login.html";
  });

  // Refresh
  $("refreshBtn").addEventListener("click", async ()=>{
    await loadFinance();
    setStatus("Refresh selesai ✅");
  });

  // Profile save
  $("saveProfileBtn").addEventListener("click", async ()=>{
    try{
      setStatus("Menyimpan profil...");
      const newName = $("meName").value.trim();
      const file = $("mePhotoInput").files?.[0];

      const payload = {};
      if (newName) payload.name = newName;

      if (file) {
        const media = await uploadToCloudinary(file, PRESET_PROFILE, `karteji/users/${ME_UID}`);
        payload.photo = media;
        $("mePhoto").src = media.url;
      }

      if (!Object.keys(payload).length) return setStatus("Tidak ada perubahan.");
      await updateDoc(doc(db, "users", ME_UID), payload);

      $("meNameText").textContent = payload.name || $("meNameText").textContent;
      setStatus("Profil tersimpan ✅");
    } catch(e){
      setStatus(e.message || "Gagal simpan profil");
    }
  });

  // Create transaction
  $("finCreateBtn").addEventListener("click", async ()=>{
    try{
      const type = $("finType").value;
      const amount = Number($("finAmt").value || 0);
      const category = $("finCat").value.trim();
      const note = $("finNote").value.trim();
      const proofFile = $("finProof").files?.[0];

      if (!amount || amount <= 0) return setStatus("Nominal wajib > 0.");

      setStatus("Menyimpan transaksi...");
      let proof = null;
      if (proofFile) {
        proof = await uploadToCloudinary(proofFile, PRESET_FINANCE, "karteji/finance");
      }

      await addDoc(collection(db, "financial_records"), {
        type, amount, category, note,
        proof,
        status: "pending",
        createdByUid: ME_UID,
        createdAt: serverTimestamp()
      });

      $("finAmt").value = ""; $("finCat").value=""; $("finNote").value=""; $("finProof").value="";
      setStatus("Transaksi ditambahkan ✅");
      await loadFinance();
    }catch(e){
      setStatus(e.message || "Gagal tambah transaksi");
    }
  });

  // Load finance list + summary
  async function loadFinance(){
    $("finList").innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;
    let sumIncome = 0;
    let sumExpense = 0;

    const q = query(collection(db, "financial_records"), orderBy("createdAt","desc"), limit(50));
    const snap = await getDocs(q);

    if (snap.empty) {
      $("finList").innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada transaksi.</div>`;
      $("sumIncome").textContent = "Rp 0";
      $("sumExpense").textContent = "Rp 0";
      $("sumBalance").textContent = "Rp 0";
      return;
    }

    $("finList").innerHTML = "";
    snap.forEach((d)=>{
      const id = d.id;
      const x = d.data();
      const status = x.status || "pending";

      if (x.type === "income") sumIncome += Number(x.amount||0);
      if (x.type === "expense") sumExpense += Number(x.amount||0);

      const row = document.createElement("div");
      row.className = "px-4 py-3";
      row.innerHTML = `
        <div class="grid grid-cols-12 items-center gap-2">
          <div class="col-span-7">
            <div class="text-sm font-extrabold">
              ${x.type==="income" ? "Kas Masuk" : "Kas Keluar"} • Rp ${fmtIDR(x.amount)}
            </div>
            <div class="text-xs text-slate-400">${esc(x.category || "-")} • ${esc(x.note || "")}</div>
            ${x.proof?.url ? `<div class="text-xs text-slate-400 mt-1">Bukti: <a class="text-emerald-300 hover:underline" target="_blank" rel="noreferrer" href="${x.proof.url}">lihat</a></div>` : ``}
          </div>

          <div class="col-span-2">
            <span class="text-xs font-semibold ${status==="approved"?"text-emerald-300":status==="rejected"?"text-rose-300":"text-slate-300"}">
              ${esc(status)}
            </span>
          </div>

          <div class="col-span-3 flex justify-end gap-2">
            <button class="editBtn rounded-xl bg-white/10 px-3 py-2 text-xs font-extrabold hover:bg-white/15"
              data-id="${esc(id)}"
              data-status="${esc(status)}"
              data-cat="${esc(x.category || "")}"
              data-note="${esc(x.note || "")}">
              Edit
            </button>
            <button class="delBtn rounded-xl bg-rose-500 px-3 py-2 text-xs font-extrabold text-white hover:bg-rose-400"
              data-id="${esc(id)}">
              Delete
            </button>
          </div>
        </div>
      `;
      $("finList").appendChild(row);
    });

    // summary
    $("sumIncome").textContent = `Rp ${fmtIDR(sumIncome)}`;
    $("sumExpense").textContent = `Rp ${fmtIDR(sumExpense)}`;
    $("sumBalance").textContent = `Rp ${fmtIDR(sumIncome - sumExpense)}`;

    // bind buttons
    document.querySelectorAll(".delBtn").forEach(b=>{
      b.addEventListener("click", async ()=>{
        if(!confirm("Hapus transaksi ini?")) return;
        try{
          await deleteDoc(doc(db,"financial_records",b.dataset.id));
          setStatus("Transaksi dihapus ✅");
          await loadFinance();
        }catch(e){
          setStatus("Gagal hapus transaksi.");
        }
      });
    });

    document.querySelectorAll(".editBtn").forEach(b=>{
      b.addEventListener("click", ()=>{
        EDIT_ID = b.dataset.id;
        $("editId").textContent = `ID: ${EDIT_ID}`;
        $("editStatus").value = b.dataset.status || "pending";
        $("editCat").value = b.dataset.cat || "";
        $("editNote").value = b.dataset.note || "";
        $("editPanel").classList.remove("hidden");
        window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
      });
    });
  }

  // Edit panel actions
  $("closeEditBtn").addEventListener("click", ()=>{
    $("editPanel").classList.add("hidden");
    EDIT_ID = null;
  });

  $("saveEditBtn").addEventListener("click", async ()=>{
    try{
      if(!EDIT_ID) return;
      setStatus("Menyimpan perubahan...");

      const status = $("editStatus").value;
      const category = $("editCat").value.trim();
      const note = $("editNote").value.trim();

      await updateDoc(doc(db,"financial_records",EDIT_ID), { status, category, note });
      $("editPanel").classList.add("hidden");
      EDIT_ID = null;

      setStatus("Perubahan tersimpan ✅");
      await loadFinance();
    }catch(e){
      setStatus("Gagal simpan perubahan.");
    }
  });
</script>

</body>
</html>
