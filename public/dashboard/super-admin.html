<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Super Admin | KARTEJI</title>

  <link rel="stylesheet" href="../../dist/assets/css/app.css">
  <link rel="icon" href="../assets/img/logo.png">
</head>

<body class="min-h-full bg-slate-950 text-slate-100">
  <header class="sticky top-0 z-20 border-b border-white/10 bg-slate-950/70 backdrop-blur-xl">
    <div class="mx-auto flex max-w-6xl items-center justify-between gap-3 px-6 py-4">
      <div class="flex items-center gap-3">
        <img
          id="brandLogo"
          src="../assets/img/logo.png"
          alt="Logo"
          class="h-10 w-10 rounded-2xl border border-white/10 object-cover"
          onerror="this.src='https://via.placeholder.com/80'"
        />
        <div>
          <div class="text-sm font-extrabold tracking-wide">KARTEJI</div>
          <div class="text-xs text-slate-400">Super Admin (CRUD)</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <a href="../index.html"
           class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-semibold hover:bg-white/10">
          Beranda
        </a>
        <button id="logoutBtn"
          class="rounded-2xl bg-rose-500 px-4 py-2 text-xs font-extrabold text-white hover:bg-rose-400 active:scale-[.99]">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-6 py-6">
    <section id="gate" class="hidden">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 shadow-2xl">
        <h1 class="text-xl font-extrabold">Akses ditolak</h1>
        <p class="mt-2 text-sm text-slate-300" id="gateMsg">Kamu tidak punya izin.</p>
        <div class="mt-5 flex gap-3">
          <a href="../login.html"
             class="rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300">
            Login
          </a>
          <a href="../index.html"
             class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm font-semibold hover:bg-white/10">
            Kembali
          </a>
        </div>
      </div>
    </section>

    <section id="content" class="hidden space-y-6">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 shadow-2xl">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h1 class="text-2xl font-extrabold tracking-tight">Super Admin Panel</h1>
            <p class="mt-1 text-sm text-slate-300">Kelola sistem (CRUD) + profil.</p>
            <p class="mt-1 text-xs text-slate-400" id="statusMsg"></p>
          </div>

          <div class="flex items-center gap-3">
            <img id="mePhoto"
              class="h-14 w-14 rounded-2xl border border-white/10 object-cover"
              src="https://via.placeholder.com/120"
              alt="Foto"
            />
            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3">
              <div class="text-xs text-slate-400">Login sebagai</div>
              <div class="text-sm font-extrabold" id="meName">-</div>
              <div class="text-xs text-slate-400" id="meEmail">-</div>
            </div>
          </div>
        </div>

        <div class="mt-5 grid gap-3 sm:grid-cols-3">
          <div class="sm:col-span-1">
            <label class="block text-xs font-medium text-slate-400 mb-1">Ubah Nama</label>
            <input id="profileName"
              class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white placeholder-slate-500 outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/20"
              placeholder="Nama baru"/>
          </div>

          <div class="sm:col-span-1">
            <label class="block text-xs font-medium text-slate-400 mb-1">Foto Profil (Cloudinary)</label>
            <input id="profilePhoto" type="file" accept="image/*"
              class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-slate-200 outline-none" />
          </div>

          <div class="sm:col-span-1 flex items-end gap-2">
            <button id="saveProfileBtn"
              class="w-full rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300 active:scale-[.99]">
              Simpan Profil
            </button>
          </div>
        </div>
      </div>

      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-4 shadow-2xl">
        <div class="flex flex-wrap gap-2">
          <button class="tabBtn px-4 py-2 rounded-2xl border border-white/10 bg-white/5 text-xs font-semibold hover:bg-white/10"
            data-tab="users">Users</button>
          <button class="tabBtn px-4 py-2 rounded-2xl border border-white/10 bg-white/5 text-xs font-semibold hover:bg-white/10"
            data-tab="activities">Activities</button>
          <button class="tabBtn px-4 py-2 rounded-2xl border border-white/10 bg-white/5 text-xs font-semibold hover:bg-white/10"
            data-tab="finance">Finance</button>
          <button class="tabBtn px-4 py-2 rounded-2xl border border-white/10 bg-white/5 text-xs font-semibold hover:bg-white/10"
            data-tab="notifications">Notifications</button>
          <button class="tabBtn px-4 py-2 rounded-2xl border border-white/10 bg-white/5 text-xs font-semibold hover:bg-white/10"
            data-tab="archives">Archives</button>
          <button class="tabBtn px-4 py-2 rounded-2xl border border-white/10 bg-white/5 text-xs font-semibold hover:bg-white/10"
            data-tab="logs">Logs</button>

          <button id="refreshAllBtn"
            class="ml-auto px-4 py-2 rounded-2xl bg-white/10 text-xs font-extrabold hover:bg-white/15 active:scale-[.99]">
            Refresh
          </button>
        </div>
      </div>

      <section id="tab-users" class="tabPanel space-y-4">
        <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 shadow-2xl">
          <h2 class="text-lg font-extrabold">Users (CRUD)</h2>
          <p class="mt-1 text-sm text-slate-300">Ubah role atau hapus dokumen user.</p>

          <div class="mt-4 overflow-hidden rounded-2xl border border-white/10">
            <div class="grid grid-cols-12 gap-0 bg-white/5 px-4 py-3 text-xs font-semibold text-slate-200">
              <div class="col-span-4">Nama</div>
              <div class="col-span-4 hidden sm:block">Email</div>
              <div class="col-span-2">Role</div>
              <div class="col-span-2 text-right">Aksi</div>
            </div>
            <div id="userList" class="divide-y divide-white/10"></div>
          </div>
        </div>
      </section>

      <section id="tab-activities" class="tabPanel hidden space-y-4">
        <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 shadow-2xl">
          <h2 class="text-lg font-extrabold">Activities (CRUD)</h2>
          <div class="mt-4 grid gap-3 sm:grid-cols-4">
            <input id="actTitle" class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
              placeholder="Judul kegiatan" />
            <input id="actDate" class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
              placeholder="YYYY-MM-DD" />
            <input id="actLoc" class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
              placeholder="Lokasi" />
            <input id="actDesc" class="sm:col-span-3 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
              placeholder="Deskripsi singkat" />
            <input id="actCover" type="file" accept="image/*"
              class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none" />
            <button id="actCreateBtn"
              class="sm:col-span-4 rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300">
              Buat Kegiatan
            </button>
          </div>

          <div class="mt-5 overflow-hidden rounded-2xl border border-white/10">
            <div class="grid grid-cols-12 gap-0 bg-white/5 px-4 py-3 text-xs font-semibold text-slate-200">
              <div class="col-span-6">Kegiatan</div>
              <div class="col-span-2">Status</div>
              <div class="col-span-4 text-right">Aksi</div>
            </div>
            <div id="actList" class="divide-y divide-white/10"></div>
          </div>
        </div>
      </section>

      <section id="tab-finance" class="tabPanel hidden space-y-4">
        <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 shadow-2xl">
          <h2 class="text-lg font-extrabold">Finance (CRUD)</h2>
          <div class="mt-4 grid gap-3 sm:grid-cols-6">
            <select id="finType"
              class="sm:col-span-1 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400">
              <option value="income">Kas Masuk</option>
              <option value="expense">Kas Keluar</option>
            </select>
            <input id="finAmt" type="number"
              class="sm:col-span-1 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
              placeholder="Nominal" />
            <input id="finCat"
              class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
              placeholder="Kategori (Operasional/Event/Donasi)" />
            <input id="finNote"
              class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
              placeholder="Catatan" />
            <input id="finProof" type="file"
              class="sm:col-span-4 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none" />
            <button id="finCreateBtn"
              class="sm:col-span-2 rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300">
              Tambah Transaksi
            </button>
          </div>

          <div class="mt-5 overflow-hidden rounded-2xl border border-white/10">
            <div class="grid grid-cols-12 gap-0 bg-white/5 px-4 py-3 text-xs font-semibold text-slate-200">
              <div class="col-span-6">Transaksi</div>
              <div class="col-span-2">Status</div>
              <div class="col-span-4 text-right">Aksi</div>
            </div>
            <div id="finList" class="divide-y divide-white/10"></div>
          </div>
        </div>
      </section>

      <section id="tab-notifications" class="tabPanel hidden space-y-4">
        <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 shadow-2xl">
          <h2 class="text-lg font-extrabold">Notifications (CRUD)</h2>
          <div class="mt-4 grid gap-3 sm:grid-cols-4">
            <input id="nTitle"
              class="sm:col-span-1 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
              placeholder="Judul" />
            <input id="nBody"
              class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
              placeholder="Isi notifikasi" />
            <select id="nLevel"
              class="sm:col-span-1 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400">
              <option value="normal">normal</option>
              <option value="important">important</option>
            </select>
            <button id="nCreateBtn"
              class="sm:col-span-4 rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300">
              Kirim Notifikasi
            </button>
          </div>

          <div class="mt-5 overflow-hidden rounded-2xl border border-white/10">
            <div class="grid grid-cols-12 gap-0 bg-white/5 px-4 py-3 text-xs font-semibold text-slate-200">
              <div class="col-span-8">Notifikasi</div>
              <div class="col-span-4 text-right">Aksi</div>
            </div>
            <div id="nList" class="divide-y divide-white/10"></div>
          </div>
        </div>
      </section>

      <section id="tab-archives" class="tabPanel hidden space-y-4">
        <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 shadow-2xl">
          <h2 class="text-lg font-extrabold">Archives (CRUD)</h2>
          <div class="mt-4 grid gap-3 sm:grid-cols-4">
            <input id="arTitle"
              class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
              placeholder="Judul dokumen" />
            <input id="arFile" type="file"
              class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none" />
            <button id="arUploadBtn"
              class="sm:col-span-4 rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300">
              Upload Arsip
            </button>
          </div>

          <div class="mt-5 overflow-hidden rounded-2xl border border-white/10">
            <div class="grid grid-cols-12 gap-0 bg-white/5 px-4 py-3 text-xs font-semibold text-slate-200">
              <div class="col-span-8">Arsip</div>
              <div class="col-span-4 text-right">Aksi</div>
            </div>
            <div id="arList" class="divide-y divide-white/10"></div>
          </div>
        </div>
      </section>

      <section id="tab-logs" class="tabPanel hidden space-y-4">
        <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 shadow-2xl">
          <h2 class="text-lg font-extrabold">Logs (Read)</h2>
          <p class="mt-1 text-sm text-slate-300">Log sederhana aktivitas sistem.</p>

          <div class="mt-5 overflow-hidden rounded-2xl border border-white/10">
            <div class="grid grid-cols-12 gap-0 bg-white/5 px-4 py-3 text-xs font-semibold text-slate-200">
              <div class="col-span-8">Action</div>
              <div class="col-span-4">Waktu</div>
            </div>
            <div id="logList" class="divide-y divide-white/10"></div>
          </div>
        </div>
      </section>

    </section>
  </main>

  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, updateDoc, deleteDoc,
      collection, addDoc, getDocs,
      query, orderBy, limit,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ========= Firebase config (punyamu) =========
    const firebaseConfig = {
      apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
      authDomain: "katar-9cac3.firebaseapp.com",
      projectId: "katar-9cac3",
      storageBucket: "katar-9cac3.firebasestorage.app",
      messagingSenderId: "1017734829960",
      appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d",
      measurementId: "G-M4F9J10TTE"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===================================================
    // ========= Cloudinary (KONFIGURASI BARU) =========
    // ===================================================
    const CLOUD_NAME = "dbxktcwug"; // Sudah diisi
    
    // Definisikan semua preset Anda sesuai tujuan upload:
    const UPLOAD_PRESET_PROFILE = "Karteji"; // untuk foto profil
    const UPLOAD_PRESET_ACTIVITY = "Karteji Galeri"; // untuk cover kegiatan
    const UPLOAD_PRESET_FINANCE = "Karteji Finance"; // untuk bukti transaksi keuangan
    const UPLOAD_PRESET_ARCHIVE = "Karteji Galeri"; // diasumsikan untuk arsip/dokumen

    // Fungsi uploadToCloudinary diubah untuk menerima uploadPreset sebagai argumen
    async function uploadToCloudinary(file, uploadPreset, folder="karteji/misc") {
      if (CLOUD_NAME.startsWith("ISI_") || !uploadPreset) {
        throw new Error("Cloudinary belum diset atau Preset kosong. Isi CLOUD_NAME & Preset di super-admin.html");
      }
      const endpoint = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
      const form = new FormData();
      form.append("file", file);
      form.append("upload_preset", uploadPreset); // Menggunakan preset yang spesifik
      form.append("folder", folder);

      const res = await fetch(endpoint, { method: "POST", body: form });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error?.message || "Upload Cloudinary gagal");
      return {
        url: data.secure_url,
        publicId: data.public_id,
        bytes: data.bytes,
        resourceType: data.resource_type,
        format: data.format,
        createdAt: data.created_at
      };
    }

    // ========= Helpers =========
    const $ = (id) => document.getElementById(id);
    const esc = (s) => String(s ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
    const fmtIDR = (n) => Number(n||0).toLocaleString("id-ID");
    const setStatus = (t) => $("statusMsg").textContent = t || "";

    const ROLES = ["super_admin","ketua","wakil_ketua","sekretaris","bendahara","koordinator","anggota"];

    async function log(action, meta = {}) {
      try {
        await addDoc(collection(db, "logs"), { action, meta, at: serverTimestamp() });
      } catch {}
    }

    function showGate(message) {
      $("content").classList.add("hidden");
      $("gate").classList.remove("hidden");
      $("gateMsg").textContent = message || "Akses ditolak.";
    }

    function showContent() {
      $("gate").classList.add("hidden");
      $("content").classList.remove("hidden");
    }

    // ========= Tabs =========
    function openTab(name) {
      document.querySelectorAll(".tabPanel").forEach(p => p.classList.add("hidden"));
      document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("bg-emerald-400","text-slate-950","font-extrabold"));

      $(`tab-${name}`).classList.remove("hidden");
      document.querySelector(`.tabBtn[data-tab="${name}"]`)
        .classList.add("bg-emerald-400","text-slate-950","font-extrabold");
    }

    document.querySelectorAll(".tabBtn").forEach(btn => {
      btn.addEventListener("click", () => openTab(btn.dataset.tab));
    });

    $("refreshAllBtn").addEventListener("click", async () => {
      await Promise.allSettled([loadUsers(), loadActivities(), loadFinance(), loadNotifications(), loadArchives(), loadLogs()]);
      setStatus("Refresh selesai ✅");
    });

    // ========= Auth Gate =========
    let ME_UID = null;
    let ME_PROFILE = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return showGate("Belum login. Silakan login.");

      try {
        const snap = await getDoc(doc(db, "users", user.uid));
        if (!snap.exists()) return showGate("Profil user tidak ditemukan.");
        const me = snap.data();
        if (me?.role !== "super_admin") return showGate("Khusus Super Admin.");

        ME_UID = user.uid;
        ME_PROFILE = me;

        $("meName").textContent = me?.name || "Super Admin";
        $("meEmail").textContent = me?.email || user.email || "-";
        $("profileName").value = me?.name || "";
        $("mePhoto").src = me?.photo?.url || "https://via.placeholder.com/120";

        showContent();
        openTab("users");
        await Promise.allSettled([loadUsers(), loadActivities(), loadFinance(), loadNotifications(), loadArchives(), loadLogs()]);
        setStatus("Siap ✅");
      } catch (e) {
        showGate("Gagal memuat data.");
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      location.href = "../login.html";
    });

    // ========= PROFILE (update name + photo) =========
    $("saveProfileBtn").addEventListener("click", async () => {
      try {
        setStatus("Menyimpan profil...");
        const newName = $("profileName").value.trim();
        const photoFile = $("profilePhoto").files?.[0];

        const payload = {};
        if (newName) payload.name = newName;

        if (photoFile) {
          // Menggunakan UPLOAD_PRESET_PROFILE
          const media = await uploadToCloudinary(photoFile, UPLOAD_PRESET_PROFILE, `karteji/users/${ME_UID}/photo`);
          payload.photo = media;
          $("mePhoto").src = media.url;
        }

        if (Object.keys(payload).length === 0) {
          setStatus("Tidak ada perubahan.");
          return;
        }

        await updateDoc(doc(db, "users", ME_UID), payload);
        await log("profile.update", { uid: ME_UID, keys: Object.keys(payload) });
        setStatus("Profil tersimpan ✅");
      } catch (e) {
        setStatus(e.message || "Gagal simpan profil");
      }
    });

    // ========= USERS CRUD =========
    async function loadUsers() {
      const list = $("userList");
      list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;

      const q = query(collection(db, "users"), orderBy("name","asc"), limit(200));
      const snap = await getDocs(q);

      if (snap.empty) {
        list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada user.</div>`;
        return;
      }

      list.innerHTML = "";
      snap.forEach((d) => {
        const uid = d.id;
        const u = d.data();

        const row = document.createElement("div");
        row.className = "grid grid-cols-12 items-center gap-0 px-4 py-3";
        row.innerHTML = `
          <div class="col-span-4">
            <div class="text-sm font-extrabold">${esc(u.name || "-")}</div>
            <div class="text-xs text-slate-400 sm:hidden">${esc(u.email || "")}</div>
          </div>
          <div class="col-span-4 hidden sm:block text-xs text-slate-300">${esc(u.email || "")}</div>
          <div class="col-span-2">
            <select class="roleSelect w-full rounded-xl border border-white/10 bg-slate-950/40 px-2 py-2 text-xs text-slate-100 outline-none focus:border-emerald-400"
              data-uid="${esc(uid)}">
              ${ROLES.map(r => `<option value="${r}" ${u.role===r?"selected":""}>${r}</option>`).join("")}
            </select>
          </div>
          <div class="col-span-2 flex justify-end gap-2">
            <button class="saveRoleBtn rounded-xl bg-emerald-400 px-3 py-2 text-xs font-extrabold text-slate-950 hover:bg-emerald-300"
              data-uid="${esc(uid)}">Simpan</button>
            <button class="delUserBtn rounded-xl bg-rose-500 px-3 py-2 text-xs font-extrabold text-white hover:bg-rose-400"
              data-uid="${esc(uid)}">Hapus</button>
          </div>
        `;
        list.appendChild(row);
      });

      // bind
      document.querySelectorAll(".saveRoleBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const uid = btn.dataset.uid;
          const sel = document.querySelector(`.roleSelect[data-uid="${uid}"]`);
          const newRole = sel.value;

          btn.disabled = true; const old = btn.textContent; btn.textContent = "…";
          try {
            await updateDoc(doc(db, "users", uid), { role: newRole });
            await log("role.update", { uid, role: newRole });
            setStatus(`Role user diubah: ${uid} → ${newRole}`);
          } catch (e) {
            setStatus("Gagal ubah role (cek rules).");
          } finally {
            btn.disabled = false; btn.textContent = old;
          }
        });
      });

      document.querySelectorAll(".delUserBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const uid = btn.dataset.uid;
          if (!confirm("Hapus dokumen user ini? (Auth user tidak terhapus otomatis)")) return;

          btn.disabled = true; const old = btn.textContent; btn.textContent = "…";
          try {
            await deleteDoc(doc(db, "users", uid));
            await log("user.deleteDoc", { uid });
            setStatus(`Dokumen user dihapus: ${uid}`);
            await loadUsers();
          } catch (e) {
            setStatus("Gagal hapus user doc.");
          } finally {
            btn.disabled = false; btn.textContent = old;
          }
        });
      });
    }

    // ========= ACTIVITIES CRUD =========
    async function loadActivities() {
      const list = $("actList");
      list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;

      const q = query(collection(db, "activities"), orderBy("createdAt","desc"), limit(50));
      const snap = await getDocs(q);

      if (snap.empty) {
        list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada kegiatan.</div>`;
        return;
      }

      list.innerHTML = "";
      snap.forEach((d) => {
        const id = d.id;
        const x = d.data();

        const row = document.createElement("div");
        row.className = "px-4 py-3";
        row.innerHTML = `
          <div class="grid grid-cols-12 items-center gap-2">
            <div class="col-span-6">
              <div class="text-sm font-extrabold">${esc(x.title || "-")}</div>
              <div class="text-xs text-slate-400">${esc(x.date || "")} • ${esc(x.location || "")}</div>
            </div>
            <div class="col-span-2">
              <span class="text-xs font-semibold ${x.status==="approved"?"text-emerald-300":x.status==="rejected"?"text-rose-300":"text-slate-300"}">
                ${esc(x.status || "pending")}
              </span>
            </div>
            <div class="col-span-4 flex justify-end gap-2">
              <button class="actApprove rounded-xl bg-emerald-400 px-3 py-2 text-xs font-extrabold text-slate-950 hover:bg-emerald-300"
                data-id="${esc(id)}">Approve</button>
              <button class="actReject rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs font-extrabold hover:bg-white/10"
                data-id="${esc(id)}">Reject</button>
              <button class="actDel rounded-xl bg-rose-500 px-3 py-2 text-xs font-extrabold text-white hover:bg-rose-400"
                data-id="${esc(id)}">Delete</button>
            </div>
          </div>
          ${x.cover?.url ? `<div class="mt-2 text-xs text-slate-400">Cover: <a class="text-emerald-300 hover:underline" target="_blank" rel="noreferrer" href="${x.cover.url}">lihat</a></div>` : ``}
        `;
        list.appendChild(row);
      });

      document.querySelectorAll(".actApprove").forEach(b => b.addEventListener("click", async () => {
        await updateDoc(doc(db,"activities",b.dataset.id), { status:"approved" });
        await log("activity.approve", { id: b.dataset.id });
        setStatus("Kegiatan approved ✅");
        await loadActivities();
      }));
      document.querySelectorAll(".actReject").forEach(b => b.addEventListener("click", async () => {
        await updateDoc(doc(db,"activities",b.dataset.id), { status:"rejected" });
        await log("activity.reject", { id: b.dataset.id });
        setStatus("Kegiatan rejected ✅");
        await loadActivities();
      }));
      document.querySelectorAll(".actDel").forEach(b => b.addEventListener("click", async () => {
        if(!confirm("Hapus kegiatan ini?")) return;
        await deleteDoc(doc(db,"activities",b.dataset.id));
        await log("activity.delete", { id: b.dataset.id });
        setStatus("Kegiatan dihapus ✅");
        await loadActivities();
      }));
    }

    $("actCreateBtn").addEventListener("click", async () => {
      try {
        const title = $("actTitle").value.trim();
        const date = $("actDate").value.trim();
        const location = $("actLoc").value.trim();
        const description = $("actDesc").value.trim();
        const coverFile = $("actCover").files?.[0];

        if(!title) return setStatus("Judul wajib diisi.");

        setStatus("Membuat kegiatan...");
        let cover = null;
        if (coverFile) {
          // Menggunakan UPLOAD_PRESET_ACTIVITY
          cover = await uploadToCloudinary(coverFile, UPLOAD_PRESET_ACTIVITY, "karteji/activities/cover");
        }

        await addDoc(collection(db, "activities"), {
          title, date, location, description,
          status: "pending",
          cover,
          createdByUid: ME_UID,
          createdAt: serverTimestamp()
        });
        await log("activity.create", { title });

        $("actTitle").value = ""; $("actDate").value = ""; $("actLoc").value = ""; $("actDesc").value = ""; $("actCover").value = "";
        setStatus("Kegiatan dibuat ✅");
        await loadActivities();
      } catch (e) {
        setStatus(e.message || "Gagal buat kegiatan");
      }
    });

    // ========= FINANCE CRUD =========
    async function loadFinance() {
      const list = $("finList");
      list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;

      const q = query(collection(db, "financial_records"), orderBy("createdAt","desc"), limit(50));
      const snap = await getDocs(q);

      if (snap.empty) {
        list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada transaksi.</div>`;
        return;
      }

      list.innerHTML = "";
      snap.forEach((d) => {
        const id = d.id;
        const x = d.data();

        const row = document.createElement("div");
        row.className = "px-4 py-3";
        row.innerHTML = `
          <div class="grid grid-cols-12 items-center gap-2">
            <div class="col-span-6">
              <div class="text-sm font-extrabold">
                ${x.type==="income" ? "Kas Masuk" : "Kas Keluar"} • Rp ${fmtIDR(x.amount)}
              </div>
              <div class="text-xs text-slate-400">${esc(x.category || "-")} • ${esc(x.note || "")}</div>
              ${x.proof?.url ? `<div class="text-xs text-slate-400 mt-1">Bukti: <a class="text-emerald-300 hover:underline" target="_blank" rel="noreferrer" href="${x.proof.url}">lihat</a></div>` : ``}
            </div>
            <div class="col-span-2">
              <span class="text-xs font-semibold ${x.status==="approved"?"text-emerald-300":x.status==="rejected"?"text-rose-300":"text-slate-300"}">
                ${esc(x.status || "pending")}
              </span>
            </div>
            <div class="col-span-4 flex justify-end gap-2">
              <button class="finApprove rounded-xl bg-emerald-400 px-3 py-2 text-xs font-extrabold text-slate-950 hover:bg-emerald-300"
                data-id="${esc(id)}">Approve</button>
              <button class="finReject rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs font-extrabold hover:bg-white/10"
                data-id="${esc(id)}">Reject</button>
              <button class="finDel rounded-xl bg-rose-500 px-3 py-2 text-xs font-extrabold text-white hover:bg-rose-400"
                data-id="${esc(id)}">Delete</button>
            </div>
          </div>
        `;
        list.appendChild(row);
      });

      document.querySelectorAll(".finApprove").forEach(b => b.addEventListener("click", async () => {
        await updateDoc(doc(db,"financial_records",b.dataset.id), { status:"approved" });
        await log("finance.approve", { id: b.dataset.id });
        setStatus("Finance approved ✅");
        await loadFinance();
      }));
      document.querySelectorAll(".finReject").forEach(b => b.addEventListener("click", async () => {
        await updateDoc(doc(db,"financial_records",b.dataset.id), { status:"rejected" });
        await log("finance.reject", { id: b.dataset.id });
        setStatus("Finance rejected ✅");
        await loadFinance();
      }));
      document.querySelectorAll(".finDel").forEach(b => b.addEventListener("click", async () => {
        if(!confirm("Hapus transaksi ini?")) return;
        await deleteDoc(doc(db,"financial_records",b.dataset.id));
        await log("finance.delete", { id: b.dataset.id });
        setStatus("Transaksi dihapus ✅");
        await loadFinance();
      }));
    }

    $("finCreateBtn").addEventListener("click", async () => {
      try {
        const type = $("finType").value;
        const amount = Number($("finAmt").value || 0);
        const category = $("finCat").value.trim();
        const note = $("finNote").value.trim();
        const proofFile = $("finProof").files?.[0];

        if (!amount || amount <= 0) return setStatus("Nominal wajib > 0.");

        setStatus("Menambah transaksi...");
        let proof = null;
        if (proofFile) {
          // Menggunakan UPLOAD_PRESET_FINANCE
          proof = await uploadToCloudinary(proofFile, UPLOAD_PRESET_FINANCE, "karteji/finance/proof");
        }

        await addDoc(collection(db, "financial_records"), {
          type, amount, category, note,
          proof,
          status: "pending",
          createdByUid: ME_UID,
          createdAt: serverTimestamp()
        });
        await log("finance.create", { type, amount });

        $("finAmt").value = ""; $("finCat").value = ""; $("finNote").value = ""; $("finProof").value = "";
        setStatus("Transaksi ditambahkan ✅");
        await loadFinance();
      } catch (e) {
        setStatus(e.message || "Gagal tambah transaksi");
      }
    });

    // ========= NOTIFICATIONS CRUD =========
    async function loadNotifications() {
      const list = $("nList");
      list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;

      const q = query(collection(db, "notifications"), orderBy("createdAt","desc"), limit(50));
      const snap = await getDocs(q);

      if (snap.empty) {
        list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada notifikasi.</div>`;
        return;
      }

      list.innerHTML = "";
      snap.forEach((d) => {
        const id = d.id;
        const x = d.data();
        const row = document.createElement("div");
        row.className = "px-4 py-3";
        row.innerHTML = `
          <div class="grid grid-cols-12 items-center gap-2">
            <div class="col-span-8">
              <div class="text-sm font-extrabold">${esc(x.title || "-")}</div>
              <div class="text-xs text-slate-400">${esc(x.body || "")} • <span class="font-semibold">${esc(x.level || "normal")}</span></div>
            </div>
            <div class="col-span-4 flex justify-end">
              <button class="nDel rounded-xl bg-rose-500 px-3 py-2 text-xs font-extrabold text-white hover:bg-rose-400"
                data-id="${esc(id)}">Delete</button>
            </div>
          </div>
        `;
        list.appendChild(row);
      });

      document.querySelectorAll(".nDel").forEach(b => b.addEventListener("click", async () => {
        if(!confirm("Hapus notifikasi ini?")) return;
        await deleteDoc(doc(db,"notifications",b.dataset.id));
        await log("notify.delete", { id: b.dataset.id });
        setStatus("Notifikasi dihapus ✅");
        await loadNotifications();
      }));
    }

    $("nCreateBtn").addEventListener("click", async () => {
      try{
        const title = $("nTitle").value.trim();
        const body = $("nBody").value.trim();
        const level = $("nLevel").value;

        if(!title) return setStatus("Judul wajib diisi.");

        setStatus("Mengirim notifikasi...");
        await addDoc(collection(db, "notifications"), {
          title, body, level,
          createdByUid: ME_UID,
          createdAt: serverTimestamp()
        });
        await log("notify.create", { title, level });

        $("nTitle").value = ""; $("nBody").value = ""; $("nLevel").value = "normal";
        setStatus("Notifikasi terkirim ✅");
        await loadNotifications();
      }catch(e){
        setStatus(e.message || "Gagal kirim notifikasi");
      }
    });

    // ========= ARCHIVES CRUD =========
    async function loadArchives() {
      const list = $("arList");
      list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;

      const q = query(collection(db, "archives"), orderBy("createdAt","desc"), limit(100));
      const snap = await getDocs(q);

      if (snap.empty) {
        list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada arsip.</div>`;
        return;
      }

      list.innerHTML = "";
      snap.forEach((d) => {
        const id = d.id;
        const x = d.data();
        const row = document.createElement("div");
        row.className = "px-4 py-3";
        row.innerHTML = `
          <div class="grid grid-cols-12 items-center gap-2">
            <div class="col-span-8">
              <div class="text-sm font-extrabold">${esc(x.title || "-")}</div>
              <div class="text-xs text-slate-400">
                ${x.file?.url ? `<a class="text-emerald-300 hover:underline" target="_blank" rel="noreferrer" href="${x.file.url}">lihat file</a>` : `-`}
              </div>
            </div>
            <div class="col-span-4 flex justify-end gap-2">
              <button class="arDel rounded-xl bg-rose-500 px-3 py-2 text-xs font-extrabold text-white hover:bg-rose-400"
                data-id="${esc(id)}">Delete</button>
            </div>
          </div>
        `;
        list.appendChild(row);
      });

      document.querySelectorAll(".arDel").forEach(b => b.addEventListener("click", async () => {
        if(!confirm("Hapus arsip ini?")) return;
        await deleteDoc(doc(db,"archives",b.dataset.id));
        await log("archive.delete", { id: b.dataset.id });
        setStatus("Arsip dihapus ✅");
        await loadArchives();
      }));
    }

    $("arUploadBtn").addEventListener("click", async () => {
      try{
        const title = $("arTitle").value.trim();
        const file = $("arFile").files?.[0];
        if(!title) return setStatus("Judul arsip wajib diisi.");
        if(!file) return setStatus("Pilih file dulu.");

        setStatus("Upload arsip...");
        // Menggunakan UPLOAD_PRESET_ARCHIVE
        const media = await uploadToCloudinary(file, UPLOAD_PRESET_ARCHIVE, "karteji/archives");
        await addDoc(collection(db, "archives"), {
          title,
          file: media,
          createdByUid: ME_UID,
          createdAt: serverTimestamp()
        });
        await log("archive.upload", { title, publicId: media.publicId });

        $("arTitle").value = ""; $("arFile").value = "";
        setStatus("Arsip terupload ✅");
        await loadArchives();
      }catch(e){
        setStatus(e.message || "Gagal upload arsip");
      }
    });

    // ========= LOGS (read) =========
    async function loadLogs() {
      const list = $("logList");
      list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;

      const q = query(collection(db, "logs"), orderBy("at","desc"), limit(50));
      const snap = await getDocs(q);

      if (snap.empty) {
        list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada log.</div>`;
        return;
      }

      list.innerHTML = "";
      snap.forEach((d) => {
        const x = d.data();
        const when = x.at?.toDate ? x.at.toDate().toLocaleString("id-ID") : "-";
        const row = document.createElement("div");
        row.className = "grid grid-cols-12 px-4 py-3";
        row.innerHTML = `
          <div class="col-span-8">
            <div class="text-sm font-extrabold">${esc(x.action || "-")}</div>
            <div class="text-xs text-slate-400">${esc(JSON.stringify(x.meta || {}))}</div>
          </div>
          <div class="col-span-4 text-xs text-slate-300">${esc(when)}</div>
        `;
        list.appendChild(row);
      });
    }

    // initial load functions are called after auth gate success
  </script>
</body>
</html>
