<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sekretaris | KARTEJI</title>

  <link rel="stylesheet" href="../../dist/assets/css/app.css">
  <link rel="icon" href="../assets/img/logo.png">
</head>

<body class="min-h-full bg-slate-950 text-slate-100">

<header class="sticky top-0 z-20 border-b border-white/10 bg-slate-950/70 backdrop-blur-xl">
  <div class="mx-auto max-w-6xl px-6 py-4 flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <img src="../assets/img/logo.png" class="h-10 w-10 rounded-2xl border border-white/10" alt="Logo">
      <div>
        <div class="text-sm font-extrabold">KARTEJI</div>
        <div class="text-xs text-slate-400">Dashboard Sekretaris</div>
      </div>
    </div>

    <button id="logoutBtn"
      class="rounded-2xl bg-rose-500 px-4 py-2 text-xs font-extrabold hover:bg-rose-400 active:scale-[.99]">
      Logout
    </button>
  </div>
</header>

<main class="mx-auto max-w-6xl px-6 py-6 space-y-6">

  <!-- Gate -->
  <section id="gate" class="hidden">
    <div class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl">
      <h1 class="text-xl font-extrabold">Akses ditolak</h1>
      <p class="mt-2 text-sm text-slate-300" id="gateMsg">Halaman ini khusus Sekretaris.</p>
      <div class="mt-5 flex gap-3">
        <a href="../login.html" class="rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300">
          Login
        </a>
        <a href="../index.html" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm font-semibold hover:bg-white/10">
          Kembali
        </a>
      </div>
    </div>
  </section>

  <!-- Content -->
  <section id="content" class="hidden space-y-6">

    <!-- Profile -->
    <section class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-lg font-extrabold">Profil Sekretaris</h2>
          <p class="text-sm text-slate-300">Ubah nama & foto profil.</p>
          <p class="mt-1 text-xs text-slate-400" id="statusMsg"></p>
        </div>

        <div class="flex items-center gap-3">
          <img id="mePhoto" class="h-14 w-14 rounded-2xl border border-white/10 object-cover" src="https://via.placeholder.com/120" alt="Foto">
          <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3">
            <div class="text-xs text-slate-400">Login sebagai</div>
            <div class="text-sm font-extrabold" id="meNameText">-</div>
            <div class="text-xs text-slate-400" id="meEmail">-</div>
          </div>
        </div>
      </div>

      <div class="mt-5 grid gap-3 sm:grid-cols-3">
        <div>
          <label class="block text-xs font-medium text-slate-400 mb-1">Nama</label>
          <input id="meName"
            class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
            placeholder="Nama"/>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-400 mb-1">Foto Profil (Cloudinary)</label>
          <input id="mePhotoInput" type="file" accept="image/*"
            class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none" />
        </div>

        <div class="flex items-end">
          <button id="saveProfileBtn"
            class="w-full rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300 active:scale-[.99]">
            Simpan Profil
          </button>
        </div>
      </div>
    </section>

    <!-- Tabs -->
    <section class="rounded-3xl border border-white/10 bg-white/5 p-4 shadow-2xl">
      <div class="flex flex-wrap gap-2">
        <button class="tabBtn rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-semibold hover:bg-white/10"
          data-tab="notulen">Notulen</button>

        <button class="tabBtn rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-semibold hover:bg-white/10"
          data-tab="surat">Surat</button>

        <button class="tabBtn rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-semibold hover:bg-white/10"
          data-tab="arsip">Arsip</button>

        <button id="refreshBtn"
          class="ml-auto rounded-2xl bg-white/10 px-4 py-2 text-xs font-extrabold hover:bg-white/15 active:scale-[.99]">
          Refresh
        </button>
      </div>
    </section>

    <!-- NOTULEN -->
    <section id="tab-notulen" class="tabPanel rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl space-y-4">
      <h3 class="text-lg font-extrabold">Notulen (CRUD)</h3>

      <div class="grid gap-3 sm:grid-cols-6">
        <input id="mTitle"
          class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          placeholder="Judul notulen" />
        <input id="mDate"
          class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          placeholder="Tanggal (YYYY-MM-DD)" />
        <input id="mLoc"
          class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          placeholder="Lokasi" />
        <textarea id="mBody"
          class="sm:col-span-6 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          rows="4"
          placeholder="Isi notulen (ringkas tapi jelas)"></textarea>
        <button id="mCreateBtn"
          class="sm:col-span-6 rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300">
          Simpan Notulen
        </button>
      </div>

      <div class="mt-2 overflow-hidden rounded-2xl border border-white/10">
        <div class="grid grid-cols-12 bg-white/5 px-4 py-3 text-xs font-semibold text-slate-200">
          <div class="col-span-9">Notulen</div>
          <div class="col-span-3 text-right">Aksi</div>
        </div>
        <div id="mList" class="divide-y divide-white/10"></div>
      </div>
    </section>

    <!-- SURAT -->
    <section id="tab-surat" class="tabPanel hidden rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl space-y-4">
      <h3 class="text-lg font-extrabold">Surat (CRUD)</h3>

      <div class="grid gap-3 sm:grid-cols-6">
        <input id="lType"
          class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          placeholder="Jenis surat (Undangan/Pengumuman/Dll)" />
        <input id="lNo"
          class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          placeholder="Nomor surat" />
        <input id="lDate"
          class="sm:col-span-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          placeholder="Tanggal (YYYY-MM-DD)" />
        <input id="lSubject"
          class="sm:col-span-6 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          placeholder="Perihal / Subjek" />
        <textarea id="lBody"
          class="sm:col-span-6 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          rows="4"
          placeholder="Isi surat"></textarea>
        <button id="lCreateBtn"
          class="sm:col-span-6 rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300">
          Simpan Surat
        </button>
      </div>

      <div class="mt-2 overflow-hidden rounded-2xl border border-white/10">
        <div class="grid grid-cols-12 bg-white/5 px-4 py-3 text-xs font-semibold text-slate-200">
          <div class="col-span-9">Surat</div>
          <div class="col-span-3 text-right">Aksi</div>
        </div>
        <div id="lList" class="divide-y divide-white/10"></div>
      </div>
    </section>

    <!-- ARSIP -->
    <section id="tab-arsip" class="tabPanel hidden rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl space-y-4">
      <h3 class="text-lg font-extrabold">Arsip (CRUD)</h3>
      <p class="text-sm text-slate-300">
        Upload file arsip ke Cloudinary. (Preset: <b>Karteji Galeri</b>)
      </p>

      <div class="grid gap-3 sm:grid-cols-6">
        <input id="aTitle"
          class="sm:col-span-3 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          placeholder="Judul arsip" />
        <input id="aTag"
          class="sm:col-span-3 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
          placeholder="Tag (opsional: surat/notulen/event/dll)" />
        <input id="aFile" type="file"
          class="sm:col-span-4 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none" />
        <button id="aUploadBtn"
          class="sm:col-span-2 rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300">
          Upload Arsip
        </button>
      </div>

      <div class="mt-2 overflow-hidden rounded-2xl border border-white/10">
        <div class="grid grid-cols-12 bg-white/5 px-4 py-3 text-xs font-semibold text-slate-200">
          <div class="col-span-9">File</div>
          <div class="col-span-3 text-right">Aksi</div>
        </div>
        <div id="aList" class="divide-y divide-white/10"></div>
      </div>
    </section>

  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    doc, getDoc, updateDoc, deleteDoc,
    collection, addDoc, getDocs,
    query, orderBy, limit,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // Firebase config (punyamu)
  const firebaseConfig = {
    apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
    authDomain: "katar-9cac3.firebaseapp.com",
    projectId: "katar-9cac3",
    storageBucket: "katar-9cac3.firebasestorage.app",
    messagingSenderId: "1017734829960",
    appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d",
    measurementId: "G-M4F9J10TTE"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Cloudinary (punyamu)
  const CLOUD_NAME = "dbxktcwug";
  const PRESET_PROFILE = "Karteji";
  const PRESET_ARCHIVE = "Karteji Galeri"; // pakai yang ada (bisa diganti jika mau preset khusus arsip)

  async function uploadToCloudinary(file, preset, folder="karteji") {
    const endpoint = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
    const form = new FormData();
    form.append("file", file);
    form.append("upload_preset", preset);
    form.append("folder", folder);

    const res = await fetch(endpoint, { method: "POST", body: form });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.error?.message || "Upload Cloudinary gagal");
    return { url: data.secure_url, publicId: data.public_id, bytes: data.bytes, format: data.format };
  }

  // UI helpers
  const $ = (id) => document.getElementById(id);
  const esc = (s) => String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
  const setStatus = (t) => $("statusMsg").textContent = t || "";

  // Tabs
  function openTab(name) {
    document.querySelectorAll(".tabPanel").forEach(p => p.classList.add("hidden"));
    document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("bg-emerald-400","text-slate-950","font-extrabold"));
    $(`tab-${name}`).classList.remove("hidden");
    document.querySelector(`.tabBtn[data-tab="${name}"]`).classList.add("bg-emerald-400","text-slate-950","font-extrabold");
  }
  document.querySelectorAll(".tabBtn").forEach(btn => btn.addEventListener("click", ()=>openTab(btn.dataset.tab)));

  $("refreshBtn").addEventListener("click", async ()=>{
    await Promise.allSettled([loadMinutes(), loadLetters(), loadArchives()]);
    setStatus("Refresh selesai ✅");
  });

  // Auth gate
  let ME_UID = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) return deny("Belum login.");

    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists()) return deny("Profil tidak ditemukan.");

    const me = snap.data();
    if (me?.role !== "sekretaris") return deny("Khusus Sekretaris.");

    ME_UID = user.uid;

    $("gate").classList.add("hidden");
    $("content").classList.remove("hidden");

    $("meNameText").textContent = me?.name || "Sekretaris";
    $("meEmail").textContent = me?.email || user.email || "-";
    $("meName").value = me?.name || "";
    $("mePhoto").src = me?.photo?.url || "https://via.placeholder.com/120";

    openTab("notulen");
    await Promise.allSettled([loadMinutes(), loadLetters(), loadArchives()]);
    setStatus("Siap ✅");
  });

  function deny(msg){
    $("content").classList.add("hidden");
    $("gate").classList.remove("hidden");
    $("gateMsg").textContent = msg || "Akses ditolak.";
  }

  // Logout
  $("logoutBtn").addEventListener("click", async ()=>{
    await signOut(auth);
    location.href = "../login.html";
  });

  // Profile save
  $("saveProfileBtn").addEventListener("click", async ()=>{
    try{
      setStatus("Menyimpan profil...");
      const newName = $("meName").value.trim();
      const file = $("mePhotoInput").files?.[0];

      const payload = {};
      if (newName) payload.name = newName;

      if (file) {
        const media = await uploadToCloudinary(file, PRESET_PROFILE, `karteji/users/${ME_UID}`);
        payload.photo = media;
        $("mePhoto").src = media.url;
      }

      if (!Object.keys(payload).length) return setStatus("Tidak ada perubahan.");
      await updateDoc(doc(db, "users", ME_UID), payload);

      $("meNameText").textContent = payload.name || $("meNameText").textContent;
      setStatus("Profil tersimpan ✅");
    } catch(e){
      setStatus(e.message || "Gagal simpan profil");
    }
  });

  // ===== NOTULEN CRUD (minutes) =====
  $("mCreateBtn").addEventListener("click", async ()=>{
    try{
      const title = $("mTitle").value.trim();
      const date = $("mDate").value.trim();
      const location = $("mLoc").value.trim();
      const body = $("mBody").value.trim();

      if(!title) return setStatus("Judul notulen wajib diisi.");

      setStatus("Menyimpan notulen...");
      await addDoc(collection(db, "minutes"), {
        title, date, location, body,
        createdByUid: ME_UID,
        createdAt: serverTimestamp()
      });

      $("mTitle").value=""; $("mDate").value=""; $("mLoc").value=""; $("mBody").value="";
      setStatus("Notulen tersimpan ✅");
      await loadMinutes();
    }catch(e){
      setStatus(e.message || "Gagal simpan notulen");
    }
  });

  async function loadMinutes(){
    const list = $("mList");
    list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;

    const q = query(collection(db, "minutes"), orderBy("createdAt","desc"), limit(50));
    const snap = await getDocs(q);

    if (snap.empty) {
      list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada notulen.</div>`;
      return;
    }

    list.innerHTML = "";
    snap.forEach((d)=>{
      const id = d.id;
      const x = d.data();
      const row = document.createElement("div");
      row.className = "px-4 py-3";
      row.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm font-extrabold">${esc(x.title || "-")}</div>
            <div class="text-xs text-slate-400">${esc(x.date || "")} • ${esc(x.location || "")}</div>
            <div class="text-xs text-slate-300 mt-1 whitespace-pre-line">${esc((x.body || "").slice(0, 180))}${(x.body||"").length>180?"…":""}</div>
          </div>
          <button class="mDel rounded-xl bg-rose-500 px-3 py-2 text-xs font-extrabold text-white hover:bg-rose-400"
            data-id="${esc(id)}">Delete</button>
        </div>
      `;
      list.appendChild(row);
    });

    document.querySelectorAll(".mDel").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if(!confirm("Hapus notulen ini?")) return;
        await deleteDoc(doc(db,"minutes",btn.dataset.id));
        setStatus("Notulen dihapus ✅");
        await loadMinutes();
      });
    });
  }

  // ===== SURAT CRUD (letters) =====
  $("lCreateBtn").addEventListener("click", async ()=>{
    try{
      const type = $("lType").value.trim();
      const number = $("lNo").value.trim();
      const date = $("lDate").value.trim();
      const subject = $("lSubject").value.trim();
      const body = $("lBody").value.trim();

      if(!subject) return setStatus("Subjek/perihal surat wajib diisi.");

      setStatus("Menyimpan surat...");
      await addDoc(collection(db, "letters"), {
        type, number, date, subject, body,
        createdByUid: ME_UID,
        createdAt: serverTimestamp()
      });

      $("lType").value=""; $("lNo").value=""; $("lDate").value=""; $("lSubject").value=""; $("lBody").value="";
      setStatus("Surat tersimpan ✅");
      await loadLetters();
    }catch(e){
      setStatus(e.message || "Gagal simpan surat");
    }
  });

  async function loadLetters(){
    const list = $("lList");
    list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;

    const q = query(collection(db, "letters"), orderBy("createdAt","desc"), limit(50));
    const snap = await getDocs(q);

    if (snap.empty) {
      list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada surat.</div>`;
      return;
    }

    list.innerHTML = "";
    snap.forEach((d)=>{
      const id = d.id;
      const x = d.data();
      const row = document.createElement("div");
      row.className = "px-4 py-3";
      row.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm font-extrabold">${esc(x.subject || "-")}</div>
            <div class="text-xs text-slate-400">
              ${esc(x.type || "-")} • ${esc(x.number || "-")} • ${esc(x.date || "")}
            </div>
            <div class="text-xs text-slate-300 mt-1 whitespace-pre-line">${esc((x.body || "").slice(0, 180))}${(x.body||"").length>180?"…":""}</div>
          </div>
          <button class="lDel rounded-xl bg-rose-500 px-3 py-2 text-xs font-extrabold text-white hover:bg-rose-400"
            data-id="${esc(id)}">Delete</button>
        </div>
      `;
      list.appendChild(row);
    });

    document.querySelectorAll(".lDel").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if(!confirm("Hapus surat ini?")) return;
        await deleteDoc(doc(db,"letters",btn.dataset.id));
        setStatus("Surat dihapus ✅");
        await loadLetters();
      });
    });
  }

  // ===== ARSIP CRUD (archives) =====
  $("aUploadBtn").addEventListener("click", async ()=>{
    try{
      const title = $("aTitle").value.trim();
      const tag = $("aTag").value.trim();
      const file = $("aFile").files?.[0];
      if(!title) return setStatus("Judul arsip wajib diisi.");
      if(!file) return setStatus("Pilih file dulu.");

      setStatus("Upload arsip...");
      const media = await uploadToCloudinary(file, PRESET_ARCHIVE, "karteji/archives");

      await addDoc(collection(db, "archives"), {
        title, tag,
        file: media,
        createdByUid: ME_UID,
        createdAt: serverTimestamp()
      });

      $("aTitle").value=""; $("aTag").value=""; $("aFile").value="";
      setStatus("Arsip terupload ✅");
      await loadArchives();
    }catch(e){
      setStatus(e.message || "Gagal upload arsip");
    }
  });

  async function loadArchives(){
    const list = $("aList");
    list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;

    const q = query(collection(db, "archives"), orderBy("createdAt","desc"), limit(100));
    const snap = await getDocs(q);

    if (snap.empty) {
      list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada arsip.</div>`;
      return;
    }

    list.innerHTML = "";
    snap.forEach((d)=>{
      const id = d.id;
      const x = d.data();
      const row = document.createElement("div");
      row.className = "px-4 py-3";
      row.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm font-extrabold">${esc(x.title || "-")}</div>
            <div class="text-xs text-slate-400">${esc(x.tag || "")}</div>
            <div class="text-xs text-slate-400 mt-1">
              ${x.file?.url ? `<a class="text-emerald-300 hover:underline" target="_blank" rel="noreferrer" href="${x.file.url}">lihat file</a>` : "-"}
            </div>
          </div>
          <button class="aDel rounded-xl bg-rose-500 px-3 py-2 text-xs font-extrabold text-white hover:bg-rose-400"
            data-id="${esc(id)}">Delete</button>
        </div>
      `;
      list.appendChild(row);
    });

    document.querySelectorAll(".aDel").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if(!confirm("Hapus arsip ini?")) return;
        await deleteDoc(doc(db,"archives",btn.dataset.id));
        setStatus("Arsip dihapus ✅");
        await loadArchives();
      });
    });
  }
</script>

</body>
</html>
