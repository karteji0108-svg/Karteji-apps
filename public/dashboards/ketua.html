<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#F8FAFC" />
  <title>Executive Dashboard | Ketua</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          colors: {
            brand: { primary: '#0F172A', light: '#334155' },
            gold: { DEFAULT: '#D97706', light: '#FEF3C7', dark: '#B45309' }
          },
          animation: {
            'blob': 'blob 10s infinite',
            'slide-in-top': 'slideInTop 0.5s cubic-bezier(0.250, 0.460, 0.450, 0.940) both',
          },
          keyframes: {
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
              '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            slideInTop: {
              '0%': { transform: 'translateY(-100px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #F8FAFC; color: #1E293B; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .glass-nav {
      background: rgba(255, 255, 255, 0.90);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-top: 1px solid rgba(15, 23, 42, 0.05);
      box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
    }
    .view-section { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
    .view-section.active { display: block; opacity: 1; transform: translateY(0); }
    .nav-btn.active span { font-variation-settings: 'FILL' 1; color: #D97706; }
    .nav-btn.active p { color: #0F172A; font-weight: 700; }

    /* Skeleton */
    .skeleton {
      background: linear-gradient(90deg, rgba(148,163,184,.12), rgba(148,163,184,.25), rgba(148,163,184,.12));
      background-size: 200% 100%;
      animation: sk 1.2s ease-in-out infinite;
      border-radius: 999px;
    }
    @keyframes sk { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    /* Dark mode */
    html.dark body { background-color: #0B1220; color: #E5E7EB; }
    html.dark .glass-nav { background: rgba(15, 23, 42, 0.82); border-top: 1px solid rgba(255,255,255,0.06); }
    html.dark .bg-white { background-color: rgba(15,23,42,0.9) !important; }
    html.dark .text-slate-400 { color: rgba(203,213,225,0.75) !important; }
    html.dark .text-slate-500 { color: rgba(203,213,225,0.85) !important; }
    html.dark .text-brand-primary { color: #E5E7EB !important; }
    html.dark .border-slate-100, html.dark .border-slate-200 { border-color: rgba(255,255,255,0.08) !important; }
    html.dark .bg-slate-50, html.dark .bg-slate-100 { background-color: rgba(255,255,255,0.06) !important; }
    html.dark .shadow-sm, html.dark .shadow-xl, html.dark .shadow-2xl { box-shadow: 0 10px 30px rgba(0,0,0,0.25) !important; }

    /* Theme color */
    html.dark meta[name="theme-color"] { content: #0B1220; }

    /* Print Styling */
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 20px; z-index: 9999; }
      .no-print { display: none !important; }
    }
  </style>
</head>

<body class="min-h-screen relative overflow-x-hidden pb-32 selection:bg-amber-200 selection:text-amber-900">

  <!-- Background blobs -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
    <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-amber-100 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob"></div>
    <div class="absolute top-[20%] right-[-10%] w-96 h-96 bg-blue-100 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-2000"></div>
  </div>

  <!-- Toast -->
  <div id="toastContainer" class="fixed top-4 left-0 right-0 z-[100] flex flex-col items-center gap-2 pointer-events-none px-4"></div>

  <!-- Loader -->
  <div id="globalLoader" class="fixed inset-0 bg-white/80 z-[9999] flex items-center justify-center flex-col gap-4 backdrop-blur-md hidden">
    <div class="w-12 h-12 border-4 border-slate-200 border-t-gold rounded-full animate-spin"></div>
    <p class="text-xs font-bold text-slate-400 animate-pulse">MEMUAT DATA...</p>
  </div>

  <!-- Gate -->
  <div id="gate" class="fixed inset-0 bg-slate-900 z-[9998] hidden items-center justify-center p-6 text-center backdrop-blur-sm">
    <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full animate-[slideInTop_0.5s]">
      <div class="bg-red-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
        <span class="material-symbols-rounded text-red-500 text-4xl">lock</span>
      </div>
      <h2 class="text-2xl font-extrabold text-brand-primary mb-2">Akses Terbatas</h2>
      <p class="text-slate-500 text-sm mb-6">Area ini khusus Ketua Umum.</p>
      <a href="../login.html" class="block w-full bg-brand-primary text-white py-3 rounded-xl font-bold hover:bg-slate-800 transition-colors">Kembali</a>
    </div>
  </div>

  <!-- Modal -->
  <div id="crudModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm transition-all">
    <div class="bg-white w-full max-w-md rounded-[2rem] p-6 relative shadow-2xl animate-[slideUp_0.3s_ease-out]">
      <div class="flex justify-between items-center mb-6">
        <h2 id="modalTitle" class="text-xl font-extrabold text-brand-primary uppercase tracking-tight">Judul</h2>
        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200 transition-colors text-slate-500">
          <span class="material-symbols-rounded text-xl">close</span>
        </button>
      </div>
      <div id="modalBody" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar"></div>
      <button id="modalSubmitBtn" class="mt-6 w-full rounded-xl bg-brand-primary text-white py-4 text-sm font-bold shadow-lg shadow-slate-300 hover:bg-slate-800 active:scale-95 transition-all">SIMPAN</button>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-30 px-6 pt-7 pb-4 bg-gradient-to-b from-[#F8FAFC] via-[#F8FAFC] to-transparent">
    <div class="flex justify-between items-center gap-3">
      <div class="flex items-center gap-3">
        <button onclick="switchView('profile')" class="relative group active:scale-95 transition-transform">
          <img id="headerPhoto" class="w-12 h-12 rounded-full border-2 border-white shadow-md object-cover" src="https://via.placeholder.com/100" alt="foto">
          <div class="absolute bottom-0 right-0 w-4 h-4 bg-gold border-2 border-white rounded-full flex items-center justify-center text-[8px] text-white font-bold">★</div>
        </button>
        <div>
          <p class="text-[10px] font-bold text-gold-dark uppercase tracking-widest bg-gold-light px-2 py-0.5 rounded-full w-fit mb-0.5">Ketua Umum</p>
          <h1 id="headerName" class="text-xl font-extrabold text-brand-primary leading-none">Memuat...</h1>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button onclick="toggleTheme()" class="w-10 h-10 rounded-full bg-white border border-slate-100 shadow-sm flex items-center justify-center active:scale-95 text-slate-500 no-print" title="Mode Gelap/Terang">
          <span id="themeIcon" class="material-symbols-rounded">dark_mode</span>
        </button>

        <button onclick="location.reload()" class="w-10 h-10 rounded-full bg-white border border-slate-100 shadow-sm flex items-center justify-center active:scale-95 text-slate-400">
          <span class="material-symbols-rounded">refresh</span>
        </button>
      </div>
    </div>
  </header>

  <main class="px-5 mt-2 relative z-10">

    <!-- HOME -->
    <section id="view-home" class="view-section active">

      <!-- ✅ WIDGET: CUACA + JADWAL SHOLAT/IMSAK -->
      <div class="grid grid-cols-1 gap-3 mb-4">
        <!-- Weather -->
        <div class="bg-white rounded-[1.5rem] p-5 shadow-sm border border-slate-100 relative overflow-hidden">
          <div class="absolute -right-10 -top-10 w-32 h-32 rounded-full blur-3xl opacity-25 bg-sky-400"></div>
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <p class="text-[10px] font-extrabold uppercase tracking-widest text-slate-500 flex items-center gap-1">
                <span class="material-symbols-rounded text-sm text-sky-500">cloud</span>
                Cuaca Sekarang
              </p>
              <h3 id="weatherPlace" class="text-sm font-extrabold text-brand-primary mt-1 truncate">Memuat lokasi...</h3>
            </div>
            <button onclick="loadWeather(true)" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center active:scale-95 no-print" title="Refresh Cuaca">
              <span class="material-symbols-rounded text-xl">refresh</span>
            </button>
          </div>

          <div class="mt-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-2xl bg-sky-50 text-sky-600 flex items-center justify-center">
                <span id="weatherIcon" class="material-symbols-rounded text-3xl">cloud</span>
              </div>
              <div>
                <div class="flex items-end gap-2">
                  <p id="weatherTemp" class="text-3xl font-black leading-none text-brand-primary">--°</p>
                  <p id="weatherCond" class="text-[11px] font-extrabold uppercase text-slate-500">...</p>
                </div>
                <p id="weatherMeta" class="text-[10px] font-semibold mt-1 text-slate-500">—</p>
              </div>
            </div>

            <div class="text-right">
              <p class="text-[9px] font-extrabold uppercase text-slate-500">Update</p>
              <p id="weatherUpdated" class="text-[10px] font-extrabold text-brand-primary">--:--</p>
            </div>
          </div>

          <div id="weatherHint" class="mt-4 text-[10px] font-semibold rounded-xl px-3 py-2 bg-slate-50 border border-slate-100 text-slate-500">
            Mengambil cuaca berdasarkan lokasi perangkat.
          </div>

          <div id="weatherSkeleton" class="mt-4 space-y-2">
            <div class="skeleton h-3 w-24"></div>
            <div class="skeleton h-3 w-44"></div>
          </div>
        </div>

        <!-- Prayer -->
        <div class="bg-white rounded-[1.5rem] p-5 shadow-sm border border-slate-100 relative overflow-hidden">
          <div class="absolute -left-10 -bottom-10 w-32 h-32 rounded-full blur-3xl opacity-25 bg-emerald-400"></div>
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <p class="text-[10px] font-extrabold uppercase tracking-widest text-slate-500 flex items-center gap-1">
                <span class="material-symbols-rounded text-sm text-emerald-600">mosque</span>
                Jadwal Sholat & Imsak
              </p>
              <h3 id="prayerPlace" class="text-sm font-extrabold text-brand-primary mt-1 truncate">Memuat lokasi...</h3>
            </div>
            <button onclick="loadPrayer(true)" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center active:scale-95 no-print" title="Refresh Jadwal">
              <span class="material-symbols-rounded text-xl">refresh</span>
            </button>
          </div>

          <div class="mt-4 flex items-center justify-between gap-3">
            <div class="min-w-0">
              <p class="text-[9px] font-extrabold uppercase text-slate-500">Berikutnya</p>
              <div class="flex items-end gap-2">
                <p id="nextPrayerName" class="text-xl font-black leading-none text-brand-primary truncate">—</p>
                <p id="nextPrayerTime" class="text-[12px] font-extrabold text-slate-500">--:--</p>
              </div>
              <p id="prayerDate" class="text-[10px] font-semibold mt-1 text-slate-500">—</p>
            </div>

            <div class="text-right">
              <p class="text-[9px] font-extrabold uppercase text-slate-500">Update</p>
              <p id="prayerUpdated" class="text-[10px] font-extrabold text-brand-primary">--:--</p>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-3 gap-2">
            <div class="rounded-2xl p-3 bg-slate-50 border border-slate-100">
              <p class="text-[9px] font-extrabold uppercase text-slate-500">Imsak</p>
              <p id="tImsak" class="text-sm font-black text-brand-primary">--:--</p>
            </div>
            <div class="rounded-2xl p-3 bg-slate-50 border border-slate-100">
              <p class="text-[9px] font-extrabold uppercase text-slate-500">Subuh</p>
              <p id="tFajr" class="text-sm font-black text-brand-primary">--:--</p>
            </div>
            <div class="rounded-2xl p-3 bg-slate-50 border border-slate-100">
              <p class="text-[9px] font-extrabold uppercase text-slate-500">Dzuhur</p>
              <p id="tDhuhr" class="text-sm font-black text-brand-primary">--:--</p>
            </div>
            <div class="rounded-2xl p-3 bg-slate-50 border border-slate-100">
              <p class="text-[9px] font-extrabold uppercase text-slate-500">Ashar</p>
              <p id="tAsr" class="text-sm font-black text-brand-primary">--:--</p>
            </div>
            <div class="rounded-2xl p-3 bg-slate-50 border border-slate-100">
              <p class="text-[9px] font-extrabold uppercase text-slate-500">Maghrib</p>
              <p id="tMaghrib" class="text-sm font-black text-brand-primary">--:--</p>
            </div>
            <div class="rounded-2xl p-3 bg-slate-50 border border-slate-100">
              <p class="text-[9px] font-extrabold uppercase text-slate-500">Isya</p>
              <p id="tIsha" class="text-sm font-black text-brand-primary">--:--</p>
            </div>
          </div>

          <div id="prayerHint" class="mt-4 text-[10px] font-semibold rounded-xl px-3 py-2 bg-slate-50 border border-slate-100 text-slate-500">
            Mengambil jadwal berdasarkan lokasi perangkat.
          </div>

          <div id="prayerSkeleton" class="mt-4 space-y-2">
            <div class="skeleton h-3 w-28"></div>
            <div class="skeleton h-3 w-48"></div>
          </div>
        </div>
      </div>

      <!-- CARD KAS -->
      <div class="w-full bg-brand-primary rounded-[2.5rem] p-7 text-white relative overflow-hidden shadow-xl shadow-slate-300 group transition-all">
        <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity duration-500 transform group-hover:scale-110">
          <span class="material-symbols-rounded text-9xl">shield</span>
        </div>
        <div class="relative z-10">
          <p class="text-[10px] font-bold uppercase tracking-widest text-slate-300 mb-1">Kas Organisasi</p>
          <h2 id="cardBalance" class="text-4xl font-black tracking-tight mb-6">Rp 0</h2>

          <div class="flex gap-2">
            <button onclick="switchView('finance')" class="flex-1 bg-white/10 backdrop-blur-md py-2.5 rounded-xl text-xs font-bold hover:bg-white/20 transition-colors flex items-center justify-center gap-1">
              <span class="material-symbols-rounded text-sm">visibility</span> Cek Detail
            </button>
            <button onclick="switchView('approvals')" class="flex-1 bg-gold text-white py-2.5 rounded-xl text-xs font-bold shadow-lg shadow-gold/20 hover:bg-gold-dark transition-colors flex items-center justify-center gap-1 active:scale-95 relative">
              <span class="material-symbols-rounded text-sm">fact_check</span> ACC Data
              <div id="homePendingBadge" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border border-white"></div>
            </button>
          </div>
        </div>
      </div>

      <!-- KPI Cards -->
      <div class="grid grid-cols-2 gap-3 mt-5">
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
          <div class="flex items-center gap-2 text-slate-500">
            <span class="material-symbols-rounded text-blue-500">group</span>
            <p class="text-[10px] font-extrabold uppercase">Total Anggota</p>
          </div>
          <p id="kpiUsers" class="text-2xl font-black text-brand-primary mt-2">0</p>
        </div>
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
          <div class="flex items-center gap-2 text-slate-500">
            <span class="material-symbols-rounded text-orange-500">pending_actions</span>
            <p class="text-[10px] font-extrabold uppercase">Pending ACC</p>
          </div>
          <p id="kpiPending" class="text-2xl font-black text-brand-primary mt-2">0</p>
        </div>
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
          <div class="flex items-center gap-2 text-slate-500">
            <span class="material-symbols-rounded text-emerald-500">event</span>
            <p class="text-[10px] font-extrabold uppercase">Agenda Terdekat</p>
          </div>
          <p id="kpiUpcoming" class="text-xs font-bold text-brand-primary mt-2 line-clamp-2">-</p>
        </div>
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
          <div class="flex items-center gap-2 text-slate-500">
            <span class="material-symbols-rounded text-fuchsia-500">campaign</span>
            <p class="text-[10px] font-extrabold uppercase">Broadcast</p>
          </div>
          <p id="kpiBroadcast" class="text-2xl font-black text-brand-primary mt-2">0</p>
        </div>
      </div>

      <div class="bg-white rounded-[1.5rem] p-5 shadow-sm border border-slate-100 mt-6">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <span class="material-symbols-rounded text-slate-400">monitoring</span>
            <span class="text-xs font-bold text-slate-500 uppercase">Analisis Arus Kas</span>
          </div>
          <button onclick="openBackupModal()" class="text-[10px] font-extrabold px-3 py-1.5 rounded-lg bg-slate-100 text-slate-600 active:scale-95 no-print flex items-center gap-1">
            <span class="material-symbols-rounded text-sm">cloud_download</span> Backup JSON
          </button>
        </div>
        <div class="h-52 relative w-full">
          <canvas id="financeChart"></canvas>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mt-6">
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition-transform" onclick="switchView('users')">
          <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mb-2">
            <span class="material-symbols-rounded">group_add</span>
          </div>
          <h3 class="text-xs font-bold text-brand-primary">Kelola Anggota</h3>
          <p class="text-[10px] text-slate-400">Atur jabatan tim</p>
        </div>
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition-transform" onclick="openBroadcastModal()">
          <div class="w-10 h-10 bg-orange-50 text-orange-600 rounded-full flex items-center justify-center mb-2">
            <span class="material-symbols-rounded">campaign</span>
          </div>
          <h3 class="text-xs font-bold text-brand-primary">Instruksi</h3>
          <p class="text-[10px] text-slate-400">Kirim broadcast</p>
        </div>
      </div>

      <!-- Quick Audit Preview -->
      <div class="bg-white rounded-[1.5rem] p-5 shadow-sm border border-slate-100 mt-6">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <span class="material-symbols-rounded text-slate-400">history</span>
            <span class="text-xs font-bold text-slate-500 uppercase">Audit Terakhir</span>
          </div>
          <button onclick="switchView('audit')" class="text-[10px] font-extrabold text-gold-dark bg-gold-light px-3 py-1.5 rounded-lg active:scale-95">
            Lihat Semua
          </button>
        </div>
        <div id="auditPreview" class="space-y-2">
          <p class="text-xs text-slate-400 italic">Memuat...</p>
        </div>
      </div>
    </section>

    <!-- USERS -->
    <section id="view-users" class="view-section">
      <div class="flex justify-between items-center mb-4 px-1 sticky top-0 bg-[#F8FAFC] py-2 z-10">
        <div>
          <h2 class="text-2xl font-bold text-brand-primary">Tim</h2>
          <p class="text-xs text-slate-400">Manajemen struktur</p>
        </div>
        <div class="flex gap-2">
          <button onclick="exportUsersCSV()" class="bg-green-100 text-green-700 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 active:scale-95 no-print">
            <span class="material-symbols-rounded text-sm">download</span> Data
          </button>
          <span id="userCountBadge" class="bg-brand-primary text-white text-xs px-3 py-1.5 rounded-lg font-bold flex items-center">0</span>
        </div>
      </div>

      <div class="mb-4 relative">
        <span class="material-symbols-rounded absolute left-3 top-2.5 text-slate-400 text-lg">search</span>
        <input type="text" id="searchUser" oninput="filterList('userList', this.value)" placeholder="Cari nama / email..." class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:border-gold shadow-sm">
      </div>

      <div id="userList" class="space-y-3 pb-20"></div>
    </section>

    <!-- PROFILE -->
    <section id="view-profile" class="view-section">
      <div class="flex flex-col items-center pt-4 pb-20">
        <div class="relative group cursor-pointer active:scale-95 transition-transform" onclick="$('profileUpload').click()">
          <img id="profileImage" src="https://via.placeholder.com/150" class="w-28 h-28 rounded-full object-cover border-4 border-white shadow-xl shadow-slate-200" alt="profil">
          <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
            <span class="material-symbols-rounded text-white">photo_camera</span>
          </div>
        </div>
        <input type="file" id="profileUpload" class="hidden" accept="image/*" onchange="previewProfileImage(this)">

        <h2 id="profileNameDisplay" class="text-xl font-bold text-brand-primary mt-4 mb-0.5">Nama Ketua</h2>
        <div id="profileRoleBadge" class="px-4 py-1 bg-gold text-white rounded-full text-[10px] font-extrabold uppercase tracking-wide mb-1 shadow-lg shadow-gold/30">KETUA UMUM</div>
        <p id="profileEmailDisplay" class="text-sm text-slate-400">email@user.com</p>

        <button onclick="showIdCard()" class="mt-4 w-full max-w-xs bg-slate-800 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform shadow-xl no-print">
          <span class="material-symbols-rounded">badge</span> Tampilkan ID Card Digital
        </button>

        <div class="w-full mt-6 space-y-4 px-1">
          <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm space-y-4">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Data Diri</h3>
            <div>
              <label class="text-[10px] font-bold text-slate-400 ml-1 uppercase">Nama Lengkap</label>
              <input id="editName" type="text" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-100 text-brand-primary text-sm font-bold mt-1 outline-none focus:border-gold">
            </div>
            <div>
              <label class="text-[10px] font-bold text-slate-400 ml-1 uppercase">WhatsApp</label>
              <input id="editPhone" type="tel" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-100 text-brand-primary text-sm font-bold mt-1 outline-none focus:border-gold">
            </div>
            <div>
              <label class="text-[10px] font-bold text-slate-400 ml-1 uppercase">Alamat</label>
              <textarea id="editAddress" rows="2" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-100 text-brand-primary text-sm font-medium mt-1 outline-none focus:border-gold resize-none"></textarea>
            </div>
          </div>

          <button onclick="saveProfile()" class="w-full bg-brand-primary text-white py-4 rounded-2xl font-bold shadow-lg shadow-slate-300 hover:bg-slate-800 transition-all active:scale-95">SIMPAN PERUBAHAN</button>
          <button id="logoutBtn" class="w-full bg-red-50 text-red-500 py-4 rounded-2xl font-bold hover:bg-red-100 transition-all active:scale-95 flex items-center justify-center gap-2">
            <span class="material-symbols-rounded">logout</span> LOGOUT
          </button>
        </div>
      </div>
    </section>

    <!-- APPROVALS -->
    <section id="view-approvals" class="view-section">
      <div class="flex justify-between items-center mb-4 px-1 sticky top-0 bg-[#F8FAFC] py-2 z-10">
        <div>
          <h2 class="text-2xl font-bold text-brand-primary">Pusat ACC</h2>
          <p class="text-xs text-slate-400">Verifikasi Data</p>
        </div>
        <button onclick="openAddActivityModal()" class="w-10 h-10 bg-brand-primary text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-transform no-print" title="Tambah Agenda">
          <span class="material-symbols-rounded">add</span>
        </button>
      </div>

      <div class="mb-4 grid grid-cols-2 gap-3">
        <button onclick="loadApprovals(true)" class="bg-gold text-white py-3 rounded-xl font-extrabold text-xs active:scale-95 no-print flex items-center justify-center gap-1">
          <span class="material-symbols-rounded text-sm">filter_alt</span> Pending Saja
        </button>
        <button onclick="loadApprovals(false)" class="bg-slate-100 text-slate-700 py-3 rounded-xl font-extrabold text-xs active:scale-95 no-print flex items-center justify-center gap-1">
          <span class="material-symbols-rounded text-sm">lists</span> Semua Data
        </button>
      </div>

      <div class="space-y-6 pb-20">
        <div>
          <h3 class="text-sm font-bold text-slate-500 mb-3 px-1 uppercase flex items-center gap-1">
            <span class="material-symbols-rounded text-sm">event</span> Kegiatan
          </h3>
          <div id="actList" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div>
          <h3 class="text-sm font-bold text-slate-500 mb-3 px-1 uppercase flex items-center gap-1">
            <span class="material-symbols-rounded text-sm">payments</span> Keuangan (Pending)
          </h3>
          <div id="finPendingList" class="space-y-3"></div>
        </div>
      </div>
    </section>

    <!-- FINANCE -->
    <section id="view-finance" class="view-section">
      <div class="flex justify-between items-center mb-4 px-1 sticky top-0 bg-[#F8FAFC] py-2 z-10">
        <div>
          <h2 class="text-2xl font-bold text-brand-primary">Laporan Kas</h2>
          <p class="text-xs text-slate-400">Monitoring, filter & cetak</p>
        </div>
        <div class="flex items-center gap-2 no-print">
          <button onclick="exportFinanceCSV()" class="w-10 h-10 bg-emerald-600 text-white rounded-full flex items-center justify-center active:scale-90 shadow-lg" title="Export CSV">
            <span class="material-symbols-rounded">download</span>
          </button>
          <button onclick="printFinance()" class="w-10 h-10 bg-slate-800 text-white rounded-full flex items-center justify-center active:scale-90 shadow-lg" title="Print">
            <span class="material-symbols-rounded">print</span>
          </button>
        </div>
      </div>

      <div class="mb-4 relative no-print">
        <span class="material-symbols-rounded absolute left-3 top-2.5 text-slate-400 text-lg">search</span>
        <input id="searchFin" oninput="filterList('finList', this.value)" placeholder="Cari transaksi (note)..." class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:border-gold shadow-sm">
      </div>

      <div id="printArea" class="bg-transparent">
        <div class="hidden mb-4 border-b-2 border-slate-800 pb-4">
          <h1 class="text-2xl font-bold uppercase text-slate-800">Laporan Keuangan</h1>
          <p class="text-sm text-slate-500">Dicetak oleh Ketua Umum pada: <span id="printDate"></span></p>
        </div>
        <div id="finList" class="space-y-3 pb-20"></div>
      </div>
    </section>

    <!-- AUDIT LOG -->
    <section id="view-audit" class="view-section">
      <div class="flex justify-between items-center mb-4 px-1 sticky top-0 bg-[#F8FAFC] py-2 z-10">
        <div>
          <h2 class="text-2xl font-bold text-brand-primary">Audit Log</h2>
          <p class="text-xs text-slate-400">Riwayat aksi Ketua</p>
        </div>
        <button onclick="loadAudit(true)" class="bg-slate-100 text-slate-700 px-3 py-2 rounded-xl font-extrabold text-xs active:scale-95 no-print flex items-center gap-1">
          <span class="material-symbols-rounded text-sm">refresh</span> Refresh
        </button>
      </div>

      <div class="mb-4 bg-white p-4 rounded-2xl border border-slate-100 shadow-sm no-print">
        <p class="text-xs font-bold text-slate-500 uppercase mb-2">Filter</p>
        <div class="grid grid-cols-2 gap-3">
          <input id="auditSearch" oninput="filterList('auditList', this.value)" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm" placeholder="Cari aksi/target...">
          <select id="auditLimit" onchange="loadAudit(true)" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm font-bold">
            <option value="30">Tampil 30</option>
            <option value="60">Tampil 60</option>
            <option value="120">Tampil 120</option>
          </select>
        </div>
      </div>

      <div id="auditList" class="space-y-3 pb-20"></div>
    </section>

  </main>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 w-full glass-nav pb-6 pt-2 px-4 z-50 rounded-t-[2rem] no-print">
    <div class="flex justify-between items-center max-w-sm mx-auto">
      <button onclick="switchView('home')" class="nav-btn active flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="home">
        <span class="material-symbols-rounded text-2xl text-slate-400 transition-colors">dashboard</span>
        <p class="text-[10px] font-medium text-slate-400 transition-colors">Home</p>
      </button>

      <button onclick="switchView('users')" class="nav-btn flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="users">
        <span class="material-symbols-rounded text-2xl text-slate-400 transition-colors">group_add</span>
        <p class="text-[10px] font-medium text-slate-400 transition-colors">Tim</p>
      </button>

      <div class="relative -top-6">
        <button onclick="switchView('profile')" class="nav-btn w-14 h-14 bg-brand-primary text-white rounded-full flex items-center justify-center shadow-xl shadow-slate-400 hover:scale-105 active:scale-95 transition-all ring-4 ring-white" data-target="profile">
          <span class="material-symbols-rounded text-3xl">shield_person</span>
        </button>
      </div>

      <button onclick="switchView('approvals')" class="nav-btn flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="approvals">
        <span class="material-symbols-rounded text-2xl text-slate-400 transition-colors">fact_check</span>
        <p class="text-[10px] font-medium text-slate-400 transition-colors">ACC</p>
      </button>

      <button onclick="switchView('finance')" class="nav-btn flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="finance">
        <span class="material-symbols-rounded text-2xl text-slate-400 transition-colors">account_balance</span>
        <p class="text-[10px] font-medium text-slate-400 transition-colors">Kas</p>
      </button>
    </div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, updateDoc, deleteDoc,
      collection, getDocs, addDoc, query, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
      authDomain: "katar-9cac3.firebaseapp.com",
      projectId: "katar-9cac3",
      storageBucket: "katar-9cac3.firebasestorage.app",
      messagingSenderId: "1017734829960",
      appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const CLOUD_NAME = "dbxktcwug";
    const UPLOAD_PRESET = "Karteji";

    window.$ = (id) => document.getElementById(id);
    let UID = null;
    let newProfileFile = null;
    let financeChart = null;

    // THEME
    function applyTheme() {
      const t = localStorage.getItem("karteji_theme") || "light";
      document.documentElement.classList.toggle("dark", t === "dark");
      const icon = $("themeIcon");
      if(icon) icon.textContent = (t === "dark") ? "light_mode" : "dark_mode";
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta) meta.setAttribute("content", t === "dark" ? "#0B1220" : "#F8FAFC");
    }
    window.toggleTheme = () => {
      const isDark = document.documentElement.classList.contains("dark");
      localStorage.setItem("karteji_theme", isDark ? "light" : "dark");
      applyTheme();
      showToast(isDark ? "Mode Terang aktif" : "Mode Gelap aktif");
    };
    applyTheme();

    // TOAST
    window.showToast = (msg, type = 'success') => {
      const container = $('toastContainer');
      const el = document.createElement('div');
      const color = type === 'error' ? 'bg-red-500' : 'bg-slate-800';
      el.className = `${color} text-white px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 animate-slide-in-top pointer-events-auto min-w-[220px] backdrop-blur-sm bg-opacity-90`;
      el.innerHTML = `<span class="material-symbols-rounded text-lg">${type==='error'?'error':'check_circle'}</span><span class="text-xs font-bold">${escapeHtml(msg)}</span>`;
      container.appendChild(el);
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(-20px)';
        el.style.transition = 'all 0.25s';
        setTimeout(() => el.remove(), 250);
      }, 3000);
    };

    // UTIL
    function animateValue(obj, start, end, duration) {
      if(!obj) return;
      let startTimestamp = null;
      const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.innerHTML = "Rp " + Math.floor(progress * (end - start) + start).toLocaleString('id-ID');
        if (progress < 1) window.requestAnimationFrame(step);
      };
      window.requestAnimationFrame(step);
    }

    window.toggleLoader = (show) => {
      const l = $("globalLoader");
      if(show) { l.classList.remove('hidden'); l.classList.add('flex'); }
      else { l.classList.add('hidden'); l.classList.remove('flex'); }
    };

    window.closeModal = () => $("crudModal").classList.add('hidden');
    window.showModal = (title, bodyHtml, onSave) => {
      $("modalTitle").textContent = title;
      $("modalBody").innerHTML = bodyHtml;
      $("crudModal").classList.remove('hidden');
      $("crudModal").classList.add('flex');
      const btn = $("modalSubmitBtn");
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      newBtn.onclick = onSave;
      newBtn.style.display = onSave ? 'block' : 'none';
    };

    window.printFinance = () => { $("printDate").innerText = new Date().toLocaleString('id-ID'); window.print(); };

    window.switchView = (viewId) => {
      document.querySelectorAll('.view-section').forEach(el => {
        el.classList.remove('active');
        setTimeout(() => { if(!el.classList.contains('active')) el.style.display = 'none'; }, 200);
      });

      const target = $(`view-${viewId}`);
      if(!target) return;
      target.style.display = 'block';
      setTimeout(() => target.classList.add('active'), 10);

      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      const activeBtn = document.querySelector(`.nav-btn[data-target="${viewId}"]`);
      if(activeBtn) activeBtn.classList.add('active');

      if(viewId === 'home') loadHomeData();
      if(viewId === 'users') loadUsers();
      if(viewId === 'profile') loadProfileData();
      if(viewId === 'approvals') loadApprovals(true);
      if(viewId === 'finance') loadFinance();
      if(viewId === 'audit') loadAudit(true);
    };

    window.filterList = (listId, q) => {
      const list = $(listId);
      if(!list) return;
      const term = (q || "").toLowerCase();
      for(const item of list.children){
        const text = (item.innerText || "").toLowerCase();
        item.style.display = text.includes(term) ? "" : "none";
      }
    };

    // CLOUDINARY UPLOAD
    async function upload(file) {
      if(!file) return null;
      if(!file.type.startsWith("image/")) { showToast("File harus gambar", "error"); return null; }
      const fd = new FormData();
      fd.append("file", file);
      fd.append("upload_preset", UPLOAD_PRESET);
      const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{ method:"POST", body:fd });
      const d = await res.json();
      if(d?.error) throw new Error(d.error.message);
      return { url: d.secure_url };
    }

    // ✅ GEO + REVERSE
    async function getCoords(){
      return new Promise((resolve, reject)=>{
        if(!navigator.geolocation) return reject(new Error("Geolocation tidak didukung."));
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
          err => reject(err),
          { enableHighAccuracy: false, timeout: 8000, maximumAge: 600000 }
        );
      });
    }
    async function reverseGeocode(lat, lon){
      try{
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
        const res = await fetch(url, { headers: { "Accept":"application/json" } });
        const j = await res.json();
        const a = j.address || {};
        return (a.city || a.town || a.village || a.suburb || a.county || "Lokasi Anda") + (a.state ? `, ${a.state}` : "");
      }catch(_){ return "Lokasi Anda"; }
    }

    // ✅ WEATHER (Open-Meteo, tanpa API key)
    const WEATHER_CACHE_KEY = "kte_exec_weather_cache_v1";
    const WEATHER_TTL = 10 * 60 * 1000;

    function setWeatherLoading(on){
      const sk = $("weatherSkeleton");
      if(sk) sk.style.display = on ? "block" : "none";
    }
    function weatherIcon(code, isDay=true){
      const m = {
        clear: isDay ? "sunny" : "nights_stay",
        cloudy: "cloud",
        fog: "foggy",
        drizzle: "grain",
        rain: "rainy",
        snow: "ac_unit",
        storm: "thunderstorm"
      };
      if (code === 0) return { icon: m.clear, label: "Cerah" };
      if ([1,2].includes(code)) return { icon: m.cloudy, label: code===1 ? "Cerah Berawan" : "Berawan" };
      if (code === 3) return { icon: m.cloudy, label: "Mendung" };
      if ([45,48].includes(code)) return { icon: m.fog, label: "Berkabut" };
      if ([51,53,55,56,57].includes(code)) return { icon: m.drizzle, label: "Gerimis" };
      if ([61,63,65,66,67,80,81,82].includes(code)) return { icon: m.rain, label: "Hujan" };
      if ([71,73,75,77,85,86].includes(code)) return { icon: m.snow, label: "Salju" };
      if ([95,96,99].includes(code)) return { icon: m.storm, label: "Badai Petir" };
      return { icon: m.cloudy, label: "Cuaca" };
    }

    async function fetchWeather(lat, lon){
      const tz = "Asia/Jakarta";
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=${encodeURIComponent(tz)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error("Weather API error");
      return await res.json();
    }

    window.loadWeather = async (force=false) => {
      try{
        setWeatherLoading(true);

        const cached = localStorage.getItem(WEATHER_CACHE_KEY);
        if(!force && cached){
          const c = JSON.parse(cached);
          if(c?.ts && (Date.now()-c.ts) < WEATHER_TTL && c?.payload){
            applyWeatherUI(c.payload);
            setWeatherLoading(false);
            return;
          }
        }

        const { lat, lon } = await getCoords();
        const [place, data] = await Promise.all([ reverseGeocode(lat, lon), fetchWeather(lat, lon) ]);
        const payload = { place, data };

        localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify({ ts: Date.now(), payload }));
        applyWeatherUI(payload);
      }catch(e){
        $("weatherPlace").textContent = "Cuaca";
        $("weatherTemp").textContent = "--°";
        $("weatherCond").textContent = "—";
        $("weatherMeta").textContent = "—";
        $("weatherUpdated").textContent = "--:--";
        $("weatherIcon").textContent = "cloud_off";
        $("weatherHint").textContent = (e && e.code === 1)
          ? "Izin lokasi ditolak. Aktifkan Location untuk menampilkan cuaca."
          : "Cuaca tidak bisa dimuat. Coba refresh.";
      }finally{
        setWeatherLoading(false);
      }
    };

    function applyWeatherUI(payload){
      const place = payload.place || "Lokasi Anda";
      const cw = payload.data?.current_weather;
      if(!cw) throw new Error("Empty weather");
      const temp = Math.round(cw.temperature);
      const wind = Math.round(cw.windspeed);
      const code = cw.weathercode;
      const isDay = !!cw.is_day;
      const w = weatherIcon(code, isDay);

      $("weatherPlace").textContent = place;
      $("weatherTemp").textContent = `${temp}°`;
      $("weatherCond").textContent = w.label.toUpperCase();
      $("weatherMeta").textContent = `Angin ${wind} km/jam • ${isDay ? "Siang" : "Malam"}`;
      $("weatherIcon").textContent = w.icon;

      const now = new Date();
      $("weatherUpdated").textContent = now.toLocaleTimeString("id-ID", { hour:"2-digit", minute:"2-digit" });
      $("weatherHint").textContent = "Data dari Open-Meteo (tanpa API key).";
    }

    // ✅ PRAYER (Aladhan, tanpa API key) + Imsak
    const PRAYER_CACHE_KEY = "kte_exec_prayer_cache_v1";

    function setPrayerLoading(on){
      const sk = $("prayerSkeleton");
      if(sk) sk.style.display = on ? "block" : "none";
    }
    function onlyHHMM(t){
      if(!t) return "--:--";
      return String(t).replace(/\s*\(.*\)\s*/g,"").trim().slice(0,5);
    }
    function dateKeyJakarta(d=new Date()){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function parseTimeToday(hhmm){
      const [h,m] = (hhmm||"00:00").split(":").map(x=>parseInt(x,10));
      const d = new Date();
      d.setHours(h||0, m||0, 0, 0);
      return d.getTime();
    }
    function computeNextPrayer(timings){
      const now = Date.now();
      const order = [
        { key: "Imsak", label: "Imsak" },
        { key: "Fajr", label: "Subuh" },
        { key: "Dhuhr", label: "Dzuhur" },
        { key: "Asr", label: "Ashar" },
        { key: "Maghrib", label: "Maghrib" },
        { key: "Isha", label: "Isya" },
      ];
      for(const it of order){
        const hhmm = onlyHHMM(timings[it.key]);
        const ts = parseTimeToday(hhmm);
        if(ts > now) return { name: it.label, time: hhmm };
      }
      return { name: "Imsak (Besok)", time: onlyHHMM(timings["Imsak"] || timings["Fajr"]) };
    }

    async function fetchPrayer(lat, lon){
      const tz = "Asia/Jakarta";
      // method bisa kamu ganti jika mau (mis: 20 / 2 / 11). Default: 20.
      const method = 20;
      const url = `https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=${method}&timezonestring=${encodeURIComponent(tz)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error("Prayer API error");
      return await res.json();
    }

    window.loadPrayer = async (force=false) => {
      try{
        setPrayerLoading(true);
        const todayKey = dateKeyJakarta();

        const cached = localStorage.getItem(PRAYER_CACHE_KEY);
        if(!force && cached){
          const c = JSON.parse(cached);
          if(c?.key === todayKey && c?.payload){
            applyPrayerUI(c.payload);
            setPrayerLoading(false);
            return;
          }
        }

        const { lat, lon } = await getCoords();
        const [place, raw] = await Promise.all([ reverseGeocode(lat, lon), fetchPrayer(lat, lon) ]);
        const payload = { place, raw };

        localStorage.setItem(PRAYER_CACHE_KEY, JSON.stringify({ key: todayKey, ts: Date.now(), payload }));
        applyPrayerUI(payload);
      }catch(e){
        $("prayerPlace").textContent = "Jadwal Sholat";
        $("nextPrayerName").textContent = "—";
        $("nextPrayerTime").textContent = "--:--";
        $("prayerDate").textContent = "—";
        $("prayerUpdated").textContent = "--:--";
        ["tImsak","tFajr","tDhuhr","tAsr","tMaghrib","tIsha"].forEach(id => { const el=$(id); if(el) el.textContent="--:--"; });
        $("prayerHint").textContent = (e && e.code === 1)
          ? "Izin lokasi ditolak. Aktifkan Location untuk menampilkan jadwal sholat."
          : "Jadwal sholat tidak bisa dimuat. Coba refresh.";
      }finally{
        setPrayerLoading(false);
      }
    };

    function applyPrayerUI(payload){
      const place = payload.place || "Lokasi Anda";
      const raw = payload.raw;
      const timings = raw?.data?.timings;
      const readable = raw?.data?.date?.readable || "-";
      if(!timings) throw new Error("Empty prayer timings");

      $("prayerPlace").textContent = place;
      $("prayerDate").textContent = `Tanggal: ${readable}`;
      $("tImsak").textContent = onlyHHMM(timings.Imsak || timings.Fajr);
      $("tFajr").textContent = onlyHHMM(timings.Fajr);
      $("tDhuhr").textContent = onlyHHMM(timings.Dhuhr);
      $("tAsr").textContent = onlyHHMM(timings.Asr);
      $("tMaghrib").textContent = onlyHHMM(timings.Maghrib);
      $("tIsha").textContent = onlyHHMM(timings.Isha);

      const next = computeNextPrayer(timings);
      $("nextPrayerName").textContent = next.name;
      $("nextPrayerTime").textContent = next.time;

      const now = new Date();
      $("prayerUpdated").textContent = now.toLocaleTimeString("id-ID", { hour:"2-digit", minute:"2-digit" });
      $("prayerHint").textContent = "Data jadwal dari Aladhan (tanpa API key).";
    }

    // AUDIT LOG
    async function writeAudit(action, targetType = "-", targetId = "-", meta = {}) {
      try {
        await addDoc(collection(db, "audit_logs"), {
          actorUid: UID,
          actorRole: "ketua",
          action,
          targetType,
          targetId,
          meta,
          createdAt: serverTimestamp()
        });
      } catch(e) {
        console.warn("Audit log gagal:", e?.message);
      }
    }

    // AUTH
    onAuthStateChanged(auth, async user => {
      if(!user) return location.href = "login.html";
      toggleLoader(true);
      try {
        const snap = await getDoc(doc(db,"users",user.uid));
        if(!snap.exists() || (snap.data().role !== "ketua" && snap.data().role !== "super_admin")){
          toggleLoader(false);
          $("gate").classList.remove("hidden"); $("gate").classList.add("flex");
          return;
        }
        UID = user.uid;

        // ✅ load widget cepat (pakai cache)
        loadWeather(false);
        loadPrayer(false);

        await Promise.all([
          loadHomeData(),
          loadProfileData(),
          loadAuditPreview()
        ]);
      } catch(e) {
        console.error(e);
        showToast("Gagal memuat (cek koneksi/rules)", "error");
      }
      toggleLoader(false);
    });

    // HOME DATA + KPI
    async function loadHomeData() {
      try {
        const finSnap = await getDocs(query(collection(db, "financial_records"), orderBy("createdAt", "desc")));
        const actsSnap = await getDocs(query(collection(db, "activities"), orderBy("date", "asc")));
        const usersSnap = await getDocs(collection(db, "users"));
        const notifSnap = await getDocs(query(collection(db, "notifications"), orderBy("createdAt", "desc"), limit(50)));

        let bal = 0, inc = 0, exp = 0, pendingCount = 0;
        let upcomingText = "-";
        let broadcastCount = notifSnap.size || 0;

        finSnap.forEach(d => {
          const f = d.data();
          if(f.status === 'approved') {
            const a = Number(f.amount)||0;
            if(f.type === 'income') { bal+=a; inc+=a; } else { bal-=a; exp+=a; }
          } else if (f.status === 'pending') pendingCount++;
        });

        let firstUpcoming = null;
        actsSnap.forEach(d => {
          const a = d.data();
          if(a.status === 'pending') pendingCount++;
          if(!firstUpcoming && a?.date) firstUpcoming = a;
        });

        if(firstUpcoming) upcomingText = `${firstUpcoming.title || 'Kegiatan'} • ${firstUpcoming.date}`;

        animateValue($("cardBalance"), 0, bal, 1200);
        renderChart(inc, exp);

        const badge = $("homePendingBadge");
        if(pendingCount > 0) badge.classList.remove('hidden');
        else badge.classList.add('hidden');

        $("kpiUsers").textContent = usersSnap.size || 0;
        $("kpiPending").textContent = pendingCount;
        $("kpiUpcoming").textContent = upcomingText;
        $("kpiBroadcast").textContent = broadcastCount;

      } catch(e) {
        console.error(e);
        showToast("Gagal load dashboard", "error");
      }
    }

    function renderChart(income, expense) {
      const ctx = $("financeChart")?.getContext('2d');
      if(!ctx) return;
      if(financeChart) financeChart.destroy();
      financeChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Pemasukan', 'Pengeluaran'],
          datasets: [{
            label: 'Arus Kas (Rp)',
            data: [income, expense],
            backgroundColor: ['#10B981', '#EF4444'],
            borderRadius: 10,
            barThickness: 44
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { display: false }, ticks: { callback: (v)=>'Rp '+Number(v).toLocaleString('id-ID') } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    // BROADCAST
    window.openBroadcastModal = () => {
      const html = `
        <input id="bcTitle" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 font-bold mb-3 outline-none" placeholder="Judul Instruksi">
        <textarea id="bcBody" rows="4" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 outline-none resize-none" placeholder="Isi pesan kepada anggota..."></textarea>
        <div class="mt-2 bg-orange-50 p-2 rounded text-xs text-orange-600 font-bold flex gap-2">
          <span class="material-symbols-rounded text-sm">info</span> Pesan akan muncul di dashboard semua anggota.
        </div>
      `;
      showModal("BROADCAST KETUA", html, async () => {
        const t = $("bcTitle").value.trim();
        const b = $("bcBody").value.trim();
        if(!t || !b) return showToast("Isi semua data", "error");
        toggleLoader(true);
        try {
          await addDoc(collection(db,"notifications"), {
            title: t,
            body: b,
            level: "important",
            createdBy: "Ketua",
            createdByUid: UID,
            createdAt: serverTimestamp()
          });
          await writeAudit("broadcast_send", "notifications", "-", { title: t });
          closeModal();
          showToast("Instruksi Terkirim!");
          loadHomeData();
        } catch(e) {
          console.error(e);
          showToast("Gagal kirim broadcast", "error");
        } finally {
          toggleLoader(false);
        }
      });
    };

    // PROFILE
    async function loadProfileData() {
      const snap = await getDoc(doc(db, "users", UID));
      if(snap.exists()){
        const d = snap.data();
        $("headerName").textContent = d.name || "Ketua";
        $("headerPhoto").src = d.photo?.url || "https://via.placeholder.com/150";
        $("profileImage").src = d.photo?.url || "https://via.placeholder.com/150";
        $("profileNameDisplay").textContent = d.name || "-";
        $("profileEmailDisplay").textContent = d.email || "-";
        $("editName").value = d.name||"";
        $("editPhone").value = d.phone||"";
        $("editAddress").value = d.address||"";
      }
    }

    window.previewProfileImage = (input) => {
      if (input.files?.[0]) {
        newProfileFile = input.files[0];
        $("profileImage").src = URL.createObjectURL(newProfileFile);
      }
    };

    window.saveProfile = async () => {
      toggleLoader(true);
      try {
        let data = {
          name: $("editName").value.trim(),
          phone: $("editPhone").value.trim(),
          address: $("editAddress").value.trim()
        };
        if(newProfileFile) data.photo = await upload(newProfileFile);
        await updateDoc(doc(db, "users", UID), data);
        await writeAudit("profile_update", "users", UID, { fields: Object.keys(data) });
        showToast("Profil Disimpan");
        newProfileFile = null;
        await loadProfileData();
      } catch(e) {
        console.error(e);
        showToast("Gagal update profil", "error");
      } finally {
        toggleLoader(false);
      }
    };

    window.showIdCard = async () => {
      const snap = await getDoc(doc(db, "users", UID));
      const u = snap.data() || {};
      const html = `
        <div class="bg-gradient-to-br from-[#0F172A] to-[#1E293B] text-white p-5 rounded-2xl relative overflow-hidden shadow-2xl border-t border-slate-600">
          <div class="absolute -right-10 -top-10 w-40 h-40 bg-gold/20 rounded-full blur-3xl"></div>
          <div class="flex justify-between items-center mb-6 relative z-10">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 bg-white/10 rounded flex items-center justify-center">
                <span class="material-symbols-rounded text-gold">verified</span>
              </div>
              <span class="font-bold tracking-widest text-xs">KARTEJI EXECUTIVE</span>
            </div>
            <div class="text-[10px] font-black bg-white/10 px-2 py-1 rounded">KETUA</div>
          </div>
          <div class="flex gap-4 items-center">
            <img src="${u.photo?.url||'https://via.placeholder.com/100'}" class="w-20 h-20 rounded-xl object-cover border-2 border-gold shadow-lg bg-slate-800">
            <div>
              <h2 class="text-xl font-bold leading-none mb-1 text-gold">${escapeHtml(u.name || 'Ketua Umum')}</h2>
              <p class="text-[10px] uppercase tracking-wider text-slate-400 font-bold">KETUA UMUM</p>
              <p class="text-[9px] mt-2 text-slate-500">ID: ${UID.substring(0,8).toUpperCase()}</p>
            </div>
          </div>
        </div>
      `;
      showModal("KARTU IDENTITAS DIGITAL", html, null);
    };

    // USERS & ROLES
    async function loadUsers(){
      const list = $("userList"); if(!list) return;
      list.innerHTML = "";
      const snap = await getDocs(query(collection(db,"users"), orderBy("name")));
      $("userCountBadge").textContent = snap.size;

      const roles = ["anggota", "koordinator", "sekretaris", "bendahara", "wakil_ketua", "ketua"];

      snap.forEach(d => {
        const u = d.data();
        if(d.id === UID) return;
        if(u.role === 'super_admin') return;

        let roleSel = `<select onchange="changeRole('${d.id}',this.value,'${(u.role||"").toString()}')" class="text-xs bg-slate-100 font-bold rounded p-2 outline-none uppercase border border-slate-200">`;
        roles.forEach(r => roleSel += `<option value="${r}" ${u.role===r?'selected':''}>${r.replace('_',' ')}</option>`);
        roleSel += `</select>`;

        list.innerHTML += `
          <div class="bg-white p-4 rounded-2xl flex items-center gap-3 border border-slate-100 shadow-sm">
            <img src="${u.photo?.url||'https://via.placeholder.com/40'}" class="w-12 h-12 rounded-full object-cover bg-slate-200" alt="user">
            <div class="flex-1 min-w-0">
              <p class="text-sm font-bold text-brand-primary truncate">${escapeHtml(u.name || 'User')}</p>
              <p class="text-[10px] text-slate-400 truncate">${escapeHtml(u.email || '-')}</p>
              <div class="mt-2 flex items-center gap-2">
                <span class="material-symbols-rounded text-xs text-gold">badge</span>
                ${roleSel}
              </div>
            </div>
            <button onclick="kickUser('${d.id}','${escapeHtml(u.name||'User')}')" class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all active:scale-95 no-print" title="Hapus akun user">
              <span class="material-symbols-rounded">delete</span>
            </button>
          </div>
        `;
      });
    }

    window.changeRole = async (uid, val, oldVal) => {
      if(!confirm("Ubah jabatan anggota ini?")) return loadUsers();
      toggleLoader(true);
      try {
        await updateDoc(doc(db,"users",uid), { role: val });
        await writeAudit("role_change", "users", uid, { from: oldVal, to: val });
        showToast("Jabatan Diubah");
        loadHomeData();
      } catch(e){
        console.error(e);
        showToast("Gagal ubah jabatan", "error");
      } finally {
        toggleLoader(false);
      }
    };

    window.kickUser = async (uid, name) => {
      if(!confirm(`Hapus data user "${name}"? (permanen)`)) return;
      toggleLoader(true);
      try {
        await deleteDoc(doc(db,"users",uid));
        await writeAudit("user_delete", "users", uid, { name });
        showToast("User dihapus");
        await loadUsers();
        loadHomeData();
      } catch(e){
        console.error(e);
        showToast("Gagal hapus user (cek rules)", "error");
      } finally {
        toggleLoader(false);
      }
    };

    window.exportUsersCSV = async () => {
      const snap = await getDocs(query(collection(db,"users"), orderBy("name")));
      let csv = "Nama,Email,Jabatan,No HP\n";
      snap.forEach(d => {
        const u = d.data();
        csv += `"${(u.name||'').replaceAll('"','""')}","${u.email||''}","${u.role||''}","${u.phone||''}"\n`;
      });
      downloadText(csv, `Data_Anggota_${new Date().toISOString().slice(0,10)}.csv`, "text/csv;charset=utf-8");
      await writeAudit("export_users_csv", "users", "-", { total: snap.size });
      showToast("CSV Anggota diunduh");
    };

    // APPROVALS
    async function loadApprovals(pendingOnly = true){
      const aList = $("actList"); if(aList) aList.innerHTML = "";
      const fList = $("finPendingList"); if(fList) fList.innerHTML = "";

      const acts = await getDocs(query(collection(db,"activities"), orderBy("date","asc")));
      const fin = await getDocs(query(collection(db,"financial_records"), orderBy("createdAt","desc")));

      let shownAct = 0;
      acts.forEach(d => {
        const x = d.data();
        const isPending = x.status === 'pending';
        if(pendingOnly && !isPending) return;
        shownAct++;

        const dateObj = x.date ? new Date(x.date) : null;
        const month = dateObj ? dateObj.toLocaleString('id-ID', { month:'short' }) : "—";
        const day = dateObj ? dateObj.getDate() : "—";

        aList.innerHTML += `
          <div class="bg-white p-3 rounded-xl border ${isPending?'border-orange-300 bg-orange-50':'border-slate-100'} shadow-sm flex items-center gap-3">
            <div class="bg-blue-50 w-14 h-14 rounded-lg flex flex-col items-center justify-center text-blue-600 shrink-0">
              <span class="text-[10px] font-bold uppercase">${month}</span>
              <span class="text-xl font-bold">${day}</span>
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="text-sm font-bold text-brand-primary line-clamp-1">${escapeHtml(x.title || 'Kegiatan')}</h4>
              <p class="text-[10px] text-slate-400 flex items-center gap-1 line-clamp-1">
                <span class="material-symbols-rounded text-[12px]">location_on</span> ${escapeHtml(x.location || '-')}
              </p>
              <p class="text-[10px] text-slate-400 mt-0.5">${isPending ? '<span class="bg-orange-100 text-orange-600 px-2 py-0.5 rounded font-extrabold">PENDING</span>' : '<span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded font-extrabold">APPROVED</span>'}</p>
            </div>

            <div class="flex items-center gap-2 no-print">
              ${isPending ? `
                <button onclick="approveDoc('activities','${d.id}')" class="bg-gold text-white p-2 rounded-full shadow-lg hover:scale-110 transition-transform" title="ACC">
                  <span class="material-symbols-rounded text-sm">check</span>
                </button>
              ` : `<span class="text-emerald-600 material-symbols-rounded">verified</span>`}
              <button onclick="deleteDocData('activities','${d.id}')" class="text-slate-300 hover:text-red-500" title="Hapus">
                <span class="material-symbols-rounded">delete</span>
              </button>
            </div>
          </div>
        `;
      });

      if(shownAct === 0) aList.innerHTML = `<p class="text-xs text-slate-400 italic text-center py-6">Tidak ada kegiatan ${pendingOnly ? 'pending' : ''}.</p>`;

      let hasPendingFin = false;
      fin.forEach(d => {
        const f = d.data();
        if(f.status !== 'pending') return;
        hasPendingFin = true;
        const isInc = f.type === 'income';
        const date = f.createdAt?.seconds ? new Date(f.createdAt.seconds*1000).toLocaleDateString('id-ID') : "-";
        fList.innerHTML += `
          <div class="bg-white p-3 rounded-xl border border-orange-300 bg-orange-50 shadow-sm flex items-center justify-between">
            <div class="min-w-0">
              <h4 class="text-sm font-bold text-brand-primary line-clamp-1">${escapeHtml(f.note || '-')}</h4>
              <p class="text-[10px] text-slate-400">${date}</p>
            </div>
            <div class="flex items-center gap-3 no-print">
              <span class="text-xs font-extrabold ${isInc?'text-green-600':'text-red-500'} whitespace-nowrap">${isInc?'+':'-'} ${Number(f.amount||0).toLocaleString('id-ID')}</span>
              <button onclick="approveDoc('financial_records','${d.id}')" class="bg-gold text-white p-2 rounded-full shadow-lg hover:scale-110 transition-transform" title="ACC">
                <span class="material-symbols-rounded text-sm">check</span>
              </button>
              <button onclick="deleteDocData('financial_records','${d.id}')" class="text-slate-300 hover:text-red-500" title="Hapus">
                <span class="material-symbols-rounded">delete</span>
              </button>
            </div>
          </div>
        `;
      });

      if(!hasPendingFin) fList.innerHTML = '<p class="text-xs text-slate-400 italic text-center py-4">Tidak ada data keuangan pending.</p>';
    }
    window.loadApprovals = loadApprovals;

    window.approveDoc = async (col, id) => {
      if(!confirm("Yakin ingin menyetujui (ACC) data ini?")) return;
      toggleLoader(true);
      try {
        await updateDoc(doc(db, col, id), {
          status: "approved",
          approvedBy: UID,
          approvedAt: serverTimestamp()
        });
        await writeAudit("approve", col, id, {});
        showToast("Berhasil di-ACC!");
        await Promise.all([loadHomeData(), loadApprovals(true), loadAuditPreview()]);
      } catch(e) {
        console.error(e);
        showToast(e?.code === 'permission-denied' ? "Izin ditolak! Cek Rules DB." : ("Gagal ACC: " + (e?.message||"Error")), "error");
      } finally {
        toggleLoader(false);
      }
    };

    window.openAddActivityModal = () => {
      const html = `
        <input id="acT" class="w-full p-3 bg-slate-50 rounded-xl mb-2 text-sm font-bold" placeholder="Nama Kegiatan">
        <input id="acD" type="date" class="w-full p-3 bg-slate-50 rounded-xl mb-2 text-sm text-slate-600">
        <input id="acL" class="w-full p-3 bg-slate-50 rounded-xl mb-2 text-sm" placeholder="Lokasi">
        <div class="bg-slate-50 rounded-xl p-3 text-xs text-slate-500">
          Agenda yang dibuat oleh Ketua langsung <b>APPROVED</b>.
        </div>
      `;
      showModal("TAMBAH AGENDA", html, async () => {
        if(!$("acT").value.trim()) return showToast("Judul wajib diisi","error");
        toggleLoader(true);
        try {
          const payload = {
            title: $("acT").value.trim(),
            date: $("acD").value,
            location: $("acL").value.trim(),
            status: 'approved',
            createdBy: "Ketua",
            createdByUid: UID,
            createdAt: serverTimestamp()
          };
          await addDoc(collection(db,"activities"), payload);
          await writeAudit("activity_create", "activities", "-", { title: payload.title, date: payload.date });
          closeModal();
          showToast("Agenda dibuat");
          await Promise.all([loadApprovals(true), loadHomeData(), loadAuditPreview()]);
        } catch(e){
          console.error(e);
          showToast("Gagal buat agenda", "error");
        } finally {
          toggleLoader(false);
        }
      });
    };

    // FINANCE LIST
    let financeCache = [];
    async function loadFinance(){
      const list = $("finList"); if(!list) return;
      list.innerHTML = "";
      financeCache = [];
      const snap = await getDocs(query(collection(db,"financial_records"), orderBy("createdAt","desc"), limit(80)));

      if(snap.empty) {
        list.innerHTML = `<p class="text-center text-slate-400 text-sm mt-10">Belum ada data kas.</p>`;
        return;
      }

      snap.forEach(d => financeCache.push({ id: d.id, ...d.data() }));
      renderFinanceList(financeCache);
    }

    function renderFinanceList(arr){
      const list = $("finList"); if(!list) return;
      list.innerHTML = "";
      arr.forEach(f => {
        const isIn = f.type==='income';
        const isPending = f.status === 'pending';
        const date = f.createdAt?.seconds ? new Date(f.createdAt.seconds*1000).toLocaleDateString('id-ID') : "-";
        list.innerHTML += `
          <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-start ${isPending?'opacity-70':''}">
            <div class="min-w-0">
              <p class="text-sm font-bold text-brand-primary line-clamp-1 flex items-center gap-2">
                ${escapeHtml(f.note || '-')}
                ${isPending ? '<span class="text-[9px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded font-extrabold">PENDING</span>' : ''}
              </p>
              <p class="text-[10px] text-slate-400 mt-1">${date}</p>
              <div class="mt-2 flex gap-2 no-print">
                <button onclick="deleteDocData('financial_records','${f.id}')" class="text-[10px] font-extrabold bg-red-50 text-red-600 px-3 py-1.5 rounded-lg active:scale-95">Hapus</button>
              </div>
            </div>
            <span class="text-sm font-black ${isIn?'text-green-600':'text-red-500'} whitespace-nowrap">${isIn?'+':'-'} ${Number(f.amount||0).toLocaleString('id-ID')}</span>
          </div>
        `;
      });
    }

    window.exportFinanceCSV = async () => {
      if(!financeCache.length) await loadFinance();
      const ts = new Date().toISOString().slice(0,10);
      let csv = "Tanggal,Status,Tipe,Nominal,Catatan\n";
      financeCache.forEach(f => {
        const date = f.createdAt?.seconds ? new Date(f.createdAt.seconds*1000).toLocaleDateString('id-ID') : "-";
        csv += `"${date}","${f.status||''}","${f.type||''}","${Number(f.amount||0)}","${(f.note||'').replaceAll('"','""')}"\n`;
      });
      downloadText(csv, `Laporan_Kas_${ts}.csv`, "text/csv;charset=utf-8");
      await writeAudit("export_finance_csv", "financial_records", "-", { total: financeCache.length });
      showToast("CSV Keuangan diunduh");
    };

    // DELETE (log + refresh)
    window.deleteDocData = async(col,id) => {
      if(!confirm("Hapus item ini permanen?")) return;
      toggleLoader(true);
      try {
        await deleteDoc(doc(db,col,id));
        await writeAudit("delete", col, id, {});
        showToast("Item dihapus");
        if(col==='activities') await loadApprovals(true);
        if(col==='financial_records') await Promise.all([loadFinance(), loadHomeData()]);
        await loadAuditPreview();
      } catch(e){
        console.error(e);
        showToast("Gagal hapus (cek rules)", "error");
      } finally {
        toggleLoader(false);
      }
    };

    // AUDIT PREVIEW
    async function loadAuditPreview(){
      const box = $("auditPreview");
      if(!box) return;
      box.innerHTML = `<p class="text-xs text-slate-400 italic">Memuat...</p>`;
      try {
        const lim = 5;
        const snap = await getDocs(query(collection(db,"audit_logs"), orderBy("createdAt","desc"), limit(lim)));
        if(snap.empty) {
          box.innerHTML = `<p class="text-xs text-slate-400 italic">Belum ada audit.</p>`;
          return;
        }
        box.innerHTML = "";
        snap.forEach(d => {
          const a = d.data();
          const dt = a.createdAt?.seconds ? new Date(a.createdAt.seconds*1000).toLocaleString('id-ID') : "-";
          box.innerHTML += `
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500">
                <span class="material-symbols-rounded text-sm">history</span>
              </div>
              <div class="min-w-0">
                <p class="text-xs font-extrabold text-brand-primary truncate">${escapeHtml((a.action||'aksi').toUpperCase())} • ${escapeHtml(a.targetType || '-')}</p>
                <p class="text-[10px] text-slate-400 truncate">${escapeHtml(dt)} • ${escapeHtml(a.targetId || '-')}</p>
              </div>
            </div>
          `;
        });
      } catch(e){
        console.warn(e);
        box.innerHTML = `<p class="text-xs text-slate-400 italic">Gagal memuat audit.</p>`;
      }
    }

    // AUDIT FULL
    window.loadAudit = async (showToastOnDone=false) => {
      const list = $("auditList"); if(!list) return;
      list.innerHTML = "";
      try {
        const lim = Number($("auditLimit")?.value || 30);
        const snap = await getDocs(query(collection(db,"audit_logs"), orderBy("createdAt","desc"), limit(lim)));
        if(snap.empty) {
          list.innerHTML = `<p class="text-xs text-slate-400 italic text-center py-6">Belum ada audit log.</p>`;
          return;
        }

        snap.forEach(d => {
          const a = d.data();
          const dt = a.createdAt?.seconds ? new Date(a.createdAt.seconds*1000).toLocaleString('id-ID') : "-";
          list.innerHTML += `
            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <p class="text-sm font-black text-brand-primary">${escapeHtml((a.action||'-').toUpperCase())}</p>
                  <p class="text-[10px] text-slate-400 mt-1">${escapeHtml(dt)}</p>
                </div>
                <div class="text-right">
                  <p class="text-[10px] font-extrabold bg-slate-100 text-slate-600 px-2 py-1 rounded">${escapeHtml(a.targetType||'-')}</p>
                  <p class="text-[10px] text-slate-400 mt-1 truncate max-w-[140px]">${escapeHtml(a.targetId||'-')}</p>
                </div>
              </div>
              ${a.meta ? `<pre class="mt-3 text-[10px] bg-slate-50 border border-slate-100 rounded-xl p-3 overflow-auto no-scrollbar">${escapeHtml(JSON.stringify(a.meta, null, 2))}</pre>` : ``}
            </div>
          `;
        });

        if(showToastOnDone) showToast("Audit log diperbarui");
      } catch(e) {
        console.error(e);
        list.innerHTML = `<p class="text-xs text-red-500 italic text-center py-6">Gagal memuat audit log.</p>`;
      }
    };

    // BACKUP JSON
    window.openBackupModal = () => {
      const html = `
        <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm text-slate-600">
          <p class="font-extrabold text-brand-primary mb-1">Backup JSON</p>
          <p class="text-xs text-slate-500">Download snapshot ringkas (maks 200 item per koleksi). Cocok untuk arsip / audit.</p>
        </div>
        <button onclick="downloadBackup()" class="w-full bg-brand-primary text-white py-4 rounded-xl font-extrabold active:scale-95">
          Download Backup
        </button>
      `;
      showModal("BACKUP DATA", html, null);
    };

    window.downloadBackup = async () => {
      toggleLoader(true);
      try {
        const [uSnap, fSnap, aSnap, nSnap] = await Promise.all([
          getDocs(query(collection(db,"users"), orderBy("name"), limit(200))),
          getDocs(query(collection(db,"financial_records"), orderBy("createdAt","desc"), limit(200))),
          getDocs(query(collection(db,"activities"), orderBy("date","desc"), limit(200))),
          getDocs(query(collection(db,"notifications"), orderBy("createdAt","desc"), limit(200))),
        ]);

        const pack = {
          generatedAt: new Date().toISOString(),
          generatedByUid: UID,
          users: uSnap.docs.map(d => ({ id:d.id, ...d.data() })),
          financial_records: fSnap.docs.map(d => ({ id:d.id, ...d.data() })),
          activities: aSnap.docs.map(d => ({ id:d.id, ...d.data() })),
          notifications: nSnap.docs.map(d => ({ id:d.id, ...d.data() })),
        };

        downloadText(JSON.stringify(pack, null, 2), `KARTEJI_Backup_${new Date().toISOString().slice(0,10)}.json`, "application/json");
        await writeAudit("backup_json_download", "backup", "-", { users:uSnap.size, finance:fSnap.size, activities:aSnap.size, notifications:nSnap.size });
        closeModal();
        showToast("Backup diunduh");
      } catch(e){
        console.error(e);
        showToast("Gagal backup (cek rules)", "error");
      } finally {
        toggleLoader(false);
      }
    };

    // DOWNLOAD HELPER
    function downloadText(content, filename, mime){
      const blob = new Blob([content], { type: mime || "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function escapeHtml(str){
      return (str||"").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    // LOGOUT
    $("logoutBtn").onclick = () => signOut(auth).then(() => location.href = "login.html");
  </script>
</body>
</html>
