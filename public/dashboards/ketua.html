<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ketua | KARTEJI</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'bg-main': '#050505',
            'card-dark': '#121212',
            'accent-lime': '#D4FC79',
          },
          fontFamily: { sans: ['Outfit', 'sans-serif'] }
        }
      }
    }
  </script>

  <style>
    body { background-color: #050505; color: #ffffff; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    /* Glass Bottom Nav */
    .glass-nav {
      background: rgba(18, 18, 18, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    /* Animasi Transisi Halaman */
    .view-section { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
    .view-section.active { display: block; opacity: 1; transform: translateY(0); }

    /* Nav Icon Active State */
    .nav-btn.active span { font-variation-settings: 'FILL' 1; color: #D4FC79; }
    .nav-btn.active p { color: #D4FC79; }
  </style>
</head>

<body class="min-h-screen relative overflow-x-hidden pb-24">

  <div id="globalLoader" class="fixed inset-0 bg-black/90 z-[9999] flex items-center justify-center flex-col gap-4 backdrop-blur-xl">
    <div class="w-12 h-12 border-4 border-gray-800 border-t-accent-lime rounded-full animate-spin"></div>
    <p id="loaderMsg" class="text-xs text-accent-lime tracking-widest animate-pulse">MEMUAT...</p>
  </div>

  <div id="gate" class="fixed inset-0 bg-black z-[9998] hidden items-center justify-center p-6 text-center">
    <span class="material-symbols-rounded text-red-500 text-6xl mb-4">lock</span>
    <h2 class="text-2xl font-bold text-white mb-2">Akses Ditolak</h2>
    <p class="text-gray-400 text-sm mb-6">Halaman ini khusus Ketua.</p>
    <a href="../login.html" class="text-accent-lime font-bold text-sm underline">Kembali ke Login</a>
  </div>

  <div id="crudModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
    <div class="bg-[#121212] border border-white/10 w-full max-w-md rounded-[2rem] p-6 relative shadow-2xl">
      <div class="flex justify-between items-center mb-6">
          <h2 id="modalTitle" class="text-xl font-bold text-white uppercase tracking-wider">Judul</h2>
          <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center hover:bg-white/10"><span class="material-symbols-rounded text-sm">close</span></button>
      </div>
      <div id="modalBody" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar"></div>
      <button id="modalSubmitBtn" class="mt-6 w-full rounded-xl bg-accent-lime text-black py-3 text-sm font-bold hover:brightness-110 transition-all">SIMPAN</button>
    </div>
  </div>

  <header class="sticky top-0 z-30 px-5 pt-6 pb-2 bg-gradient-to-b from-[#050505] to-transparent">
      <div class="flex justify-between items-center">
          <div class="flex items-center gap-3">
              <img id="headerPhoto" src="https://via.placeholder.com/100" class="w-10 h-10 rounded-full border border-white/10 object-cover">
              <div>
                  <p class="text-[10px] text-accent-lime uppercase tracking-widest font-bold">Ketua</p>
                  <h1 id="headerName" class="text-lg font-bold leading-none text-white">...</h1>
              </div>
          </div>
          <button id="logoutBtn" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-red-400 hover:bg-red-500/20"><span class="material-symbols-rounded text-lg">logout</span></button>
      </div>
  </header>

  <main class="px-4 mt-2">

      <section id="view-home" class="view-section active">
          
          <div class="w-full bg-accent-lime rounded-[2rem] p-5 text-black relative overflow-hidden shadow-[0_10px_40px_-10px_rgba(212,252,121,0.2)]">
              <div class="absolute top-0 right-0 p-4 opacity-10"><span class="material-symbols-rounded text-8xl">account_balance_wallet</span></div>
              
              <p class="text-[10px] font-bold uppercase tracking-widest opacity-60 mb-1">Total Kas Organisasi</p>
              <h2 id="cardBalance" class="text-3xl font-black tracking-tight mb-4">Rp 0</h2>

              <div class="grid grid-cols-2 gap-2 mt-2">
                  <div class="bg-black/10 rounded-xl p-2.5 backdrop-blur-sm">
                      <div class="flex items-center gap-1 mb-1">
                          <span class="material-symbols-rounded text-[10px] bg-white/20 p-0.5 rounded-full">arrow_downward</span>
                          <span class="text-[9px] font-bold uppercase opacity-60">Masuk Dari</span>
                      </div>
                      <p id="lastIncomeNote" class="text-[10px] font-bold leading-tight line-clamp-1">-</p>
                      <p id="lastIncomeAmt" class="text-[10px] opacity-70 mt-0.5">Rp 0</p>
                  </div>
                  <div class="bg-black/10 rounded-xl p-2.5 backdrop-blur-sm">
                      <div class="flex items-center gap-1 mb-1">
                          <span class="material-symbols-rounded text-[10px] bg-white/20 p-0.5 rounded-full">arrow_upward</span>
                          <span class="text-[9px] font-bold uppercase opacity-60">Keluar Untuk</span>
                      </div>
                      <p id="lastExpenseNote" class="text-[10px] font-bold leading-tight line-clamp-1">-</p>
                      <p id="lastExpenseAmt" class="text-[10px] opacity-70 mt-0.5">Rp 0</p>
                  </div>
              </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-3">
              <div class="bg-[#121212] border border-white/5 rounded-[1.5rem] p-4 flex flex-col justify-between h-32 relative group overflow-hidden" onclick="switchView('activities')">
                   <div class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-all"></div>
                   <div>
                       <span class="material-symbols-rounded text-blue-400 mb-2">event</span>
                       <p class="text-[9px] text-gray-500 uppercase font-bold">Agenda Terdekat</p>
                   </div>
                   <h3 id="widgetEvent" class="text-xs font-bold text-white line-clamp-2 leading-relaxed mt-1">Belum ada acara</h3>
              </div>

              <div class="bg-[#121212] border border-white/5 rounded-[1.5rem] p-4 flex flex-col justify-between h-32 relative group overflow-hidden" onclick="switchView('activities')">
                   <div class="absolute inset-0 bg-gradient-to-br from-red-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-all"></div>
                   <div>
                       <span class="material-symbols-rounded text-red-400 mb-2">campaign</span>
                       <p class="text-[9px] text-gray-500 uppercase font-bold">Info Penting</p>
                   </div>
                   <h3 id="widgetAlert" class="text-xs font-bold text-white line-clamp-2 leading-relaxed mt-1">Tidak ada info</h3>
              </div>
          </div>

          <div class="mt-4">
              <button onclick="openProfileModal()" class="w-full py-3 rounded-2xl bg-[#121212] border border-white/5 text-xs font-bold flex items-center justify-center gap-2 hover:bg-[#1E1E1E]">
                  <span class="material-symbols-rounded text-sm">edit</span> Edit Profil Saya
              </button>
          </div>

      </section>

      <section id="view-users" class="view-section">
          <div class="flex justify-between items-end mb-4 px-1">
              <h2 class="text-2xl font-bold">Anggota</h2>
              <span id="userCountBadge" class="bg-white/10 text-[10px] px-2 py-1 rounded-md font-mono">0</span>
          </div>
          <div id="userList" class="grid grid-cols-1 gap-2"></div>
      </section>

      <section id="view-activities" class="view-section">
          <div class="flex justify-between items-center mb-4 px-1">
            <h2 class="text-2xl font-bold">Kegiatan</h2>
            <button onclick="openAddActivityModal()" class="bg-accent-lime text-black w-10 h-10 rounded-full flex items-center justify-center shadow-[0_0_15px_rgba(212,252,121,0.3)]"><span class="material-symbols-rounded">add</span></button>
          </div>
          <div id="actList" class="grid grid-cols-1 gap-3"></div>
      </section>

      <section id="view-finance" class="view-section">
          <h2 class="text-2xl font-bold mb-4 px-1">Riwayat Kas</h2>
          <div id="finList" class="space-y-2"></div>
      </section>

  </main>

  <nav class="fixed bottom-0 w-full glass-nav pb-6 pt-3 px-2 z-40">
      <div class="flex justify-around items-center max-w-md mx-auto">
          <button onclick="switchView('home')" class="nav-btn active flex flex-col items-center gap-1 p-2 w-16 transition-all" data-target="home">
              <span class="material-symbols-rounded text-2xl text-gray-400 transition-colors">grid_view</span>
              <p class="text-[9px] font-bold text-gray-500 transition-colors">Home</p>
          </button>
          
          <button onclick="switchView('users')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 transition-all" data-target="users">
              <span class="material-symbols-rounded text-2xl text-gray-400 transition-colors">group</span>
              <p class="text-[9px] font-bold text-gray-500 transition-colors">User</p>
          </button>

          <div class="w-8"></div>
          <button onclick="openAddActivityModal()" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 w-14 h-14 bg-accent-lime rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(212,252,121,0.4)] text-black hover:scale-105 transition-all">
              <span class="material-symbols-rounded text-3xl">add</span>
          </button>

          <button onclick="switchView('activities')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 transition-all" data-target="activities">
              <span class="material-symbols-rounded text-2xl text-gray-400 transition-colors">calendar_month</span>
              <p class="text-[9px] font-bold text-gray-500 transition-colors">Acara</p>
          </button>

          <button onclick="switchView('finance')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 transition-all" data-target="finance">
              <span class="material-symbols-rounded text-2xl text-gray-400 transition-colors">account_balance_wallet</span>
              <p class="text-[9px] font-bold text-gray-500 transition-colors">Kas</p>
          </button>
      </div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, getDocs, addDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
      authDomain: "katar-9cac3.firebaseapp.com",
      projectId: "katar-9cac3",
      storageBucket: "katar-9cac3.firebasestorage.app",
      messagingSenderId: "1017734829960",
      appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const CLOUD_NAME = "dbxktcwug";
    const PRESET_PROFILE = "Karteji";
    const PRESET_GALLERY = "Karteji Galeri";

    const $ = (id) => document.getElementById(id);
    let UID = null;

    // --- UTILITIES ---
    window.toggleLoader = (show, msg="MEMUAT...") => {
        const l = $("globalLoader");
        $("loaderMsg").textContent = msg;
        if(show) { l.classList.remove('hidden'); l.classList.add('flex'); }
        else { l.classList.add('hidden'); l.classList.remove('flex'); }
    };

    window.closeModal = () => $("crudModal").classList.add('hidden');
    window.showModal = (title, bodyHtml, onSave) => {
        $("modalTitle").textContent = title;
        $("modalBody").innerHTML = bodyHtml;
        $("crudModal").classList.remove('hidden');
        $("crudModal").classList.add('flex');
        $("modalSubmitBtn").onclick = onSave;
    };

    window.switchView = (viewId) => {
        document.querySelectorAll('.view-section').forEach(el => {
            el.classList.remove('active');
            setTimeout(() => { if(!el.classList.contains('active')) el.style.display = 'none'; }, 300);
        });
        const target = $(`view-${viewId}`);
        target.style.display = 'block';
        setTimeout(() => target.classList.add('active'), 10);

        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`.nav-btn[data-target="${viewId}"]`);
        if(activeBtn) activeBtn.classList.add('active');
        
        // Refresh specific data
        if(viewId === 'home') loadHomeData();
        if(viewId === 'users') loadUsers();
    };

    async function upload(file, preset, folder){
        const fd = new FormData();
        fd.append("file", file);
        fd.append("upload_preset", preset);
        fd.append("folder", folder);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,{ method:"POST", body:fd });
        const data = await res.json();
        if(!res.ok) throw new Error("Upload Gagal");
        return { url:data.secure_url };
    }

    // --- MAIN LOGIC ---
    onAuthStateChanged(auth, async user => {
        if(!user) return location.href = "../login.html";
        
        toggleLoader(true, "CEK AKSES...");
        try {
            const snap = await getDoc(doc(db,"users",user.uid));
            if(!snap.exists() || (snap.data().role !== "ketua" && snap.data().role !== "super_admin")){
                // Izinkan Ketua ATAU Super Admin untuk preview
                toggleLoader(false);
                $("gate").classList.remove("hidden");
                return;
            }
            UID = user.uid;
            const me = snap.data();
            
            $("headerName").textContent = me.name || "Ketua";
            $("headerPhoto").src = me.photo?.url || "https://via.placeholder.com/100";

            await Promise.all([loadHomeData(), loadUsers(), loadActivities(), loadFinance()]);
        } catch(e) { console.error(e); }
        toggleLoader(false);
    });

    async function loadHomeData() {
        const fin = await getDocs(query(collection(db, "financial_records"), orderBy("createdAt", "desc")));
        let bal = 0;
        let lastInc = { note: "-", amount: 0 };
        let lastExp = { note: "-", amount: 0 };
        let foundInc = false, foundExp = false;

        fin.forEach(d => {
            const f = d.data();
            if(f.status === 'approved') {
                if(f.type === 'income') {
                    bal += Number(f.amount);
                    if(!foundInc) { lastInc = f; foundInc = true; }
                } else {
                    bal -= Number(f.amount);
                    if(!foundExp) { lastExp = f; foundExp = true; }
                }
            }
        });

        $("cardBalance").textContent = "Rp " + bal.toLocaleString('id-ID');
        $("lastIncomeNote").textContent = lastInc.note || "-";
        $("lastIncomeAmt").textContent = "Rp " + Number(lastInc.amount).toLocaleString('id-ID');
        $("lastExpenseNote").textContent = lastExp.note || "-";
        $("lastExpenseAmt").textContent = "Rp " + Number(lastExp.amount).toLocaleString('id-ID');

        const ev = await getDocs(query(collection(db, "activities"), orderBy("createdAt", "desc"), limit(1)));
        if(!ev.empty) $("widgetEvent").textContent = ev.docs[0].data().title;

        const notif = await getDocs(query(collection(db, "notifications"), orderBy("createdAt", "desc"), limit(1)));
        if(!notif.empty) $("widgetAlert").textContent = notif.docs[0].data().title;
        else $("widgetAlert").textContent = "Tidak ada info penting";
    }

    window.openProfileModal = () => {
        const html = `
            <input id="editName" class="w-full p-4 rounded-xl bg-white/5 border border-white/10 text-white outline-none mb-2" value="${$("headerName").textContent}">
            <div class="bg-white/5 p-3 rounded-xl border border-white/10">
                <p class="text-[10px] text-gray-400 mb-2">Ganti Foto Profil</p>
                <input id="editFile" type="file" accept="image/*" class="text-xs text-gray-300">
            </div>
        `;
        showModal("EDIT PROFIL", html, async () => {
            const name = $("editName").value.trim();
            const file = $("editFile").files?.[0];
            const payload = {};
            
            toggleLoader(true);
            try {
                if(name) payload.name = name;
                if(file) payload.photo = await upload(file, PRESET_PROFILE, `karteji/users/${UID}`);
                
                if(Object.keys(payload).length){
                    await updateDoc(doc(db,"users",UID), payload);
                    location.reload();
                } else { closeModal(); toggleLoader(false); }
            } catch(e){ alert("Gagal update"); toggleLoader(false); }
        });
    }

    /* --- USERS (KETUA BISA GANTI ROLE, KECUALI SUPER ADMIN) --- */
    async function loadUsers(){
        const list = $("userList"); list.innerHTML = "";
        const snap = await getDocs(query(collection(db,"users"), orderBy("name","asc")));
        $("userCountBadge").textContent = (snap.size > 0 ? snap.size : 0) + " Users";

        // Daftar role yang bisa dipilih Ketua
        const roles = ["anggota", "koordinator", "sekretaris", "bendahara", "wakil_ketua", "ketua"];

        snap.forEach(d => {
            const u = d.data();
            // Skip diri sendiri agar tidak tidak sengaja menghapus akses sendiri
            if(d.id === UID) return;

            const isSuper = u.role === "super_admin";
            let controlHTML = "";
            let deleteBtnHTML = "";

            if(isSuper) {
                // PROTEKSI SUPER ADMIN
                controlHTML = `<p class="text-[9px] font-bold text-red-500 bg-red-500/10 px-2 py-0.5 rounded inline-block mt-1">LOCKED</p>`;
                deleteBtnHTML = `<div class="w-8 h-8"></div>`; // Spacer kosong
            } else {
                // RENDER DROPDOWN & DELETE
                let options = roles.map(r => `<option value="${r}" ${u.role===r ? 'selected' : ''}>${r.substr(0,1).toUpperCase()+r.substr(1)}</option>`).join('');
                
                controlHTML = `
                    <select onchange="changeRole('${d.id}', this.value)" class="text-[10px] bg-transparent text-accent-lime outline-none p-0 cursor-pointer uppercase font-bold mt-0.5 border-b border-white/10 w-full pb-0.5">
                        ${options}
                    </select>
                `;
                deleteBtnHTML = `
                    <button onclick="deleteDocData('users','${d.id}')" class="w-8 h-8 rounded-full bg-red-500/10 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all shrink-0">
                        <span class="material-symbols-rounded text-base">delete</span>
                    </button>
                `;
            }
            
            list.innerHTML += `
                <div class="bg-[#121212] p-3 rounded-2xl flex items-center justify-between border border-white/5 overflow-hidden gap-2">
                     <div class="flex items-center gap-3 overflow-hidden w-full">
                        <img src="${u.photo?.url || 'https://via.placeholder.com/50'}" class="w-10 h-10 rounded-full object-cover bg-gray-800 flex-shrink-0">
                        <div class="min-w-0 w-full pr-2">
                            <p class="text-xs font-bold text-white truncate">${u.name || '-'}</p>
                            ${controlHTML}
                        </div>
                     </div>
                     ${deleteBtnHTML}
                </div>
            `;
        });
    }

    window.changeRole = async (uid, val) => {
        toggleLoader(true, "UPDATE ROLE...");
        await updateDoc(doc(db, "users", uid), { role: val });
        toggleLoader(false);
    }

    /* --- ACTIVITIES (KETUA BISA TAMBAH & HAPUS) --- */
    async function loadActivities(){
        const list = $("actList"); list.innerHTML = "";
        const snap = await getDocs(query(collection(db,"activities"), orderBy("createdAt","desc")));

        snap.forEach(d => {
            const x = d.data();
            list.innerHTML += `
                <div class="bg-[#121212] rounded-2xl overflow-hidden border border-white/5 flex h-24 relative group">
                    <img src="${x.cover?.url || 'https://via.placeholder.com/150'}" class="w-24 h-full object-cover opacity-80">
                    <div class="p-3 flex flex-col justify-center w-full">
                        <h3 class="text-sm font-bold text-white line-clamp-1">${x.title}</h3>
                        <p class="text-[10px] text-gray-400 mt-1">${x.status || 'Active'}</p>
                    </div>
                    <button onclick="deleteDocData('activities','${d.id}')" class="absolute top-2 right-2 w-7 h-7 bg-red-500/20 text-red-500 rounded-full flex items-center justify-center hover:bg-red-500 hover:text-white transition-all">
                        <span class="material-symbols-rounded text-sm">delete</span>
                    </button>
                </div>
            `;
        });
    }

    window.openAddActivityModal = () => {
        const html = `
            <input id="actTitle" class="w-full p-4 rounded-xl bg-white/5 border border-white/10 text-white outline-none mb-3" placeholder="Judul Kegiatan">
            <div class="bg-white/5 p-3 rounded-xl border border-white/10">
                <p class="text-[10px] text-gray-400 mb-2">Upload Cover</p>
                <input id="actCover" type="file" accept="image/*" class="text-xs text-gray-300">
            </div>
        `;
        showModal("TAMBAH KEGIATAN", html, async () => {
            const title = $("actTitle").value.trim();
            const file = $("actCover").files?.[0];
            if(!title) return alert("Judul wajib diisi");
            
            toggleLoader(true);
            try {
                let cover = null;
                if(file) cover = await upload(file, PRESET_GALLERY, "karteji/activities");
                
                await addDoc(collection(db,"activities"), {
                    title, cover, status: "approved", createdByUid: UID, createdAt: serverTimestamp()
                });
                closeModal(); await loadActivities(); await loadHomeData();
            } catch(e) { alert("Gagal tambah"); }
            toggleLoader(false);
        });
    }

    /* --- FINANCE (READ ONLY) --- */
    async function loadFinance(){
        const list = $("finList"); list.innerHTML = "";
        const snap = await getDocs(query(collection(db,"financial_records"), orderBy("createdAt","desc"), limit(50)));
        
        snap.forEach(d => {
            const x = d.data();
            const isInc = x.type === 'income';
            list.innerHTML += `
                 <div class="bg-[#121212] p-4 rounded-2xl flex justify-between items-center border border-white/5">
                    <div class="flex items-center gap-3">
                         <div class="w-8 h-8 rounded-full ${isInc ? 'bg-accent-lime/20 text-accent-lime' : 'bg-white/10 text-white'} flex items-center justify-center">
                            <span class="material-symbols-rounded text-lg">${isInc ? 'arrow_downward' : 'arrow_upward'}</span>
                        </div>
                        <p class="text-xs font-bold text-white">${x.note || 'Transaksi'}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold ${isInc?'text-accent-lime':'text-white'}">${isInc?'+':'-'} Rp ${Number(x.amount).toLocaleString('id-ID')}</p>
                        </div>
                </div>
            `;
        });
    }

    // --- GLOBAL DELETE ---
    window.deleteDocData = async (col, id) => {
        if(!confirm("Hapus data ini secara permanen?")) return;
        toggleLoader(true, "MENGHAPUS...");
        try {
            await deleteDoc(doc(db, col, id));
            if(col === 'users') loadUsers();
            if(col === 'activities') loadActivities();
            // Finance tidak ada delete, jadi aman
            await loadHomeData();
        } catch(e) { alert("Gagal hapus"); }
        toggleLoader(false);
    };

    $("logoutBtn").onclick = async () => {
        await signOut(auth);
        location.href = "../login.html";
    };
  </script>
</body>
</html>
