<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#F8FAFC" />
  <title>Area Anggota | KARTEJI</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: ['class', '[data-theme="dark"]'],
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          colors: {
            brand: { primary: '#0F172A', light: '#334155', dark: '#0B1120' },
            accent: { DEFAULT: '#F97316', light: '#FFEDD5', glow: '#FDBA74' }
          },
          animation: {
            'blob': 'blob 10s infinite',
            'slide-in-top': 'slideInTop 0.5s cubic-bezier(0.250, 0.460, 0.450, 0.940) both',
            'sheen': 'sheen 1.2s ease-out both',
          },
          keyframes: {
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
              '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            slideInTop: {
              '0%': { transform: 'translateY(-50px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            },
            sheen: { '0%': { transform: 'translateX(-120%)' }, '100%': { transform: 'translateX(120%)' } }
          }
        }
      }
    }
  </script>

  <style>
    :root{
      color-scheme: light;
      --bg0:#f8fafc; --bg1:#ffffff;
      --fg0:#0f172a; --fg1:rgba(15,23,42,.68);
      --glass: rgba(255,255,255,.78);
      --glassBorder: rgba(255,255,255,.55);
      --glassShadow: 0 18px 60px rgba(2,6,23,.08);
      --ring: rgba(249,115,22,.35);
      --nav: rgba(255,255,255,.88);
      --navBorder: rgba(15,23,42,.06);
    }
    html[data-theme="dark"]{
      color-scheme: dark;
      --bg0:#050814; --bg1:#0b1223;
      --fg0:#e5e7eb; --fg1:rgba(229,231,235,.72);
      --glass: rgba(15,23,42,.55);
      --glassBorder: rgba(148,163,184,.18);
      --glassShadow: 0 18px 70px rgba(0,0,0,.40);
      --ring: rgba(253,186,116,.25);
      --nav: rgba(15,23,42,.62);
      --navBorder: rgba(148,163,184,.14);
    }

    body { background: linear-gradient(180deg, var(--bg0), var(--bg1)); color: var(--fg0); -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }

    .glass-nav{
      background: var(--nav);
      backdrop-filter: blur(16px) saturate(130%);
      -webkit-backdrop-filter: blur(16px) saturate(130%);
      border-top: 1px solid var(--navBorder);
      box-shadow: 0 -8px 30px rgba(0,0,0,0.06);
    }
    .glass-card{
      background: var(--glass);
      backdrop-filter: blur(18px) saturate(130%);
      -webkit-backdrop-filter: blur(18px) saturate(130%);
      border: 1px solid var(--glassBorder);
      box-shadow: var(--glassShadow);
    }

    .view-section { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
    .view-section.active { display: block; opacity: 1; transform: translateY(0); }
    .nav-btn.active span { font-variation-settings: 'FILL' 1; color: #F97316; }
    .nav-btn.active p { color: var(--fg0); font-weight: 800; }

    .tap{ transition: transform .1s ease; will-change: transform; }
    .tap:active{ transform: scale(.95); }
    .focus-ring:focus{ outline:none; }
    .focus-ring:focus-visible{ box-shadow: 0 0 0 4px var(--ring); }

    .online-ring { animation: ringPulse 2s infinite; }
    @keyframes ringPulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
      70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }

    .skeleton {
      background: linear-gradient(90deg, rgba(148,163,184,.14), rgba(148,163,184,.26), rgba(148,163,184,.14));
      background-size: 200% 100%;
      animation: sk 1.2s ease-in-out infinite;
      border-radius: 999px;
    }
    @keyframes sk { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  </style>

  <script>
    (function(){
      const saved = localStorage.getItem('kte_theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
</head>

<body class="min-h-screen relative overflow-x-hidden pb-32 selection:bg-orange-200 selection:text-orange-900">

  <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
    <div class="absolute inset-0" style="background: linear-gradient(180deg, var(--bg0), var(--bg1));"></div>
    <div class="absolute top-[-10%] left-[-10%] w-96 h-96 rounded-full filter blur-3xl opacity-30 animate-blob" style="background: rgba(59,130,246,.5)"></div>
    <div class="absolute top-[30%] right-[-10%] w-96 h-96 rounded-full filter blur-3xl opacity-30 animate-blob animation-delay-2000" style="background: rgba(249,115,22,.4)"></div>
    <div class="absolute bottom-[-20%] left-[20%] w-80 h-80 rounded-full filter blur-3xl opacity-30 animate-blob animation-delay-4000" style="background: rgba(168,85,247,.4)"></div>
  </div>

  <div id="toastContainer" class="fixed top-4 left-0 right-0 z-[100] flex flex-col items-center gap-2 pointer-events-none px-4"></div>

  <div id="globalLoader" class="fixed inset-0 z-[9999] hidden items-center justify-center flex-col gap-4 backdrop-blur-md" style="background: rgba(248,250,252, 0.6)">
    <div class="w-12 h-12 border-4 border-slate-200 border-t-accent rounded-full animate-spin"></div>
    <p class="text-xs font-extrabold animate-pulse" style="color:var(--fg1)">MEMUAT...</p>
  </div>

  <div id="crudModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm transition-all">
    <div class="glass-card w-full max-w-md rounded-[2rem] p-6 relative shadow-2xl animate-[slideInTop_0.3s_ease-out]">
      <div class="flex justify-between items-center mb-6">
        <h2 id="modalTitle" class="text-xl font-extrabold uppercase tracking-tight" style="color:var(--fg0)">Judul</h2>
        <button onclick="closeModal()" class="tap w-9 h-9 rounded-full flex items-center justify-center" style="background: rgba(148,163,184,.12); color: rgba(148,163,184,.9)">
          <span class="material-symbols-rounded text-xl">close</span>
        </button>
      </div>
      <div id="modalBody" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar"></div>
      <button id="modalSubmitBtn" class="tap focus-ring mt-6 w-full rounded-xl py-4 text-sm font-extrabold shadow-lg overflow-hidden relative group"
        style="background: linear-gradient(135deg, #0F172A, #111c33); color: white;">
        SIMPAN
      </button>
    </div>
  </div>

  <header class="sticky top-0 z-30 px-6 pt-8 pb-4">
    <div class="glass-card rounded-[1.75rem] px-5 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <button onclick="switchView('profile')" class="relative tap focus-ring rounded-full">
          <img id="headerPhoto" class="w-11 h-11 rounded-full border-2 border-white shadow-md object-cover shrink-0" src="https://via.placeholder.com/100" alt="Foto">
          <div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full"></div>
        </button>
        <div>
          <p class="text-[10px] font-extrabold uppercase tracking-widest px-2 py-0.5 rounded-full w-fit mb-1"
             style="background: rgba(249,115,22,.14); color: #F97316">ANGGOTA</p>
          <h1 id="headerName" class="text-lg font-extrabold leading-none truncate max-w-[140px]">Memuat...</h1>
        </div>
      </div>
      <div class="flex gap-2">
        <button id="btn-theme" class="tap w-10 h-10 rounded-full flex items-center justify-center"
          style="background: rgba(148,163,184,.12); color: rgba(148,163,184,.95)">
          <span id="themeIcon" class="material-symbols-rounded">dark_mode</span>
        </button>
        <button onclick="refreshAll()" class="tap w-10 h-10 rounded-full flex items-center justify-center"
          style="background: rgba(148,163,184,.12); color: rgba(148,163,184,.95)">
          <span class="material-symbols-rounded">refresh</span>
        </button>
      </div>
    </div>
  </header>

  <main class="px-5 mt-2 relative z-10 pb-28">

    <section id="view-home" class="view-section active">

      <!-- ✅ WEATHER WIDGET -->
      <div id="weatherCard" class="glass-card rounded-[2rem] p-5 mb-4 overflow-hidden relative">
        <div class="absolute -right-10 -top-10 w-32 h-32 rounded-full blur-3xl opacity-20" style="background: rgba(59,130,246,.8)"></div>
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <p class="text-[10px] font-extrabold uppercase tracking-widest flex items-center gap-1" style="color:var(--fg1)">
              <span class="material-symbols-rounded text-sm" style="color:#0ea5e9">cloud</span>
              Cuaca Sekarang
            </p>
            <h3 id="weatherPlace" class="text-sm font-extrabold mt-1 truncate" style="color:var(--fg0)">Memuat lokasi...</h3>
          </div>
          <button onclick="loadWeather(true)" class="tap w-9 h-9 rounded-full flex items-center justify-center"
                  style="background: rgba(148,163,184,.12); color: rgba(148,163,184,.95)" aria-label="Refresh Cuaca">
            <span class="material-symbols-rounded text-xl">refresh</span>
          </button>
        </div>

        <div class="mt-4 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-2xl flex items-center justify-center"
                 style="background: rgba(14,165,233,.12); color: rgba(14,165,233,.95)">
              <span id="weatherIcon" class="material-symbols-rounded text-3xl">cloud</span>
            </div>
            <div>
              <div class="flex items-end gap-2">
                <p id="weatherTemp" class="text-3xl font-black leading-none" style="color:var(--fg0)">--°</p>
                <p id="weatherCond" class="text-[11px] font-extrabold uppercase" style="color:var(--fg1)">...</p>
              </div>
              <p id="weatherMeta" class="text-[10px] font-semibold mt-1" style="color:var(--fg1)">—</p>
            </div>
          </div>

          <div class="text-right">
            <p class="text-[9px] font-extrabold uppercase" style="color:var(--fg1)">Terakhir update</p>
            <p id="weatherUpdated" class="text-[10px] font-extrabold" style="color:var(--fg0)">--:--</p>
          </div>
        </div>

        <div id="weatherHint" class="mt-4 text-[10px] font-semibold rounded-xl px-3 py-2"
             style="background: rgba(148,163,184,.10); color:var(--fg1)">
          Mengambil data cuaca berdasarkan lokasi perangkat.
        </div>

        <div id="weatherSkeleton" class="mt-4 space-y-2">
          <div class="skeleton h-3 w-24"></div>
          <div class="skeleton h-3 w-44"></div>
        </div>
      </div>

      <!-- ✅ JADWAL SHOLAT + IMSAK (TETAP ADA) -->
      <div id="prayerCard" class="glass-card rounded-[2rem] p-5 mb-6 overflow-hidden relative">
        <div class="absolute -left-10 -bottom-10 w-40 h-40 rounded-full blur-3xl opacity-15" style="background: rgba(34,197,94,.75)"></div>

        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <p class="text-[10px] font-extrabold uppercase tracking-widest flex items-center gap-1" style="color:var(--fg1)">
              <span class="material-symbols-rounded text-sm" style="color:#22c55e">mosque</span>
              Jadwal Sholat & Imsak
            </p>
            <h3 id="prayerPlace" class="text-sm font-extrabold mt-1 truncate" style="color:var(--fg0)">Memuat lokasi...</h3>
          </div>
          <button onclick="loadPrayer(true)" class="tap w-9 h-9 rounded-full flex items-center justify-center"
                  style="background: rgba(148,163,184,.12); color: rgba(148,163,184,.95)" aria-label="Refresh Jadwal Sholat">
            <span class="material-symbols-rounded text-xl">refresh</span>
          </button>
        </div>

        <div class="mt-4 flex items-center justify-between gap-3">
          <div class="min-w-0">
            <p class="text-[9px] font-extrabold uppercase" style="color:var(--fg1)">Berikutnya</p>
            <div class="flex items-end gap-2">
              <p id="nextPrayerName" class="text-xl font-black leading-none truncate" style="color:var(--fg0)">—</p>
              <p id="nextPrayerTime" class="text-[12px] font-extrabold" style="color:var(--fg1)">--:--</p>
            </div>
            <p id="prayerDate" class="text-[10px] font-semibold mt-1" style="color:var(--fg1)">—</p>
          </div>

          <div class="text-right">
            <p class="text-[9px] font-extrabold uppercase" style="color:var(--fg1)">Update</p>
            <p id="prayerUpdated" class="text-[10px] font-extrabold" style="color:var(--fg0)">--:--</p>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-3 gap-2">
          <div class="rounded-2xl p-3" style="background: rgba(148,163,184,.10); border:1px solid rgba(148,163,184,.14)">
            <p class="text-[9px] font-extrabold uppercase" style="color:var(--fg1)">Imsak</p>
            <p id="tImsak" class="text-sm font-black" style="color:var(--fg0)">--:--</p>
          </div>
          <div class="rounded-2xl p-3" style="background: rgba(148,163,184,.10); border:1px solid rgba(148,163,184,.14)">
            <p class="text-[9px] font-extrabold uppercase" style="color:var(--fg1)">Subuh</p>
            <p id="tFajr" class="text-sm font-black" style="color:var(--fg0)">--:--</p>
          </div>
          <div class="rounded-2xl p-3" style="background: rgba(148,163,184,.10); border:1px solid rgba(148,163,184,.14)">
            <p class="text-[9px] font-extrabold uppercase" style="color:var(--fg1)">Dzuhur</p>
            <p id="tDhuhr" class="text-sm font-black" style="color:var(--fg0)">--:--</p>
          </div>
          <div class="rounded-2xl p-3" style="background: rgba(148,163,184,.10); border:1px solid rgba(148,163,184,.14)">
            <p class="text-[9px] font-extrabold uppercase" style="color:var(--fg1)">Ashar</p>
            <p id="tAsr" class="text-sm font-black" style="color:var(--fg0)">--:--</p>
          </div>
          <div class="rounded-2xl p-3" style="background: rgba(148,163,184,.10); border:1px solid rgba(148,163,184,.14)">
            <p class="text-[9px] font-extrabold uppercase" style="color:var(--fg1)">Maghrib</p>
            <p id="tMaghrib" class="text-sm font-black" style="color:var(--fg0)">--:--</p>
          </div>
          <div class="rounded-2xl p-3" style="background: rgba(148,163,184,.10); border:1px solid rgba(148,163,184,.14)">
            <p class="text-[9px] font-extrabold uppercase" style="color:var(--fg1)">Isya</p>
            <p id="tIsha" class="text-sm font-black" style="color:var(--fg0)">--:--</p>
          </div>
        </div>

        <div id="prayerHint" class="mt-4 text-[10px] font-semibold rounded-xl px-3 py-2"
             style="background: rgba(148,163,184,.10); color:var(--fg1)">
          Mengambil jadwal berdasarkan lokasi perangkat.
        </div>

        <div id="prayerSkeleton" class="mt-4 space-y-2">
          <div class="skeleton h-3 w-28"></div>
          <div class="skeleton h-3 w-48"></div>
        </div>
      </div>

      <div id="arisanWidget" class="w-full p-[1px] rounded-[2rem] mb-6 relative overflow-hidden group"
           style="background: linear-gradient(45deg, #a855f7, #ec4899);">
        <div class="glass-card rounded-[1.9rem] p-5 flex items-center gap-4 relative z-10 h-full border-none">
          <div class="relative">
            <img id="arisanPhoto" src="https://via.placeholder.com/100" class="w-14 h-14 rounded-full border-2 border-white shadow-md object-cover shrink-0" alt="Arisan">
            <div id="arisanBadge" class="hidden absolute -top-2 -right-2 bg-yellow-400 text-yellow-900 text-[10px] font-extrabold px-2 py-0.5 rounded-full shadow-sm animate-bounce">WINNER</div>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-[10px] font-bold text-purple-500 uppercase tracking-widest mb-0.5">Arisan Bulanan</p>
            <h3 id="arisanName" class="text-lg font-extrabold leading-none truncate" style="color:var(--fg0)">Belum ada pemenang</h3>
            <p id="arisanDate" class="text-[10px] mt-1" style="color:var(--fg1)">Menunggu pengundian...</p>
          </div>
          <span class="material-symbols-rounded text-4xl text-purple-500/20">celebration</span>
        </div>
      </div>

      <div class="w-full rounded-[2.5rem] p-7 text-white relative overflow-hidden shadow-xl shadow-slate-300/50 group transition-all mb-6"
           style="background: linear-gradient(135deg, #0F172A, #111c33);">
        <div class="absolute top-0 right-0 p-4 opacity-10"><span class="material-symbols-rounded text-9xl">account_balance_wallet</span></div>
        <div class="absolute -bottom-10 -left-10 w-40 h-40 blur-3xl opacity-20" style="background: #F97316"></div>

        <div class="relative z-10">
          <div class="flex justify-between items-start mb-2">
            <p class="text-[10px] font-extrabold uppercase tracking-widest text-slate-400">Kas Organisasi</p>
            <span class="text-[9px] bg-white/10 px-2 py-0.5 rounded-lg text-slate-300 font-bold backdrop-blur-sm">Transparan</span>
          </div>
          <h2 id="cardBalance" class="text-4xl font-black tracking-tight mb-6">Rp 0</h2>

          <div class="flex gap-2">
            <div class="bg-white/10 backdrop-blur-md px-3 py-2.5 rounded-xl flex-1 border border-white/5">
              <div class="flex items-center gap-1 mb-1">
                <span class="material-symbols-rounded text-[10px] text-green-300 bg-green-500/20 p-0.5 rounded-full">arrow_downward</span>
                <span class="text-[9px] uppercase font-bold text-slate-300">Masuk</span>
              </div>
              <p id="cardIncome" class="text-xs font-extrabold text-white">Rp 0</p>
            </div>
            <div class="bg-white/10 backdrop-blur-md px-3 py-2.5 rounded-xl flex-1 border border-white/5">
              <div class="flex items-center gap-1 mb-1">
                <span class="material-symbols-rounded text-[10px] text-red-300 bg-red-500/20 p-0.5 rounded-full">arrow_upward</span>
                <span class="text-[9px] uppercase font-bold text-slate-300">Keluar</span>
              </div>
              <p id="cardExpense" class="text-xs font-extrabold text-white">Rp 0</p>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-6">
        <button onclick="switchView('kegiatan')" class="glass-card p-4 rounded-[1.5rem] flex flex-col items-center justify-center gap-2 tap relative overflow-hidden group">
          <div class="absolute -right-4 -top-4 w-16 h-16 bg-blue-500/10 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
          <span class="material-symbols-rounded text-3xl text-blue-500">calendar_month</span>
          <span class="text-xs font-extrabold" style="color:var(--fg0)">Jadwal</span>
        </button>

        <button onclick="switchView('voting')" class="glass-card p-4 rounded-[1.5rem] flex flex-col items-center justify-center gap-2 tap relative overflow-hidden group">
          <div class="absolute -right-4 -top-4 w-16 h-16 bg-purple-500/10 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
          <span class="material-symbols-rounded text-3xl text-purple-500">how_to_vote</span>
          <span class="text-xs font-extrabold" style="color:var(--fg0)">E-Voting</span>
        </button>

        <button onclick="showIdCard()" class="glass-card p-4 rounded-[1.5rem] flex flex-col items-center justify-center gap-2 tap relative overflow-hidden group">
          <div class="absolute -right-4 -top-4 w-16 h-16 bg-orange-500/10 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
          <span class="material-symbols-rounded text-3xl text-accent">badge</span>
          <span class="text-xs font-extrabold" style="color:var(--fg0)">ID Card</span>
        </button>

        <button onclick="switchView('keuangan')" class="glass-card p-4 rounded-[1.5rem] flex flex-col items-center justify-center gap-2 tap relative overflow-hidden group">
          <div class="absolute -right-4 -top-4 w-16 h-16 bg-green-500/10 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
          <span class="material-symbols-rounded text-3xl text-green-500">receipt_long</span>
          <span class="text-xs font-extrabold" style="color:var(--fg0)">Laporan</span>
        </button>
      </div>

      <div class="mb-4">
        <h3 class="text-xs font-extrabold uppercase tracking-wide mb-3 px-1 flex items-center gap-2" style="color:var(--fg1)">
          <span class="material-symbols-rounded text-accent text-sm">campaign</span> Pengumuman
        </h3>
        <div id="homeNoticeList" class="space-y-3"></div>
      </div>
    </section>

    <section id="view-voting" class="view-section">
      <div class="flex justify-between items-center mb-6 px-1">
        <div>
          <h2 class="text-2xl font-black" style="color:var(--fg0)">E-Voting</h2>
          <p class="text-xs" style="color:var(--fg1)">Suara anda menentukan masa depan</p>
        </div>
      </div>
      <div id="votingList" class="space-y-6"></div>
    </section>

    <section id="view-kegiatan" class="view-section">
      <div class="flex justify-between items-center mb-6 px-1">
        <div>
          <h2 class="text-2xl font-black" style="color:var(--fg0)">Kegiatan</h2>
          <p class="text-xs" style="color:var(--fg1)">Agenda & Jadwal Organisasi</p>
        </div>
      </div>
      <div id="actList" class="space-y-4"></div>
    </section>

    <section id="view-keuangan" class="view-section">
      <div class="flex justify-between items-center mb-6 px-1">
        <div>
          <h2 class="text-2xl font-black" style="color:var(--fg0)">Laporan Kas</h2>
          <p class="text-xs" style="color:var(--fg1)">Transparan & Akuntabel</p>
        </div>
        <div class="px-3 py-1 rounded-full border border-blue-500/20 bg-blue-500/10">
          <p class="text-[9px] font-extrabold text-blue-500 flex items-center gap-1">
            <span class="material-symbols-rounded text-xs">visibility</span> READ ONLY
          </p>
        </div>
      </div>

      <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-2">
        <button onclick="filterFinance('all')" class="tap bg-brand-primary text-white px-4 py-2 rounded-full text-xs font-extrabold whitespace-nowrap shadow-md">Semua</button>
        <button onclick="filterFinance('income')" class="tap glass-card text-green-600 px-4 py-2 rounded-full text-xs font-extrabold whitespace-nowrap">Pemasukan</button>
        <button onclick="filterFinance('expense')" class="tap glass-card text-red-500 px-4 py-2 rounded-full text-xs font-extrabold whitespace-nowrap">Pengeluaran</button>
      </div>

      <div id="finList" class="space-y-3"></div>
    </section>

    <section id="view-anggota" class="view-section">
      <div class="flex justify-between items-center mb-4 px-1">
        <div>
          <h2 class="text-2xl font-black" style="color:var(--fg0)">Anggota</h2>
          <p class="text-xs" style="color:var(--fg1)">Daftar teman organisasi</p>
        </div>
        <div id="onlineBadgeContainer" class="hidden text-[10px] border border-green-500/20 bg-green-500/10 text-green-600 px-3 py-1.5 rounded-full font-extrabold flex items-center gap-1.5 shadow-sm">
          <span class="relative flex h-2 w-2">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
          </span>
          <span id="onlineCountText">0 Online</span>
        </div>
      </div>

      <div id="memberList" class="grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
    </section>

    <section id="view-profile" class="view-section">
      <div class="flex flex-col items-center pt-4">
        <div class="relative group cursor-pointer tap" onclick="$('profileUpload').click()">
          <img id="profileImage" src="https://via.placeholder.com/150" class="w-28 h-28 rounded-full object-cover border-4 border-white shadow-xl shadow-slate-200" alt="Profil">
          <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
            <span class="material-symbols-rounded text-white">photo_camera</span>
          </div>
          <div class="absolute bottom-1 right-1 bg-accent p-1.5 rounded-full border-2 border-white shadow-sm">
            <span class="material-symbols-rounded text-white text-sm block">edit</span>
          </div>
        </div>
        <input type="file" id="profileUpload" class="hidden" accept="image/*" onchange="previewProfileImage(this)">

        <h2 id="profileNameDisplay" class="text-xl font-extrabold mt-4 mb-0.5" style="color:var(--fg0)">Nama Anggota</h2>
        <div id="profileRoleBadge" class="px-3 py-0.5 bg-blue-500/10 text-blue-500 rounded-full text-[10px] font-extrabold uppercase tracking-wide mb-1">ANGGOTA</div>
        <p id="profileEmailDisplay" class="text-sm" style="color:var(--fg1)">email@user.com</p>

        <button onclick="showIdCard()" class="tap mt-3 text-[10px] font-extrabold bg-brand-primary text-white px-3 py-1.5 rounded-lg flex items-center gap-1 shadow-lg">
          <span class="material-symbols-rounded text-xs">badge</span> KARTU DIGITAL
        </button>

        <div class="w-full mt-8 space-y-4 px-1">
          <div class="glass-card p-5 rounded-3xl space-y-4">
            <div>
              <label class="text-[10px] font-extrabold ml-1 uppercase flex items-center gap-1" style="color:var(--fg1)"><span class="material-symbols-rounded text-sm">badge</span> Nama Lengkap</label>
              <input id="editName" type="text" class="focus-ring w-full p-3 rounded-xl text-sm font-bold mt-1 outline-none"
                     style="background: rgba(148,163,184,.10); border: 1px solid rgba(148,163,184,.18); color: var(--fg0)">
            </div>
            <div>
              <label class="text-[10px] font-extrabold ml-1 uppercase flex items-center gap-1" style="color:var(--fg1)"><span class="material-symbols-rounded text-sm">call</span> No. WhatsApp</label>
              <input id="editPhone" type="tel" placeholder="08..." class="focus-ring w-full p-3 rounded-xl text-sm font-bold mt-1 outline-none"
                     style="background: rgba(148,163,184,.10); border: 1px solid rgba(148,163,184,.18); color: var(--fg0)">
            </div>
            <div>
              <label class="text-[10px] font-extrabold ml-1 uppercase flex items-center gap-1" style="color:var(--fg1)"><span class="material-symbols-rounded text-sm">home_pin</span> Alamat</label>
              <textarea id="editAddress" rows="2" class="focus-ring w-full p-3 rounded-xl text-sm font-medium mt-1 outline-none resize-none"
                        style="background: rgba(148,163,184,.10); border: 1px solid rgba(148,163,184,.18); color: var(--fg0)"></textarea>
            </div>
          </div>

          <button onclick="saveProfile(event)" class="tap focus-ring w-full py-4 rounded-2xl font-extrabold text-white shadow-lg overflow-hidden relative group"
                  style="background: linear-gradient(135deg, #0F172A, #111c33);">
            SIMPAN PROFIL
            <span class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity"><span class="absolute -left-1/2 top-0 h-full w-1/2 bg-white/15 skew-x-[-18deg] animate-sheen"></span></span>
          </button>

          <button id="logoutBtn" class="tap focus-ring w-full py-4 rounded-2xl font-extrabold flex items-center justify-center gap-2"
                  style="background: rgba(239,68,68,.12); color: rgb(239,68,68)">
            <span class="material-symbols-rounded">logout</span> KELUAR
          </button>
        </div>
      </div>
    </section>

  </main>

  <nav class="fixed bottom-0 w-full glass-nav pb-6 pt-2 px-4 z-50 rounded-t-[2rem]">
    <div class="flex justify-between items-center max-w-sm mx-auto">
      <button onclick="switchView('home')" class="nav-btn active flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="home">
        <span class="material-symbols-rounded text-2xl" style="color:rgba(148,163,184,.9)">grid_view</span>
        <p class="text-[10px] font-medium" style="color:rgba(148,163,184,.9)">Home</p>
      </button>

      <button onclick="switchView('kegiatan')" class="nav-btn flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="kegiatan">
        <span class="material-symbols-rounded text-2xl" style="color:rgba(148,163,184,.9)">event_note</span>
        <p class="text-[10px] font-medium" style="color:rgba(148,163,184,.9)">Acara</p>
      </button>

      <div class="relative -top-6">
        <button onclick="switchView('profile')" class="nav-btn w-14 h-14 rounded-full flex items-center justify-center shadow-xl shadow-slate-900/20 hover:scale-105 active:scale-95 transition-all ring-4 ring-white dark:ring-slate-800"
                style="background: linear-gradient(135deg, #0F172A, #111c33); color: white;" data-target="profile">
          <span class="material-symbols-rounded text-3xl">person</span>
        </button>
      </div>

      <button onclick="switchView('keuangan')" class="nav-btn flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="keuangan">
        <span class="material-symbols-rounded text-2xl" style="color:rgba(148,163,184,.9)">account_balance_wallet</span>
        <p class="text-[10px] font-medium" style="color:rgba(148,163,184,.9)">Kas</p>
      </button>

      <button onclick="switchView('anggota')" class="nav-btn flex flex-col items-center gap-1 p-2 w-14 transition-all" data-target="anggota">
        <span class="material-symbols-rounded text-2xl" style="color:rgba(148,163,184,.9)">groups</span>
        <p class="text-[10px] font-medium" style="color:rgba(148,163,184,.9)">Grup</p>
      </button>
    </div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, query, where, orderBy, limit, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
      authDomain: "katar-9cac3.firebaseapp.com",
      projectId: "katar-9cac3",
      storageBucket: "katar-9cac3.firebasestorage.app",
      messagingSenderId: "1017734829960",
      appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const CLOUD_NAME = "dbxktcwug";
    const PRESET = "Karteji";

    window.$ = (id) => document.getElementById(id);
    let ME_UID = null;
    let ME_DATA = null;
    let newProfileFile = null;

    const fmtIDR = (n) => Number(n || 0).toLocaleString("id-ID");
    function clean(text) { if (!text) return ""; return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

    // Theme
    const btnTheme = document.getElementById("btn-theme");
    const themeIcon = document.getElementById("themeIcon");
    function getTheme(){ return document.documentElement.getAttribute('data-theme') || 'light'; }
    function setTheme(next){
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('kte_theme', next);
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta) meta.setAttribute('content', next === 'dark' ? '#0B1120' : '#F8FAFC');
      if(themeIcon) themeIcon.textContent = (next === 'dark') ? 'light_mode' : 'dark_mode';
    }
    function toggleTheme(){ setTheme(getTheme() === 'dark' ? 'light' : 'dark'); }
    setTheme(getTheme());
    btnTheme?.addEventListener("click", toggleTheme);

    // UX
    window.showToast = (msg, type = 'success') => {
      const container = $('toastContainer');
      const el = document.createElement('div');
      const isErr = type === 'error';
      el.className = `glass-card px-4 py-3 rounded-xl flex items-center gap-3 animate-slide-in-top pointer-events-auto min-w-[200px] border-l-4 ${isErr ? 'border-red-500' : 'border-green-500'}`;
      el.innerHTML = `
        <span class="material-symbols-rounded ${isErr ? 'text-red-500' : 'text-green-500'}">${isErr ? 'error' : 'check_circle'}</span>
        <span class="text-xs font-extrabold" style="color:var(--fg0)">${clean(msg)}</span>
      `;
      container.appendChild(el);
      setTimeout(() => {
        el.style.opacity = '0'; el.style.transform = 'translateY(-20px)';
        setTimeout(() => el.remove(), 300);
      }, 2500);
    };

    window.toggleLoader = (show) => {
      const l = $("globalLoader");
      if (!l) return;
      if (show) { l.classList.remove('hidden'); l.classList.add('flex'); }
      else { l.classList.add('hidden'); l.classList.remove('flex'); }
    };

    window.closeModal = () => {
      const m = $("crudModal");
      m.classList.add('hidden');
      m.classList.remove('flex');
    };

    window.showModal = (title, bodyHtml, onSave) => {
      $("modalTitle").textContent = title;
      $("modalBody").innerHTML = bodyHtml;
      const m = $("crudModal");
      m.classList.remove('hidden'); m.classList.add('flex');

      const btn = $("modalSubmitBtn");
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      newBtn.onclick = onSave || null;
      newBtn.style.display = onSave ? 'block' : 'none';
    };

    window.switchView = (viewId) => {
      document.querySelectorAll('.view-section').forEach(el => {
        el.classList.remove('active');
        setTimeout(() => { if (!el.classList.contains('active')) el.style.display = 'none'; }, 200);
      });

      setTimeout(() => {
        const target = $(`view-${viewId}`);
        if(target) { target.style.display = 'block'; setTimeout(() => target.classList.add('active'), 20); }
      }, 200);

      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      const activeBtn = document.querySelector(`.nav-btn[data-target="${viewId}"]`);
      if (activeBtn) activeBtn.classList.add('active');

      if (viewId === 'home') refreshAll();
      if (viewId === 'profile') loadProfileData();
      if (viewId === 'voting') loadPolls();
      if (viewId === 'kegiatan') loadActivities();
      if (viewId === 'keuangan') loadFinance();
      if (viewId === 'anggota') loadMembers();
    };

    function animateValue(obj, start, end, duration) {
      if (!obj) return;
      let startTimestamp = null;
      const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.innerHTML = "Rp " + Math.floor(progress * (end - start) + start).toLocaleString('id-ID');
        if (progress < 1) window.requestAnimationFrame(step);
      };
      window.requestAnimationFrame(step);
    }

    // -----------------------------
    // Shared Geo + Reverse
    // -----------------------------
    async function getCoords(){
      return new Promise((resolve, reject)=>{
        if(!navigator.geolocation) return reject(new Error("Geolocation tidak didukung."));
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
          err => reject(err),
          { enableHighAccuracy: false, timeout: 8000, maximumAge: 600000 }
        );
      });
    }

    async function reverseGeocode(lat, lon){
      try{
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
        const res = await fetch(url, { headers: { "Accept":"application/json" } });
        const j = await res.json();
        const a = j.address || {};
        return (a.city || a.town || a.village || a.suburb || a.county || "Lokasi Anda") + (a.state ? `, ${a.state}` : "");
      }catch(_){
        return "Lokasi Anda";
      }
    }

    // -----------------------------
    // ✅ WEATHER — Open-Meteo (tanpa API key)
    // -----------------------------
    const WEATHER_CACHE_KEY = "kte_weather_cache_v1";
    const WEATHER_CACHE_TTL = 10 * 60 * 1000; // 10 menit

    function weatherIcon(code, isDay=true){
      const m = {
        clear: isDay ? "sunny" : "nights_stay",
        cloudy: "cloud",
        fog: "foggy",
        drizzle: "grain",
        rain: "rainy",
        snow: "ac_unit",
        storm: "thunderstorm"
      };
      if (code === 0) return { icon: m.clear, label: "Cerah" };
      if ([1,2].includes(code)) return { icon: m.cloudy, label: code===1 ? "Cerah Berawan" : "Berawan" };
      if (code === 3) return { icon: m.cloudy, label: "Mendung" };
      if ([45,48].includes(code)) return { icon: m.fog, label: "Berkabut" };
      if ([51,53,55,56,57].includes(code)) return { icon: m.drizzle, label: "Gerimis" };
      if ([61,63,65,66,67,80,81,82].includes(code)) return { icon: m.rain, label: "Hujan" };
      if ([71,73,75,77,85,86].includes(code)) return { icon: m.snow, label: "Salju" };
      if ([95,96,99].includes(code)) return { icon: m.storm, label: "Badai Petir" };
      return { icon: m.cloudy, label: "Cuaca" };
    }

    function setWeatherLoading(loading){
      const sk = $("weatherSkeleton");
      if(sk) sk.style.display = loading ? "block" : "none";
    }

    function setWeatherError(msg){
      $("weatherPlace").textContent = "Cuaca";
      $("weatherTemp").textContent = "--°";
      $("weatherCond").textContent = "—";
      $("weatherMeta").textContent = "—";
      $("weatherUpdated").textContent = "--:--";
      $("weatherIcon").textContent = "cloud_off";
      $("weatherHint").textContent = msg || "Gagal memuat cuaca.";
      setWeatherLoading(false);
    }

    async function fetchWeather(lat, lon){
      const tz = "Asia/Jakarta";
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=${encodeURIComponent(tz)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error("Weather API error");
      return await res.json();
    }

    window.loadWeather = async (force=false) => {
      try{
        setWeatherLoading(true);

        const cached = localStorage.getItem(WEATHER_CACHE_KEY);
        if(!force && cached){
          const c = JSON.parse(cached);
          if(c?.ts && (Date.now()-c.ts) < WEATHER_CACHE_TTL && c?.data){
            applyWeatherUI(c.data);
            setWeatherLoading(false);
            return;
          }
        }

        const { lat, lon } = await getCoords();
        const [place, data] = await Promise.all([
          reverseGeocode(lat, lon),
          fetchWeather(lat, lon)
        ]);

        const payload = { place, data };
        localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify({ ts: Date.now(), data: payload }));
        applyWeatherUI(payload);
        setWeatherLoading(false);
      }catch(e){
        const msg = (e && e.code === 1)
          ? "Izin lokasi ditolak. Aktifkan Location untuk menampilkan cuaca."
          : "Cuaca tidak bisa dimuat. Coba refresh.";
        setWeatherError(msg);
      }
    };

    function applyWeatherUI(payload){
      const place = payload.place || "Lokasi Anda";
      const cw = payload.data?.current_weather;
      if(!cw){
        setWeatherError("Data cuaca kosong.");
        return;
      }

      const temp = Math.round(cw.temperature);
      const wind = Math.round(cw.windspeed);
      const code = cw.weathercode;
      const isDay = !!cw.is_day;
      const w = weatherIcon(code, isDay);

      $("weatherPlace").textContent = place;
      $("weatherTemp").textContent = `${temp}°`;
      $("weatherCond").textContent = w.label.toUpperCase();
      $("weatherMeta").textContent = `Angin ${wind} km/jam • ${isDay ? "Siang" : "Malam"}`;
      $("weatherIcon").textContent = w.icon;

      const now = new Date();
      $("weatherUpdated").textContent = now.toLocaleTimeString("id-ID", { hour:"2-digit", minute:"2-digit" });
      $("weatherHint").textContent = "Data dari Open-Meteo (tanpa API key).";
    }

    // -----------------------------
    // ✅ JADWAL SHOLAT + IMSAK — Aladhan (tanpa API key)
    // -----------------------------
    const PRAYER_CACHE_KEY = "kte_prayer_cache_v1";

    function setPrayerLoading(loading){
      const sk = $("prayerSkeleton");
      if(sk) sk.style.display = loading ? "block" : "none";
    }

    function setPrayerError(msg){
      $("prayerPlace").textContent = "Jadwal Sholat";
      $("nextPrayerName").textContent = "—";
      $("nextPrayerTime").textContent = "--:--";
      $("prayerDate").textContent = "—";
      $("prayerUpdated").textContent = "--:--";
      ["tImsak","tFajr","tDhuhr","tAsr","tMaghrib","tIsha"].forEach(id => { const el=$(id); if(el) el.textContent="--:--"; });
      $("prayerHint").textContent = msg || "Gagal memuat jadwal sholat.";
      setPrayerLoading(false);
    }

    function onlyHHMM(t){
      if(!t) return "--:--";
      return String(t).replace(/\s*\(.*\)\s*/g,"").trim().slice(0,5);
    }

    function dateKeyJakarta(d=new Date()){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function parseTimeToday(hhmm){
      const [h,m] = (hhmm||"00:00").split(":").map(x=>parseInt(x,10));
      const d = new Date();
      d.setHours(h||0, m||0, 0, 0);
      return d.getTime();
    }

    function computeNextPrayer(timings){
      const now = Date.now();
      const order = [
        { key: "Imsak", label: "Imsak" },
        { key: "Fajr", label: "Subuh" },
        { key: "Dhuhr", label: "Dzuhur" },
        { key: "Asr", label: "Ashar" },
        { key: "Maghrib", label: "Maghrib" },
        { key: "Isha", label: "Isya" },
      ];
      for(const it of order){
        const hhmm = onlyHHMM(timings[it.key]);
        const ts = parseTimeToday(hhmm);
        if(ts > now) return { name: it.label, time: hhmm };
      }
      // fallback: sudah lewat semua => tampilkan Imsak besok (estimasi: ambil Imsak hari ini sebagai "besok" fallback)
      return { name: "Imsak (Besok)", time: onlyHHMM(timings["Imsak"] || timings["Fajr"]) };
    }

    async function fetchPrayer(lat, lon){
      const tz = "Asia/Jakarta";
      const url = `https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=20&timezonestring=${encodeURIComponent(tz)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error("Prayer API error");
      return await res.json();
    }

    window.loadPrayer = async (force=false) => {
      try{
        setPrayerLoading(true);
        const todayKey = dateKeyJakarta();

        const cached = localStorage.getItem(PRAYER_CACHE_KEY);
        if(!force && cached){
          const c = JSON.parse(cached);
          if(c?.key === todayKey && c?.data){
            applyPrayerUI(c.data);
            setPrayerLoading(false);
            return;
          }
        }

        const { lat, lon } = await getCoords();
        const [place, raw] = await Promise.all([
          reverseGeocode(lat, lon),
          fetchPrayer(lat, lon)
        ]);

        const data = { place, raw };
        localStorage.setItem(PRAYER_CACHE_KEY, JSON.stringify({ key: todayKey, ts: Date.now(), data }));
        applyPrayerUI(data);
        setPrayerLoading(false);
      }catch(e){
        const msg = (e && e.code === 1)
          ? "Izin lokasi ditolak. Aktifkan Location untuk menampilkan jadwal sholat."
          : "Jadwal sholat tidak bisa dimuat. Coba refresh.";
        setPrayerError(msg);
      }
    };

    function applyPrayerUI(payload){
      const place = payload.place || "Lokasi Anda";
      const raw = payload.raw;
      const timings = raw?.data?.timings;
      const readable = raw?.data?.date?.readable || "-";

      if(!timings){
        setPrayerError("Data jadwal kosong.");
        return;
      }

      $("prayerPlace").textContent = place;
      $("prayerDate").textContent = `Tanggal: ${readable}`;
      $("tImsak").textContent = onlyHHMM(timings.Imsak || timings.Fajr);
      $("tFajr").textContent = onlyHHMM(timings.Fajr);
      $("tDhuhr").textContent = onlyHHMM(timings.Dhuhr);
      $("tAsr").textContent = onlyHHMM(timings.Asr);
      $("tMaghrib").textContent = onlyHHMM(timings.Maghrib);
      $("tIsha").textContent = onlyHHMM(timings.Isha);

      const next = computeNextPrayer(timings);
      $("nextPrayerName").textContent = next.name;
      $("nextPrayerTime").textContent = next.time;

      const now = new Date();
      $("prayerUpdated").textContent = now.toLocaleTimeString("id-ID", { hour:"2-digit", minute:"2-digit" });
      $("prayerHint").textContent = "Data jadwal dari Aladhan (tanpa API key).";
    }

    // -----------------------------
    // ID Card
    // -----------------------------
    window.showIdCard = async () => {
      toggleLoader(true);
      try {
        const u = ME_DATA || (await getDoc(doc(db, "users", ME_UID))).data();
        const html = `
          <div class="p-4 rounded-xl relative overflow-hidden shadow-xl"
               style="background: linear-gradient(135deg, #0F172A, #000); color: white; border: 1px solid rgba(148,163,184,.25)">
            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
            <div class="flex justify-between items-start">
              <div class="text-[10px] font-extrabold tracking-widest bg-white/15 px-2 py-0.5 rounded">KARTEJI</div>
              <div id="qrcode" class="bg-white p-1 rounded"></div>
            </div>
            <div class="flex gap-4 items-center mt-3">
              <img src="${u.photo?.url || 'https://via.placeholder.com/150'}" class="w-16 h-16 rounded-xl object-cover bg-slate-700 border border-slate-500" alt="Foto">
              <div class="min-w-0">
                <h3 class="text-lg font-extrabold leading-none truncate">${clean(u.name)}</h3>
                <p class="text-[10px] text-slate-300 mt-1 uppercase">${u.role || 'ANGGOTA'}</p>
                <p class="text-[9px] text-slate-400 mt-0.5 tracking-wider">${String(ME_UID).substring(0,8).toUpperCase()}</p>
              </div>
            </div>
            <div class="mt-4 pt-3 border-t border-white/10 flex justify-between items-end">
              <div>
                <p class="text-[8px] text-slate-300">Valid Until</p>
                <p class="text-[10px] font-extrabold">MEMBERSHIP ACTIVE</p>
              </div>
              <div class="w-16 h-4 bg-white/20 skew-x-[-20deg]"></div>
            </div>
          </div>
          <p class="text-center text-xs mt-4" style="color:var(--fg1)">Scan QR untuk verifikasi kehadiran.</p>
        `;
        showModal("Kartu Anggota Digital", html, null);
        setTimeout(() => {
          const q = document.getElementById("qrcode");
          if(q){
            q.innerHTML = "";
            new QRCode(q, { text: ME_UID, width: 40, height: 40 });
          }
        }, 100);
      } finally { toggleLoader(false); }
    }

    // Upload Cloudinary
    async function upload(file) {
      if (!file) return null;
      if (!file.type.startsWith('image/')) { showToast("File harus gambar!", "error"); return null; }
      const fd = new FormData(); fd.append("file", file); fd.append("upload_preset", PRESET);
      const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: fd });
      const data = await res.json();
      if (data?.error) throw new Error(data.error.message);
      return { url: data.secure_url };
    }

    // Auth bootstrap
    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "login.html";
      ME_UID = user.uid;
      const snap = await getDoc(doc(db, "users", ME_UID));
      if (!snap.exists()) { showToast("User error", "error"); return; }
      ME_DATA = snap.data();

      const pUrl = ME_DATA.photo?.url || "https://via.placeholder.com/150";
      $("headerName").textContent = clean(ME_DATA.name);
      $("headerPhoto").src = pUrl;

      // Presence
      const updatePresence = () => updateDoc(doc(db, "users", ME_UID), { lastSeen: serverTimestamp() }).catch(()=>{});
      updatePresence(); setInterval(updatePresence, 60000);

      // ✅ load widgets pertama kali (pakai cache)
      loadWeather(false);
      loadPrayer(false);

      await refreshAll();
      await loadProfileData();
    });

    window.refreshAll = async () => {
      // widget refresh (tanpa force)
      loadWeather(false);
      loadPrayer(false);
      await Promise.all([loadActivities(), loadNotifications(), loadFinance(), loadMembers(), loadArisanWinner()]);
    };

    // Arisan
    async function loadArisanWinner() {
      try {
        const qy = query(collection(db, "arisan_history"), orderBy("createdAt", "desc"), limit(1));
        const snap = await getDocs(qy);

        const badge = $("arisanBadge");

        if (!snap.empty) {
          const data = snap.docs[0].data();
          $("arisanName").textContent = clean(data.name);
          $("arisanPhoto").src = data.photo || "https://via.placeholder.com/100";
          const dt = data.createdAt?.seconds ? new Date(data.createdAt.seconds * 1000) : new Date();
          $("arisanDate").textContent = "Pemenang Periode " + dt.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
          badge.classList.remove('hidden');
        } else {
          $("arisanName").textContent = "Belum ada pemenang";
          $("arisanDate").textContent = "Menunggu pengundian...";
          $("arisanPhoto").src = "https://via.placeholder.com/100?text=?";
          badge.classList.add('hidden');
        }
      } catch (e) {
        // biarkan widget tetap tampil
      }
    }

    // Voting
    window.loadPolls = async () => {
      const list = $("votingList");
      list.innerHTML = `<div class="flex justify-center"><div class="w-8 h-8 border-4 border-slate-200 border-t-purple-500 rounded-full animate-spin"></div></div>`;
      try {
        const qy = query(collection(db, "polls"), where("status", "==", "active"));
        const snap = await getDocs(qy);
        const polls = [];
        snap.forEach(d => polls.push({ id: d.id, ...d.data() }));
        polls.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));

        list.innerHTML = "";
        if (!polls.length) {
          list.innerHTML = `<div class="glass-card p-6 text-center"><p class="text-xs font-bold" style="color:var(--fg1)">Tidak ada voting aktif.</p></div>`;
          return;
        }

        polls.forEach(poll => {
          const hasVoted = poll.voters && poll.voters.includes(ME_UID);
          const totalVotes = (poll.options || []).reduce((acc, curr) => acc + (curr.count || 0), 0);
          let optionsHtml = '';
          (poll.options || []).forEach((opt, idx) => {
            const percent = totalVotes === 0 ? 0 : Math.round(((opt.count || 0) / totalVotes) * 100);
            if (hasVoted) {
              optionsHtml += `
                <div class="mb-3">
                  <div class="flex justify-between text-[10px] font-extrabold mb-1" style="color:var(--fg1)">
                    <span>${clean(opt.text)}</span>
                    <span>${percent}%</span>
                  </div>
                  <div class="w-full bg-slate-200 rounded-full h-2.5 overflow-hidden dark:bg-slate-700">
                    <div class="bg-purple-500 h-2.5 rounded-full" style="width:${percent}%"></div>
                  </div>
                </div>`;
            } else {
              optionsHtml += `
                <button onclick="submitVote('${poll.id}', ${idx})" class="tap w-full text-left p-3 rounded-xl border border-slate-200 dark:border-slate-700 mb-2 hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all flex items-center justify-between group">
                  <span class="font-bold text-xs" style="color:var(--fg0)">${clean(opt.text)}</span>
                  <span class="material-symbols-rounded text-slate-300 group-hover:text-purple-500">radio_button_unchecked</span>
                </button>`;
            }
          });

          list.innerHTML += `
            <div class="glass-card p-5 rounded-[1.5rem] relative overflow-hidden">
              ${hasVoted ? '<div class="absolute top-0 right-0 bg-green-500/20 text-green-600 text-[9px] font-extrabold px-3 py-1 rounded-bl-xl">SUDAH MEMILIH</div>' : ''}
              <h3 class="font-extrabold text-sm mb-1" style="color:var(--fg0)">${clean(poll.title)}</h3>
              <p class="text-[10px] mb-4" style="color:var(--fg1)">${clean(poll.description)}</p>
              <div class="space-y-1">${optionsHtml}</div>
            </div>`;
        });
      } catch (e) { list.innerHTML = `<div class="glass-card p-6 text-center"><p class="text-xs font-bold" style="color:var(--fg1)">Gagal memuat voting.</p></div>`; }
    };

    window.submitVote = async (pollId, idx) => {
      if (!confirm("Kirim suara anda?")) return;
      toggleLoader(true);
      try {
        const ref = doc(db, "polls", pollId);
        const snap = await getDoc(ref);
        const d = snap.data();
        if (d.voters?.includes(ME_UID)) throw new Error("Sudah memilih!");
        const opts = [...(d.options || [])];
        if(!opts[idx]) throw new Error("Opsi tidak valid.");
        opts[idx].count = (opts[idx].count || 0) + 1;
        await updateDoc(ref, { options: opts, voters: arrayUnion(ME_UID) });
        showToast("Voting berhasil!");
        loadPolls();
      } catch (e) { showToast(e.message || "Gagal voting", "error"); }
      finally { toggleLoader(false); }
    };

    // Profile
    async function loadProfileData() {
      try {
        const snap = await getDoc(doc(db, "users", ME_UID));
        if (snap.exists()) {
          const d = snap.data();
          $("headerName").textContent = clean(d.name);
          $("headerPhoto").src = d.photo?.url || "https://via.placeholder.com/150";

          $("profileImage").src = d.photo?.url || "https://via.placeholder.com/150";
          $("profileNameDisplay").textContent = clean(d.name);
          $("profileEmailDisplay").textContent = clean(d.email || "");

          $("editName").value = d.name || "";
          $("editPhone").value = d.phone || "";
          $("editAddress").value = d.address || "";
        }
      } catch (e) {}
    }

    window.previewProfileImage = (input) => {
      if (input.files && input.files[0]) {
        newProfileFile = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => $("profileImage").src = e.target.result;
        reader.readAsDataURL(input.files[0]);
      }
    };

    window.saveProfile = async (ev) => {
      const btn = ev?.target; if(btn){ btn.innerText="MENYIMPAN..."; btn.disabled=true; }
      toggleLoader(true);
      try {
        const up = {
          name: $("editName").value || "",
          phone: $("editPhone").value || "",
          address: $("editAddress").value || ""
        };
        if (newProfileFile) { const res = await upload(newProfileFile); up.photo = res; }
        await updateDoc(doc(db, "users", ME_UID), up);
        showToast("Profil disimpan!");
        await loadProfileData();
      } catch (e) { showToast("Gagal simpan", "error"); }
      finally { toggleLoader(false); if(btn){ btn.innerText="SIMPAN PROFIL"; btn.disabled=false; } }
    };

    // Activities
    async function loadActivities() {
      const list = $("actList"); if(list) list.innerHTML = "";
      try {
        const snap = await getDocs(collection(db, "activities"));
        const rows = []; snap.forEach(d => rows.push({id:d.id, ...d.data()}));
        rows.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));

        if(!rows.length) {
          if(list) list.innerHTML = `<p class="text-center text-xs" style="color:var(--fg1)">Belum ada agenda.</p>`;
          return;
        }

        rows.forEach(x => {
          list.innerHTML += `
            <div class="glass-card rounded-[1.5rem] overflow-hidden flex h-24 relative">
              ${x.cover?.url ? `<img src="${x.cover.url}" class="w-24 h-full object-cover shrink-0" alt="Cover">` : ''}
              <div class="p-3 flex flex-col justify-center min-w-0">
                <span class="text-[9px] font-extrabold uppercase text-blue-500 mb-0.5">${clean(x.date)}</span>
                <h4 class="font-extrabold text-sm line-clamp-2 leading-tight" style="color:var(--fg0)">${clean(x.title)}</h4>
                <p class="text-[10px] mt-1 flex items-center gap-1" style="color:var(--fg1)">
                  <span class="material-symbols-rounded text-xs">location_on</span> ${clean(x.location)}
                </p>
              </div>
            </div>`;
        });
      } catch(e) {
        if(list) list.innerHTML = `<p class="text-center text-xs" style="color:var(--fg1)">Gagal memuat kegiatan.</p>`;
      }
    }

    // Notifications
    async function loadNotifications() {
      const list = $("homeNoticeList"); if(list) list.innerHTML = "";
      try {
        const snap = await getDocs(query(collection(db, "notifications"), orderBy("createdAt","desc"), limit(3)));
        if(snap.empty){
          if(list) list.innerHTML = `<p class="text-xs italic" style="color:var(--fg1)">Belum ada pengumuman.</p>`;
          return;
        }
        snap.forEach(d => {
          const x = d.data();
          list.innerHTML += `
            <div class="glass-card p-3 rounded-xl border-l-4 ${x.level==='important'?'border-red-500':'border-accent'}">
              <h4 class="font-extrabold text-xs uppercase mb-1" style="color:var(--fg0)">${clean(x.title)}</h4>
              <p class="text-[10px] line-clamp-2" style="color:var(--fg1)">${clean(x.body)}</p>
            </div>`;
        });
      } catch(e) {
        if(list) list.innerHTML = `<p class="text-xs italic" style="color:var(--fg1)">Gagal memuat pengumuman.</p>`;
      }
    }

    // Finance
    window.allFinanceData = [];
    window.filterFinance = (type) => {
      const list = $("finList"); if(list) list.innerHTML = "";
      const filtered = type === 'all' ? window.allFinanceData : window.allFinanceData.filter(f => f.type === type);
      if(!filtered.length) {
        if(list) list.innerHTML = `<p class="text-center text-xs mt-4" style="color:var(--fg1)">Tidak ada data.</p>`;
        return;
      }

      filtered.forEach(f => {
        const isInc = f.type === 'income';
        list.innerHTML += `
          <div class="glass-card p-3 rounded-2xl flex justify-between items-center animate-[slideInTop_.2s]">
            <div class="flex items-center gap-3 min-w-0">
              <div class="w-9 h-9 rounded-full ${isInc?'bg-green-500/10 text-green-600':'bg-red-500/10 text-red-500'} flex items-center justify-center">
                <span class="material-symbols-rounded text-lg">${isInc?'arrow_downward':'arrow_upward'}</span>
              </div>
              <div class="min-w-0">
                <p class="text-xs font-extrabold line-clamp-1" style="color:var(--fg0)">${clean(f.note)}</p>
                <p class="text-[9px]" style="color:var(--fg1)">${f.createdAt?.seconds ? new Date(f.createdAt.seconds*1000).toLocaleDateString("id-ID") : '-'}</p>
              </div>
            </div>
            <span class="font-extrabold text-xs ${isInc?'text-green-600':'text-red-500'} whitespace-nowrap">${isInc?'+':'-'} ${fmtIDR(f.amount)}</span>
          </div>`;
      });
    };

    async function loadFinance() {
      try {
        const snap = await getDocs(collection(db, "financial_records"));
        let bal=0, inc=0, exp=0; window.allFinanceData = [];
        snap.forEach(d => {
          const f = d.data(); window.allFinanceData.push({id:d.id, ...f});
          const amt = Number(f.amount)||0;
          if(f.type==="income"){inc+=amt; bal+=amt;} else {exp+=amt; bal-=amt;}
        });
        window.allFinanceData.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        animateValue($("cardBalance"), 0, bal, 1000);
        $("cardIncome").textContent = `Rp ${fmtIDR(inc)}`;
        $("cardExpense").textContent = `Rp ${fmtIDR(exp)}`;
        filterFinance('all');
      } catch(e) {}
    }

    // Members
    async function loadMembers() {
      const list = $("memberList"); if(list) list.innerHTML = "";
      try {
        const snap = await getDocs(collection(db, "users"));
        const rows = []; snap.forEach(d => rows.push({id:d.id, ...d.data()}));
        let onlineCount = 0; const now = Date.now();

        rows.forEach(u => {
          const last = u.lastSeen?.seconds ? u.lastSeen.seconds*1000 : 0;
          const isOnline = (now - last) <= 120000;
          if(isOnline) onlineCount++;

          list.innerHTML += `
            <div class="glass-card p-3 rounded-2xl flex flex-col items-center gap-2 relative group tap">
              <div class="relative">
                <img src="${u.photo?.url||'https://via.placeholder.com/100'}" class="h-12 w-12 rounded-full object-cover shrink-0 border-2 ${isOnline?'border-green-400 online-ring':'border-slate-200 grayscale opacity-70'}" alt="User">
                ${isOnline ? '<span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></span>' : ''}
              </div>
              <p class="text-[9px] font-extrabold text-center truncate w-full" style="color:var(--fg0)">${clean(u.name)}</p>
              <span class="text-[8px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 dark:bg-slate-800 uppercase">${u.role||'Anggota'}</span>
            </div>`;
        });

        const badge = $("onlineBadgeContainer");
        if(onlineCount > 0) {
          badge.classList.remove('hidden');
          $("onlineCountText").innerText=`${onlineCount} Online`;
        } else {
          badge.classList.add('hidden');
        }
      } catch(e) {}
    }

    // Logout
    $("logoutBtn").onclick = () => signOut(auth).then(()=>location.href="login.html");
  </script>
</body>
</html>
