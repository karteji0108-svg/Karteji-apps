<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anggota | KARTEJI</title>

  <link rel="stylesheet" href="../../dist/assets/css/app.css">
  <link rel="icon" href="../assets/img/logo.png">
</head>

<body class="min-h-full bg-slate-950 text-slate-100">

<header class="sticky top-0 z-20 border-b border-white/10 bg-slate-950/70 backdrop-blur-xl">
  <div class="mx-auto max-w-6xl px-6 py-4 flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <img src="../assets/img/logo.png" class="h-10 w-10 rounded-2xl border border-white/10" alt="Logo">
      <div>
        <div class="text-sm font-extrabold">KARTEJI</div>
        <div class="text-xs text-slate-400">Dashboard Anggota</div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <span id="onlineBadge" class="hidden rounded-2xl border border-emerald-400/30 bg-emerald-400/10 px-3 py-2 text-xs font-extrabold text-emerald-200">
        ONLINE
      </span>
      <button id="logoutBtn"
        class="rounded-2xl bg-rose-500 px-4 py-2 text-xs font-extrabold hover:bg-rose-400 active:scale-[.99]">
        Logout
      </button>
    </div>
  </div>
</header>

<main class="mx-auto max-w-6xl px-6 py-6 space-y-6">

  <!-- Gate -->
  <section id="gate" class="hidden">
    <div class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl">
      <h1 class="text-xl font-extrabold">Akses ditolak</h1>
      <p class="mt-2 text-sm text-slate-300" id="gateMsg">Kamu harus login.</p>
      <div class="mt-5 flex gap-3">
        <a href="../login.html" class="rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300">
          Login
        </a>
        <a href="../index.html" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm font-semibold hover:bg-white/10">
          Kembali
        </a>
      </div>
    </div>
  </section>

  <!-- Content -->
  <section id="content" class="hidden space-y-6">

    <!-- Profile -->
    <section class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-lg font-extrabold">Profil</h2>
          <p class="text-sm text-slate-300">Ubah nama & foto profil.</p>
          <p class="mt-1 text-xs text-slate-400" id="statusMsg"></p>
        </div>

        <div class="flex items-center gap-3">
          <img id="mePhoto" class="h-14 w-14 rounded-2xl border border-white/10 object-cover" src="https://via.placeholder.com/120" alt="Foto">
          <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3">
            <div class="text-xs text-slate-400">Login sebagai</div>
            <div class="text-sm font-extrabold" id="meNameText">-</div>
            <div class="text-xs text-slate-400" id="meRoleText">-</div>
          </div>
        </div>
      </div>

      <div class="mt-5 grid gap-3 sm:grid-cols-3">
        <div>
          <label class="block text-xs font-medium text-slate-400 mb-1">Nama</label>
          <input id="meName"
            class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-emerald-400"
            placeholder="Nama"/>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-400 mb-1">Foto Profil (Cloudinary)</label>
          <input id="mePhotoInput" type="file" accept="image/*"
            class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none" />
        </div>

        <div class="flex items-end">
          <button id="saveProfileBtn"
            class="w-full rounded-2xl bg-emerald-400 px-4 py-3 text-sm font-extrabold text-slate-950 hover:bg-emerald-300 active:scale-[.99]">
            Simpan Profil
          </button>
        </div>
      </div>
    </section>

    <!-- Tabs -->
    <section class="rounded-3xl border border-white/10 bg-white/5 p-4 shadow-2xl">
      <div class="flex flex-wrap gap-2">
        <button class="tabBtn rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-semibold hover:bg-white/10"
          data-tab="kegiatan">Kegiatan</button>

        <button class="tabBtn rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-semibold hover:bg-white/10"
          data-tab="pengumuman">Pengumuman</button>

        <button class="tabBtn rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-semibold hover:bg-white/10"
          data-tab="kas">Kas</button>

        <button class="tabBtn rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-semibold hover:bg-white/10"
          data-tab="anggota">Anggota</button>

        <button id="refreshBtn"
          class="ml-auto rounded-2xl bg-white/10 px-4 py-2 text-xs font-extrabold hover:bg-white/15 active:scale-[.99]">
          Refresh
        </button>
      </div>
    </section>

    <!-- Kegiatan -->
    <section id="tab-kegiatan" class="tabPanel rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl space-y-3">
      <h3 class="text-lg font-extrabold">Kegiatan (Approved)</h3>
      <div id="actList" class="divide-y divide-white/10"></div>
    </section>

    <!-- Pengumuman -->
    <section id="tab-pengumuman" class="tabPanel hidden rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl space-y-3">
      <h3 class="text-lg font-extrabold">Pengumuman</h3>
      <div id="nList" class="divide-y divide-white/10"></div>
    </section>

    <!-- Kas -->
    <section id="tab-kas" class="tabPanel hidden rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl space-y-4">
      <h3 class="text-lg font-extrabold">Ringkasan Kas (Approved)</h3>

      <div class="grid gap-3 sm:grid-cols-3">
        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
          <div class="text-xs text-slate-400">Total Masuk</div>
          <div class="text-xl font-extrabold mt-1" id="sumIncome">Rp 0</div>
        </div>
        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
          <div class="text-xs text-slate-400">Total Keluar</div>
          <div class="text-xl font-extrabold mt-1" id="sumExpense">Rp 0</div>
        </div>
        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
          <div class="text-xs text-slate-400">Saldo</div>
          <div class="text-xl font-extrabold mt-1" id="sumBalance">Rp 0</div>
        </div>
      </div>

      <div class="overflow-hidden rounded-2xl border border-white/10">
        <div class="grid grid-cols-12 bg-white/5 px-4 py-3 text-xs font-semibold text-slate-200">
          <div class="col-span-9">Transaksi</div>
          <div class="col-span-3 text-right">Bukti</div>
        </div>
        <div id="finList" class="divide-y divide-white/10"></div>
      </div>
    </section>

    <!-- Anggota -->
    <section id="tab-anggota" class="tabPanel hidden rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl space-y-3">
      <h3 class="text-lg font-extrabold">Daftar Anggota</h3>
      <p class="text-sm text-slate-300">
        Sesuai aturan: hanya <b>nama</b> + status <b>online/offline</b> (tidak bisa edit).
      </p>

      <div id="memberList" class="divide-y divide-white/10"></div>
      <p class="text-xs text-slate-400 mt-2">Online dihitung dari lastSeen (≤ 2 menit).</p>
    </section>

  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    doc, getDoc, updateDoc,
    collection, getDocs,
    query, where, orderBy, limit,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
    authDomain: "katar-9cac3.firebaseapp.com",
    projectId: "katar-9cac3",
    storageBucket: "katar-9cac3.firebasestorage.app",
    messagingSenderId: "1017734829960",
    appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d",
    measurementId: "G-M4F9J10TTE"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Cloudinary
  const CLOUD_NAME = "dbxktcwug";
  const PRESET_PROFILE = "Karteji";

  async function uploadToCloudinary(file, preset, folder="karteji") {
    const endpoint = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
    const form = new FormData();
    form.append("file", file);
    form.append("upload_preset", preset);
    form.append("folder", folder);

    const res = await fetch(endpoint, { method: "POST", body: form });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.error?.message || "Upload Cloudinary gagal");
    return { url: data.secure_url, publicId: data.public_id, bytes: data.bytes, format: data.format };
  }

  // UI helpers
  const $ = (id) => document.getElementById(id);
  const esc = (s) => String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
  const fmtIDR = (n) => Number(n||0).toLocaleString("id-ID");
  const setStatus = (t) => $("statusMsg").textContent = t || "";

  // Tabs
  function openTab(name) {
    document.querySelectorAll(".tabPanel").forEach(p => p.classList.add("hidden"));
    document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("bg-emerald-400","text-slate-950","font-extrabold"));
    $(`tab-${name}`).classList.remove("hidden");
    document.querySelector(`.tabBtn[data-tab="${name}"]`).classList.add("bg-emerald-400","text-slate-950","font-extrabold");
  }
  document.querySelectorAll(".tabBtn").forEach(btn => btn.addEventListener("click", ()=>openTab(btn.dataset.tab)));

  $("refreshBtn").addEventListener("click", async ()=>{
    await Promise.allSettled([loadActivities(), loadNotifications(), loadFinanceApproved(), loadMembers()]);
    setStatus("Refresh selesai ✅");
  });

  // Auth gate + online heartbeat
  let ME_UID = null;
  let HEARTBEAT = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) return deny("Belum login.");

    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists()) return deny("Profil tidak ditemukan.");

    const me = snap.data();
    // Dashboard anggota boleh untuk semua role yang login (anggota = dashboard umum)
    // Kalau kamu ingin *khusus anggota saja*, ganti ke:
    // if (me?.role !== "anggota") return deny("Khusus Anggota.");
    ME_UID = user.uid;

    $("gate").classList.add("hidden");
    $("content").classList.remove("hidden");

    $("meNameText").textContent = me?.name || "Anggota";
    $("meRoleText").textContent = me?.role || "anggota";
    $("meName").value = me?.name || "";
    $("mePhoto").src = me?.photo?.url || "https://via.placeholder.com/120";

    // set online + heartbeat
    $("onlineBadge").classList.remove("hidden");
    await setLastSeen();
    HEARTBEAT = setInterval(setLastSeen, 60_000); // tiap 60 detik
    window.addEventListener("beforeunload", () => { try { clearInterval(HEARTBEAT); } catch {} });

    openTab("kegiatan");
    await Promise.allSettled([loadActivities(), loadNotifications(), loadFinanceApproved(), loadMembers()]);
    setStatus("Siap ✅");
  });

  async function setLastSeen(){
    if (!ME_UID) return;
    try{
      await updateDoc(doc(db, "users", ME_UID), { lastSeen: serverTimestamp() });
    }catch{}
  }

  function deny(msg){
    $("content").classList.add("hidden");
    $("gate").classList.remove("hidden");
    $("gateMsg").textContent = msg || "Akses ditolak.";
  }

  // Logout
  $("logoutBtn").addEventListener("click", async ()=>{
    try { if (HEARTBEAT) clearInterval(HEARTBEAT); } catch {}
    await signOut(auth);
    location.href = "../login.html";
  });

  // Profile save
  $("saveProfileBtn").addEventListener("click", async ()=>{
    try{
      setStatus("Menyimpan profil...");
      const newName = $("meName").value.trim();
      const file = $("mePhotoInput").files?.[0];

      const payload = {};
      if (newName) payload.name = newName;

      if (file) {
        const media = await uploadToCloudinary(file, PRESET_PROFILE, `karteji/users/${ME_UID}`);
        payload.photo = media;
        $("mePhoto").src = media.url;
      }

      if (!Object.keys(payload).length) return setStatus("Tidak ada perubahan.");
      await updateDoc(doc(db, "users", ME_UID), payload);

      $("meNameText").textContent = payload.name || $("meNameText").textContent;
      setStatus("Profil tersimpan ✅");
    } catch(e){
      setStatus(e.message || "Gagal simpan profil");
    }
  });

  // Kegiatan (approved only)
  async function loadActivities(){
    const list = $("actList");
    list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;

    const q = query(
      collection(db, "activities"),
      where("status","==","approved"),
      orderBy("createdAt","desc"),
      limit(50)
    );
    const snap = await getDocs(q);

    if (snap.empty) {
      list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada kegiatan approved.</div>`;
      return;
    }

    list.innerHTML = "";
    snap.forEach((d)=>{
      const x = d.data();
      const row = document.createElement("div");
      row.className = "px-4 py-3";
      row.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm font-extrabold">${esc(x.title || "-")}</div>
            <div class="text-xs text-slate-400">${esc(x.date || "")} • ${esc(x.location || "")}</div>
            <div class="text-xs text-slate-300 mt-1 whitespace-pre-line">${esc(x.description || "")}</div>
            ${x.cover?.url ? `<div class="text-xs text-slate-400 mt-1">Cover: <a class="text-emerald-300 hover:underline" target="_blank" rel="noreferrer" href="${x.cover.url}">lihat</a></div>` : ``}
          </div>
        </div>
      `;
      list.appendChild(row);
    });
  }

  // Notifications (read-only)
  async function loadNotifications(){
    const list = $("nList");
    list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;

    const q = query(collection(db, "notifications"), orderBy("createdAt","desc"), limit(30));
    const snap = await getDocs(q);

    if (snap.empty) {
      list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada pengumuman.</div>`;
      return;
    }

    list.innerHTML = "";
    snap.forEach((d)=>{
      const x = d.data();
      const badge = x.level === "important"
        ? `<span class="ml-2 rounded-full bg-rose-500/15 text-rose-200 border border-rose-500/20 px-2 py-1 text-[10px] font-extrabold">IMPORTANT</span>`
        : ``;

      const row = document.createElement("div");
      row.className = "px-4 py-3";
      row.innerHTML = `
        <div>
          <div class="text-sm font-extrabold">${esc(x.title || "-")}${badge}</div>
          <div class="text-xs text-slate-300 mt-1 whitespace-pre-line">${esc(x.body || "")}</div>
        </div>
      `;
      list.appendChild(row);
    });
  }

  // Finance approved (read-only + summary)
  async function loadFinanceApproved(){
    const list = $("finList");
    list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;

    let sumIncome = 0;
    let sumExpense = 0;

    const q = query(
      collection(db, "financial_records"),
      where("status","==","approved"),
      orderBy("createdAt","desc"),
      limit(50)
    );
    const snap = await getDocs(q);

    if (snap.empty) {
      list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada transaksi approved.</div>`;
      $("sumIncome").textContent = "Rp 0";
      $("sumExpense").textContent = "Rp 0";
      $("sumBalance").textContent = "Rp 0";
      return;
    }

    list.innerHTML = "";
    snap.forEach((d)=>{
      const x = d.data();
      if (x.type === "income") sumIncome += Number(x.amount||0);
      if (x.type === "expense") sumExpense += Number(x.amount||0);

      const row = document.createElement("div");
      row.className = "px-4 py-3";
      row.innerHTML = `
        <div class="grid grid-cols-12 items-center gap-2">
          <div class="col-span-9">
            <div class="text-sm font-extrabold">${x.type==="income" ? "Kas Masuk" : "Kas Keluar"} • Rp ${fmtIDR(x.amount)}</div>
            <div class="text-xs text-slate-400">${esc(x.category || "-")} • ${esc(x.note || "")}</div>
          </div>
          <div class="col-span-3 text-right text-xs">
            ${x.proof?.url ? `<a class="text-emerald-300 hover:underline" target="_blank" rel="noreferrer" href="${x.proof.url}">lihat</a>` : `<span class="text-slate-500">-</span>`}
          </div>
        </div>
      `;
      list.appendChild(row);
    });

    $("sumIncome").textContent = `Rp ${fmtIDR(sumIncome)}`;
    $("sumExpense").textContent = `Rp ${fmtIDR(sumExpense)}`;
    $("sumBalance").textContent = `Rp ${fmtIDR(sumIncome - sumExpense)}`;
  }

  // Members: name only + online/offline from lastSeen
  async function loadMembers(){
    const list = $("memberList");
    list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Loading...</div>`;

    const q = query(collection(db, "users"), orderBy("name","asc"), limit(300));
    const snap = await getDocs(q);

    if (snap.empty) {
      list.innerHTML = `<div class="px-4 py-4 text-sm text-slate-300">Belum ada anggota.</div>`;
      return;
    }

    const now = Date.now();
    const ONLINE_MS = 2 * 60 * 1000; // 2 menit

    list.innerHTML = "";
    snap.forEach((d)=>{
      const u = d.data();
      const last = u.lastSeen?.toDate ? u.lastSeen.toDate().getTime() : 0;
      const isOnline = last && (now - last) <= ONLINE_MS;

      const dot = isOnline
        ? `<span class="inline-block h-2 w-2 rounded-full bg-emerald-400"></span>`
        : `<span class="inline-block h-2 w-2 rounded-full bg-slate-500"></span>`;

      const row = document.createElement("div");
      row.className = "px-4 py-3 flex items-center justify-between";
      row.innerHTML = `
        <div class="flex items-center gap-2">
          ${dot}
          <div class="text-sm font-extrabold">${esc(u.name || "-")}</div>
        </div>
        <div class="text-xs ${isOnline ? "text-emerald-200" : "text-slate-400"}">
          ${isOnline ? "online" : "offline"}
        </div>
      `;
      list.appendChild(row);
    });
  }
</script>

</body>
</html>
