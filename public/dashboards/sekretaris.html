<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sekretaris | KARTEJI Administration</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,0,0" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="icon" href="../assets/img/logo.png">

  <style>
    body { font-family: 'Outfit', sans-serif; }
    .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    .tab-active { background: #34d399 !important; color: #020617 !important; font-weight: 900; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    #loader { display: none; }
    #loader.active { display: flex; }
    .modal-enter { animation: modalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-100 selection:bg-emerald-400">

  <div id="loader" class="fixed inset-0 z-[100] bg-slate-950/90 flex items-center justify-center flex-col gap-4">
      <div class="w-12 h-12 border-4 border-emerald-400/20 border-t-emerald-400 rounded-full animate-spin"></div>
      <p class="text-[10px] font-black tracking-widest text-emerald-400 animate-pulse uppercase">Mengarsipkan Data...</p>
  </div>

  <div id="crudModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm">
    <div class="glass w-full max-w-lg rounded-[2.5rem] p-8 modal-enter relative shadow-2xl">
      <button id="closeModalBtn" class="absolute top-6 right-6 text-slate-400 hover:text-white transition-colors">
        <span class="material-symbols-rounded text-2xl">close</span>
      </button>
      <h2 id="modalTitle" class="text-xl font-black mb-6 text-emerald-400 italic uppercase tracking-tight">Judul Modal</h2>
      <div id="modalBody" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 no-scrollbar">
        </div>
      <div id="modalFooter" class="mt-8">
        <button id="modalSubmitBtn" class="w-full rounded-2xl bg-emerald-400 py-4 text-sm font-black text-slate-950 hover:bg-emerald-300 transition-all active:scale-95 shadow-lg shadow-emerald-400/10">
          SIMPAN DOKUMEN
        </button>
      </div>
    </div>
  </div>

  <header class="sticky top-0 z-30 px-4 py-4">
    <div class="mx-auto max-w-5xl glass rounded-[2rem] p-3 flex items-center justify-between shadow-2xl">
      <div class="flex items-center gap-3 pl-2">
        <div class="w-10 h-10 bg-emerald-400 rounded-2xl flex items-center justify-center shadow-[0_0_15px_rgba(52,211,153,0.3)]">
            <span class="material-symbols-rounded text-slate-950">edit_note</span>
        </div>
        <div>
          <div class="text-sm font-black tracking-tight">KARTEJI</div>
          <div class="text-[9px] text-emerald-400 font-bold uppercase tracking-widest">Sekretariat Digital</div>
        </div>
      </div>
      <button id="logoutBtn" class="p-2.5 rounded-xl bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500 hover:text-white transition-all">
          <span class="material-symbols-rounded text-sm">logout</span>
      </button>
    </div>
  </header>

  <main id="content" class="hidden mx-auto max-w-5xl px-4 pb-24 space-y-6">
    
    <section class="grid grid-cols-3 gap-3">
        <div class="glass rounded-[2rem] p-5 text-center">
            <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Notulen</p>
            <h3 id="countMinutes" class="text-lg font-black text-emerald-400 mt-1">0</h3>
        </div>
        <div class="glass rounded-[2rem] p-5 text-center">
            <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Surat Keluar</p>
            <h3 id="countLetters" class="text-lg font-black text-emerald-400 mt-1">0</h3>
        </div>
        <div class="glass rounded-[2rem] p-5 text-center border-b-4 border-emerald-400/30">
            <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Arsip</p>
            <h3 id="countArchives" class="text-lg font-black text-emerald-400 mt-1">0</h3>
        </div>
    </section>

    <nav class="flex overflow-x-auto no-scrollbar gap-2 py-2">
        <button class="tabBtn whitespace-nowrap px-6 py-3 rounded-2xl glass text-[10px] font-black tracking-widest transition-all" data-tab="notulen">NOTULEN RAPAT</button>
        <button class="tabBtn whitespace-nowrap px-6 py-3 rounded-2xl glass text-[10px] font-black tracking-widest transition-all" data-tab="surat">PERSURATAN</button>
        <button class="tabBtn whitespace-nowrap px-6 py-3 rounded-2xl glass text-[10px] font-black tracking-widest transition-all" data-tab="arsip">ARSIP DIGITAL</button>
    </nav>

    <div class="flex items-center justify-between px-2">
        <h2 id="sectionTitle" class="text-2xl font-black italic uppercase tracking-tighter">Administrasi</h2>
        <div class="flex gap-2">
            <button id="refreshBtn" class="p-4 rounded-2xl glass text-emerald-400 hover:bg-white/5 transition-all"><span class="material-symbols-rounded">sync</span></button>
            <button id="createActionBtn" class="px-6 py-4 bg-emerald-400 text-slate-950 rounded-2xl font-black text-xs shadow-lg">+ DATA BARU</button>
        </div>
    </div>

    <section id="dataList" class="space-y-4"></section>

  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAQxpD7ea9gHWGiU3wYXr0XHyl-SNyFYNs",
      authDomain: "katar-9cac3.firebaseapp.com",
      projectId: "katar-9cac3",
      storageBucket: "katar-9cac3.firebasestorage.app",
      messagingSenderId: "1017734829960",
      appId: "1:1017734829960:web:6b02b7176f08a23ce28c3d"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const CLOUD_NAME = "dbxktcwug";
    const PRESET_ARCHIVE = "Karteji Galeri";

    const $ = id => document.getElementById(id);
    let ME_UID = null;
    let ACTIVE_TAB = "notulen";

    // --- UI ENGINE ---
    window.toggleLoader = (show) => $("loader").classList.toggle('active', show);
    
    window.showModal = (title, bodyHtml, onSave) => {
        $("modalTitle").textContent = title;
        $("modalBody").innerHTML = bodyHtml;
        $("crudModal").classList.remove('hidden');
        $("crudModal").classList.add('flex');
        $("modalSubmitBtn").onclick = onSave;
    };

    window.closeModal = () => {
        $("crudModal").classList.add('hidden');
        $("crudModal").classList.remove('flex');
    };
    $("closeModalBtn").onclick = closeModal;

    window.openTab = (name) => {
        ACTIVE_TAB = name;
        document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("tab-active"));
        document.querySelector(`[data-tab="${name}"]`).classList.add("tab-active");
        $("sectionTitle").textContent = name === 'notulen' ? 'Log Notulen' : name === 'surat' ? 'Log Surat' : 'Folder Arsip';
        loadData();
    };

    // --- CLOUDINARY ENGINE ---
    async function upload(file) {
        if(!file) return null;
        const fd = new FormData();
        fd.append("file", file);
        fd.append("upload_preset", PRESET_ARCHIVE);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, { method: "POST", body: fd });
        const d = await res.json();
        return { url: d.secure_url };
    }

    // --- AUTH ---
    onAuthStateChanged(auth, async user => {
        if (!user) return window.location.href = "../login.html";
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.data()?.role !== "sekretaris") return window.location.href = "../index.html";
        
        ME_UID = user.uid;
        $("content").classList.remove("hidden");
        openTab("notulen");
    });

    // --- CRUD POPUPS ---
    $("createActionBtn").onclick = () => {
        if(ACTIVE_TAB === 'notulen') openNotulenForm();
        else if(ACTIVE_TAB === 'surat') openSuratForm();
        else openArsipForm();
    };

    function openNotulenForm() {
        const html = `
            <input id="nTitle" class="w-full p-4 rounded-2xl bg-white/5 border border-white/10" placeholder="Judul Rapat">
            <div class="grid grid-cols-2 gap-3">
                <input id="nDate" type="date" class="p-4 rounded-2xl bg-white/5 border border-white/10 text-xs">
                <input id="nLoc" class="p-4 rounded-2xl bg-white/5 border border-white/10 text-xs" placeholder="Lokasi Rapat">
            </div>
            <textarea id="nBody" class="w-full p-4 rounded-2xl bg-white/5 border border-white/10 h-32 text-sm" placeholder="Isi pembahasan rapat..."></textarea>
        `;
        showModal("CATAT NOTULEN", html, async () => {
            if(!$("nTitle").value) return alert("Isi judul!");
            toggleLoader(true);
            await addDoc(collection(db, "minutes"), {
                title: $("nTitle").value, date: $("nDate").value, location: $("nLoc").value, body: $("nBody").value,
                createdAt: serverTimestamp()
            });
            closeModal(); loadData(); toggleLoader(false);
        });
    }

    function openSuratForm() {
        const html = `
            <input id="lSub" class="w-full p-4 rounded-2xl bg-white/5 border border-white/10" placeholder="Perihal Surat">
            <div class="grid grid-cols-2 gap-3">
                <input id="lNo" class="p-4 rounded-2xl bg-white/5 border border-white/10 text-xs" placeholder="No Surat">
                <input id="lType" class="p-4 rounded-2xl bg-white/5 border border-white/10 text-xs" placeholder="Jenis (Undangan/BA)">
            </div>
            <textarea id="lBody" class="w-full p-4 rounded-2xl bg-white/5 border border-white/10 h-32 text-sm" placeholder="Ringkasan isi surat..."></textarea>
        `;
        showModal("ARSIP SURAT", html, async () => {
            toggleLoader(true);
            await addDoc(collection(db, "letters"), {
                subject: $("lSub").value, number: $("lNo").value, type: $("lType").value, body: $("lBody").value,
                createdAt: serverTimestamp()
            });
            closeModal(); loadData(); toggleLoader(false);
        });
    }

    function openArsipForm() {
        const html = `
            <input id="aTitle" class="w-full p-4 rounded-2xl bg-white/5 border border-white/10" placeholder="Nama Dokumen">
            <input id="aTag" class="w-full p-4 rounded-2xl bg-white/5 border border-white/10 text-xs" placeholder="Kategori (Sertifikat/SK/Foto)">
            <input id="aFile" type="file" class="text-xs">
        `;
        showModal("UPLOAD ARSIP", html, async () => {
            if(!$("aFile").files[0]) return alert("Pilih file!");
            toggleLoader(true);
            const file = await upload($("aFile").files[0]);
            await addDoc(collection(db, "archives"), {
                title: $("aTitle").value, tag: $("aTag").value, file,
                createdAt: serverTimestamp()
            });
            closeModal(); loadData(); toggleLoader(false);
        });
    }

    // --- DATA LOADERS ---
    async function loadData() {
        const collectionMap = { notulen: 'minutes', surat: 'letters', arsip: 'archives' };
        const snap = await getDocs(query(collection(db, collectionMap[ACTIVE_TAB]), orderBy("createdAt", "desc"), limit(30)));
        const list = $("dataList");
        list.innerHTML = "";
        
        // Update Stats
        if(ACTIVE_TAB === 'notulen') $("countMinutes").textContent = snap.size;
        else if(ACTIVE_TAB === 'surat') $("countLetters").textContent = snap.size;
        else $("countArchives").textContent = snap.size;

        snap.forEach(d => {
            const x = d.data();
            const div = document.createElement("div");
            div.className = "glass p-5 rounded-[2rem] flex justify-between items-center group hover:border-emerald-400/30 transition-all";
            
            if(ACTIVE_TAB === 'notulen') {
                div.innerHTML = `<div><p class="text-[9px] font-black text-emerald-400 uppercase">${x.date || '-'}</p><h4 class="font-black italic">${x.title}</h4></div>`;
            } else if(ACTIVE_TAB === 'surat') {
                div.innerHTML = `<div><p class="text-[9px] font-black text-slate-500 uppercase">${x.number || '-'}</p><h4 class="font-black italic">${x.subject}</h4></div>`;
            } else {
                div.innerHTML = `<div><p class="text-[9px] font-black text-slate-500 uppercase">${x.tag || '-'}</p><h4 class="font-black italic">${x.title}</h4><a href="${x.file?.url}" target="_blank" class="text-[8px] text-emerald-400 underline uppercase font-bold">Buka Dokumen</a></div>`;
            }

            div.innerHTML += `<button onclick="deleteData('${collectionMap[ACTIVE_TAB]}','${d.id}')" class="p-3 rounded-xl bg-rose-500/10 text-rose-500 hover:bg-rose-500 hover:text-white transition-all"><span class="material-symbols-rounded text-sm">delete</span></button>`;
            list.appendChild(div);
        });
    }

    window.deleteData = async (col, id) => {
        if(!confirm("Hapus data ini?")) return;
        toggleLoader(true);
        await deleteDoc(doc(db, col, id));
        loadData();
        toggleLoader(false);
    };

    $("refreshBtn").onclick = loadData;
    $("logoutBtn").onclick = () => signOut(auth).then(() => location.href = "../login.html");
    document.querySelectorAll(".tabBtn").forEach(b => b.onclick = () => openTab(b.dataset.tab));

  </script>
</body>
</html>
